!function(e){function t(e){Object.defineProperty(this,e,{enumerable:!0,get:function(){return this[v][e]}})}function r(e){if("undefined"!=typeof System&&System.isModule?System.isModule(e):"[object Module]"===Object.prototype.toString.call(e))return e;var t={default:e,__useDefault:e};if(e&&e.__esModule)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return new o(t)}function o(e){Object.defineProperty(this,v,{value:e}),Object.keys(e).forEach(t,this)}function n(e){return"@node/"===e.substr(0,6)?c(e,r(m(e.substr(6)))):p[e]}function u(e){var t=n(e);if(!t)throw new Error('Module "'+e+'" expected, but not contained in build.');if(t.module)return t.module;var r=t.linkRecord;return function i(e,t){if(!t.depLoads){t.declare&&d(e,t),t.depLoads=[];for(var r=0;r<t.deps.length;r++){var o=n(t.deps[r]);t.depLoads.push(o),o.linkRecord&&i(o,o.linkRecord);var u=t.setters&&t.setters[r];u&&(u(o.module||o.linkRecord.moduleObj),o.importerSetters.push(u))}return e}}(t,r),a(t,r,[]),t.module}function d(t,r){var o=r.moduleObj,n=t.importerSetters,u=!1,i=r.declare.call(e,function(e,t){if(!u){if("object"==typeof e)for(var r in e)"__useDefault"!==r&&(o[r]=e[r]);else o[e]=t;u=!0;for(var i=0;i<n.length;i++)n[i](o);return u=!1,t}},{id:t.key});"function"!=typeof i?(r.setters=i.setters,r.execute=i.execute):(r.setters=[],r.execute=i)}function l(e,t,r){return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:r,setters:void 0,execute:void 0,moduleObj:{}}}}function f(e,t,r,o){var n={};return p[e]={key:e,module:void 0,importerSetters:[],linkRecord:{deps:t,depLoads:void 0,declare:void 0,execute:o,executingRequire:r,moduleObj:{default:n,__useDefault:n},setters:void 0}}}function a(t,r,n){if(n.push(t),t.module)return t.module;if(r.setters){for(var i=0;i<r.deps.length;i++){var d=r.depLoads[i],l=d.linkRecord;l&&-1===n.indexOf(d)&&a(d,l,l.setters?n:[])}r.execute.call(y)}else{var f={id:t.key},c=r.moduleObj;Object.defineProperty(f,"exports",{configurable:!0,set:function(e){c.default=c.__useDefault=e},get:function(){return c.__useDefault}});var p=function(e,t,r){return function(o){for(var n=0;n<e.length;n++)if(e[n]===o){var u,i=t[n],d=i.linkRecord;return"__useDefault"in(u=d?-1===r.indexOf(i)?a(i,d,r):d.moduleObj:i.module)?u.__useDefault:u}}}(r.deps,r.depLoads,n);if(!r.executingRequire)for(i=0;i<r.deps.length;i++)p(r.deps[i]);var v=r.execute.call(e,p,c.__useDefault,f);void 0!==v?c.default=c.__useDefault=v:f.exports!==c.__useDefault&&(c.default=c.__useDefault=f.exports);var m=c.__useDefault;if(m&&m.__esModule)for(var b in m)Object.hasOwnProperty.call(m,b)&&(c[b]=m[b])}f=t.module=new o(r.moduleObj);if(!r.setters)for(i=0;i<t.importerSetters.length;i++)t.importerSetters[i](f);return f}function c(e,t){return p[e]={key:e,module:t,importerSetters:[],linkRecord:void 0}}var p={},v="undefined"!=typeof Symbol?Symbol():"@@baseObject";o.prototype=Object.create(null),"undefined"!=typeof Symbol&&Symbol.toStringTag&&(o.prototype[Symbol.toStringTag]="Module");var m="undefined"!=typeof System&&System._nodeRequire||"undefined"!=typeof require&&void 0!==require.resolve&&"undefined"!=typeof process&&process.platform&&require,y={};return Object.freeze&&Object.freeze(y),function(e,t,n,i){return function(d){d(function(d){var s={_nodeRequire:m,register:l,registerDynamic:f,registry:{get:function(e){return p[e].module},set:c},newModule:function(e){return new o(e)}};c("@empty",new o({}));for(var a=0;a<t.length;a++)c(t[a],r(arguments[a]));i(s);var v=u(e[0]);if(e.length>1)for(a=1;a<e.length;a++)u(e[a]);return n?v.__useDefault:(v instanceof o&&Object.defineProperty(v,"__esModule",{value:!0}),v)})}}}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this)(["a"],["c","34","32","31","30","33","35","36"],!0,function($__System){this.require,this.exports;var definition,module=this.module;$__System.registerDynamic("b",["c","d","e"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__values=exports&&exports.__values||function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),extensions_1=$__require("d"),AssetsExtension=function(_super){function AssetsExtension(scene){var _this=_super.call(this,scene)||this;return _this.prefabs=[],_this.particles=[],_this._particlesInstances={},_this}return __extends(AssetsExtension,_super),AssetsExtension.prototype.onApply=function(data){var _this=this;data.prefabs&&data.prefabs.forEach(function(p){return _this.prefabs.push(p)}),data.particles&&data.particles.forEach(function(p){return _this.particles.push(p)})},AssetsExtension.prototype.instantiatePrefab=function(name){var e_1,_a,_this=this,_loop_1=function(p){var _a;if(p.name!==name)return"continue";var source=this_1.scene.getNodeByID(p.data.nodeIds[0]);if(!source)return{value:null};var master=this_1._createInstance(source);if(!master)return{value:null};var descendants=source.getDescendants(),parentingDict=((_a={})[source.id]=master,_a);return descendants.forEach(function(d){var child=_this._createInstance(d);child&&(child.parent=parentingDict[d.parent.id],parentingDict[d.id]=child)}),{value:master}},this_1=this;try{for(var _b=__values(this.prefabs),_c=_b.next();!_c.done;_c=_b.next()){var state_1=_loop_1(_c.value);if("object"==typeof state_1)return state_1.value}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}return null},AssetsExtension.prototype.instantiateParticleSystemsSet=function(name,position){var e_2,_a,_this=this,_loop_2=function(ps){if(ps.name!==name)return"continue";var set=this_2._particlesInstances[name];return set||(set=new babylonjs_1.ParticleSystemSet,ps.data.psData.systems.forEach(function(s){var ps=babylonjs_1.ParticleSystem.Parse(s,_this.scene,extensions_1.default.RoolUrl,!0);set.systems.push(ps)}),this_2._particlesInstances[name]=set),position&&set.systems.forEach(function(s){return s.emitter=position}),this_2._particlesInstances[name]=set,{value:set}},this_2=this;try{for(var _b=__values(this.particles),_c=_b.next();!_c.done;_c=_b.next()){var state_2=_loop_2(_c.value);if("object"==typeof state_2)return state_2.value}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_2)throw e_2.error}}return null},AssetsExtension.prototype._createInstance=function(node){return node instanceof babylonjs_1.Mesh?node.createInstance(node.name+"Inst"):node.clone?node.clone(node.name+"Inst",null):null},AssetsExtension.prototype.onSerialize=function(){return null},AssetsExtension.prototype.onLoad=function(data){},AssetsExtension}($__require("e").default);exports.default=AssetsExtension,extensions_1.default.Register("AssetsExtension",AssetsExtension)}),$__System.registerDynamic("f",["10","11"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var graph_node_1=$__require("10"),types_1=$__require("11");exports.registerTypeNode=function(path,name,description,getDefaultValue){var _a;graph_node_1.GraphNode.RegisterNode(path,((_a=function(_super){function class_1(){var _this=_super.call(this,getDefaultValue)||this;return _this.title=name,_this.desc=description,_this}return __extends(class_1,_super),class_1}(GraphTypeNode)).Title=name,_a.Desc=description,_a))};var GraphTypeNode=function(_super){function GraphTypeNode(getDefaultValue){var _this=_super.call(this)||this;_this.defaultValue=getDefaultValue();var type=graph_node_1.GraphNode.GetConstructorName(_this.defaultValue).toLowerCase();switch(type){case"number":case"string":_this.addProperty("Value",_this.defaultValue);break;case"vector2":type="vec2",_this.addProperty("Value",graph_node_1.GraphNode.vector3ToVec3(_this.defaultValue));break;case"vector3":type="vec3",_this.addProperty("Value",graph_node_1.GraphNode.vector3ToVec3(_this.defaultValue));break;case"vector4":type="vec4",_this.addProperty("Value",graph_node_1.GraphNode.vector4ToVec4(_this.defaultValue));break;case"color3":type="col3",_this.addProperty("Value",graph_node_1.GraphNode.color3ToCol3(_this.defaultValue));break;case"color4":type="col4",_this.addProperty("Value",graph_node_1.GraphNode.color4ToCol4(_this.defaultValue))}return _this.addOutput("Value",type),GraphTypeNode._VectorOuputs.forEach(function(v){return void 0!==_this.defaultValue[v]&&_this.addOutput(v,"number")}),GraphTypeNode._ColorOutputs.forEach(function(v){return void 0!==_this.defaultValue[v]&&_this.addOutput(v,"number")}),_this}return __extends(GraphTypeNode,_super),GraphTypeNode.prototype.onExecute=function(){var _this=this;this.setOutputData(0,this.properties.Value),GraphTypeNode._VectorOuputs.forEach(function(v,index){return void 0!==_this.defaultValue[v]&&_this.setOutputData(index+1,_this.properties.Value[index])}),GraphTypeNode._ColorOutputs.forEach(function(v,index){return void 0!==_this.defaultValue[v]&&_this.setOutputData(index+1,_this.properties.Value[index])})},GraphTypeNode.prototype.onDrawBackground=function(ctx){if(!this.flags.collapsed){ctx.font="14px Arial",ctx.fillStyle="grey",ctx.textAlign="center";var text=this.properties.Value.toString(),measure=ctx.measureText(text);this.size[0]<=measure.width&&(this.size[0]=measure.width+100),ctx.fillText(text,.5*this.size[0],this.size[1]+15)}},GraphTypeNode._VectorOuputs=["x","y","z","w"],GraphTypeNode._ColorOutputs=["r","g","b","a"],GraphTypeNode}(types_1.IGraphNode);exports.GraphTypeNode=GraphTypeNode}),$__System.registerDynamic("12",["c","f"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),graph_type_node_1=$__require("f");exports.registerAllTypeNodes=function(object){graph_type_node_1.registerTypeNode("types/number","Number","Represents a number",function(){return 0}),graph_type_node_1.registerTypeNode("types/string","String","Represents a string",function(){return"new string"}),graph_type_node_1.registerTypeNode("types/vector2","Vector2","Represents a Vector 2D",function(){return babylonjs_1.Vector2.Zero()}),graph_type_node_1.registerTypeNode("types/vector3","Vector3","Represents a Vector3D",function(){return babylonjs_1.Vector3.Zero()}),graph_type_node_1.registerTypeNode("types/vector4","Vector4","Represents a Vector4D",function(){return babylonjs_1.Vector4.Zero()}),graph_type_node_1.registerTypeNode("types/color3","Color3","Represents a Color3",function(){return babylonjs_1.Color3.Black()}),graph_type_node_1.registerTypeNode("types/color4","Color4","Represents a Color4",function(){return new babylonjs_1.Color4(0,0,0,1)})}}),$__System.registerDynamic("13",["14","11","15"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var litegraph_js_1=$__require("14"),types_1=$__require("11"),graph_1=$__require("15");exports.registerFunctionNode=function(ctor,object,path,name,description,methodName,args,returnType){var _a;(!object||object instanceof ctor)&&graph_1.GraphNode.RegisterNode(path,((_a=function(_super){function class_1(){var _this=_super.call(this,methodName,args,returnType)||this;return _this.title=name,_this.desc=description,_this}return __extends(class_1,_super),class_1}(GraphFunctionNode)).Title=name,_a.Desc=description,_a))};var GraphFunctionNode=function(_super){function GraphFunctionNode(methodName,args,returnType){var _this=_super.call(this)||this;return _this._isValid=!1,_this._methodName=methodName,_this._args=args,_this._returnType=returnType,_this._configureInputs(),_this._configureOutput(),_this.computeSize(),_this}return __extends(GraphFunctionNode,_super),GraphFunctionNode.prototype.onExecute=function(){var _this=this,target=this.graph.scriptObject,method=target[this._methodName];if(!method)return console.warn('No method exists on target: "'+this._methodName+'"');this._isValid=!0;var args=this._args.map(function(a,index){var i=_this.getInputData(index+1);if(null!=i||a.optional)return graph_1.GraphNode.nodeToOutput(i);_this._isValid=!1});this.setNodeState(!this._isValid),this._isValid&&method.apply(target,args)},GraphFunctionNode.prototype.onDrawBackground=function(ctx){this.flags.collapsed},GraphFunctionNode.prototype._configureInputs=function(){var _this=this;this.addInput("Execute",litegraph_js_1.LiteGraph.EVENT),this._args.forEach(function(a,index){return _this.addInput(a.name+(a.optional?"":" *"),a.type)})},GraphFunctionNode.prototype._configureOutput=function(){this._returnType&&this.addOutput(this._returnType.name,this._returnType.type)},GraphFunctionNode}(types_1.IGraphNode);exports.GraphFunctionNode=GraphFunctionNode}),$__System.registerDynamic("16",["c","13"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),graph_function_node_1=$__require("13");exports.registerAllFunctionNodes=function(object){graph_function_node_1.registerFunctionNode(babylonjs_1.AbstractMesh,object,"functions/movewithcollisions","Move With Collisions","Move the mesh using collision engine.","moveWithCollisions",[{name:"displacement",type:"vec3",optional:!1}]),graph_function_node_1.registerFunctionNode(babylonjs_1.AbstractMesh,object,"functions/lookat","Look At","Orients a mesh towards a target point. Mesh must be drawn facing user.","lookAt",[{name:"target point",type:"vec3",optional:!1},{name:"yawCor",type:"number",optional:!0},{name:"pitchCor",type:"number",optional:!0},{name:"rollCor",type:"number",optional:!0}]),graph_function_node_1.registerFunctionNode(babylonjs_1.AbstractMesh,object,"functions/rotate","Rotate","Rotates the mesh around the axis vector for the passed angle (amount) expressed in radians, in the local space.","rotate",[{name:"axis",type:"vec3",optional:!1},{name:"amount",type:"number",optional:!1}]),graph_function_node_1.registerFunctionNode(babylonjs_1.AbstractMesh,object,"functions/translate","Translate","Translates the mesh along the axis vector for the passed distance in the local space.","translate",[{name:"axis",type:"vec3",optional:!1},{name:"distance",type:"number",optional:!1}]),graph_function_node_1.registerFunctionNode(babylonjs_1.AbstractMesh,object,"functions/setdirection","Set Direction","Sets this transform node rotation to the given local axis.","setDirection",[{name:"localAxis",type:"vec3",optional:!1},{name:"yawCor",type:"number",optional:!0},{name:"pitchCor",type:"number",optional:!0},{name:"rollCor",type:"number",optional:!0}])}}),$__System.registerDynamic("17",["c","14","10","d"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),litegraph_js_1=$__require("14"),graph_node_1=$__require("10"),extensions_1=$__require("d");exports.registerAllUtilsNodes=function(object){graph_node_1.registerNode({name:"Bypass Type",description:"Removes the type of the input",path:"utils/bypass",ctor:Object,inputs:[{name:"In",type:void 0}],outputs:[{name:"Out",type:void 0,inputName:"In"}]},object),graph_node_1.registerNode({name:"Time",description:"Returns the current time in milliseconds or seconds",path:"utils/time",ctor:Object,functionRef:function(node,target){return node.setOutputData(1,node.graph.globaltime),1e3*node.graph.globaltime},outputs:[{name:"ms",type:"number"},{name:"sec",type:"number"}],drawBackground:function(node){return(1e3*node.graph.globaltime).toString()}},object),graph_node_1.registerNode({name:"Log",description:"Logs the given message",path:"utils/log",ctor:Object,functionRef:function(node){console[node.properties.Level.toLowerCase()](node.properties.Message,node.getInputData(1))},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Message",type:void 0}],properties:[{name:"Message",type:"string",defaultValue:"My Message"},{name:"Level",type:"string",defaultValue:"Info",enums:["Info","Warn","Error"]}],drawBackground:function(node){return node.properties.Level+": "+node.properties.Message+", "+(node.getInputData(1)||"").toString()}},object),graph_node_1.registerNode({name:"Set Timeout",description:"Triggers the next node(s) after x milliseconds",path:"utils/settimeout",ctor:Object,functionRef:function(node){node.store.ids=node.store.ids||[];var ms=node.getInputData(1)||node.properties["Time (ms)"],id=setTimeout(function(){return node.triggerSlot(0)},ms);node.store.ids.push(id),node.setOutputData(1,id)},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Time (ms)",type:"number"}],properties:[{name:"Time (ms)",type:"number",defaultValue:1e3}],outputs:[{name:"Time out",type:litegraph_js_1.LiteGraph.EVENT},{name:"Id",type:"number"}],onStop:function(node){node.store.ids&&node.store.ids.forEach(function(id){return clearTimeout(id)})}},object),graph_node_1.registerNode({name:"Clear Timeout",description:"Clears the given timeout Id",path:"utils/cleartimeout",ctor:Object,functionRef:function(node){clearTimeout(node.getInputData(1))},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Id",type:"number"}]},object),graph_node_1.registerNode({name:"Vector 2D to XY",description:"Takes a vector as parameter and ouputs its x and y",path:"utils/vec2toxy",ctor:Object,functionRef:function(node){var v=graph_node_1.GraphNode.nodeToOutput(node.getInputData(0));return v&&node.setOutputData(1,v.y),v.x},inputs:[{name:"In Vector",type:"vec2"}],outputs:[{name:"x",type:"number"},{name:"y",type:"number"}]},object),graph_node_1.registerNode({name:"Vector 3D to XYZ",description:"Takes a vector as parameter and ouputs its x, y and z",path:"utils/vec3toxyz",ctor:Object,functionRef:function(node){var v=graph_node_1.GraphNode.nodeToOutput(node.getInputData(0));return v&&(node.setOutputData(1,v.y),node.setOutputData(2,v.z)),v.x},inputs:[{name:"In Vector",type:"vec3"}],outputs:[{name:"x",type:"number"},{name:"y",type:"number"},{name:"z",type:"number"}]},object),graph_node_1.registerNode({name:"Vector 4D to XYZW",description:"Takes a vector as parameter and ouputs its x, y, z and w",path:"utils/vec4toxyzw",ctor:Object,functionRef:function(node){var v=graph_node_1.GraphNode.nodeToOutput(node.getInputData(0));return v&&(node.setOutputData(1,v.y),node.setOutputData(2,v.z),node.setOutputData(3,v.w)),v.x},inputs:[{name:"In Vector",type:"vec4"}],outputs:[{name:"x",type:"number"},{name:"y",type:"number"},{name:"z",type:"number"},{name:"w",type:"number"}]},object),graph_node_1.registerNode({name:"Color 3 to RGB",description:"Takes a color as parameter and ouputs its r, g and b",path:"utils/col3torgb",ctor:Object,functionRef:function(node){var c=graph_node_1.GraphNode.nodeToOutput(node.getInputData(0),!0);return c&&(node.setOutputData(1,c.g),node.setOutputData(2,c.b)),c.r},inputs:[{name:"In Color",type:"col3"}],outputs:[{name:"r",type:"number"},{name:"g",type:"number"},{name:"b",type:"number"}],onGetInputs:function(){return[["pos","vec3"]]}},object),graph_node_1.registerNode({name:"Color 4 to RGBA",description:"Takes a color as parameter and ouputs its r, g, b and a",path:"utils/col4torgba",ctor:Object,functionRef:function(node){var c=graph_node_1.GraphNode.nodeToOutput(node.getInputData(0),!0);return c&&(node.setOutputData(1,c.g),node.setOutputData(2,c.b),node.setOutputData(3,c.a)),c.r},inputs:[{name:"In Color",type:"col4"}],outputs:[{name:"r",type:"number"},{name:"g",type:"number"},{name:"b",type:"number"},{name:"a",type:"number"}]},object),graph_node_1.registerNode({name:"Vector Merger",description:"Exposes the XYZW properties to merge into 2d, 3d or 4d vectors.",path:"utils/vectormerger",ctor:Object,functionRef:function(node){return node.store.vector2=node.store.vector2||new babylonjs_1.Vector2(0,0),node.store.vector3=node.store.vector3||new babylonjs_1.Vector3(0,0,0),node.store.vector4=node.store.vector4||new babylonjs_1.Vector4(0,0,0,0),node.store.vector2.x=node.store.vector3.x=node.store.vector4.x=node.getInputData(0),node.store.vector2.y=node.store.vector3.y=node.store.vector4.y=node.getInputData(1),node.store.vector3.z=node.store.vector4.z=node.getInputData(2),node.store.vector4.w=node.getInputData(3),node.setOutputData(1,node.store.vector3.asArray()),node.setOutputData(2,node.store.vector4.asArray()),node.store.vector2},inputs:[{name:"x",type:"number"},{name:"y",type:"number"},{name:"z",type:"number"},{name:"w",type:"number"}],outputs:[{name:"Vector 2",type:"vec2"},{name:"Vector 3",type:"vec3"},{name:"Vector 4",type:"vec4"}]},object),graph_node_1.registerNode({name:"Send Script Message",description:"Sends a message to the given target by giving the method name and a parameter",path:"utils/sendmessage",ctor:Object,functionRef:function(node,target){var input=node.getInputData(1);extensions_1.default.Tools.sendMessage(target,node.properties["Method Name"],input)},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Value",type:void 0}],outputs:[],properties:[{name:"Target Path",type:"string",defaultValue:"Self"},{name:"Method Name",type:"string",defaultValue:""}],drawBackground:function(node){return node.properties["Target Path"]+"."+node.properties["Method Name"]}},object)}}),$__System.registerDynamic("18",["c","14","10"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),litegraph_js_1=$__require("14"),graph_node_1=$__require("10");exports.registerAllMathNodes=function(object){graph_node_1.registerNode({name:"Scale",description:"Scales",path:"math/scale",ctor:Object,functionRef:function(node){var vec=graph_node_1.GraphNode.nodeToOutput(node.getInputData(1));return vec&&node.setOutputData(1,graph_node_1.GraphNode.inputToNode(vec.scale(node.properties.Amount))),node.getInputData(0)*node.properties.Amount},properties:[{name:"Amount",type:"number",defaultValue:1}],inputs:[{name:"Number",type:"number"},{name:"Vector",type:"vec2,vec3,vec4"}],outputs:[{name:"Scaled number",type:"number"},{name:"Scaled vector",type:"vec2,vec3,vec4"}],drawBackground:function(node){return node.properties.Amount.toString()}},object),graph_node_1.registerNode({name:"Operation",description:"Performs an operation (+, -, *, /)",path:"math/operation",ctor:Object,functionRef:function(node){var a=node.getInputData(0),b=node.getInputData(1);switch(node.properties.Operator){case"+":return a+b;case"-":return a-b;case"*":return a*b;case"/":return a/b;default:return 0}},properties:[{name:"Operator",type:"string",defaultValue:"+",enums:["+","-","*","/"]}],inputs:[{name:"a",type:"number"},{name:"b",type:"number"}],outputs:[{name:"Result",type:"number"}],drawBackground:function(node){switch(node.properties.Operator){case"+":return"Add";case"-":return"Subtract";case"*":return"Multiply";case"/":return"Divide";default:return""}}},object),graph_node_1.registerNode({name:"Vector Operation",description:"Performs a vector operation (+, -, *, /)",path:"math/vectoroperation",ctor:Object,functionRef:function(node){var a=graph_node_1.GraphNode.nodeToOutput(node.getInputData(0)),b=graph_node_1.GraphNode.nodeToOutput(node.getInputData(1));switch(node.properties.Operator){case"+":return a.add(b);case"-":return a.subtract(b);case"*":return a.multiply(b);case"/":return a.divide(b);default:return 0}},inputs:[{name:"vec1",type:"vec2,vec3,vec4"},{name:"vec2",type:"vec2,vec3,vec4"}],outputs:[{name:"Result",type:"vec2,vec3,vec4"}],properties:[{name:"Operator",type:"string",defaultValue:"+",enums:["+","-","*","/"]}],drawBackground:function(node){return node.properties.Operator}},object),graph_node_1.registerNode({name:"Fract",description:"Computes the fractional part of the input vector.",path:"math/fract",ctor:Object,functionRef:function(node){return graph_node_1.GraphNode.nodeToOutput(node.getInputData(0)).fract()},inputs:[{name:"Vector",type:"vec2,vec3,vec4"}],outputs:[{name:"Result",type:"vec2,vec3,vec4"}]},object),graph_node_1.registerNode({name:"Negate",description:"Computes the negation of the input value.",path:"math/negate",ctor:Object,functionRef:function(node){var v=graph_node_1.GraphNode.nodeToOutput(node.getInputData(0));switch(graph_node_1.GraphNode.GetConstructorName(v).toLowerCase()){case"number":return-v;case"vector2":case"vector3":case"vector4":return v.negate()}},inputs:[{name:"Input",type:"number,vec2,vec3,vec4"}],outputs:[{name:"Result",type:"number,vec2,vec3,vec4"}]},object),graph_node_1.registerNode({name:"Condition",description:"Check the inputs and compares to trigger the appropriate slot.",path:"math/condition",ctor:Object,functionRef:function(node){var a=node.getInputData(1),b=node.getInputData(2);a===b&&node.triggerSlot(0),a!==b&&node.triggerSlot(1),a>=b&&node.triggerSlot(2),a<=b&&node.triggerSlot(3),a>b&&node.triggerSlot(4),a<b&&node.triggerSlot(5)},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"a",type:"number,boolean,string"},{name:"b",type:"number,boolean,string"}],outputs:[{name:"a == b",type:litegraph_js_1.LiteGraph.EVENT},{name:"a != b",type:litegraph_js_1.LiteGraph.EVENT},{name:"a >= b",type:litegraph_js_1.LiteGraph.EVENT},{name:"a <= b",type:litegraph_js_1.LiteGraph.EVENT},{name:"a > b",type:litegraph_js_1.LiteGraph.EVENT},{name:"a < b",type:litegraph_js_1.LiteGraph.EVENT}]},object),graph_node_1.registerNode({name:"For Loop",description:'Performs a "for loop" that will trigger the next nodes Nth times',path:"math/forloop",ctor:Object,functionRef:function(node){var i=node.getInputData(1);node.isInputValid(i)||(i=node.properties.Begin);var end=node.getInputData(2);node.isInputValid(end)||(end=node.properties.End);var increment=node.getInputData(3);for(node.isInputValid(increment)||(increment=node.properties.Increment);i<=end;i+=increment)node.setOutputData(1,i),node.triggerSlot(0)},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Begin",type:"number"},{name:"End",type:"number"},{name:"Increment",type:"number"}],outputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Indice",type:"number"}],properties:[{name:"Begin",defaultValue:0,type:"number"},{name:"End",defaultValue:32,type:"number"},{name:"Increment",defaultValue:1,type:"number"}],widgets:[{type:"number",name:"Begin",value:0,callback:function(v,g,n){return n.properties.Begin=v}},{type:"number",name:"End",value:32,callback:function(v,g,n){return n.properties.End=v}},{type:"number",name:"Increment",value:1,callback:function(v,g,n){return n.properties.Increment=v}}]},object),graph_node_1.registerNode({name:"Cosinus",description:"Performs a cosinus operation",path:"math/cos",ctor:Object,functionRef:function(node){return Math.cos(node.getInputData(0))},inputs:[{name:"In",type:"number"}],outputs:[{name:"Out",type:"number"}]},object),graph_node_1.registerNode({name:"Sinus",description:"Performs a sinus operation",path:"math/sin",ctor:Object,functionRef:function(node){return Math.sin(node.getInputData(0))},inputs:[{name:"In",type:"number"}],outputs:[{name:"Out",type:"number"}]},object),graph_node_1.registerNode({name:"Tangent",description:"Performs a tangent operation",path:"math/tan",ctor:Object,functionRef:function(node){return Math.tan(node.getInputData(0))},inputs:[{name:"In",type:"number"}],outputs:[{name:"Out",type:"number"}]},object),graph_node_1.registerNode({name:"Abs",description:"Returns the absolute position of the input number",path:"math/abs",ctor:Object,functionRef:function(node){return Math.abs(node.getInputData(0))||0},inputs:[{name:"In",type:"number"}],outputs:[{name:"Out",type:"number"}]},object),graph_node_1.registerNode({name:"Random",description:"Returns a random number in the given range",path:"math/random",ctor:Object,functionRef:function(node){return Math.random()*(node.properties.Max-node.properties.Min)+node.properties.Min},outputs:[{name:"Value",type:"number"}],properties:[{name:"Min",defaultValue:0,type:"number"},{name:"Max",defaultValue:1,type:"number"}]},object),graph_node_1.registerNode({name:"Floor",description:"Floors the given number of vector",path:"math/floor",ctor:Object,functionRef:function(node){var vec=graph_node_1.GraphNode.nodeToOutput(node.getInputData(1));return vec&&node.setOutputData(1,graph_node_1.GraphNode.inputToNode(vec.floor())),Math.floor(node.getInputData(0)||0)},inputs:[{name:"Input Number",type:"number"},{name:"Input Vector",type:"vec2,vec3,vec4"}],outputs:[{name:"Number Result",type:"number"},{name:"Vector Result",type:"vec2,vec3,vec4"}]},object),graph_node_1.registerNode({name:"Exp",description:"Returns e (the base of natural logarithms) raised to the given power",path:"math/exp",ctor:Object,functionRef:function(node){var i=node.getInputData(0);return null==i?Math.exp(node.properties.Power):Math.exp(i)},inputs:[{name:"Power",type:"number"}],outputs:[{name:"Result",type:"number"}],properties:[{name:"Power",defaultValue:1,type:"number"}]},object),graph_node_1.registerNode({name:"Clamp",description:"Clamps the given value in the given interval [min, max]",path:"math/clamp",ctor:Object,functionRef:function(node){var val=graph_node_1.GraphNode.nodeToOutput(node.getInputData(0));if(node.isInputValid(val)){var min=graph_node_1.GraphNode.nodeToOutput(node.getInputData(1));if(node.isInputValid(min)){var max=graph_node_1.GraphNode.nodeToOutput(node.getInputData(2));if(node.isInputValid(max))return val instanceof babylonjs_1.Vector2?babylonjs_1.Vector2.Clamp(val,min,max):val instanceof babylonjs_1.Vector3?babylonjs_1.Vector3.Clamp(val,min,max):babylonjs_1.Scalar.Clamp(val,min,max)}}},inputs:[{name:"Value",type:"number,vec2,vec3"},{name:"Min",type:"number,vec2,vec3"},{name:"Max",type:"number,vec2,vec3"}],outputs:[{name:"Result",type:"number,vec2,vec3"}]},object)}}),$__System.registerDynamic("19",["14","10","c"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var litegraph_js_1=$__require("14"),graph_node_1=$__require("10"),babylonjs_1=$__require("c");exports.registerAllPropertiesNodes=function(object){graph_node_1.registerNode({name:"Get Property",description:"Gets the property of the current node and returns its value.",path:"properties/getproperty",ctor:Object,properties:[{name:"Property Path",type:"string",defaultValue:"name"},{name:"Target Path",type:"string",defaultValue:object&&object.name?object.name:"Scene"}],outputs:[{type:void 0,name:"Value",propertyPath:"propertyPath",propertyName:"Property Path"}],drawBackground:function(node,target){return target+"'s\n"+node.properties["Property Path"]}},object),graph_node_1.registerNode({name:"Set Property",description:"Sets the property of the current node to the input value.",path:"properties/setproperty",ctor:Object,functionRef:function(node,target,scene){var split=node.properties["Property Path"].split("."),effectiveProperty=graph_node_1.GraphNode.GetEffectiveProperty(target,node.properties["Property Path"]),property=effectiveProperty[split[split.length-1]],input=graph_node_1.GraphNode.nodeToOutput(node.getInputData(1),property instanceof babylonjs_1.Color3||property instanceof babylonjs_1.Color4);return graph_node_1.GraphNode.GetConstructorName(input)!==graph_node_1.GraphNode.GetConstructorName(property)?node.getInputData(1):effectiveProperty[split[split.length-1]]=input},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"In",type:void 0}],properties:[{name:"Property Path",type:"string",defaultValue:"name"},{name:"Target Path",type:"string",defaultValue:"Self"}],outputs:[{type:void 0,name:"Value",propertyPath:"propertyPath",propertyName:"Property Path"}],drawBackground:function(node,target){return target+"'s\n"+node.properties["Property Path"]}},object),graph_node_1.registerNode({name:"Variable",description:"Sets a variable node taken from the avaialable node variables.",path:"properties/variable",ctor:Object,functionRef:function(node){node.graph.variables=node.graph.variables||[];var v=node.graph.variables.find(function(v){return v.name===node.properties.Variable});if(v){var i=node.getInputData(1);return null!=i&&(v.value=i),graph_node_1.GraphNode.nodeToOutput(v.value)}console.warn('No variable found for name "'+node.properties.Variable+'"')},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Set Value",type:void 0}],outputs:[{name:"Get Value",type:void 0}],properties:[{name:"Variable",type:"string",defaultValue:""}],widgets:[{name:"Variable",type:"combo",value:"None",callback:function(v,g,n){return n.properties.Variable=v},options:{onInstanciate:function(n,w){return w.value=n.properties.Variable},values:function(w,n){return n.graph.variables.map(function(v){return v.name})}}}],drawBackground:function(node){return node.properties.Variable}},object)}}),$__System.registerDynamic("1a",["c","14","10"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),litegraph_js_1=$__require("14"),graph_node_1=$__require("10");exports.registerAllTransformsNodes=function(object){graph_node_1.registerNode({name:"Transform",description:"Gets the current transformation of the node",path:"node/transform",ctor:babylonjs_1.AbstractMesh,functionRef:function(node,target){var position=graph_node_1.GraphNode.nodeToOutput(node.getInputData(1),!1),rotation=graph_node_1.GraphNode.nodeToOutput(node.getInputData(2),!1),scaling=graph_node_1.GraphNode.nodeToOutput(node.getInputData(3),!1);return position&&target.position&&target.position.copyFrom(position),rotation&&target.rotation&&target.rotation.copyFrom(rotation),scaling&&target.scaling&&target.scaling.copyFrom(scaling),node.setOutputData(1,rotation?rotation.asArray():target.rotation),node.setOutputData(2,scaling?scaling.asArray():target.scaling),position||target.position},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Position",type:"vec3"},{name:"Rotation",type:"vec3"},{name:"Scaling",type:"vec3"}],outputs:[{name:"Position",type:"vec3"},{name:"Rotation",type:"vec3"},{name:"Scaling",type:"vec3"}],drawBackground:function(node,target){return target}},object),graph_node_1.registerNode({name:"Set Parent",description:"Sets the new parent of the node",path:"node/setparent",ctor:babylonjs_1.Node,functionRef:function(node,target,scene){var parent=node.getInputData(1)||target;parent!==node.graph.scriptObject?node.graph.scriptObject.parent=parent:node.graph.scriptObject.parent=null},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Parent",type:"node"}],properties:[{name:"Target Path",type:"string",defaultValue:"Self"}]},object)}}),$__System.registerDynamic("1b",["c","14","10"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),litegraph_js_1=$__require("14"),graph_node_1=$__require("10");exports.registerAllPointerNodes=function(object){var checkPointerEvent=function(node,target,scene,ev,type){if(ev.type===type)return scene.pick(scene.pointerX,scene.pointerY).pickedMesh===target};graph_node_1.registerNode({name:"Pointer Down",description:"Triggers on the node has been clicked.",path:"events/pointerdown",ctor:babylonjs_1.AbstractMesh,functionRef:function(node,target,scene){node.store.observer=node.store.observer||scene.onPointerObservable.add(function(ev){checkPointerEvent(0,target,scene,ev,babylonjs_1.PointerEventTypes.POINTERDOWN)&&node.triggerSlot(0)})},outputs:[{name:"Clicked",type:litegraph_js_1.LiteGraph.EVENT}],onStop:function(node,target,scene){node.store.observer&&scene.onPointerObservable.remove(node.store.observer)}},object),graph_node_1.registerNode({name:"Pointer Move",description:"Triggers on the pointer moves on the node.",path:"events/pointermove",ctor:babylonjs_1.AbstractMesh,functionRef:function(node,target,scene){node.store.observer=node.store.observer||scene.onPointerObservable.add(function(ev){checkPointerEvent(0,target,scene,ev,babylonjs_1.PointerEventTypes.POINTERMOVE)&&node.triggerSlot(0)})},outputs:[{name:"Moved",type:litegraph_js_1.LiteGraph.EVENT}],onStop:function(node,target,scene){node.store.observer&&scene.onPointerObservable.remove(node.store.observer)}},object),graph_node_1.registerNode({name:"Pointer Up",description:"Triggers on the pointer is up on the node.",path:"events/pointerup",ctor:babylonjs_1.AbstractMesh,functionRef:function(node,target,scene){node.store.observer=node.store.observer||scene.onPointerObservable.add(function(ev){checkPointerEvent(0,target,scene,ev,babylonjs_1.PointerEventTypes.POINTERUP)&&node.triggerSlot(0)})},outputs:[{name:"Up",type:litegraph_js_1.LiteGraph.EVENT}],onStop:function(node,target,scene){node.store.observer&&scene.onPointerObservable.remove(node.store.observer)}},object),graph_node_1.registerNode({name:"Pointer Over",description:"Triggers on the pointer is over the node.",path:"events/pointerover",ctor:babylonjs_1.AbstractMesh,functionRef:function(node,target,scene){node.store.wasOver=node.store.wasOver||!1,node.store.observer=node.store.observer||scene.onPointerObservable.add(function(ev){node.store.wasOver=checkPointerEvent(0,target,scene,ev,babylonjs_1.PointerEventTypes.POINTERMOVE)}),node.store.wasOver&&node.triggerSlot(0)},outputs:[{name:"Over",type:litegraph_js_1.LiteGraph.EVENT}],onStop:function(node,target,scene){node.store.observer&&scene.onPointerObservable.remove(node.store.observer)}},object),graph_node_1.registerNode({name:"Pointer Out",description:"Triggers on the pointer is out of the node.",path:"events/pointerout",ctor:babylonjs_1.AbstractMesh,functionRef:function(node,target,scene){node.store.wasOver=node.store.wasOver||!1,node.store.observer=node.store.observer||scene.onPointerObservable.add(function(ev){var isOver=node.store.wasOver;node.store.wasOver=checkPointerEvent(0,target,scene,ev,babylonjs_1.PointerEventTypes.POINTERMOVE),isOver&&!node.store.wasOver&&node.triggerSlot(0)})},outputs:[{name:"Out",type:litegraph_js_1.LiteGraph.EVENT}],onStop:function(node,target,scene){node.store.observer&&scene.onPointerObservable.remove(node.store.observer)}},object)}}),$__System.registerDynamic("1c",["c","14","10"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),litegraph_js_1=$__require("14"),graph_node_1=$__require("10");exports.registerAllKeyboardNodes=function(object){var checkKeyboardEvent=function(node,target,ev,type){if(ev.type===type){var hasControl=ev.event.ctrlKey||ev.event.metaKey,isKey=ev.event.key.toLowerCase()===node.properties.Key.toLowerCase();return isKey&&!node.properties["Check Control"]||isKey&&node.properties["Check Control"]&&hasControl}};graph_node_1.registerNode({name:"Keyboard Down",description:"Triggers on a keyboard key is down",path:"events/keyboarddown",ctor:babylonjs_1.Node,functionRef:function(node,target,scene){node.store.wasDown=node.store.wasDown||!1,node.store.observer=node.store.observer||scene.onKeyboardObservable.add(function(ev){node.store.wasDown=checkKeyboardEvent(node,0,ev,babylonjs_1.KeyboardEventTypes.KEYDOWN)}),node.store.wasDown&&node.triggerSlot(0)},outputs:[{name:"Key Down",type:litegraph_js_1.LiteGraph.EVENT}],properties:[{name:"Key",type:"string",defaultValue:"a"},{name:"Check Control",type:"boolean",defaultValue:!1}],onStop:function(node,target,scene){node.store.observer&&scene.onPointerObservable.remove(node.store.observer)},drawBackground:function(node){return node.properties.Key}},object),graph_node_1.registerNode({name:"Keyboard Up",description:"Triggers on a keyboard key is up",path:"events/keyboardup",ctor:babylonjs_1.Node,functionRef:function(node,target,scene){node.store.observer=node.store.observer||scene.onKeyboardObservable.add(function(ev){checkKeyboardEvent(node,0,ev,babylonjs_1.KeyboardEventTypes.KEYUP)&&node.triggerSlot(0)})},outputs:[{name:"Key Up",type:litegraph_js_1.LiteGraph.EVENT}],properties:[{name:"Key",type:"string",defaultValue:"a"},{name:"Check Control",type:"boolean",defaultValue:!1}],onStop:function(node,target,scene){node.store.observer&&scene.onPointerObservable.remove(node.store.observer)}},object)}}),$__System.registerDynamic("1d",["c","14","10"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),litegraph_js_1=$__require("14"),graph_node_1=$__require("10");exports.registerAllAbstractMeshNodes=function(object){graph_node_1.registerNode({name:"Get Mesh Direction",description:"Returns the current direction of the node.",path:"node/getdirection",ctor:babylonjs_1.AbstractMesh,functionRef:"getDirection",inputs:[{name:"localAxis",type:"vec3"}],outputs:[{name:"vec3",type:"vec3"}],parameters:[{inputName:"localAxis",type:"vec3"}]},object),graph_node_1.registerNode({name:"Set Mesh Direction",description:"Sets the current direction of the node.",path:"node/setdirection",ctor:babylonjs_1.AbstractMesh,functionRef:"setDirection",inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"localAxis",type:"vec3"}],parameters:[{inputName:"localAxis",type:"vec3"}]},object)}}),$__System.registerDynamic("1e",["c","14","10"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),litegraph_js_1=$__require("14"),graph_node_1=$__require("10");exports.registerAllAnimationNodes=function(object){graph_node_1.registerNode({name:"Play Animations",description:"Plays the animations of the current node.",path:"animation/play",ctor:babylonjs_1.Node,functionRef:function(node,target,scene){node.store.playing||(node.store.playing=!0,scene.beginAnimation(target,node.properties.From,node.properties.To,node.properties.Loop,node.properties.Speed,function(){node.triggerSlot(0),node.store.playing=!1},null,null,null,function(){return node.triggerSlot(1)}))},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT}],properties:[{name:"Target Path",type:"string",defaultValue:"Self"},{name:"From",type:"number",defaultValue:0},{name:"To",type:"number",defaultValue:60},{name:"Speed",type:"number",defaultValue:1},{name:"Loop",type:"boolean",defaultValue:!1}],outputs:[{name:"On End",type:litegraph_js_1.LiteGraph.EVENT},{name:"On Loop",type:litegraph_js_1.LiteGraph.EVENT}],widgets:[{type:"number",name:"From",value:0,callback:function(v,g,n){return n.properties.From=v}},{type:"number",name:"To",value:60,callback:function(v,g,n){return n.properties.To=v}},{type:"number",name:"Speed",value:0,callback:function(v,g,n){return n.properties.Speed=v}},{type:"toggle",name:"Loop",value:!1,callback:function(v,g,n){return n.properties.Loop=v}}],drawBackground:function(node,target){return target}},object),graph_node_1.registerNode({name:"Stop Animations",description:"Stops the currently playing animations of the current node.",path:"animation/stop",ctor:babylonjs_1.Node,functionRef:function(node,target,scene){scene.stopAnimation(target)},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT}],properties:[{name:"Target Path",type:"string",defaultValue:"Self"}],drawBackground:function(node,target){return target}},object),graph_node_1.registerNode({name:"Interpolate Value",description:"Interpolates the ",path:"animation/interpolatevalue",ctor:babylonjs_1.Node,functionRef:function(node,target,scene){if(!node.store.playing){node.store.playing=!0;var targetValue=graph_node_1.GraphNode.nodeToOutput(node.getInputData(1));if(void 0!==targetValue){var propertyPath=node.properties["Property Path"],property=graph_node_1.GraphNode.GetProperty(target,propertyPath),ctor1=graph_node_1.GraphNode.GetConstructorName(property).toLowerCase(),ctor2=graph_node_1.GraphNode.GetConstructorName(targetValue).toLowerCase();if(ctor1===ctor2){var animationType=babylonjs_1.Animation.ANIMATIONTYPE_FLOAT;switch(ctor1){case"vector2":animationType=babylonjs_1.Animation.ANIMATIONTYPE_VECTOR2;break;case"vector3":animationType=babylonjs_1.Animation.ANIMATIONTYPE_VECTOR3;break;case"color3":animationType=babylonjs_1.Animation.ANIMATIONTYPE_COLOR3}var animation=new babylonjs_1.Animation(propertyPath,propertyPath,60,animationType,babylonjs_1.Animation.ANIMATIONLOOPMODE_CONSTANT,!1);animation.setKeys([{frame:0,value:property.clone?property.clone():property},{frame:60*node.properties["Duration (seconds)"],value:targetValue}]),scene.stopAnimation(target),scene.beginDirectAnimation(target,[animation],0,60,!1,node.properties.Speed,function(){return node.store.playing=!1})}else console.warn('Cannot interpolate values of two different types. property: "'+ctor1+'", target value: "'+ctor2+'"')}}},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Target Value",type:"number,vec2,vec3,col3"}],properties:[{name:"Target Path",type:"string",defaultValue:"Self"},{name:"Property Path",type:"string",defaultValue:"name"},{name:"Speed",type:"number",defaultValue:1},{name:"Duration (seconds)",type:"number",defaultValue:1}],outputs:[{name:"Current Value",type:"number,vec2,vec3,vec4,col3,col4"}],widgets:[{type:"number",name:"Speed",value:1,callback:function(v,g,n){return n.properties.Speed=v}},{type:"number",name:"Duration (seconds)",value:1,callback:function(v,g,n){return n.properties["Duration (seconds)"]=v}}],drawBackground:function(node,target){return target+"'s "+node.properties["Property Path"]}},object)}}),$__System.registerDynamic("1f",["14","10"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var litegraph_js_1=$__require("14"),graph_node_1=$__require("10");exports.registerAllSoundNodes=function(object){var getSound=function(node,scene){var input=node.getInputData(1);return scene.getSoundByName(input||node.properties["Sound Name"])};graph_node_1.registerNode({name:"Play Sound",description:"Plays the given sound",path:"sound/play",ctor:Object,functionRef:function(node,target,scene){var sound=getSound(node,scene);sound&&(sound.loop=node.properties.Loop,sound.play())},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Sound Name",type:"string"}],properties:[{name:"Sound Name",type:"string",defaultValue:"None"},{name:"Loop",type:"boolean",defaultValue:!1}],widgets:[{type:"toggle",name:"Loop",value:!1,callback:function(v,g,n){return n.properties.Loop=v},options:{onInstanciate:function(n,w){w.value=n.properties.Loop}}}],drawBackground:function(node){return node.properties["Sound Name"]}},object),graph_node_1.registerNode({name:"Pause Sound",description:"Pauses the given sound",path:"sound/pause",ctor:Object,functionRef:function(node,target,scene){var sound=getSound(node,scene);sound&&sound.pause()},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Sound Name",type:"string"}],properties:[{name:"Sound Name",type:"string",defaultValue:"None"}],drawBackground:function(node){return node.properties["Sound Name"]}},object),graph_node_1.registerNode({name:"Stop Sound",description:"Stops the given sound",path:"sound/stop",ctor:Object,functionRef:function(node,target,scene){var sound=getSound(node,scene);sound&&sound.stop()},inputs:[{name:"Execute",type:litegraph_js_1.LiteGraph.EVENT},{name:"Sound Name",type:"string"}],properties:[{name:"Sound Name",type:"string",defaultValue:"None"}],drawBackground:function(node){return node.properties["Sound Name"]}},object)}}),$__System.registerDynamic("14",[],!0,function($__require,exports,module){this||self;!function(global){var LiteGraph=global.LiteGraph={CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:20,NODE_SLOT_HEIGHT:15,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#444",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,LINK_COLOR:"#AAD",EVENT_LINK_COLOR:"#F85",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,proxy:null,node_images_path:"",debug:!1,throw_errors:!0,allow_scripts:!1,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},searchbox_extras:{},registerNodeType:function(type,base_class){if(!base_class.prototype)throw"Cannot register a simple object, it must be a class with a prototype";base_class.type=type,LiteGraph.debug&&console.log("Node registered: "+type);type.split("/");var classname=base_class.name,pos=type.lastIndexOf("/");if(base_class.category=type.substr(0,pos),base_class.title||(base_class.title=classname),base_class.prototype)for(var i in LGraphNode.prototype)base_class.prototype[i]||(base_class.prototype[i]=LGraphNode.prototype[i]);if(Object.defineProperty(base_class.prototype,"shape",{set:function(v){switch(v){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=v}},get:function(v){return this._shape},enumerable:!0}),this.registered_node_types[type]=base_class,base_class.constructor.name&&(this.Nodes[classname]=base_class),base_class.prototype.onPropertyChange&&console.warn("LiteGraph node class "+type+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),base_class.supported_extensions)for(var i in base_class.supported_extensions)this.node_types_by_file_extension[base_class.supported_extensions[i].toLowerCase()]=base_class},wrapFunctionAsNode:function(name,func,param_types,return_type){for(var params=Array(func.length),code="",names=LiteGraph.getParameterNames(func),i=0;i<names.length;++i)code+="this.addInput('"+names[i]+"',"+(param_types&&param_types[i]?"'"+param_types[i]+"'":"0")+");\n";code+="this.addOutput('out',"+(return_type?"'"+return_type+"'":0)+");\n";var classobj=Function(code);classobj.title=name.split("/").pop(),classobj.desc="Generated from "+func.name,classobj.prototype.onExecute=function(){for(var i=0;i<params.length;++i)params[i]=this.getInputData(i);var r=func.apply(this,params);this.setOutputData(0,r)},this.registerNodeType(name,classobj)},addNodeMethod:function(name,func){for(var i in LGraphNode.prototype[name]=func,this.registered_node_types){var type=this.registered_node_types[i];type.prototype[name]&&(type.prototype["_"+name]=type.prototype[name]),type.prototype[name]=func}},createNode:function(type,title,options){var base_class=this.registered_node_types[type];if(!base_class)return LiteGraph.debug&&console.log('GraphNode type "'+type+'" not registered.'),null;base_class.prototype;var node=new base_class(title=title||base_class.title||type);if(node.type=type,!node.title&&title&&(node.title=title),node.properties||(node.properties={}),node.properties_info||(node.properties_info=[]),node.flags||(node.flags={}),node.size||(node.size=node.computeSize()),node.pos||(node.pos=LiteGraph.DEFAULT_POSITION.concat()),node.mode||(node.mode=LiteGraph.ALWAYS),options)for(var i in options)node[i]=options[i];return node},getNodeType:function(type){return this.registered_node_types[type]},getNodeTypesInCategory:function(category,filter){var r=[];for(var i in this.registered_node_types){var type=this.registered_node_types[i];filter&&type.filter&&type.filter!=filter||(""==category?null==type.category&&r.push(type):type.category==category&&r.push(type))}return r},getNodeTypesCategories:function(){var categories={"":1};for(var i in this.registered_node_types)this.registered_node_types[i].category&&!this.registered_node_types[i].skip_list&&(categories[this.registered_node_types[i].category]=1);var result=[];for(var i in categories)result.push(i);return result},reloadNodes:function(folder_wildcard){var tmp=document.getElementsByTagName("script"),script_files=[];for(var i in tmp)script_files.push(tmp[i]);var docHeadObj=document.getElementsByTagName("head")[0];for(var i in folder_wildcard=document.location.href+folder_wildcard,script_files){var src=script_files[i].src;if(src&&src.substr(0,folder_wildcard.length)==folder_wildcard)try{LiteGraph.debug&&console.log("Reloading: "+src);var dynamicScript=document.createElement("script");dynamicScript.type="text/javascript",dynamicScript.src=src,docHeadObj.appendChild(dynamicScript),docHeadObj.removeChild(script_files[i])}catch(err){if(LiteGraph.throw_errors)throw err;LiteGraph.debug&&console.log("Error while reloading "+src)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(obj,target){if(null==obj)return null;var r=JSON.parse(JSON.stringify(obj));if(!target)return r;for(var i in r)target[i]=r[i];return target},isValidConnection:function(type_a,type_b){if(!type_a||!type_b||type_a==type_b||type_a==LiteGraph.EVENT&&type_b==LiteGraph.ACTION)return!0;if(type_a=String(type_a),type_b=String(type_b),type_a=type_a.toLowerCase(),type_b=type_b.toLowerCase(),-1==type_a.indexOf(",")&&-1==type_b.indexOf(","))return type_a==type_b;for(var supported_types_a=type_a.split(","),supported_types_b=type_b.split(","),i=0;i<supported_types_a.length;++i)for(var j=0;j<supported_types_b.length;++j)if(supported_types_a[i]==supported_types_b[j])return!0;return!1},registerSearchboxExtra:function(node_type,description,data){this.searchbox_extras[description]={type:node_type,desc:description,data:data}}};function LGraph(o){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),o&&this.configure(o)}function LGraphNode(title){this._ctor(title)}function LGraphGroup(title){this._ctor(title)}function LGraphCanvas(canvas,graph,options){options=options||{},this.background_image="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",canvas&&canvas.constructor===String&&(canvas=document.querySelector(canvas)),this.max_zoom=10,this.min_zoom=.1,this.zoom_modify_alpha=!0,this.title_text_font="bold "+LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#AAB",input_on:"#7F7",output_off:"#AAB",output_on:"#7F7"},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.render_shadows=!0,this.clear_background=!0,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.allow_searchbox=!0,this.allow_reconnect_links=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.always_render_background=!1,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!0,this.render_connection_arrows=!0,this.render_execution_order=!1,this.canvas_mouse=[0,0],this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.last_mouse_position=[0,0],this.visible_area=new Float32Array(4),graph&&graph.attachCanvas(this),this.setCanvas(canvas),this.clear(),options.skip_render||this.startRendering(),this.autoresize=options.autoresize}"undefined"!=typeof performance?LiteGraph.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?LiteGraph.getTime=Date.now.bind(Date):"undefined"!=typeof process?LiteGraph.getTime=function(){var t=process.hrtime();return.001*t[0]+1e-6*t[1]}:LiteGraph.getTime=function(){return(new Date).getTime()},global.LGraph=LiteGraph.LGraph=LGraph,LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=1,this.last_link_id=1,this._version=-1,this._nodes)for(var i=0;i<this._nodes.length;++i){var node=this._nodes[i];node.onRemoved&&node.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.global_inputs={},this.global_outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(graphcanvas){if(graphcanvas.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";graphcanvas.graph&&graphcanvas.graph!=this&&graphcanvas.graph.detachCanvas(graphcanvas),graphcanvas.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(graphcanvas)},LGraph.prototype.detachCanvas=function(graphcanvas){if(this.list_of_graphcanvas){var pos=this.list_of_graphcanvas.indexOf(graphcanvas);-1!=pos&&(graphcanvas.graph=null,this.list_of_graphcanvas.splice(pos,1))}},LGraph.prototype.start=function(interval){if(this.status!=LGraph.STATUS_RUNNING){this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime;var that=this;if(0==(interval=interval||0)&&"undefined"!=typeof window&&window.requestAnimationFrame){this.execution_timer_id=-1,function on_frame(){-1==that.execution_timer_id&&(window.requestAnimationFrame(on_frame),that.runStep(1,!this.catch_errors))}()}else this.execution_timer_id=setInterval(function(){that.runStep(1,!this.catch_errors)},interval)}},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(num,do_not_catch_errors){num=num||1;var start=LiteGraph.getTime();this.globaltime=.001*(start-this.starttime);var nodes=this._nodes_executable?this._nodes_executable:this._nodes;if(nodes){if(do_not_catch_errors){for(var i=0;i<num;i++){for(var j=0,l=nodes.length;j<l;++j){(node=nodes[j]).mode==LiteGraph.ALWAYS&&node.onExecute&&node.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(i=0;i<num;i++){for(j=0,l=nodes.length;j<l;++j){var node;(node=nodes[j]).mode==LiteGraph.ALWAYS&&node.onExecute&&node.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(err){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw err;LiteGraph.debug&&console.log("Error during execution: "+err),this.stop()}var now=LiteGraph.getTime(),elapsed=now-start;0==elapsed&&(elapsed=1),this.execution_time=.001*elapsed,this.globaltime+=.001*elapsed,this.iteration+=1,this.elapsed_time=.001*(now-this.last_update_time),this.last_update_time=now}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var i=0;i<this._nodes_in_order.length;++i)this._nodes_in_order[i].onExecute&&this._nodes_executable.push(this._nodes_in_order[i])},LGraph.prototype.computeExecutionOrder=function(only_onExecute,set_level){for(var L=[],S=[],M={},visited_links={},remaining_links={},i=0,l=this._nodes.length;i<l;++i){var node=this._nodes[i];if(!only_onExecute||node.onExecute){M[node.id]=node;var num=0;if(node.inputs)for(var j=0,l2=node.inputs.length;j<l2;j++)node.inputs[j]&&null!=node.inputs[j].link&&(num+=1);0==num?(S.push(node),set_level&&(node._level=1)):(set_level&&(node._level=0),remaining_links[node.id]=num)}}for(;0!=S.length;){node=S.shift();if(L.push(node),delete M[node.id],node.outputs)for(i=0;i<node.outputs.length;i++){var output=node.outputs[i];if(null!=output&&null!=output.links&&0!=output.links.length)for(j=0;j<output.links.length;j++){var link_id=output.links[j],link=this.links[link_id];if(link&&!visited_links[link.id]){var target_node=this.getNodeById(link.target_id);null!=target_node?(set_level&&(!target_node._level||target_node._level<=node._level)&&(target_node._level=node._level+1),visited_links[link.id]=!0,remaining_links[target_node.id]-=1,0==remaining_links[target_node.id]&&S.push(target_node)):visited_links[link.id]=!0}}}}for(var i in M)L.push(M[i]);L.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");for(l=L.length,i=0;i<l;++i)L[i].order=i;L=L.sort(function(A,B){var Ap=A.constructor.priority||A.priority||0,Bp=B.constructor.priority||B.priority||0;return Ap==Bp?A.order-B.order:Ap-Bp});for(i=0;i<l;++i)L[i].order=i;return L},LGraph.prototype.getAncestors=function(node){for(var ancestors=[],pending=[node],visited={};pending.length;){var current=pending.shift();if(current.inputs){visited[current.id]||current==node||(visited[current.id]=!0,ancestors.push(current));for(var i=0;i<current.inputs.length;++i){var input=current.getInputNode(i);input&&-1==ancestors.indexOf(input)&&pending.push(input)}}}return ancestors.sort(function(a,b){return a.order-b.order}),ancestors},LGraph.prototype.arrange=function(margin){margin=margin||40;for(var nodes=this.computeExecutionOrder(!1,!0),columns=[],i=0;i<nodes.length;++i){var col=(node=nodes[i])._level||1;columns[col]||(columns[col]=[]),columns[col].push(node)}var x=margin;for(i=0;i<columns.length;++i){var column=columns[i];if(column){for(var max_size=100,y=margin,j=0;j<column.length;++j){var node;(node=column[j]).pos[0]=x,node.pos[1]=y,node.size[0]>max_size&&(max_size=node.size[0]),y+=node.size[1]+margin}x+=max_size+margin}}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(eventname,params,mode){mode=mode||LiteGraph.ALWAYS;var nodes=this._nodes_in_order?this._nodes_in_order:this._nodes;if(nodes)for(var j=0,l=nodes.length;j<l;++j){var node=nodes[j];node[eventname]&&node.mode==mode&&(void 0===params?node[eventname]():params&&params.constructor===Array?node[eventname].apply(node,params):node[eventname](params))}},LGraph.prototype.sendActionToCanvas=function(action,params){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i){var c=this.list_of_graphcanvas[i];c[action]&&c[action].apply(c,params)}},LGraph.prototype.add=function(node,skip_compute_order){if(node){if(node.constructor===LGraphGroup)return this._groups.push(node),this.setDirtyCanvas(!0),this.change(),node.graph=this,void this._version++;if(-1!=node.id&&null!=this._nodes_by_id[node.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),node.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return null==node.id||-1==node.id?node.id=++this.last_node_id:this.last_node_id<node.id&&(this.last_node_id=node.id),node.graph=this,this._version++,this._nodes.push(node),this._nodes_by_id[node.id]=node,node.onAdded&&node.onAdded(this),this.config.align_to_grid&&node.alignToGrid(),skip_compute_order||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(node),this.setDirtyCanvas(!0),this.change(),node}},LGraph.prototype.remove=function(node){if(node.constructor===LiteGraph.LGraphGroup){var index=this._groups.indexOf(node);return-1!=index&&this._groups.splice(index,1),node.graph=null,this._version++,this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[node.id]&&!node.ignore_remove){if(node.inputs)for(var i=0;i<node.inputs.length;i++){null!=(slot=node.inputs[i]).link&&node.disconnectInput(i)}if(node.outputs)for(i=0;i<node.outputs.length;i++){var slot;null!=(slot=node.outputs[i]).links&&slot.links.length&&node.disconnectOutput(i)}if(node.onRemoved&&node.onRemoved(),node.graph=null,this._version++,this.list_of_graphcanvas)for(i=0;i<this.list_of_graphcanvas.length;++i){var canvas=this.list_of_graphcanvas[i];canvas.selected_nodes[node.id]&&delete canvas.selected_nodes[node.id],canvas.node_dragged==node&&(canvas.node_dragged=null)}var pos=this._nodes.indexOf(node);-1!=pos&&this._nodes.splice(pos,1),delete this._nodes_by_id[node.id],this.onNodeRemoved&&this.onNodeRemoved(node),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(id){return null==id?null:this._nodes_by_id[id]},LGraph.prototype.findNodesByClass=function(classObject){for(var r=[],i=0,l=this._nodes.length;i<l;++i)this._nodes[i].constructor===classObject&&r.push(this._nodes[i]);return r},LGraph.prototype.findNodesByType=function(type){type=type.toLowerCase();for(var r=[],i=0,l=this._nodes.length;i<l;++i)this._nodes[i].type.toLowerCase()==type&&r.push(this._nodes[i]);return r},LGraph.prototype.findNodesByTitle=function(title){for(var result=[],i=0,l=this._nodes.length;i<l;++i)this._nodes[i].title==title&&result.push(this._nodes[i]);return result},LGraph.prototype.getNodeOnPos=function(x,y,nodes_list,margin){for(var i=(nodes_list=nodes_list||this._nodes).length-1;i>=0;i--){var n=nodes_list[i];if(n.isPointInside(x,y,margin))return n}return null},LGraph.prototype.getGroupOnPos=function(x,y){for(var i=this._groups.length-1;i>=0;i--){var g=this._groups[i];if(g.isPointInside(x,y,2,!0))return g}return null},LGraph.prototype.addGlobalInput=function(name,type,value){this.global_inputs[name]={name:name,type:type,value:value},this._version++,this.onGlobalInputAdded&&this.onGlobalInputAdded(name,type),this.onGlobalsChange&&this.onGlobalsChange()},LGraph.prototype.setGlobalInputData=function(name,data){var input=this.global_inputs[name];input&&(input.value=data)},LGraph.prototype.setInputData=LGraph.prototype.setGlobalInputData,LGraph.prototype.getGlobalInputData=function(name){var input=this.global_inputs[name];return input?input.value:null},LGraph.prototype.renameGlobalInput=function(old_name,name){if(name!=old_name){if(!this.global_inputs[old_name])return!1;if(this.global_inputs[name])return console.error("there is already one input with that name"),!1;this.global_inputs[name]=this.global_inputs[old_name],delete this.global_inputs[old_name],this._version++,this.onGlobalInputRenamed&&this.onGlobalInputRenamed(old_name,name),this.onGlobalsChange&&this.onGlobalsChange()}},LGraph.prototype.changeGlobalInputType=function(name,type){if(!this.global_inputs[name])return!1;this.global_inputs[name].type&&this.global_inputs[name].type.toLowerCase()==type.toLowerCase()||(this.global_inputs[name].type=type,this._version++,this.onGlobalInputTypeChanged&&this.onGlobalInputTypeChanged(name,type))},LGraph.prototype.removeGlobalInput=function(name){return!!this.global_inputs[name]&&(delete this.global_inputs[name],this._version++,this.onGlobalInputRemoved&&this.onGlobalInputRemoved(name),this.onGlobalsChange&&this.onGlobalsChange(),!0)},LGraph.prototype.addGlobalOutput=function(name,type,value){this.global_outputs[name]={name:name,type:type,value:value},this._version++,this.onGlobalOutputAdded&&this.onGlobalOutputAdded(name,type),this.onGlobalsChange&&this.onGlobalsChange()},LGraph.prototype.setGlobalOutputData=function(name,value){var output=this.global_outputs[name];output&&(output.value=value)},LGraph.prototype.getGlobalOutputData=function(name){var output=this.global_outputs[name];return output?output.value:null},LGraph.prototype.getOutputData=LGraph.prototype.getGlobalOutputData,LGraph.prototype.renameGlobalOutput=function(old_name,name){return!!this.global_outputs[old_name]&&(this.global_outputs[name]?(console.error("there is already one output with that name"),!1):(this.global_outputs[name]=this.global_outputs[old_name],delete this.global_outputs[old_name],this._version++,this.onGlobalOutputRenamed&&this.onGlobalOutputRenamed(old_name,name),void(this.onGlobalsChange&&this.onGlobalsChange())))},LGraph.prototype.changeGlobalOutputType=function(name,type){if(!this.global_outputs[name])return!1;this.global_outputs[name].type&&this.global_outputs[name].type.toLowerCase()==type.toLowerCase()||(this.global_outputs[name].type=type,this._version++,this.onGlobalOutputTypeChanged&&this.onGlobalOutputTypeChanged(name,type))},LGraph.prototype.removeGlobalOutput=function(name){return!!this.global_outputs[name]&&(delete this.global_outputs[name],this._version++,this.onGlobalOutputRemoved&&this.onGlobalOutputRemoved(name),this.onGlobalsChange&&this.onGlobalsChange(),!0)},LGraph.prototype.triggerInput=function(name,value){for(var nodes=this.findNodesByTitle(name),i=0;i<nodes.length;++i)nodes[i].onTrigger(value)},LGraph.prototype.setCallback=function(name,func){for(var nodes=this.findNodesByTitle(name),i=0;i<nodes.length;++i)nodes[i].setTrigger(func)},LGraph.prototype.connectionChange=function(node,link_info){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(node),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var i=0;i<this.list_of_graphcanvas.length;++i){if(this.list_of_graphcanvas[i].live_mode)return!0}return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var i in this.links){var link_info=this.links[i];link_info&&(link_info._last_time&&(link_info._last_time=0))}},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(fg,bg){this.sendActionToCanvas("setDirty",[fg,bg])},LGraph.prototype.serialize=function(){for(var nodes_info=[],i=0,l=this._nodes.length;i<l;++i)nodes_info.push(this._nodes[i].serialize());var links=[];for(var i in this.links){var link=this.links[i];links.push([link.id,link.origin_id,link.origin_slot,link.target_id,link.target_slot,link.type])}var groups_info=[];for(i=0;i<this._groups.length;++i)groups_info.push(this._groups[i].serialize());return{last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:nodes_info,links:links,groups:groups_info,config:this.config}},LGraph.prototype.configure=function(data,keep_old){if(data){keep_old||this.clear();var nodes=data.nodes;if(data.links&&data.links.constructor===Array){for(var links=[],i=0;i<data.links.length;++i){var link=data.links[i];links[link[0]]={id:link[0],origin_id:link[1],origin_slot:link[2],target_id:link[3],target_slot:link[4],type:link[5]}}data.links=links}for(var i in data)this[i]=data[i];var error=!1;if(this._nodes=[],nodes){i=0;for(var l=nodes.length;i<l;++i){var n_info=nodes[i];(node=LiteGraph.createNode(n_info.type,n_info.title))?(node.id=n_info.id,this.add(node,!0)):(LiteGraph.debug&&console.log("Node not found: "+n_info.type),error=!0)}for(i=0,l=nodes.length;i<l;++i){var node;n_info=nodes[i];(node=this.getNodeById(n_info.id))&&node.configure(n_info)}}if(this._groups.length=0,data.groups)for(i=0;i<data.groups.length;++i){var group=new LiteGraph.LGraphGroup;group.configure(data.groups[i]),this.add(group)}return this.updateExecutionOrder(),this._version++,this.setDirtyCanvas(!0,!0),error}},LGraph.prototype.load=function(url){var that=this,req=new XMLHttpRequest;req.open("GET",url,!0),req.send(null),req.onload=function(oEvent){if(200===req.status){var data=JSON.parse(req.response);that.configure(data)}else console.error("Error loading graph:",req.status,req.response)},req.onerror=function(err){console.error("Error loading graph:",err)}},LGraph.prototype.onNodeTrace=function(node,msg,color){},global.LGraphNode=LiteGraph.LGraphNode=LGraphNode,LGraphNode.prototype._ctor=function(title){this.title=title||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(v){!v||v.length<2||(this._pos[0]=v[0],this._pos[1]=v[1])},get:function(){return this._pos},enumerable:!0}),this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(info){for(var j in this.graph&&this.graph._version++,info)if("console"!=j)if("properties"!=j)null!=info[j]&&("object"==typeof info[j]?this[j]&&this[j].configure?this[j].configure(info[j]):this[j]=LiteGraph.cloneObject(info[j],this[j]):this[j]=info[j]);else for(var k in info.properties)this.properties[k]=info.properties[k],this.onPropertyChanged&&this.onPropertyChanged(k,info.properties[k]);if(info.title||(this.title=this.constructor.title),this.onConnectionsChange){if(this.inputs)for(var i=0;i<this.inputs.length;++i){var input=this.inputs[i],link_info=this.graph?this.graph.links[input.link]:null;this.onConnectionsChange(LiteGraph.INPUT,i,!0,link_info,input)}if(this.outputs)for(i=0;i<this.outputs.length;++i){if((output=this.outputs[i]).links)for(j=0;j<output.links.length;++j){link_info=this.graph?this.graph.links[output.links[j]]:null;this.onConnectionsChange(LiteGraph.OUTPUT,i,!0,link_info,output)}}}for(var i in this.inputs){if((input=this.inputs[i]).link&&input.link.length)"object"==typeof(link=input.link)&&(input.link=link[0],this.graph&&(this.graph.links[link[0]]={id:link[0],origin_id:link[1],origin_slot:link[2],target_id:link[3],target_slot:link[4]}))}for(var i in this.outputs){var output;if((output=this.outputs[i]).links&&0!=output.links.length)for(var j in output.links){var link;"object"==typeof(link=output.links[j])&&(output.links[j]=link[0])}}this.onConfigure&&this.onConfigure(info)},LGraphNode.prototype.serialize=function(){var o={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),mode:this.mode};if(this.inputs&&(o.inputs=this.inputs),this.outputs){for(var i=0;i<this.outputs.length;i++)delete this.outputs[i]._data;o.outputs=this.outputs}return this.title&&this.title!=this.constructor.title&&(o.title=this.title),this.properties&&(o.properties=LiteGraph.cloneObject(this.properties)),o.type||(o.type=this.constructor.type),this.color&&(o.color=this.color),this.bgcolor&&(o.bgcolor=this.bgcolor),this.boxcolor&&(o.boxcolor=this.boxcolor),this.shape&&(o.shape=this.shape),this.onSerialize&&this.onSerialize(o)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),o},LGraphNode.prototype.clone=function(){var node=LiteGraph.createNode(this.type),data=LiteGraph.cloneObject(this.serialize());if(data.inputs)for(var i=0;i<data.inputs.length;++i)data.inputs[i].link=null;if(data.outputs)for(i=0;i<data.outputs.length;++i)data.outputs[i].links&&(data.outputs[i].links.length=0);return delete data.id,node.configure(data),node},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setOutputData=function(slot,data){if(this.outputs&&!(-1==slot||slot>=this.outputs.length)){var output_info=this.outputs[slot];if(output_info&&(output_info._data=data,this.outputs[slot].links))for(var i=0;i<this.outputs[slot].links.length;i++){var link_id=this.outputs[slot].links[i];this.graph.links[link_id].data=data}}},LGraphNode.prototype.getInputData=function(slot,force_update){if(this.inputs&&!(slot>=this.inputs.length||null==this.inputs[slot].link)){var link_id=this.inputs[slot].link,link=this.graph.links[link_id];if(!link)return null;if(!force_update)return link.data;var node=this.graph.getNodeById(link.origin_id);return node?(node.updateOutputData?node.updateOutputData(link.origin_slot):node.onExecute&&node.onExecute(),link.data):link.data}},LGraphNode.prototype.getInputDataByName=function(slot_name,force_update){var slot=this.findInputSlot(slot_name);return-1==slot?null:this.getInputData(slot,force_update)},LGraphNode.prototype.isInputConnected=function(slot){return!!this.inputs&&(slot<this.inputs.length&&null!=this.inputs[slot].link)},LGraphNode.prototype.getInputInfo=function(slot){return this.inputs&&slot<this.inputs.length?this.inputs[slot]:null},LGraphNode.prototype.getInputNode=function(slot){if(!this.inputs)return null;if(slot>=this.inputs.length)return null;var input=this.inputs[slot];if(!input||null===input.link)return null;var link_info=this.graph.links[input.link];return link_info?this.graph.getNodeById(link_info.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(name){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[name]:null;for(var i=0,l=this.inputs.length;i<l;++i)if(name==this.inputs[i].name){var link_id=this.inputs[i].link,link=this.graph.links[link_id];return link?link.data:null}return this.properties[name]},LGraphNode.prototype.getOutputData=function(slot){return this.outputs?slot>=this.outputs.length?null:this.outputs[slot]._data:null},LGraphNode.prototype.getOutputInfo=function(slot){return this.outputs&&slot<this.outputs.length?this.outputs[slot]:null},LGraphNode.prototype.isOutputConnected=function(slot){return!!this.outputs&&(slot<this.outputs.length&&this.outputs[slot].links&&this.outputs[slot].links.length)},LGraphNode.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var i=0;i<this.outputs.length;++i)if(this.outputs[i].links&&this.outputs[i].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(slot){if(!this.outputs||0==this.outputs.length)return null;if(slot>=this.outputs.length)return null;var output=this.outputs[slot];if(!output.links||0==output.links.length)return null;for(var r=[],i=0;i<output.links.length;i++){var link_id=output.links[i],link=this.graph.links[link_id];if(link){var target_node=this.graph.getNodeById(link.target_id);target_node&&r.push(target_node)}}return r},LGraphNode.prototype.trigger=function(action,param){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var i=0;i<this.outputs.length;++i){var output=this.outputs[i];!output||output.type!==LiteGraph.EVENT||action&&output.name!=action||this.triggerSlot(i,param)}}},LGraphNode.prototype.triggerSlot=function(slot,param,link_id){if(this.outputs){var output=this.outputs[slot];if(output){var links=output.links;if(links&&links.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var k=0;k<links.length;++k){var id=links[k];if(null==link_id||link_id==id){var link_info=this.graph.links[links[k]];if(link_info){link_info._last_time=LiteGraph.getTime();var node=this.graph.getNodeById(link_info.target_id);if(node){var target_connection=node.inputs[link_info.target_slot];node.onAction?node.onAction(target_connection.name,param):node.mode===LiteGraph.ON_TRIGGER&&node.onExecute&&node.onExecute(param)}}}}}}}},LGraphNode.prototype.clearTriggeredSlot=function(slot,link_id){if(this.outputs){var output=this.outputs[slot];if(output){var links=output.links;if(links&&links.length)for(var k=0;k<links.length;++k){var id=links[k];if(null==link_id||link_id==id){var link_info=this.graph.links[links[k]];link_info&&(link_info._last_time=0)}}}}},LGraphNode.prototype.addProperty=function(name,default_value,type,extra_info){var o={name:name,type:type,default_value:default_value};if(extra_info)for(var i in extra_info)o[i]=extra_info[i];return this.properties_info||(this.properties_info=[]),this.properties_info.push(o),this.properties||(this.properties={}),this.properties[name]=default_value,o},LGraphNode.prototype.addOutput=function(name,type,extra_info){var o={name:name,type:type,links:null};if(extra_info)for(var i in extra_info)o[i]=extra_info[i];return this.outputs||(this.outputs=[]),this.outputs.push(o),this.onOutputAdded&&this.onOutputAdded(o),this.size=this.computeSize(),this.setDirtyCanvas(!0,!0),o},LGraphNode.prototype.addOutputs=function(array){for(var i=0;i<array.length;++i){var info=array[i],o={name:info[0],type:info[1],link:null};if(array[2])for(var j in info[2])o[j]=info[2][j];this.outputs||(this.outputs=[]),this.outputs.push(o),this.onOutputAdded&&this.onOutputAdded(o)}this.size=this.computeSize(),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(slot){this.disconnectOutput(slot),this.outputs.splice(slot,1);for(var i=slot;i<this.outputs.length;++i)if(this.outputs[i]&&this.outputs[i].links)for(var links=this.outputs[i].links,j=0;j<links.length;++j){var link=this.graph.links[links[j]];link&&(link.origin_slot-=1)}this.size=this.computeSize(),this.onOutputRemoved&&this.onOutputRemoved(slot),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(name,type,extra_info){var o={name:name,type:type=type||0,link:null};if(extra_info)for(var i in extra_info)o[i]=extra_info[i];return this.inputs||(this.inputs=[]),this.inputs.push(o),this.size=this.computeSize(),this.onInputAdded&&this.onInputAdded(o),this.setDirtyCanvas(!0,!0),o},LGraphNode.prototype.addInputs=function(array){for(var i=0;i<array.length;++i){var info=array[i],o={name:info[0],type:info[1],link:null};if(array[2])for(var j in info[2])o[j]=info[2][j];this.inputs||(this.inputs=[]),this.inputs.push(o),this.onInputAdded&&this.onInputAdded(o)}this.size=this.computeSize(),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(slot){this.disconnectInput(slot),this.inputs.splice(slot,1);for(var i=slot;i<this.inputs.length;++i)if(this.inputs[i]){var link=this.graph.links[this.inputs[i].link];link&&(link.target_slot-=1)}this.size=this.computeSize(),this.onInputRemoved&&this.onInputRemoved(slot),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(name,type,pos,direction){var o={name:name,type:type,pos:pos,direction:direction,links:null};return this.connections.push(o),o},LGraphNode.prototype.computeSize=function(minHeight,out){var rows=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),size=out||new Float32Array([0,0]);rows=Math.max(rows,1);var font_size=LiteGraph.NODE_TEXT_SIZE;size[1]=(this.constructor.slot_start_y||0)+rows*(font_size+1)+4,this.widgets&&this.widgets.length&&(size[1]+=this.widgets.length*(LiteGraph.NODE_WIDGET_HEIGHT+4)+8);font_size=font_size;var title_width=compute_text_size(this.title),input_width=0,output_width=0;if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i){var input=this.inputs[i];input_width<(text_width=compute_text_size(input.label||input.name||""))&&(input_width=text_width)}if(this.outputs)for(i=0,l=this.outputs.length;i<l;++i){var text_width,output=this.outputs[i];output_width<(text_width=compute_text_size(output.label||output.name||""))&&(output_width=text_width)}function compute_text_size(text){return text?font_size*text.length*.6:0}return size[0]=Math.max(input_width+output_width+10,title_width),size[0]=Math.max(size[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(size[0]=Math.max(size[0],1.5*LiteGraph.NODE_WIDTH)),this.onResize&&this.onResize(size),size},LGraphNode.prototype.addWidget=function(type,name,value,callback,options){this.widgets||(this.widgets=[]);var w={type:type.toLowerCase(),name:name,value:value,callback:callback,options:options||{}};if(void 0!==w.options.y&&(w.y=w.options.y),callback||console.warn("LiteGraph addWidget('button',...) without a callback"),"combo"==type&&!w.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(w),w},LGraphNode.prototype.addCustomWidget=function(custom_widget){return this.widgets||(this.widgets=[]),this.widgets.push(custom_widget),custom_widget},LGraphNode.prototype.getBounding=function(out){return(out=out||new Float32Array(4))[0]=this.pos[0]-4,out[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,out[2]=this.size[0]+4,out[3]=this.size[1]+LiteGraph.NODE_TITLE_HEIGHT,this.onBounding&&this.onBounding(out),out},LGraphNode.prototype.isPointInside=function(x,y,margin,skip_title){margin=margin||0;var margin_top=this.graph&&this.graph.isLive()?0:20;if(skip_title&&(margin_top=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(x,y,this.pos[0]-margin,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-margin,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*margin,LiteGraph.NODE_TITLE_HEIGHT+2*margin))return!0}else if(this.pos[0]-4-margin<x&&this.pos[0]+this.size[0]+4+margin>x&&this.pos[1]-margin_top-margin<y&&this.pos[1]+this.size[1]+margin>y)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(x,y){var link_pos=new Float32Array(2);if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i){var input=this.inputs[i];if(this.getConnectionPos(!0,i,link_pos),isInsideRectangle(x,y,link_pos[0]-10,link_pos[1]-5,20,10))return{input:input,slot:i,link_pos:link_pos,locked:input.locked}}if(this.outputs)for(i=0,l=this.outputs.length;i<l;++i){var output=this.outputs[i];if(this.getConnectionPos(!1,i,link_pos),isInsideRectangle(x,y,link_pos[0]-10,link_pos[1]-5,20,10))return{output:output,slot:i,link_pos:link_pos,locked:output.locked}}return null},LGraphNode.prototype.findInputSlot=function(name){if(!this.inputs)return-1;for(var i=0,l=this.inputs.length;i<l;++i)if(name==this.inputs[i].name)return i;return-1},LGraphNode.prototype.findOutputSlot=function(name){if(!this.outputs)return-1;for(var i=0,l=this.outputs.length;i<l;++i)if(name==this.outputs[i].name)return i;return-1},LGraphNode.prototype.connect=function(slot,target_node,target_slot){if(target_slot=target_slot||0,!this.graph)return console.log("Connect: Error, node doesnt belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(slot.constructor===String){if(-1==(slot=this.findOutputSlot(slot)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+slot),null}else if(!this.outputs||slot>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(target_node&&target_node.constructor===Number&&(target_node=this.graph.getNodeById(target_node)),!target_node)throw"target node is null";if(target_node==this)return null;if(target_slot.constructor===String){if(-1==(target_slot=target_node.findInputSlot(target_slot)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+target_slot),null}else{if(target_slot===LiteGraph.EVENT)return null;if(!target_node.inputs||target_slot>=target_node.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null}null!=target_node.inputs[target_slot].link&&target_node.disconnectInput(target_slot);var output=this.outputs[slot];if(target_node.onConnectInput&&!1===target_node.onConnectInput(target_slot,output.type,output))return null;var input=target_node.inputs[target_slot],link_info=null;return LiteGraph.isValidConnection(output.type,input.type)&&(link_info={id:this.graph.last_link_id++,type:input.type,origin_id:this.id,origin_slot:slot,target_id:target_node.id,target_slot:target_slot},this.graph.links[link_info.id]=link_info,null==output.links&&(output.links=[]),output.links.push(link_info.id),target_node.inputs[target_slot].link=link_info.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,slot,!0,link_info,output),target_node.onConnectionsChange&&target_node.onConnectionsChange(LiteGraph.INPUT,target_slot,!0,link_info,input),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,target_node,target_slot,this,slot),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,slot,target_node,target_slot))),this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this,link_info),link_info},LGraphNode.prototype.disconnectOutput=function(slot,target_node){if(slot.constructor===String){if(-1==(slot=this.findOutputSlot(slot)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+slot),!1}else if(!this.outputs||slot>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var output=this.outputs[slot];if(!output||!output.links||0==output.links.length)return!1;if(target_node){if(target_node.constructor===Number&&(target_node=this.graph.getNodeById(target_node)),!target_node)throw"Target Node not found";for(var i=0,l=output.links.length;i<l;i++){var link_id=output.links[i];if((link_info=this.graph.links[link_id]).target_id==target_node.id){output.links.splice(i,1),(input=target_node.inputs[link_info.target_slot]).link=null,delete this.graph.links[link_id],this.graph&&this.graph._version++,target_node.onConnectionsChange&&target_node.onConnectionsChange(LiteGraph.INPUT,link_info.target_slot,!1,link_info,input),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,slot,!1,link_info,output),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,slot),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,slot),this.graph.onNodeConnectionChange(LiteGraph.INPUT,target_node,link_info.target_slot));break}}}else{for(i=0,l=output.links.length;i<l;i++){var link_info;link_id=output.links[i];if(link_info=this.graph.links[link_id]){target_node=this.graph.getNodeById(link_info.target_id);var input=null;this.graph&&this.graph._version++,target_node&&((input=target_node.inputs[link_info.target_slot]).link=null,target_node.onConnectionsChange&&target_node.onConnectionsChange(LiteGraph.INPUT,link_info.target_slot,!1,link_info,input),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,target_node,link_info.target_slot)),delete this.graph.links[link_id],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,slot,!1,link_info,output),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,slot),this.graph.onNodeConnectionChange(LiteGraph.INPUT,target_node,link_info.target_slot))}}output.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(slot){if(slot.constructor===String){if(-1==(slot=this.findInputSlot(slot)))return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+slot),!1}else if(!this.inputs||slot>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var input=this.inputs[slot];if(!input)return!1;var link_id=this.inputs[slot].link;this.inputs[slot].link=null;var link_info=this.graph.links[link_id];if(link_info){var target_node=this.graph.getNodeById(link_info.origin_id);if(!target_node)return!1;var output=target_node.outputs[link_info.origin_slot];if(!output||!output.links||0==output.links.length)return!1;for(var i=0,l=output.links.length;i<l;i++)if(output.links[i]==link_id){output.links.splice(i,1);break}delete this.graph.links[link_id],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,slot,!1,link_info,input),target_node.onConnectionsChange&&target_node.onConnectionsChange(LiteGraph.OUTPUT,i,!1,link_info,output),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,target_node,i),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,slot))}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(is_input,slot_number,out){out=out||new Float32Array(2);var num_slots=0;if(is_input&&this.inputs&&(num_slots=this.inputs.length),!is_input&&this.outputs&&(num_slots=this.outputs.length),this.flags.collapsed){var w=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.flags.horizontal?(out[0]=this.pos[0]+.5*w,out[1]=is_input?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]):(out[0]=is_input?this.pos[0]:this.pos[0]+w,out[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT),out}return is_input&&-1==slot_number?(out[0]=this.pos[0]+10,out[1]=this.pos[1]+10,out):is_input&&num_slots>slot_number&&this.inputs[slot_number].pos?(out[0]=this.pos[0]+this.inputs[slot_number].pos[0],out[1]=this.pos[1]+this.inputs[slot_number].pos[1],out):!is_input&&num_slots>slot_number&&this.outputs[slot_number].pos?(out[0]=this.pos[0]+this.outputs[slot_number].pos[0],out[1]=this.pos[1]+this.outputs[slot_number].pos[1],out):this.flags.horizontal?(out[0]=this.pos[0]+(slot_number+.5)*(this.size[0]/num_slots),out[1]=is_input?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],out):(out[0]=is_input?this.pos[0]:this.pos[0]+this.size[0]+1,out[1]=this.pos[1]+10+slot_number*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),out)},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(msg){this.console||(this.console=[]),this.console.push(msg),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace(this,msg)},LGraphNode.prototype.setDirtyCanvas=function(dirty_foreground,dirty_background){this.graph&&this.graph.sendActionToCanvas("setDirty",[dirty_foreground,dirty_background])},LGraphNode.prototype.loadImage=function(url){var img=new Image;img.src=LiteGraph.node_images_path+url,img.ready=!1;var that=this;return img.onload=function(){this.ready=!0,that.setDirtyCanvas(!0)},img},LGraphNode.prototype.captureInput=function(v){if(this.graph&&this.graph.list_of_graphcanvas)for(var list=this.graph.list_of_graphcanvas,i=0;i<list.length;++i){var c=list[i];(v||c.node_capturing_input==this)&&(c.node_capturing_input=v?this:null)}},LGraphNode.prototype.collapse=function(force){this.graph._version++,(!1!==this.constructor.collapsable||force)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(v){this.graph._version++,this.flags.pinned=void 0===v?!this.flags.pinned:v},LGraphNode.prototype.localToScreen=function(x,y,graphcanvas){return[(x+this.pos[0])*graphcanvas.scale+graphcanvas.offset[0],(y+this.pos[1])*graphcanvas.scale+graphcanvas.offset[1]]},global.LGraphGroup=LiteGraph.LGraphGroup=LGraphGroup,LGraphGroup.prototype._ctor=function(title){this.title=title||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(v){!v||v.length<2||(this._pos[0]=v[0],this._pos[1]=v[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(v){!v||v.length<2||(this._size[0]=Math.max(140,v[0]),this._size[1]=Math.max(80,v[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(o){this.title=o.title,this._bounding.set(o.bounding),this.color=o.color,this.font=o.font},LGraphGroup.prototype.serialize=function(){var b=this._bounding;return{title:this.title,bounding:[Math.round(b[0]),Math.round(b[1]),Math.round(b[2]),Math.round(b[3])],color:this.color,font:this.font}},LGraphGroup.prototype.move=function(deltax,deltay,ignore_nodes){if(this._pos[0]+=deltax,this._pos[1]+=deltay,!ignore_nodes)for(var i=0;i<this._nodes.length;++i){var node=this._nodes[i];node.pos[0]+=deltax,node.pos[1]+=deltay}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var nodes=this.graph._nodes,node_bounding=new Float32Array(4),i=0;i<nodes.length;++i){var node=nodes[i];node.getBounding(node_bounding),overlapBounding(this._bounding,node_bounding)&&this._nodes.push(node)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas,global.LGraphCanvas=LiteGraph.LGraphCanvas=LGraphCanvas,LGraphCanvas.link_type_colors={"-1":"#F85",number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.scale=1,this.offset=[0,0],this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(graph,skip_clear){this.graph!=graph&&(skip_clear||this.clear(),graph||!this.graph?(graph.attachCanvas(this),this.setDirty(!0,!0)):this.graph.detachCanvas(this))},LGraphCanvas.prototype.openSubgraph=function(graph){if(!graph)throw"graph cannot be null";if(this.graph==graph)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),graph.attachCanvas(this),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){if(this._graph_stack&&0!=this._graph_stack.length){var subraph_node=this.graph._subgraph_node,graph=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},graph.attachCanvas(this),this.setDirty(!0,!0),subraph_node&&(this.centerOnNode(subraph_node),this.selectNodes([subraph_node]))}},LGraphCanvas.prototype.setCanvas=function(canvas,skip_events){if(canvas&&canvas.constructor===String&&!(canvas=document.getElementById(canvas)))throw"Error creating LiteGraph canvas: Canvas not found";if(canvas!==this.canvas&&(!canvas&&this.canvas&&(skip_events||this.unbindEvents()),this.canvas=canvas,canvas)){if(canvas.className+=" lgraphcanvas",canvas.data=this,this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==canvas.getContext){if("canvas"!=canvas.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+canvas.localName;throw"This browser doesnt support Canvas"}null==(this.ctx=canvas.getContext("2d"))&&(canvas.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),skip_events||this.bindEvents()}},LGraphCanvas.prototype._doNothing=function(e){return e.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function(e){return e.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){if(this._events_binded)console.warn("LGraphCanvas: events already binded");else{var canvas=this.canvas,document=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),canvas.addEventListener("mousedown",this._mousedown_callback,!0),canvas.addEventListener("mousemove",this._mousemove_callback),canvas.addEventListener("mousewheel",this._mousewheel_callback,!1),canvas.addEventListener("contextmenu",this._doNothing),canvas.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),canvas.addEventListener("touchstart",this.touchHandler,!0),canvas.addEventListener("touchmove",this.touchHandler,!0),canvas.addEventListener("touchend",this.touchHandler,!0),canvas.addEventListener("touchcancel",this.touchHandler,!0),this._key_callback=this.processKey.bind(this),canvas.addEventListener("keydown",this._key_callback,!0),document.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),canvas.addEventListener("dragover",this._doNothing,!1),canvas.addEventListener("dragend",this._doNothing,!1),canvas.addEventListener("drop",this._ondrop_callback,!1),canvas.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}},LGraphCanvas.prototype.unbindEvents=function(){if(this._events_binded){var document=this.getCanvasWindow().document;this.canvas.removeEventListener("mousedown",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),document.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this.canvas.removeEventListener("touchstart",this.touchHandler),this.canvas.removeEventListener("touchmove",this.touchHandler),this.canvas.removeEventListener("touchend",this.touchHandler),this.canvas.removeEventListener("touchcancel",this.touchHandler),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}else console.warn("LGraphCanvas: no events binded")},LGraphCanvas.getFileExtension=function(url){var question=url.indexOf("?");-1!=question&&(url=url.substr(0,question));var point=url.lastIndexOf(".");return-1==point?"":url.substr(point+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if(void 0===typeof GL)throw"litegl.js must be included to use a WebGL canvas";if(void 0===typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(fgcanvas,bgcanvas){fgcanvas&&(this.dirty_canvas=!0),bgcanvas&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var doc=this.canvas.ownerDocument;return doc.defaultView||doc.parentWindow},LGraphCanvas.prototype.startRendering=function(){this.is_rendering||(this.is_rendering=!0,function renderFrame(){this.pause_rendering||this.draw();var window=this.getCanvasWindow();this.is_rendering&&window.requestAnimationFrame(renderFrame.bind(this))}.call(this))},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.processMouseDown=function(e){if(this.graph){this.adjustMouseEvent(e);var ref_window=this.getCanvasWindow();ref_window.document;LGraphCanvas.active_canvas=this;this.canvas.removeEventListener("mousemove",this._mousemove_callback),ref_window.document.addEventListener("mousemove",this._mousemove_callback,!0),ref_window.document.addEventListener("mouseup",this._mouseup_callback,!0);var node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),skip_action=!1,is_double_click=LiteGraph.getTime()-this.last_mouseclick<300;if(this.canvas_mouse[0]=e.canvasX,this.canvas_mouse[1]=e.canvasY,LiteGraph.closeAllContextMenus(ref_window),!this.onMouse||1!=this.onMouse(e)){if(1==e.which){e.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,skip_action=!0);var clicking_canvas_bg=!1;if(node&&this.allow_interaction&&!skip_action){if(this.live_mode||node.flags.pinned||this.bringToFront(node),!this.connecting_node&&!node.flags.collapsed&&!this.live_mode)if(!skip_action&&!1!==node.flags.resizable&&isInsideRectangle(e.canvasX,e.canvasY,node.pos[0]+node.size[0]-5,node.pos[1]+node.size[1]-5,10,10))this.resizing_node=node,this.canvas.style.cursor="se-resize",skip_action=!0;else{if(node.outputs)for(var i=0,l=node.outputs.length;i<l;++i){var output=node.outputs[i],link_pos=node.getConnectionPos(!1,i);if(isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){this.connecting_node=node,this.connecting_output=output,this.connecting_pos=node.getConnectionPos(!1,i),this.connecting_slot=i,e.shiftKey&&node.disconnectOutput(i),is_double_click?node.onOutputDblClick&&node.onOutputDblClick(i,e):node.onOutputClick&&node.onOutputClick(i,e),skip_action=!0;break}}if(node.inputs)for(i=0,l=node.inputs.length;i<l;++i){var input=node.inputs[i];link_pos=node.getConnectionPos(!0,i);if(isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)&&(is_double_click?node.onInputDblClick&&node.onInputDblClick(i,e):node.onInputClick&&node.onInputClick(i,e),null!==input.link)){var link_info=this.graph.links[input.link];node.disconnectInput(i),(this.allow_reconnect_links||e.shiftKey)&&(this.connecting_node=this.graph._nodes_by_id[link_info.origin_id],this.connecting_slot=link_info.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot)),this.dirty_bgcanvas=!0,skip_action=!0}}}if(!skip_action&&isInsideRectangle(e.canvasX,e.canvasY,node.pos[0],node.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&(node.collapse(),skip_action=!0),!skip_action){var block_drag_node=!1,widget=this.processNodeWidgets(node,this.canvas_mouse,e);widget&&(block_drag_node=!0,this.node_widget=[node,widget]),is_double_click&&this.selected_nodes[node.id]&&(node.onDblClick&&node.onDblClick(e,[e.canvasX-node.pos[0],e.canvasY-node.pos[1]],graphcanvas),this.processNodeDblClicked(node),block_drag_node=!0),node.onMouseDown&&node.onMouseDown(e,[e.canvasX-node.pos[0],e.canvasY-node.pos[1]],this)?block_drag_node=!0:this.live_mode&&(clicking_canvas_bg=!0,block_drag_node=!0),block_drag_node||(this.allow_dragnodes&&(this.node_dragged=node),this.selected_nodes[node.id]||this.processNodeSelected(node,e)),this.dirty_canvas=!0}}else{if(this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group)e.ctrlKey&&(this.dragging_rectangle=null),distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes();is_double_click&&this.showSearchBox(e),clicking_canvas_bg=!0}!skip_action&&clicking_canvas_bg&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else 2==e.which||3==e.which&&this.processContextMenu(node,e);return this.last_mouse[0]=e.localX,this.last_mouse[1]=e.localY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!ref_window.document.activeElement||"input"!=ref_window.document.activeElement.nodeName.toLowerCase()&&"textarea"!=ref_window.document.activeElement.nodeName.toLowerCase())&&e.preventDefault(),e.stopPropagation(),this.onMouseDown&&this.onMouseDown(e),!1}}},LGraphCanvas.prototype.processMouseMove=function(e){if(this.autoresize&&this.resize(),this.graph){LGraphCanvas.active_canvas=this,this.adjustMouseEvent(e);var mouse=[e.localX,e.localY],delta=[mouse[0]-this.last_mouse[0],mouse[1]-this.last_mouse[1]];if(this.last_mouse=mouse,this.canvas_mouse[0]=e.canvasX,this.canvas_mouse[1]=e.canvasY,e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.canvas_mouse,e,this.node_widget[1]),this.dirty_canvas=!0),this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group){if(this.selected_group_resizing)this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{var deltax=delta[0]/this.scale,deltay=delta[1]/this.scale;this.selected_group.move(deltax,deltay,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.offset[0]+=delta[0]/this.scale,this.offset[1]+=delta[1]/this.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if(this.allow_interaction){this.connecting_node&&(this.dirty_canvas=!0);for(var node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes),i=0,l=this.graph._nodes.length;i<l;++i)this.graph._nodes[i].mouseOver&&node!=this.graph._nodes[i]&&(this.graph._nodes[i].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e),this.node_over=null,this.dirty_canvas=!0);if(node){if(node.mouseOver||(node.mouseOver=!0,this.node_over=node,this.dirty_canvas=!0,node.onMouseEnter&&node.onMouseEnter(e)),node.onMouseMove&&node.onMouseMove(e,[e.canvasX-node.pos[0],e.canvasY-node.pos[1]],this),this.connecting_node){var pos=this._highlight_input||[0,0];if(this.isOverNodeBox(node,e.canvasX,e.canvasY));else{var slot=this.isOverNodeInput(node,e.canvasX,e.canvasY,pos);if(-1!=slot&&node.inputs[slot]){var slot_type=node.inputs[slot].type;LiteGraph.isValidConnection(this.connecting_output.type,slot_type)&&(this._highlight_input=pos)}else this._highlight_input=null}}this.canvas&&(isInsideRectangle(e.canvasX,e.canvasY,node.pos[0]+node.size[0]-5,node.pos[1]+node.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="")}else this.canvas&&(this.canvas.style.cursor="");if(this.node_capturing_input&&this.node_capturing_input!=node&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e),this.node_dragged&&!this.live_mode){for(var i in this.selected_nodes){var n=this.selected_nodes[i];n.pos[0]+=delta[0]/this.scale,n.pos[1]+=delta[1]/this.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){this.resizing_node.size[0]=e.canvasX-this.resizing_node.pos[0],this.resizing_node.size[1]=e.canvasY-this.resizing_node.pos[1];var min_height=Math.max(this.resizing_node.inputs?this.resizing_node.inputs.length:0,this.resizing_node.outputs?this.resizing_node.outputs.length:0)*LiteGraph.NODE_SLOT_HEIGHT+(this.resizing_node.widgets?this.resizing_node.widgets.length:0)*(LiteGraph.NODE_WIDGET_HEIGHT+4)+4;this.resizing_node.size[1]<min_height&&(this.resizing_node.size[1]=min_height),this.resizing_node.size[0]<LiteGraph.NODE_MIN_WIDTH&&(this.resizing_node.size[0]=LiteGraph.NODE_MIN_WIDTH),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(e){if(this.graph){var document=this.getCanvasWindow().document;LGraphCanvas.active_canvas=this,document.removeEventListener("mousemove",this._mousemove_callback,!0),this.canvas.addEventListener("mousemove",this._mousemove_callback,!0),document.removeEventListener("mouseup",this._mouseup_callback,!0),this.adjustMouseEvent(e);var now=LiteGraph.getTime();if(e.click_time=now-this.last_mouseclick,this.last_mouse_dragging=!1,1==e.which){if(this.node_widget=null,this.selected_group){var diffx=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),diffy=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(diffx,diffy,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}if(this.selected_group_resizing=!1,this.dragging_rectangle){if(this.graph){var nodes=this.graph._nodes,node_bounding=new Float32Array(4);this.deselectAllNodes();var w=Math.abs(this.dragging_rectangle[2]),h=Math.abs(this.dragging_rectangle[3]),startx=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-w:this.dragging_rectangle[0],starty=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-h:this.dragging_rectangle[1];this.dragging_rectangle[0]=startx,this.dragging_rectangle[1]=starty,this.dragging_rectangle[2]=w,this.dragging_rectangle[3]=h;for(var to_select=[],i=0;i<nodes.length;++i){(node=nodes[i]).getBounding(node_bounding),overlapBounding(this.dragging_rectangle,node_bounding)&&to_select.push(node)}to_select.length&&this.selectNodes(to_select)}this.dragging_rectangle=null}else if(this.connecting_node){if(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes))if(this.connecting_output.type==LiteGraph.EVENT&&this.isOverNodeBox(node,e.canvasX,e.canvasY))this.connecting_node.connect(this.connecting_slot,node,LiteGraph.EVENT);else{var slot=this.isOverNodeInput(node,e.canvasX,e.canvasY);if(-1!=slot)this.connecting_node.connect(this.connecting_slot,node,slot);else{var input=node.getInputInfo(0);this.connecting_output.type==LiteGraph.EVENT?this.connecting_node.connect(this.connecting_slot,node,LiteGraph.EVENT):input&&!input.link&&LiteGraph.isValidConnection(input.type&&this.connecting_output.type)&&this.connecting_node.connect(this.connecting_slot,node,0)}}this.connecting_output=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.resizing_node=null;else if(this.node_dragged)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),this.graph.config.align_to_grid&&this.node_dragged.alignToGrid(),this.node_dragged=null;else{var node;!(node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes))&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}}else 2==e.which?(this.dirty_canvas=!0,this.dragging_canvas=!1):3==e.which&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(e){if(this.graph&&this.allow_dragcanvas){var delta=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail;this.adjustMouseEvent(e);var zoom=this.scale;return delta>0?zoom*=1.1:delta<0&&(zoom*=1/1.1),this.setZoom(zoom,[e.localX,e.localY]),this.graph.change(),e.preventDefault(),!1}},LGraphCanvas.prototype.isOverNodeBox=function(node,canvasx,canvasy){var title_height=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(canvasx,canvasy,node.pos[0]+2,node.pos[1]+2-title_height,title_height-4,title_height-4)},LGraphCanvas.prototype.isOverNodeInput=function(node,canvasx,canvasy,slot_pos){if(node.inputs)for(var i=0,l=node.inputs.length;i<l;++i){node.inputs[i];var link_pos=node.getConnectionPos(!0,i);if(isInsideRectangle(canvasx,canvasy,link_pos[0]-10,link_pos[1]-5,20,10))return slot_pos&&(slot_pos[0]=link_pos[0],slot_pos[1]=link_pos[1]),i}return-1},LGraphCanvas.prototype.processKey=function(e){if(this.graph){var block_default=!1;if("input"!=e.target.localName){if("keydown"==e.type){if(32==e.keyCode&&(this.dragging_canvas=!0,block_default=!0),65==e.keyCode&&e.ctrlKey&&(this.selectNodes(),block_default=!0),"KeyC"!=e.code||!e.metaKey&&!e.ctrlKey||e.shiftKey||this.selected_nodes&&(this.copyToClipboard(),block_default=!0),"KeyV"!=e.code||!e.metaKey&&!e.ctrlKey||e.shiftKey||this.pasteFromClipboard(),46!=e.keyCode&&8!=e.keyCode||"input"!=e.target.localName&&"textarea"!=e.target.localName&&(this.deleteSelectedNodes(),block_default=!0),this.selected_nodes)for(var i in this.selected_nodes)this.selected_nodes[i].onKeyDown&&this.selected_nodes[i].onKeyDown(e)}else if("keyup"==e.type&&(32==e.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var i in this.selected_nodes)this.selected_nodes[i].onKeyUp&&this.selected_nodes[i].onKeyUp(e);return this.graph.change(),block_default?(e.preventDefault(),!1):void 0}}},LGraphCanvas.prototype.copyToClipboard=function(){var clipboard_info={nodes:[],links:[]},index=0,selected_nodes_array=[];for(var i in this.selected_nodes){(node=this.selected_nodes[i])._relative_id=index,selected_nodes_array.push(node),index+=1}for(i=0;i<selected_nodes_array.length;++i){var node=selected_nodes_array[i];if(clipboard_info.nodes.push(node.clone().serialize()),node.inputs&&node.inputs.length)for(var j=0;j<node.inputs.length;++j){var input=node.inputs[j];if(input&&null!=input.link){var link_info=this.graph.links[input.link];if(link_info){var target_node=this.graph.getNodeById(link_info.origin_id);target_node&&this.selected_nodes[target_node.id]&&clipboard_info.links.push([target_node._relative_id,j,node._relative_id,link_info.target_slot])}}}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(clipboard_info))},LGraphCanvas.prototype.pasteFromClipboard=function(){var data=localStorage.getItem("litegrapheditor_clipboard");if(data){for(var clipboard_info=JSON.parse(data),nodes=[],i=0;i<clipboard_info.nodes.length;++i){var node_data=clipboard_info.nodes[i],node=LiteGraph.createNode(node_data.type);node&&(node.configure(node_data),node.pos[0]+=5,node.pos[1]+=5,this.graph.add(node),nodes.push(node))}for(i=0;i<clipboard_info.links.length;++i){var link_info=clipboard_info.links[i],origin_node=nodes[link_info[0]],target_node=nodes[link_info[2]];origin_node.connect(link_info[1],target_node,link_info[3])}this.selectNodes(nodes)}},LGraphCanvas.prototype.processDrop=function(e){e.preventDefault(),this.adjustMouseEvent(e);var pos=[e.canvasX,e.canvasY],node=this.graph.getNodeOnPos(pos[0],pos[1]);if(!node){var r=null;return this.onDropItem&&(r=this.onDropItem(event)),void(r||this.checkDropItem(e))}if(node.onDropFile||node.onDropData){var files=e.dataTransfer.files;if(files&&files.length)for(var i=0;i<files.length;i++){var file=e.dataTransfer.files[0],filename=file.name;LGraphCanvas.getFileExtension(filename);if(node.onDropFile&&node.onDropFile(file),node.onDropData){var reader=new FileReader;reader.onload=function(event){var data=event.target.result;node.onDropData(data,filename,file)};var type=file.type.split("/")[0];"text"==type||""==type?reader.readAsText(file):"image"==type?reader.readAsDataURL(file):reader.readAsArrayBuffer(file)}}}return!(!node.onDropItem||!node.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)},LGraphCanvas.prototype.checkDropItem=function(e){if(e.dataTransfer.files.length){var file=e.dataTransfer.files[0],ext=LGraphCanvas.getFileExtension(file.name).toLowerCase(),nodetype=LiteGraph.node_types_by_file_extension[ext];if(nodetype){var node=LiteGraph.createNode(nodetype.type);node.pos=[e.canvasX,e.canvasY],this.graph.add(node),node.onDropFile&&node.onDropFile(file)}}},LGraphCanvas.prototype.processNodeDblClicked=function(n){this.onShowNodePanel&&this.onShowNodePanel(n),this.onNodeDblClicked&&this.onNodeDblClicked(n),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(node,e){this.selectNode(node,e&&e.shiftKey),this.onNodeSelected&&this.onNodeSelected(node)},LGraphCanvas.prototype.processNodeDeselected=function(node){this.deselectNode(node),this.onNodeDeselected&&this.onNodeDeselected(node)},LGraphCanvas.prototype.selectNode=function(node,add_to_current_selection){null==node?this.deselectAllNodes():this.selectNodes([node],add_to_current_selection)},LGraphCanvas.prototype.selectNodes=function(nodes,add_to_current_selection){add_to_current_selection||this.deselectAllNodes(),nodes=nodes||this.graph._nodes;for(var i=0;i<nodes.length;++i){var node=nodes[i];if(!node.selected){if(!node.selected&&node.onSelected&&node.onSelected(),node.selected=!0,this.selected_nodes[node.id]=node,node.inputs)for(var j=0;j<node.inputs.length;++j)this.highlighted_links[node.inputs[j].link]=!0;if(node.outputs)for(j=0;j<node.outputs.length;++j){var out=node.outputs[j];if(out.links)for(var k=0;k<out.links.length;++k)this.highlighted_links[out.links[k]]=!0}}}this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(node){if(node.selected){if(node.onDeselected&&node.onDeselected(),node.selected=!1,node.inputs)for(var i=0;i<node.inputs.length;++i)delete this.highlighted_links[node.inputs[i].link];if(node.outputs)for(i=0;i<node.outputs.length;++i){var out=node.outputs[i];if(out.links)for(var j=0;j<out.links.length;++j)delete this.highlighted_links[out.links[j]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var nodes=this.graph._nodes,i=0,l=nodes.length;i<l;++i){var node=nodes[i];node.selected&&(node.onDeselected&&node.onDeselected(),node.selected=!1)}this.selected_nodes={},this.highlighted_links={},this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){for(var i in this.selected_nodes){var m=this.selected_nodes[i];this.graph.remove(m)}this.selected_nodes={},this.highlighted_links={},this.setDirty(!0)},LGraphCanvas.prototype.centerOnNode=function(node){this.offset[0]=-node.pos[0]-.5*node.size[0]+.5*this.canvas.width/this.scale,this.offset[1]=-node.pos[1]-.5*node.size[1]+.5*this.canvas.height/this.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(e){if(this.canvas){var b=this.canvas.getBoundingClientRect();e.localX=e.pageX-b.left,e.localY=e.pageY-b.top}else e.localX=e.pageX,e.localY=e.pageY;e.deltaX=e.localX-this.last_mouse_position[0],e.deltaY=e.localY-this.last_mouse_position[1],this.last_mouse_position[0]=e.localX,this.last_mouse_position[1]=e.localY,e.canvasX=e.localX/this.scale-this.offset[0],e.canvasY=e.localY/this.scale-this.offset[1]},LGraphCanvas.prototype.setZoom=function(value,zooming_center){!zooming_center&&this.canvas&&(zooming_center=[.5*this.canvas.width,.5*this.canvas.height]);var center=this.convertOffsetToCanvas(zooming_center);this.scale=value,this.scale>this.max_zoom?this.scale=this.max_zoom:this.scale<this.min_zoom&&(this.scale=this.min_zoom);var new_center=this.convertOffsetToCanvas(zooming_center),delta_offset=[new_center[0]-center[0],new_center[1]-center[1]];this.offset[0]+=delta_offset[0],this.offset[1]+=delta_offset[1],this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(pos,out){return(out=out||[])[0]=pos[0]/this.scale-this.offset[0],out[1]=pos[1]/this.scale-this.offset[1],out},LGraphCanvas.prototype.convertCanvasToOffset=function(pos,out){return(out=out||[])[0]=(pos[0]+this.offset[0])*this.scale,out[1]=(pos[1]+this.offset[1])*this.scale,out},LGraphCanvas.prototype.convertEventToCanvas=function(e){var rect=this.canvas.getBoundingClientRect();return this.convertOffsetToCanvas([e.pageX-rect.left,e.pageY-rect.top])},LGraphCanvas.prototype.bringToFront=function(node){var i=this.graph._nodes.indexOf(node);-1!=i&&(this.graph._nodes.splice(i,1),this.graph._nodes.push(node))},LGraphCanvas.prototype.sendToBack=function(node){var i=this.graph._nodes.indexOf(node);-1!=i&&(this.graph._nodes.splice(i,1),this.graph._nodes.unshift(node))};var temp=new Float32Array(4);LGraphCanvas.prototype.computeVisibleNodes=function(nodes,out){var visible_nodes=out||[];visible_nodes.length=0;for(var i=0,l=(nodes=nodes||this.graph._nodes).length;i<l;++i){var n=nodes[i];(!this.live_mode||n.onDrawBackground||n.onDrawForeground)&&(overlapBounding(this.visible_area,n.getBounding(temp))&&visible_nodes.push(n))}return visible_nodes},LGraphCanvas.prototype.draw=function(force_canvas,force_bgcanvas){if(this.canvas){var now=LiteGraph.getTime();if(this.render_time=.001*(now-this.last_draw_time),this.last_draw_time=now,this.graph){var startx=-this.offset[0],starty=-this.offset[1],endx=startx+this.canvas.width/this.scale,endy=starty+this.canvas.height/this.scale;this.visible_area[0]=startx,this.visible_area[1]=starty,this.visible_area[2]=endx-startx,this.visible_area[3]=endy-starty}(this.dirty_bgcanvas||force_bgcanvas||this.always_render_background||this.graph&&this.graph._last_trigger_time&&now-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||force_canvas)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var ctx=this.ctx;if(ctx){ctx.start2D&&ctx.start2D();var canvas=this.canvas;if(ctx.restore(),ctx.setTransform(1,0,0,1,0,0),this.dirty_area&&(ctx.save(),ctx.beginPath(),ctx.rect(this.dirty_area[0],this.dirty_area[1],this.dirty_area[2],this.dirty_area[3]),ctx.clip()),this.clear_background&&ctx.clearRect(0,0,canvas.width,canvas.height),this.bgcanvas==this.canvas?this.drawBackCanvas():ctx.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(canvas,ctx),this.show_info&&this.renderInfo(ctx),this.graph){ctx.save(),ctx.scale(this.scale,this.scale),ctx.translate(this.offset[0],this.offset[1]);for(var visible_nodes=this.computeVisibleNodes(null,this.visible_nodes),i=0;i<visible_nodes.length;++i){var node=visible_nodes[i];ctx.save(),ctx.translate(node.pos[0],node.pos[1]),this.drawNode(node,ctx),1,ctx.restore()}if(this.render_execution_order&&this.drawExecutionOrder(ctx),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(ctx)),null!=this.connecting_pos){ctx.lineWidth=this.connections_width;var link_color=null;switch(this.connecting_output.type){case LiteGraph.EVENT:link_color=LiteGraph.EVENT_LINK_COLOR;break;default:link_color=LiteGraph.CONNECTING_LINK_COLOR}this.renderLink(ctx,this.connecting_pos,[this.canvas_mouse[0],this.canvas_mouse[1]],null,!1,null,link_color,this.connecting_output.dir||(this.connecting_node.flags.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),LiteGraph.CENTER),ctx.beginPath(),this.connecting_output.type===LiteGraph.EVENT||this.connecting_output.shape===LiteGraph.BOX_SHAPE?ctx.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10):ctx.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#ffcc00",this._highlight_input&&(ctx.beginPath(),ctx.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),ctx.fill())}this.dragging_rectangle&&(ctx.strokeStyle="#FFF",ctx.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.onDrawForeground&&this.onDrawForeground(ctx,this.visible_rect),ctx.restore()}this.onDrawOverlay&&this.onDrawOverlay(ctx),this.dirty_area&&ctx.restore(),ctx.finish2D&&ctx.finish2D()}},LGraphCanvas.prototype.renderInfo=function(ctx,x,y){x=x||0,y=y||0,ctx.save(),ctx.translate(x,y),ctx.font="10px Arial",ctx.fillStyle="#888",this.graph?(ctx.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),ctx.fillText("I: "+this.graph.iteration,5,26),ctx.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),ctx.fillText("V: "+this.graph._version,5,52),ctx.fillText("FPS:"+this.fps.toFixed(2),5,65)):ctx.fillText("No graph selected",5,13),ctx.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var canvas=this.bgcanvas;canvas.width==this.canvas.width&&canvas.height==this.canvas.height||(canvas.width=this.canvas.width,canvas.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var ctx=this.bgctx;if(ctx.start&&ctx.start(),this.clear_background&&ctx.clearRect(0,0,canvas.width,canvas.height),this._graph_stack&&this._graph_stack.length){ctx.save();this._graph_stack[this._graph_stack.length-1];var subgraph_node=this.graph._subgraph_node;ctx.strokeStyle=subgraph_node.bgcolor,ctx.lineWidth=10,ctx.strokeRect(1,1,canvas.width-2,canvas.height-2),ctx.lineWidth=1,ctx.font="40px Arial",ctx.textAlign="center",ctx.fillStyle=subgraph_node.bgcolor;for(var title="",i=1;i<this._graph_stack.length;++i)title+=this._graph_stack[i]._subgraph_node.getTitle()+" >> ";ctx.fillText(title+subgraph_node.getTitle(),.5*canvas.width,40),ctx.restore()}var bg_already_painted=!1;if(this.onRenderBackground&&(bg_already_painted=this.onRenderBackground(canvas,ctx)),ctx.restore(),ctx.setTransform(1,0,0,1,0,0),this.graph){if(ctx.save(),ctx.scale(this.scale,this.scale),ctx.translate(this.offset[0],this.offset[1]),this.background_image&&this.scale>.5&&!bg_already_painted){if(this.zoom_modify_alpha?ctx.globalAlpha=(1-.5/this.scale)*this.editor_alpha:ctx.globalAlpha=this.editor_alpha,ctx.imageSmoothingEnabled=ctx.mozImageSmoothingEnabled=ctx.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var that=this;this._bg_img.onload=function(){that.draw(!0,!0)}}var pattern=null;null==this._pattern&&this._bg_img.width>0?(pattern=ctx.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=pattern):pattern=this._pattern,pattern&&(ctx.fillStyle=pattern,ctx.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),ctx.fillStyle="transparent"),ctx.globalAlpha=1,ctx.imageSmoothingEnabled=ctx.mozImageSmoothingEnabled=ctx.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(canvas,ctx),this.onDrawBackground&&this.onDrawBackground(ctx,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(ctx.strokeStyle="#235",ctx.strokeRect(0,0,canvas.width,canvas.height)),this.render_connections_shadows?(ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=6):ctx.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(ctx),ctx.shadowColor="rgba(0,0,0,0)",ctx.restore()}ctx.finish&&ctx.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var temp_vec2=new Float32Array(2);LGraphCanvas.prototype.drawNode=function(node,ctx){this.current_node=node;var color=node.color||node.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,bgcolor=node.bgcolor||node.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR;if(node.mouseOver&&!0,this.live_mode)node.flags.collapsed||(ctx.shadowColor="transparent",node.onDrawForeground&&node.onDrawForeground(ctx,this,this.canvas));else{var editor_alpha=this.editor_alpha;if(ctx.globalAlpha=editor_alpha,this.render_shadows?(ctx.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,ctx.shadowOffsetX=2*this.scale,ctx.shadowOffsetY=2*this.scale,ctx.shadowBlur=3*this.scale):ctx.shadowColor="transparent",!node.flags.collapsed||!node.onDrawCollaped||1!=node.onDrawCollapsed(ctx,this)){var shape=node._shape||LiteGraph.BOX_SHAPE,size=temp_vec2;if(temp_vec2.set(node.size),node.flags.collapsed){ctx.font=this.inner_text_font;var title=node.getTitle?node.getTitle():node.title;node._collapsed_width=Math.min(node.size[0],ctx.measureText(title).width+40),size[0]=node._collapsed_width,size[1]=0}node.flags.clip_area&&(ctx.save(),ctx.beginPath(),shape==LiteGraph.BOX_SHAPE?ctx.rect(0,0,size[0],size[1]):shape==LiteGraph.ROUND_SHAPE?ctx.roundRect(0,0,size[0],size[1],10):shape==LiteGraph.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0],0,2*Math.PI),ctx.clip()),this.drawNodeShape(node,ctx,size,color,bgcolor,node.selected,node.mouseOver),ctx.shadowColor="transparent",ctx.textAlign=node.flags.horizontal?"center":"left",ctx.font=this.inner_text_font;var render_text=this.scale>.6,out_slot=this.connecting_output;ctx.lineWidth=1;var max_y=0,slot_pos=new Float32Array(2);if(node.flags.collapsed){var input_slot=null,output_slot=null;if(node.inputs)for(i=0;i<node.inputs.length;i++){if(null!=(slot=node.inputs[i]).link){input_slot=slot;break}}if(node.outputs)for(i=0;i<node.outputs.length;i++){(slot=node.outputs[i]).links&&slot.links.length&&(output_slot=slot)}if(input_slot){var x=0,y=-.5*LiteGraph.NODE_TITLE_HEIGHT;node.flags.horizontal&&(x=.5*node._collapsed_width,y=-LiteGraph.NODE_TITLE_HEIGHT),ctx.fillStyle=slot.color_on||this.default_connection_color.input_on,ctx.beginPath(),slot.type===LiteGraph.EVENT||slot.shape===LiteGraph.BOX_SHAPE?ctx.rect(x-7+.5,y+4-.5*LiteGraph.NODE_TITLE_HEIGHT+.5,14,LiteGraph.NODE_TITLE_HEIGHT-8):slot.shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(x+8,y),ctx.lineTo(x+-4,y-4),ctx.lineTo(x+-4,y+4),ctx.closePath()):ctx.arc(x,y,4,0,2*Math.PI),ctx.fill()}if(output_slot){x=node._collapsed_width,y=-.5*LiteGraph.NODE_TITLE_HEIGHT;node.flags.horizontal&&(x=.5*node._collapsed_width,y=0),ctx.fillStyle=slot.color_on||this.default_connection_color.output_on,ctx.strokeStyle="black",ctx.beginPath(),slot.type===LiteGraph.EVENT||slot.shape===LiteGraph.BOX_SHAPE?ctx.rect(x-7+.5,y+4-.5*LiteGraph.NODE_TITLE_HEIGHT+.5,14,LiteGraph.NODE_TITLE_HEIGHT-8):slot.shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(x+6,y),ctx.lineTo(x-6,y-4),ctx.lineTo(x-6,y+4),ctx.closePath()):ctx.arc(x,y,4,0,2*Math.PI),ctx.fill(),ctx.stroke()}}else{if(node.inputs)for(var i=0;i<node.inputs.length;i++){var slot=node.inputs[i];if(ctx.globalAlpha=editor_alpha,this.connecting_node&&LiteGraph.isValidConnection(slot.type&&out_slot.type)&&(ctx.globalAlpha=.4*editor_alpha),ctx.fillStyle=null!=slot.link?slot.color_on||this.default_connection_color.input_on:slot.color_off||this.default_connection_color.input_off,(pos=node.getConnectionPos(!0,i,slot_pos))[0]-=node.pos[0],pos[1]-=node.pos[1],max_y<pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(max_y=pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),ctx.beginPath(),slot.type===LiteGraph.EVENT||slot.shape===LiteGraph.BOX_SHAPE?ctx.rect(pos[0]-6+.5,pos[1]-5+.5,14,10):slot.shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(pos[0]+8,pos[1]+.5),ctx.lineTo(pos[0]-4,pos[1]+6+.5),ctx.lineTo(pos[0]-4,pos[1]-6+.5),ctx.closePath()):ctx.arc(pos[0],pos[1],4,0,2*Math.PI),ctx.fill(),render_text)(text=null!=slot.label?slot.label:slot.name)&&(ctx.fillStyle=LiteGraph.NODE_TEXT_COLOR,node.flags.horizontal||slot.dir==LiteGraph.UP?ctx.fillText(text,pos[0],pos[1]-10):ctx.fillText(text,pos[0]+10,pos[1]+5))}if(this.connecting_node&&(ctx.globalAlpha=.4*editor_alpha),ctx.textAlign=node.flags.horizontal?"center":"right",ctx.strokeStyle="black",node.outputs)for(var i=0;i<node.outputs.length;i++){var pos,text,slot=node.outputs[i];if((pos=node.getConnectionPos(!1,i,slot_pos))[0]-=node.pos[0],pos[1]-=node.pos[1],max_y<pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(max_y=pos[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),ctx.fillStyle=slot.links&&slot.links.length?slot.color_on||this.default_connection_color.output_on:slot.color_off||this.default_connection_color.output_off,ctx.beginPath(),slot.type===LiteGraph.EVENT||slot.shape===LiteGraph.BOX_SHAPE?ctx.rect(pos[0]-6+.5,pos[1]-5+.5,14,10):slot.shape===LiteGraph.ARROW_SHAPE?(ctx.moveTo(pos[0]+8,pos[1]+.5),ctx.lineTo(pos[0]-4,pos[1]+6+.5),ctx.lineTo(pos[0]-4,pos[1]-6+.5),ctx.closePath()):ctx.arc(pos[0],pos[1],4,0,2*Math.PI),ctx.fill(),ctx.stroke(),render_text)(text=null!=slot.label?slot.label:slot.name)&&(ctx.fillStyle=LiteGraph.NODE_TEXT_COLOR,node.flags.horizontal||slot.dir==LiteGraph.DOWN?ctx.fillText(text,pos[0],pos[1]-8):ctx.fillText(text,pos[0]-10,pos[1]+5))}ctx.textAlign="left",ctx.globalAlpha=1,node.widgets&&((node.flags.horizontal||node.flags.widgets_up)&&(max_y=2),this.drawNodeWidgets(node,max_y,ctx,this.node_widget&&this.node_widget[0]==node?this.node_widget[1]:null)),node.onDrawForeground&&node.onDrawForeground(ctx,this,this.canvas)}node.flags.clip_area&&ctx.restore(),ctx.globalAlpha=1}}};var tmp_area=new Float32Array(4);function distance(a,b){return Math.sqrt((b[0]-a[0])*(b[0]-a[0])+(b[1]-a[1])*(b[1]-a[1]))}function isInsideRectangle(x,y,left,top,width,height){return left<x&&left+width>x&&top<y&&top+height>y}function overlapBounding(a,b){var A_end_x=a[0]+a[2],A_end_y=a[1]+a[3],B_end_x=b[0]+b[2],B_end_y=b[1]+b[3];return!(a[0]>B_end_x||a[1]>B_end_y||A_end_x<b[0]||A_end_y<b[1])}function ContextMenu(values,options){options=options||{},this.options=options;var that=this;options.parentMenu&&(options.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),options.parentMenu=null):(this.parentMenu=options.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this)),options.event&&options.event.constructor!==MouseEvent&&options.event.constructor!==CustomEvent&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it."),options.event=null);var root=document.createElement("div");function on_mouse_wheel(e){var pos=parseInt(root.style.top);return root.style.top=(pos+.1*e.deltaY).toFixed()+"px",e.preventDefault(),!0}if(root.className="litegraph litecontextmenu litemenubar-panel",options.className&&(root.className+=" "+options.className),root.style.minWidth=100,root.style.minHeight=100,root.style.pointerEvents="none",setTimeout(function(){root.style.pointerEvents="auto"},100),root.addEventListener("mouseup",function(e){return e.preventDefault(),!0},!0),root.addEventListener("contextmenu",function(e){return 2==e.button&&(e.preventDefault(),!1)},!0),root.addEventListener("mousedown",function(e){if(2==e.button)return that.close(),e.preventDefault(),!0},!0),root.addEventListener("wheel",on_mouse_wheel,!0),root.addEventListener("mousewheel",on_mouse_wheel,!0),this.root=root,options.title){var element=document.createElement("div");element.className="litemenu-title",element.innerHTML=options.title,root.appendChild(element)}for(var i in values){var name=values.constructor==Array?values[i]:i;null!=name&&name.constructor!==String&&(name=void 0===name.content?String(name):name.content);var value=values[i];this.addItem(name,value,options),0}root.addEventListener("mouseleave",function(e){that.lock||(root.closing_timer&&clearTimeout(root.closing_timer),root.closing_timer=setTimeout(that.close.bind(that,e),500))}),root.addEventListener("mouseenter",function(e){root.closing_timer&&clearTimeout(root.closing_timer)});var root_document=document;options.event&&(root_document=options.event.target.ownerDocument),root_document||(root_document=document),root_document.body.appendChild(root);var left=options.left||0,top=options.top||0;if(options.event){if(left=options.event.pageX-10,top=options.event.pageY-10,options.title&&(top-=20),options.parentMenu){var rect=options.parentMenu.root.getBoundingClientRect();left=rect.left+rect.width}var body_rect=document.body.getBoundingClientRect(),root_rect=root.getBoundingClientRect();left>body_rect.width-root_rect.width-10&&(left=body_rect.width-root_rect.width-10),top>body_rect.height-root_rect.height-10&&(top=body_rect.height-root_rect.height-10)}root.style.left=left+"px",root.style.top=top+"px"}LGraphCanvas.prototype.drawNodeShape=function(node,ctx,size,fgcolor,bgcolor,selected,mouse_over){ctx.strokeStyle=fgcolor,ctx.fillStyle=bgcolor;var title_height=LiteGraph.NODE_TITLE_HEIGHT,shape=node._shape||node.constructor.shape||LiteGraph.BOX_SHAPE,title_mode=node.constructor.title_mode,render_title=!0;title_mode==LiteGraph.TRANSPARENT_TITLE?render_title=!1:title_mode==LiteGraph.AUTOHIDE_TITLE&&mouse_over&&(render_title=!0);var area=tmp_area;if(area[0]=0,area[1]=render_title?-title_height:0,area[2]=size[0]+1,area[3]=render_title?size[1]+title_height:size[1],node.flags.collapsed||(ctx.beginPath(),shape==LiteGraph.BOX_SHAPE||this.scale<.5?ctx.fillRect(area[0],area[1],area[2],area[3]):shape==LiteGraph.ROUND_SHAPE||shape==LiteGraph.CARD_SHAPE?ctx.roundRect(area[0],area[1],area[2],area[3],this.round_radius,shape==LiteGraph.CARD_SHAPE?0:this.round_radius):shape==LiteGraph.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0],0,2*Math.PI),ctx.fill()),ctx.shadowColor="transparent",node.bgImage&&node.bgImage.width&&ctx.drawImage(node.bgImage,.5*(size[0]-node.bgImage.width),.5*(size[1]-node.bgImage.height)),node.bgImageUrl&&!node.bgImage&&(node.bgImage=node.loadImage(node.bgImageUrl)),node.onDrawBackground&&node.onDrawBackground(ctx,this,this.canvas),render_title||title_mode==LiteGraph.TRANSPARENT_TITLE){if(title_mode!=LiteGraph.TRANSPARENT_TITLE){if(node.flags.collapsed&&(ctx.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){var grad=LGraphCanvas.gradients[fgcolor];grad||((grad=LGraphCanvas.gradients[fgcolor]=ctx.createLinearGradient(0,0,400,0)).addColorStop(0,fgcolor),grad.addColorStop(1,"#000")),ctx.fillStyle=grad}else ctx.fillStyle=fgcolor;var old_alpha=ctx.globalAlpha;ctx.beginPath(),shape==LiteGraph.BOX_SHAPE||this.scale<.5?ctx.rect(0,-title_height,size[0]+1,title_height):shape!=LiteGraph.ROUND_SHAPE&&shape!=LiteGraph.CARD_SHAPE||ctx.roundRect(0,-title_height,size[0]+1,title_height,this.round_radius,node.flags.collapsed?this.round_radius:0),ctx.fill(),ctx.shadowColor="transparent"}if(shape==LiteGraph.ROUND_SHAPE||shape==LiteGraph.CIRCLE_SHAPE||shape==LiteGraph.CARD_SHAPE?(this.scale>.5&&(ctx.fillStyle="black",ctx.beginPath(),ctx.arc(.5*title_height,-.5*title_height,.5*(title_height-8),0,2*Math.PI),ctx.fill()),ctx.fillStyle=node.boxcolor||LiteGraph.NODE_DEFAULT_BOXCOLOR,ctx.beginPath(),ctx.arc(.5*title_height,-.5*title_height,.4*(title_height-8),0,2*Math.PI),ctx.fill()):(this.scale>.5&&(ctx.fillStyle="black",ctx.fillRect(4,4-title_height,title_height-8,title_height-8)),ctx.fillStyle=node.boxcolor||LiteGraph.NODE_DEFAULT_BOXCOLOR,ctx.fillRect(5,5-title_height,title_height-10,title_height-10)),ctx.globalAlpha=old_alpha,this.scale>.5){ctx.font=this.title_text_font;var title=node.getTitle();if(title)if(ctx.fillStyle=selected?"white":node.constructor.title_text_color||this.node_title_color,node.flags.collapsed){ctx.textAlign="center";var measure=ctx.measureText(title);ctx.fillText(title,title_height+.5*measure.width,.2*-title_height),ctx.textAlign="left"}else ctx.textAlign="left",ctx.fillText(title,title_height,.2*-title_height)}node.onDrawTitle&&node.onDrawTitle(ctx)}selected&&(node.onBounding&&node.onBounding(area),title_mode==LiteGraph.TRANSPARENT_TITLE&&(area[1]-=title_height,area[3]+=title_height),ctx.lineWidth=1,ctx.globalAlpha=.8,ctx.beginPath(),shape==LiteGraph.BOX_SHAPE?ctx.rect(-6+area[0],-6+area[1],12+area[2],12+area[3]):shape==LiteGraph.ROUND_SHAPE||shape==LiteGraph.CARD_SHAPE&&node.flags.collapsed?ctx.roundRect(-6+area[0],-6+area[1],12+area[2],12+area[3],2*this.round_radius):shape==LiteGraph.CARD_SHAPE?ctx.roundRect(-6+area[0],-6+area[1],12+area[2],12+area[3],2*this.round_radius,2):shape==LiteGraph.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0]+6,0,2*Math.PI),ctx.strokeStyle="#FFF",ctx.stroke(),ctx.strokeStyle=fgcolor,ctx.globalAlpha=1)},LGraphCanvas.prototype.drawConnections=function(ctx){var now=LiteGraph.getTime(),visible_area=this.visible_area,margin_area=new Float32Array([visible_area[0]-20,visible_area[1]-20,visible_area[2]+40,visible_area[3]+40]),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);ctx.lineWidth=this.connections_width,ctx.fillStyle="#AAA",ctx.strokeStyle="#AAA",ctx.globalAlpha=this.editor_alpha;for(var nodes=this.graph._nodes,n=0,l=nodes.length;n<l;++n){var node=nodes[n];if(node.inputs&&node.inputs.length)for(var i=0;i<node.inputs.length;++i){var input=node.inputs[i];if(input&&null!=input.link){var link_id=input.link,link=this.graph.links[link_id];if(link){var start_node=this.graph.getNodeById(link.origin_id);if(null!=start_node){var start_node_slot=link.origin_slot,start_node_slotpos=null;start_node_slotpos=-1==start_node_slot?[start_node.pos[0]+10,start_node.pos[1]+10]:start_node.getConnectionPos(!1,start_node_slot,tempA);var end_node_slotpos=node.getConnectionPos(!0,i,tempB);if(link_bounding[0]=start_node_slotpos[0],link_bounding[1]=start_node_slotpos[1],link_bounding[2]=end_node_slotpos[0]-start_node_slotpos[0],link_bounding[3]=end_node_slotpos[1]-start_node_slotpos[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),overlapBounding(link_bounding,margin_area)){var start_slot=start_node.outputs[start_node_slot],end_slot=node.inputs[i];if(start_slot&&end_slot){var start_dir=start_slot.dir||(start_node.flags.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),end_dir=end_slot.dir||(node.flags.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.renderLink(ctx,start_node_slotpos,end_node_slotpos,link,!1,0,null,start_dir,end_dir),link&&link._last_time&&now-link._last_time<1e3){var f=2-.002*(now-link._last_time),tmp=ctx.globalAlpha;ctx.globalAlpha=tmp*f,this.renderLink(ctx,start_node_slotpos,end_node_slotpos,link,!0,f,"white",start_dir,end_dir),ctx.globalAlpha=tmp}}}}}}}}ctx.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(ctx,a,b,link,skip_border,flow,color,start_dir,end_dir){if(!this.highquality_render)return ctx.beginPath(),ctx.moveTo(a[0],a[1]),ctx.lineTo(b[0],b[1]),void ctx.stroke();start_dir=start_dir||LiteGraph.RIGHT,end_dir=end_dir||LiteGraph.LEFT;var dist=distance(a,b);if(this.render_connections_border&&this.scale>.6&&(ctx.lineWidth=this.connections_width+4),!color&&link&&(color=link.color||LGraphCanvas.link_type_colors[link.type]),color||(color=this.default_link_color),null!=link&&this.highlighted_links[link.id]&&(color="#FFF"),ctx.beginPath(),this.render_curved_connections){ctx.moveTo(a[0],a[1]);var start_offset_x=0,start_offset_y=0,end_offset_x=0,end_offset_y=0;switch(start_dir){case LiteGraph.LEFT:start_offset_x=-.25*dist;break;case LiteGraph.RIGHT:start_offset_x=.25*dist;break;case LiteGraph.UP:start_offset_y=-.25*dist;break;case LiteGraph.DOWN:start_offset_y=.25*dist}switch(end_dir){case LiteGraph.LEFT:end_offset_x=-.25*dist;break;case LiteGraph.RIGHT:end_offset_x=.25*dist;break;case LiteGraph.UP:end_offset_y=-.25*dist;break;case LiteGraph.DOWN:end_offset_y=.25*dist}ctx.bezierCurveTo(a[0]+start_offset_x,a[1]+start_offset_y,b[0]+end_offset_x,b[1]+end_offset_y,b[0],b[1])}else ctx.moveTo(a[0]+10,a[1]),ctx.lineTo(.5*(a[0]+10+(b[0]-10)),a[1]),ctx.lineTo(.5*(a[0]+10+(b[0]-10)),b[1]),ctx.lineTo(b[0]-10,b[1]);if(this.render_connections_border&&this.scale>.6&&!skip_border&&(ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.stroke()),ctx.lineWidth=this.connections_width,ctx.fillStyle=ctx.strokeStyle=color,ctx.stroke(),this.render_connection_arrows&&this.scale>=.6&&this.render_connection_arrows&&this.scale>.6){var pos=this.computeConnectionPoint(a,b,.5,start_dir,end_dir),pos2=this.computeConnectionPoint(a,b,.51,start_dir,end_dir),angle=0;angle=this.render_curved_connections?-Math.atan2(pos2[0]-pos[0],pos2[1]-pos[1]):b[1]>a[1]?0:Math.PI,ctx.save(),ctx.translate(pos[0],pos[1]),ctx.rotate(angle),ctx.beginPath(),ctx.moveTo(-5,-5),ctx.lineTo(0,5),ctx.lineTo(5,-5),ctx.fill(),ctx.restore()}if(flow)for(var i=0;i<5;++i){var f=(.001*LiteGraph.getTime()+.2*i)%1;pos=this.computeConnectionPoint(a,b,f,start_dir,end_dir);ctx.beginPath(),ctx.arc(pos[0],pos[1],5,0,2*Math.PI),ctx.fill()}},LGraphCanvas.prototype.computeConnectionPoint=function(a,b,t,start_dir,end_dir){start_dir=start_dir||LiteGraph.RIGHT,end_dir=end_dir||LiteGraph.LEFT;var dist=distance(a,b),p0=a,p1=[a[0],a[1]],p2=[b[0],b[1]],p3=b;switch(start_dir){case LiteGraph.LEFT:p1[0]+=-.25*dist;break;case LiteGraph.RIGHT:p1[0]+=.25*dist;break;case LiteGraph.UP:p1[1]+=-.25*dist;break;case LiteGraph.DOWN:p1[1]+=.25*dist}switch(end_dir){case LiteGraph.LEFT:p2[0]+=-.25*dist;break;case LiteGraph.RIGHT:p2[0]+=.25*dist;break;case LiteGraph.UP:p2[1]+=-.25*dist;break;case LiteGraph.DOWN:p2[1]+=.25*dist}var c1=(1-t)*(1-t)*(1-t),c2=(1-t)*(1-t)*3*t,c3=3*(1-t)*(t*t),c4=t*t*t;return[c1*p0[0]+c2*p1[0]+c3*p2[0]+c4*p3[0],c1*p0[1]+c2*p1[1]+c3*p2[1]+c4*p3[1]]},LGraphCanvas.prototype.drawExecutionOrder=function(ctx){ctx.shadowColor="transparent",ctx.globalAlpha=.25,ctx.textAlign="center",ctx.strokeStyle="white",ctx.globalAlpha=.75;for(var visible_nodes=this.visible_nodes,i=0;i<visible_nodes.length;++i){var node=visible_nodes[i];ctx.fillStyle="black",ctx.fillRect(node.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,node.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==node.order&&ctx.strokeRect(node.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,node.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),ctx.fillStyle="#FFF",ctx.fillText(node.order,node.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,node.pos[1]-6)}ctx.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(node,posY,ctx,active_widget){if(!node.widgets||!node.widgets.length)return 0;var width=node.size[0],widgets=node.widgets;posY+=2;var H=LiteGraph.NODE_WIDGET_HEIGHT,show_text=this.scale>.5;ctx.save(),ctx.globalAlpha=this.editor_alpha;for(var i=0;i<widgets.length;++i){var w=widgets[i],y=posY;switch(w.y&&(y=w.y),w.last_y=y,ctx.strokeStyle="#AAA",ctx.fillStyle="#222",ctx.textAlign="left",w.type){case"button":w.clicked&&(ctx.fillStyle="#AAA",w.clicked=!1,this.dirty_canvas=!0),ctx.fillRect(10,y,width-20,H),ctx.strokeRect(10,y,width-20,H),show_text&&(ctx.textAlign="center",ctx.fillStyle="#AAA",ctx.fillText(w.name,.5*width,y+.7*H));break;case"toggle":ctx.textAlign="left",ctx.strokeStyle="#AAA",ctx.fillStyle="#111",ctx.beginPath(),ctx.roundRect(10,posY,width-20,H,.5*H),ctx.fill(),ctx.stroke(),ctx.fillStyle=w.value?"#89A":"#333",ctx.beginPath(),ctx.arc(width-20,y+.5*H,.36*H,0,2*Math.PI),ctx.fill(),show_text&&(ctx.fillStyle="#999",null!=w.name&&ctx.fillText(w.name,20,y+.7*H),ctx.fillStyle=w.value?"#DDD":"#888",ctx.textAlign="right",ctx.fillText(w.value?w.options.on||"true":w.options.off||"false",width-30,y+.7*H));break;case"slider":ctx.fillStyle="#111",ctx.fillRect(10,y,width-20,H);var range=w.options.max-w.options.min,nvalue=(w.value-w.options.min)/range;ctx.fillStyle=active_widget==w?"#89A":"#678",ctx.fillRect(10,y,nvalue*(width-20),H),ctx.strokeRect(10,y,width-20,H),show_text&&(ctx.textAlign="center",ctx.fillStyle="#DDD",ctx.fillText(w.name+"  "+Number(w.value).toFixed(3),.5*width,y+.7*H));break;case"number":case"combo":ctx.textAlign="left",ctx.strokeStyle="#AAA",ctx.fillStyle="#111",ctx.beginPath(),ctx.roundRect(10,posY,width-20,H,.5*H),ctx.fill(),ctx.stroke(),show_text&&(ctx.fillStyle="#AAA",ctx.beginPath(),ctx.moveTo(26,posY+5),ctx.lineTo(16,posY+.5*H),ctx.lineTo(26,posY+H-5),ctx.moveTo(width-26,posY+5),ctx.lineTo(width-16,posY+.5*H),ctx.lineTo(width-26,posY+H-5),ctx.fill(),ctx.fillStyle="#999",ctx.fillText(w.name,30,y+.7*H),ctx.fillStyle="#DDD",ctx.textAlign="right","number"==w.type?ctx.fillText(Number(w.value).toFixed(void 0!==w.options.precision?w.options.precision:3),width-40,y+.7*H):ctx.fillText(w.value,width-40,y+.7*H));break;case"text":ctx.textAlign="left",ctx.strokeStyle="#AAA",ctx.fillStyle="#111",ctx.beginPath(),ctx.roundRect(10,posY,width-20,H,.5*H),ctx.fill(),ctx.stroke(),show_text&&(ctx.fillStyle="#999",null!=w.name&&ctx.fillText(w.name,20,y+.7*H),ctx.fillStyle="#DDD",ctx.textAlign="right",ctx.fillText(w.value,width-20,y+.7*H));break;default:w.draw&&w.draw(ctx,node,w,y,H)}posY+=H+4}ctx.restore()},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length)return null;for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],that=this,ref_window=this.getCanvasWindow(),i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w==active_widget||x>6&&x<width-12&&y>w.last_y&&y<w.last_y+LiteGraph.NODE_WIDGET_HEIGHT){switch(w.type){case"button":w.callback&&setTimeout(function(){w.callback(w,that,node,pos)},20),w.clicked=!0,this.dirty_canvas=!0;break;case"slider":w.options.max,w.options.min;var nvalue=Math.clamp((x-10)/(width-20),0,1);w.value=w.options.min+(w.options.max-w.options.min)*nvalue,w.callback&&setTimeout(function(){w.callback(w.value,that,node,pos)},20),this.dirty_canvas=!0;break;case"number":case"combo":if("mousemove"==event.type&&"number"==w.type)w.value+=.1*event.deltaX*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if("mousedown"==event.type){var values=w.options.values;values&&values.constructor===Function&&(values=w.options.values(w,node));var delta=x<40?-1:x>width-40?1:0;if("number"==w.type)w.value+=.1*delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if(delta){var index=values.indexOf(w.value)+delta;index>=values.length&&(index=0),index<0&&(index=values.length-1),w.value=values[index]}else{new LiteGraph.ContextMenu(values,{event:event,className:"dark",callback:inner_clicked.bind(w)},ref_window);function inner_clicked(v,option,event){return this.value=v,that.dirty_canvas=!0,!1}}}w.callback&&setTimeout(function(){this.callback(this.value,that,node,pos)}.bind(w),20),this.dirty_canvas=!0;break;case"toggle":"mousedown"==event.type&&(w.value=!w.value,w.callback&&setTimeout(function(){w.callback(w.value,that,node,pos)},20));break;case"text":"mousedown"==event.type&&this.prompt("Value",w.value,function(v){this.value=v,w.callback&&w.callback(v,that,node)}.bind(w),event);break;default:w.mouse&&w.mouse(ctx,event,[x,y],node)}return w}}return null},LGraphCanvas.prototype.drawGroups=function(canvas,ctx){if(this.graph){var groups=this.graph._groups;ctx.save(),ctx.globalAlpha=.5*this.editor_alpha;for(var i=0;i<groups.length;++i){var group=groups[i];if(overlapBounding(this.visible_area,group._bounding)){ctx.fillStyle=group.color||"#335",ctx.strokeStyle=group.color||"#335";var pos=group._pos,size=group._size;ctx.globalAlpha=.25*this.editor_alpha,ctx.beginPath(),ctx.rect(pos[0]+.5,pos[1]+.5,size[0],size[1]),ctx.fill(),ctx.globalAlpha=this.editor_alpha,ctx.stroke(),ctx.beginPath(),ctx.moveTo(pos[0]+size[0],pos[1]+size[1]),ctx.lineTo(pos[0]+size[0]-10,pos[1]+size[1]),ctx.lineTo(pos[0]+size[0],pos[1]+size[1]-10),ctx.fill();var font_size=group.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;ctx.font=font_size+"px Arial",ctx.fillText(group.title,pos[0]+4,pos[1]+font_size)}}ctx.restore()}},LGraphCanvas.prototype.resize=function(width,height){if(!width&&!height){var parent=this.canvas.parentNode;width=parent.offsetWidth,height=parent.offsetHeight}this.canvas.width==width&&this.canvas.height==height||(this.canvas.width=width,this.canvas.height=height,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(transition){if(!transition)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var self=this,delta=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var t=setInterval(function(){self.editor_alpha*=delta,self.dirty_canvas=!0,self.dirty_bgcanvas=!0,delta<1&&self.editor_alpha<.01&&(clearInterval(t),delta<1&&(self.live_mode=!0)),delta>1&&self.editor_alpha>.99&&(clearInterval(t),self.editor_alpha=1)},1)},LGraphCanvas.prototype.onNodeSelectionChange=function(node){},LGraphCanvas.prototype.touchHandler=function(event){var first=event.changedTouches[0],type="";switch(event.type){case"touchstart":type="mousedown";break;case"touchmove":type="mousemove";break;case"touchend":type="mouseup";break;default:return}var window=this.getCanvasWindow(),simulatedEvent=window.document.createEvent("MouseEvent");simulatedEvent.initMouseEvent(type,!0,!0,window,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,null),first.target.dispatchEvent(simulatedEvent),event.preventDefault()},LGraphCanvas.onGroupAdd=function(info,entry,mouse_event){var canvas=LGraphCanvas.active_canvas,group=(canvas.getCanvasWindow(),new LiteGraph.LGraphGroup);group.pos=canvas.convertEventToCanvas(mouse_event),canvas.graph.add(group)},LGraphCanvas.onMenuAdd=function(node,options,e,prev_menu){var canvas=LGraphCanvas.active_canvas,ref_window=canvas.getCanvasWindow(),values=LiteGraph.getNodeTypesCategories(),entries=[];for(var i in values)values[i]&&entries.push({value:values[i],content:values[i],has_submenu:!0});var menu=new LiteGraph.ContextMenu(entries,{event:e,callback:function(v,option,e){var category=v.value,node_types=LiteGraph.getNodeTypesInCategory(category,canvas.filter),values=[];for(var i in node_types)node_types[i].skip_list||values.push({content:node_types[i].title,value:node_types[i].type});return new LiteGraph.ContextMenu(values,{event:e,callback:inner_create,parentMenu:menu},ref_window),!1},parentMenu:prev_menu},ref_window);function inner_create(v,e){var first_event=prev_menu.getFirstEvent(),node=LiteGraph.createNode(v.value);node&&(node.pos=canvas.convertEventToCanvas(first_event),canvas.graph.add(node))}return!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(v,options,e,prev_menu,node){if(node){var that=this,ref_window=LGraphCanvas.active_canvas.getCanvasWindow();options=node.optional_inputs;node.onGetInputs&&(options=node.onGetInputs());var entries=[];if(options)for(var i in options){var entry=options[i];if(entry){var label=entry[0];entry[2]&&entry[2].label&&(label=entry[2].label);var data={content:label,value:entry};entry[1]==LiteGraph.ACTION&&(data.className="event"),entries.push(data)}else entries.push(null)}if(this.onMenuNodeInputs&&(entries=this.onMenuNodeInputs(entries)),entries.length){new LiteGraph.ContextMenu(entries,{event:e,callback:function(v,e,prev){if(!node)return;v.callback&&v.callback.call(that,node,v,e,prev);v.value&&(node.addInput(v.value[0],v.value[1],v.value[2]),node.setDirtyCanvas(!0,!0))},parentMenu:prev_menu,node:node},ref_window);return!1}}},LGraphCanvas.showMenuNodeOptionalOutputs=function(v,options,e,prev_menu,node){if(node){var that=this,ref_window=LGraphCanvas.active_canvas.getCanvasWindow();options=node.optional_outputs;node.onGetOutputs&&(options=node.onGetOutputs());var entries=[];if(options)for(var i in options){var entry=options[i];if(entry){if(!node.flags||!node.flags.skip_repeated_outputs||-1==node.findOutputSlot(entry[0])){var label=entry[0];entry[2]&&entry[2].label&&(label=entry[2].label);var data={content:label,value:entry};entry[1]==LiteGraph.EVENT&&(data.className="event"),entries.push(data)}}else entries.push(null)}if(this.onMenuNodeOutputs&&(entries=this.onMenuNodeOutputs(entries)),entries.length){new LiteGraph.ContextMenu(entries,{event:e,callback:function inner_clicked(v,e,prev){if(!node)return;v.callback&&v.callback.call(that,node,v,e,prev);if(!v.value)return;var value=v.value[1];if(value&&(value.constructor===Object||value.constructor===Array)){var entries=[];for(var i in value)entries.push({content:i,value:value[i]});return new LiteGraph.ContextMenu(entries,{event:e,callback:inner_clicked,parentMenu:prev_menu,node:node}),!1}node.addOutput(v.value[0],v.value[1],v.value[2]),node.setDirtyCanvas(!0,!0)},parentMenu:prev_menu,node:node},ref_window);return!1}}},LGraphCanvas.onShowMenuNodeProperties=function(value,options,e,prev_menu,node){if(node&&node.properties){var canvas=LGraphCanvas.active_canvas,ref_window=canvas.getCanvasWindow(),entries=[];for(var i in node.properties){value=void 0!==node.properties[i]?node.properties[i]:" ";value=LGraphCanvas.decodeHTML(value),entries.push({content:"<span class='property_name'>"+i+"</span><span class='property_value'>"+value+"</span>",value:i})}if(entries.length){new LiteGraph.ContextMenu(entries,{event:e,callback:function(v,options,e,prev){if(!node)return;var rect=this.getBoundingClientRect();canvas.showEditPropertyValue(node,v.value,{position:[rect.left,rect.top]})},parentMenu:prev_menu,allow_html:!0,node:node},ref_window);return!1}}},LGraphCanvas.decodeHTML=function(str){var e=document.createElement("div");return e.innerText=str,e.innerHTML},LGraphCanvas.onResizeNode=function(value,options,e,menu,node){node&&(node.size=node.computeSize(),node.setDirtyCanvas(!0,!0))},LGraphCanvas.onShowPropertyEditor=function(item,options,e,menu,node){var property=item.property||"title",value=node[property],dialog=document.createElement("div");dialog.className="graphdialog",dialog.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",dialog.querySelector(".name").innerText=property;var input=dialog.querySelector("input");input&&(input.value=value,input.addEventListener("blur",function(e){this.focus()}),input.addEventListener("keydown",function(e){13==e.keyCode&&(inner(),e.preventDefault(),e.stopPropagation())}));var canvas=LGraphCanvas.active_canvas.canvas,rect=canvas.getBoundingClientRect(),offsetx=-20,offsety=-20;function inner(){!function(value){"Number"==item.type?value=Number(value):"Boolean"==item.type&&(value=Boolean(value));node[property]=value,dialog.parentNode.removeChild(dialog),node.setDirtyCanvas(!0,!0)}(input.value)}rect&&(offsetx-=rect.left,offsety-=rect.top),event?(dialog.style.left=event.pageX+offsetx+"px",dialog.style.top=event.pageY+offsety+"px"):(dialog.style.left=.5*canvas.width+offsetx+"px",dialog.style.top=.5*canvas.height+offsety+"px"),dialog.querySelector("button").addEventListener("click",inner),canvas.parentNode.appendChild(dialog)},LGraphCanvas.prototype.prompt=function(title,value,callback,event){var that=this;title=title||"";var dialog=document.createElement("div");dialog.className="graphdialog rounded",dialog.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",dialog.close=function(){that.prompt_box=null,dialog.parentNode.removeChild(dialog)},dialog.addEventListener("mouseleave",function(e){dialog.close()}),that.prompt_box&&that.prompt_box.close(),that.prompt_box=dialog;dialog.querySelector(".name").innerText=title,dialog.querySelector(".value").value=value;var input=dialog.querySelector("input");input.addEventListener("keydown",function(e){if(27==e.keyCode)dialog.close();else{if(13!=e.keyCode)return;callback&&callback(this.value),dialog.close()}e.preventDefault(),e.stopPropagation()}),dialog.querySelector("button").addEventListener("click",function(e){callback&&callback(input.value),that.setDirty(!0),dialog.close()});var canvas=LGraphCanvas.active_canvas.canvas,rect=canvas.getBoundingClientRect(),offsetx=-20,offsety=-20;return rect&&(offsetx-=rect.left,offsety-=rect.top),event?(dialog.style.left=event.pageX+offsetx+"px",dialog.style.top=event.pageY+offsety+"px"):(dialog.style.left=.5*canvas.width+offsetx+"px",dialog.style.top=.5*canvas.height+offsety+"px"),canvas.parentNode.appendChild(dialog),setTimeout(function(){input.focus()},10),dialog},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(event){var that=this,dialog=document.createElement("div");dialog.className="litegraph litesearchbox graphdialog rounded",dialog.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/><div class='helper'></div>",dialog.close=function(){that.search_box=null,dialog.parentNode.removeChild(dialog)},dialog.addEventListener("mouseleave",function(e){dialog.close()}),that.search_box&&that.search_box.close(),that.search_box=dialog;var helper=dialog.querySelector(".helper"),first=null,timeout=null,selected=null,input=dialog.querySelector("input");input&&(input.addEventListener("blur",function(e){this.focus()}),input.addEventListener("keydown",function(e){if(38==e.keyCode)changeSelection(!1);else if(40==e.keyCode)changeSelection(!0);else if(27==e.keyCode)dialog.close();else{if(13!=e.keyCode)return timeout&&clearInterval(timeout),void(timeout=setTimeout(refreshHelper,10));selected?select(selected.innerHTML):first?select(first):dialog.close()}e.preventDefault(),e.stopPropagation()}));var graphcanvas=LGraphCanvas.active_canvas,canvas=graphcanvas.canvas,rect=canvas.getBoundingClientRect(),offsetx=-20,offsety=-20;function select(name){if(name)if(that.onSearchBoxSelection)that.onSearchBoxSelection(name,event,graphcanvas);else{var extra=LiteGraph.searchbox_extras[name];extra&&(name=extra.type);var node=LiteGraph.createNode(name);if(node&&(node.pos=graphcanvas.convertEventToCanvas(event),graphcanvas.graph.add(node)),extra&&extra.data){if(extra.data.properties)for(var i in extra.data.properties)node.addProperty(extra.data.properties[i][0],extra.data.properties[i][0]);if(extra.data.inputs)for(var i in node.inputs=[],extra.data.inputs)node.addOutput(extra.data.inputs[i][0],extra.data.inputs[i][1]);if(extra.data.outputs)for(var i in node.outputs=[],extra.data.outputs)node.addOutput(extra.data.outputs[i][0],extra.data.outputs[i][1]);extra.data.title&&(node.title=extra.data.title),extra.data.json&&node.configure(extra.data.json)}}dialog.close()}function changeSelection(forward){var prev=selected;selected&&selected.classList.remove("selected"),selected?(selected=forward?selected.nextSibling:selected.previousSibling)||(selected=prev):selected=forward?helper.childNodes[0]:helper.childNodes[helper.childNodes.length],selected&&(selected.classList.add("selected"),selected.scrollIntoView())}function refreshHelper(){timeout=null;var str=input.value;if(first=null,helper.innerHTML="",str)if(that.onSearchBox){var list=that.onSearchBox(help,str,graphcanvas);if(list)for(var i=0;i<list.length;++i)addResult(list[i])}else{var c=0;for(var i in str=str.toLowerCase(),LiteGraph.searchbox_extras){var extra=LiteGraph.searchbox_extras[i];if(-1!==extra.desc.toLowerCase().indexOf(str)&&(addResult(extra.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit&&c++>LGraphCanvas.search_limit))break}if(Array.prototype.filter){var filtered=Object.keys(LiteGraph.registered_node_types).filter(function(item){return-1!==item.toLowerCase().indexOf(str)});for(i=0;i<filtered.length&&(addResult(filtered[i]),!(-1!==LGraphCanvas.search_limit&&c++>LGraphCanvas.search_limit));i++);}else for(var i in LiteGraph.registered_node_types)if(-1!=i.indexOf(str)&&(addResult(i),-1!==LGraphCanvas.search_limit&&c++>LGraphCanvas.search_limit))break}function addResult(type,className){var help=document.createElement("div");first||(first=type),help.innerText=type,help.dataset.type=escape(type),help.className="litegraph lite-search-item",className&&(help.className+=" "+className),help.addEventListener("click",function(e){select(unescape(this.dataset.type))}),helper.appendChild(help)}}return rect&&(offsetx-=rect.left,offsety-=rect.top),event?(dialog.style.left=event.pageX+offsetx+"px",dialog.style.top=event.pageY+offsety+"px"):(dialog.style.left=.5*canvas.width+offsetx+"px",dialog.style.top=.5*canvas.height+offsety+"px"),canvas.parentNode.appendChild(dialog),input.focus(),dialog},LGraphCanvas.prototype.showEditPropertyValue=function(node,property,options){if(node&&void 0!==node.properties[property]){options=options||{};var type="string";null!==node.properties[property]&&(type=typeof node.properties[property]),"object"==type&&node.properties[property].length&&(type="array");var info=null;if(node.getPropertyInfo&&(info=node.getPropertyInfo(property)),node.properties_info)for(var i=0;i<node.properties_info.length;++i)if(node.properties_info[i].name==property){info=node.properties_info[i];break}null!=info&&info.type&&(type=info.type);var input_html="";if("string"==type||"number"==type||"array"==type)input_html="<input autofocus type='text' class='value'/>";else if("enum"==type&&info.values){for(var i in input_html="<select autofocus type='text' class='value'>",info.values){var v=info.values.constructor===Array?info.values[i]:i;input_html+="<option value='"+v+"' "+(v==node.properties[property]?"selected":"")+">"+info.values[i]+"</option>"}input_html+="</select>"}else{if("boolean"!=type)return void console.warn("unknown type: "+type);input_html="<input autofocus type='checkbox' class='value' "+(node.properties[property]?"checked":"")+"/>"}var dialog=this.createDialog("<span class='name'>"+property+"</span>"+input_html+"<button>OK</button>",options);if("enum"==type&&info.values)(input=dialog.querySelector("select")).addEventListener("change",function(e){setValue(e.target.value)});else if("boolean"==type){(input=dialog.querySelector("input"))&&input.addEventListener("click",function(e){setValue(!!input.checked)})}else{var input;(input=dialog.querySelector("input"))&&(input.addEventListener("blur",function(e){this.focus()}),input.value=void 0!==node.properties[property]?node.properties[property]:"",input.addEventListener("keydown",function(e){13==e.keyCode&&(inner(),e.preventDefault(),e.stopPropagation())}))}dialog.querySelector("button").addEventListener("click",inner)}function inner(){setValue(input.value)}function setValue(value){"number"==typeof node.properties[property]&&(value=Number(value)),"array"==type&&(value=value.split(",").map(Number)),node.properties[property]=value,node._graph&&node._graph._version++,node.onPropertyChanged&&node.onPropertyChanged(property,value),dialog.close(),node.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.createDialog=function(html,options){options=options||{};var dialog=document.createElement("div");dialog.className="graphdialog",dialog.innerHTML=html;var rect=this.canvas.getBoundingClientRect(),offsetx=-20,offsety=-20;return rect&&(offsetx-=rect.left,offsety-=rect.top),options.position?(offsetx+=options.position[0],offsety+=options.position[1]):options.event?(offsetx+=options.event.pageX,offsety+=options.event.pageY):(offsetx+=.5*this.canvas.width,offsety+=.5*this.canvas.height),dialog.style.left=offsetx+"px",dialog.style.top=offsety+"px",this.canvas.parentNode.appendChild(dialog),dialog.close=function(){this.parentNode&&this.parentNode.removeChild(this)},dialog},LGraphCanvas.onMenuNodeCollapse=function(value,options,e,menu,node){node.collapse()},LGraphCanvas.onMenuNodePin=function(value,options,e,menu,node){node.pin()},LGraphCanvas.onMenuNodeMode=function(value,options,e,menu,node){return new LiteGraph.ContextMenu(["Always","On Event","On Trigger","Never"],{event:e,callback:function(v){if(!node)return;switch(v){case"On Event":node.mode=LiteGraph.ON_EVENT;break;case"On Trigger":node.mode=LiteGraph.ON_TRIGGER;break;case"Never":node.mode=LiteGraph.NEVER;break;case"Always":default:node.mode=LiteGraph.ALWAYS}},parentMenu:menu,node:node}),!1},LGraphCanvas.onMenuNodeColors=function(value,options,e,menu,node){if(!node)throw"no node for color";var values=[];for(var i in values.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),LGraphCanvas.node_colors){var color=LGraphCanvas.node_colors[i];value={value:i,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+color.color+"; background-color:"+color.bgcolor+"'>"+i+"</span>"};values.push(value)}return new LiteGraph.ContextMenu(values,{event:e,callback:function(v){if(!node)return;var color=v.value?LGraphCanvas.node_colors[v.value]:null;color?node.constructor===LiteGraph.LGraphGroup?node.color=color.groupcolor:(node.color=color.color,node.bgcolor=color.bgcolor):(delete node.color,delete node.bgcolor);node.setDirtyCanvas(!0,!0)},parentMenu:menu,node:node}),!1},LGraphCanvas.onMenuNodeShapes=function(value,options,e,menu,node){if(!node)throw"no node passed";return new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:e,callback:function(v){if(!node)return;node.shape=v,node.setDirtyCanvas(!0)},parentMenu:menu,node:node}),!1},LGraphCanvas.onMenuNodeRemove=function(value,options,e,menu,node){if(!node)throw"no node passed";!1!==node.removable&&(node.graph.remove(node),node.setDirtyCanvas(!0,!0))},LGraphCanvas.onMenuNodeClone=function(value,options,e,menu,node){if(0!=node.clonable){var newnode=node.clone();newnode&&(newnode.pos=[node.pos[0]+5,node.pos[1]+5],node.graph.add(newnode),node.setDirtyCanvas(!0,!0))}},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var options=null;if(this.getMenuOptions?options=this.getMenuOptions():(options=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],this._graph_stack&&this._graph_stack.length>0&&options.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var extra=this.getExtraMenuOptions(this,options);extra&&(options=options.concat(extra))}return options},LGraphCanvas.prototype.getNodeMenuOptions=function(node){var options=null;if(options=node.getMenuOptions?node.getMenuOptions(this):[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode},{content:"Resize",callback:LGraphCanvas.onResizeNode},{content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null],node.onGetInputs){var inputs=node.onGetInputs();inputs&&inputs.length&&(options[0].disabled=!1)}if(node.onGetOutputs){var outputs=node.onGetOutputs();outputs&&outputs.length&&(options[1].disabled=!1)}if(node.getExtraMenuOptions){var extra=node.getExtraMenuOptions(this);extra&&(extra.push(null),options=extra.concat(options))}return!1!==node.clonable&&options.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),!1!==node.removable&&options.push(null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}),node.graph&&node.graph.onGetNodeMenuOptions&&node.graph.onGetNodeMenuOptions(options,node),options},LGraphCanvas.prototype.getGroupMenuOptions=function(node){return[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]},LGraphCanvas.prototype.processContextMenu=function(node,event){var that=this,ref_window=LGraphCanvas.active_canvas.getCanvasWindow(),menu_info=null,options={event:event,callback:function(v,options,e){if(!v)return;if("Remove Slot"==v.content){var info=v.slot;return void(info.input?node.removeInput(info.slot):info.output&&node.removeOutput(info.slot))}if("Disconnect Links"==v.content){var info=v.slot;return void(info.output?node.disconnectOutput(info.slot):info.input&&node.disconnectInput(info.slot))}if("Rename Slot"==v.content){var info=v.slot,slot_info=info.input?node.getInputInfo(info.slot):node.getOutputInfo(info.slot),dialog=that.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",options),input=dialog.querySelector("input");input&&slot_info&&(input.value=slot_info.label),dialog.querySelector("button").addEventListener("click",function(e){input.value&&(slot_info&&(slot_info.label=input.value),that.setDirty(!0)),dialog.close()})}},extra:node},slot=null;if(node&&(slot=node.getSlotInPosition(event.canvasX,event.canvasY),LGraphCanvas.active_node=node),slot)menu_info=[],slot&&slot.output&&slot.output.links&&slot.output.links.length&&menu_info.push({content:"Disconnect Links",slot:slot}),menu_info.push(slot.locked?"Cannot remove":{content:"Remove Slot",slot:slot}),menu_info.push(slot.nameLocked?"Cannot rename":{content:"Rename Slot",slot:slot}),options.title=(slot.input?slot.input.type:slot.output.type)||"*",slot.input&&slot.input.type==LiteGraph.ACTION&&(options.title="Action"),slot.output&&slot.output.type==LiteGraph.EVENT&&(options.title="Event");else if(node)menu_info=this.getNodeMenuOptions(node);else{menu_info=this.getCanvasMenuOptions();var group=this.graph.getGroupOnPos(event.canvasX,event.canvasY);group&&menu_info.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:group,options:this.getGroupMenuOptions(group)}})}if(menu_info)new LiteGraph.ContextMenu(menu_info,options,ref_window)},this.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.roundRect=function(x,y,width,height,radius,radius_low){void 0===radius&&(radius=5),void 0===radius_low&&(radius_low=radius),this.moveTo(x+radius,y),this.lineTo(x+width-radius,y),this.quadraticCurveTo(x+width,y,x+width,y+radius),this.lineTo(x+width,y+height-radius_low),this.quadraticCurveTo(x+width,y+height,x+width-radius_low,y+height),this.lineTo(x+radius_low,y+height),this.quadraticCurveTo(x,y+height,x,y+height-radius_low),this.lineTo(x,y+radius),this.quadraticCurveTo(x,y,x+radius,y)}),LiteGraph.compareObjects=function(a,b){for(var i in a)if(a[i]!=b[i])return!1;return!0},LiteGraph.distance=distance,LiteGraph.colorToString=function(c){return"rgba("+Math.round(255*c[0]).toFixed()+","+Math.round(255*c[1]).toFixed()+","+Math.round(255*c[2]).toFixed()+","+(4==c.length?c[3].toFixed(2):"1.0")+")"},LiteGraph.isInsideRectangle=isInsideRectangle,LiteGraph.growBounding=function(bounding,x,y){x<bounding[0]?bounding[0]=x:x>bounding[2]&&(bounding[2]=x),y<bounding[1]?bounding[1]=y:y>bounding[3]&&(bounding[3]=y)},LiteGraph.isInsideBounding=function(p,bb){return!(p[0]<bb[0][0]||p[1]<bb[0][1]||p[0]>bb[1][0]||p[1]>bb[1][1])},LiteGraph.overlapBounding=overlapBounding,LiteGraph.hex2num=function(hex){"#"==hex.charAt(0)&&(hex=hex.slice(1)),hex=hex.toUpperCase();for(var int1,int2,value=new Array(3),k=0,i=0;i<6;i+=2)int1="0123456789ABCDEF".indexOf(hex.charAt(i)),int2="0123456789ABCDEF".indexOf(hex.charAt(i+1)),value[k]=16*int1+int2,k++;return value},LiteGraph.num2hex=function(triplet){for(var int1,int2,hex="#",i=0;i<3;i++)int1=triplet[i]/16,int2=triplet[i]%16,hex+="0123456789ABCDEF".charAt(int1)+"0123456789ABCDEF".charAt(int2);return hex},ContextMenu.prototype.addItem=function(name,value,options){var that=this;options=options||{};var element=document.createElement("div");element.className="litemenu-entry submenu";var disabled=!1;function inner_onclick(e){var value=this.value,close_parent=!0;(that.current_submenu&&that.current_submenu.close(e),options.callback)&&(!0===options.callback.call(this,value,options,e,that,options.node)&&(close_parent=!1));if(value){if(value.callback&&!options.ignore_item_callbacks&&!0!==value.disabled)!0===value.callback.call(this,value,options,e,that,options.extra)&&(close_parent=!1);if(value.submenu){if(!value.submenu.options)throw"ContextMenu submenu needs options";new that.constructor(value.submenu.options,{callback:value.submenu.callback,event:e,parentMenu:that,ignore_item_callbacks:value.submenu.ignore_item_callbacks,title:value.submenu.title,extra:value.submenu.extra,autoopen:options.autoopen});close_parent=!1}}close_parent&&!that.lock&&that.close()}return null===value?element.classList.add("separator"):(element.innerHTML=value&&value.title?value.title:name,element.value=value,value&&(value.disabled&&(disabled=!0,element.classList.add("disabled")),(value.submenu||value.has_submenu)&&element.classList.add("has_submenu")),"function"==typeof value?(element.dataset.value=name,element.onclick_callback=value):element.dataset.value=value,value.className&&(element.className+=" "+value.className)),this.root.appendChild(element),disabled||element.addEventListener("click",inner_onclick),options.autoopen&&element.addEventListener("mouseenter",function(e){var value=this.value;if(!value||!value.has_submenu)return;inner_onclick.call(this,e)}),element},ContextMenu.prototype.close=function(e,ignore_parent_menu){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!ignore_parent_menu&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===e?this.parentMenu.close():e&&!ContextMenu.isCursorOverElement(e,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,"mouseleave",e)),this.current_submenu&&this.current_submenu.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(element,event_name,params,origin){var evt=document.createEvent("CustomEvent");return evt.initCustomEvent(event_name,!0,!0,params),evt.srcElement=origin,element.dispatchEvent?element.dispatchEvent(evt):element.__events&&element.__events.dispatchEvent(evt),evt},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(event,element){var left=event.pageX,top=event.pageY,rect=element.getBoundingClientRect();return!!rect&&(top>rect.top&&top<rect.top+rect.height&&left>rect.left&&left<rect.left+rect.width)},LiteGraph.ContextMenu=ContextMenu,LiteGraph.closeAllContextMenus=function(ref_window){var elements=(ref_window=ref_window||window).document.querySelectorAll(".litecontextmenu");if(elements.length){for(var result=[],i=0;i<elements.length;i++)result.push(elements[i]);for(var i in result)result[i].close?result[i].close():result[i].parentNode&&result[i].parentNode.removeChild(result[i])}},LiteGraph.extendClass=function(target,origin){for(var i in origin)target.hasOwnProperty(i)||(target[i]=origin[i]);if(origin.prototype)for(var i in origin.prototype)origin.prototype.hasOwnProperty(i)&&(target.prototype.hasOwnProperty(i)||(origin.prototype.__lookupGetter__(i)?target.prototype.__defineGetter__(i,origin.prototype.__lookupGetter__(i)):target.prototype[i]=origin.prototype[i],origin.prototype.__lookupSetter__(i)&&target.prototype.__defineSetter__(i,origin.prototype.__lookupSetter__(i))))},LiteGraph.getParameterNames=function(func){return(func+"").replace(/[\/][\/].*$/gm,"").replace(/\s+/g,"").replace(/[\/][*][^\/*]*[*][\/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},Math.clamp=function(v,a,b){return a>v?a:b<v?b:v},"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)})}(exports),void 0!==exports&&(exports.LiteGraph=exports.LiteGraph),function(global){var LiteGraph=exports.LiteGraph;function Time(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}function Subgraph(){this.size=[120,80],this.subgraph=new LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onGlobalInputAdded=this.onSubgraphNewGlobalInput.bind(this),this.subgraph.onGlobalInputRenamed=this.onSubgraphRenamedGlobalInput.bind(this),this.subgraph.onGlobalInputTypeChanged=this.onSubgraphTypeChangeGlobalInput.bind(this),this.subgraph.onGlobalOutputAdded=this.onSubgraphNewGlobalOutput.bind(this),this.subgraph.onGlobalOutputRenamed=this.onSubgraphRenamedGlobalOutput.bind(this),this.subgraph.onGlobalOutputTypeChanged=this.onSubgraphTypeChangeGlobalOutput.bind(this),this.color="#335",this.bgcolor="#557"}function GlobalInput(){var input_name="input_"+(1e3*Math.random()).toFixed();this.addOutput(input_name,null),this.properties={name:input_name,type:null};var that=this;Object.defineProperty(this.properties,"name",{get:function(){return input_name},set:function(v){if(""!=v){var info=that.getOutputInfo(0);info.name!=v&&(info.name=v,that.graph&&that.graph.renameGlobalInput(input_name,v),input_name=v)}},enumerable:!0}),Object.defineProperty(this.properties,"type",{get:function(){return that.outputs[0].type},set:function(v){that.outputs[0].type=v,that.graph&&that.graph.changeGlobalInputType(input_name,that.outputs[0].type)},enumerable:!0})}function GlobalOutput(){var output_name="output_"+(1e3*Math.random()).toFixed();this.addInput(output_name,null),this._value=null,this.properties={name:output_name,type:null};var that=this;Object.defineProperty(this.properties,"name",{get:function(){return output_name},set:function(v){if(""!=v){var info=that.getInputInfo(0);info.name!=v&&(info.name=v,that.graph&&that.graph.renameGlobalOutput(output_name,v),output_name=v)}},enumerable:!0}),Object.defineProperty(this.properties,"type",{get:function(){return that.inputs[0].type},set:function(v){that.inputs[0].type=v,that.graph&&that.graph.changeGlobalInputType(output_name,that.inputs[0].type)},enumerable:!0})}function Constant(){this.addOutput("value","number"),this.addProperty("value",1),this.editable={property:"value",type:"number"}}function Watch(){this.size=[60,20],this.addInput("value",0,{label:""}),this.value=0}function Pass(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,20]}function Console(){this.mode=LiteGraph.ON_EVENT,this.size=[60,20],this.addProperty("msg",""),this.addInput("log",LiteGraph.EVENT),this.addInput("msg",0)}function NodeScript(){this.size=[60,20],this.addProperty("onExecute",""),this.addInput("in",""),this.addInput("in2",""),this.addOutput("out",""),this.addOutput("out2",""),this._func=null}Time.title="Time",Time.desc="Time",Time.prototype.onExecute=function(){this.setOutputData(0,1e3*this.graph.globaltime),this.setOutputData(1,this.graph.globaltime)},LiteGraph.registerNodeType("basic/time",Time),Subgraph.title="Subgraph",Subgraph.desc="Graph inside a node",Subgraph.prototype.onDrawTitle=function(ctx){if(!this.flags.collapsed){ctx.fillStyle="#AAA";var w=LiteGraph.NODE_TITLE_HEIGHT,x=this.size[0]-w;ctx.fillRect(x,-w,w,w),ctx.fillStyle="#333",ctx.beginPath(),ctx.moveTo(x+.2*w,.6*-w),ctx.lineTo(x+.8*w,.6*-w),ctx.lineTo(x+.5*w,.3*-w),ctx.fill()}},Subgraph.prototype.onDblClick=function(e,pos,graphcanvas){var that=this;setTimeout(function(){graphcanvas.openSubgraph(that.subgraph)},10)},Subgraph.prototype.onMouseDown=function(e,pos,graphcanvas){if(!this.flags.collapsed&&pos[0]>this.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&pos[1]<0){var that=this;setTimeout(function(){graphcanvas.openSubgraph(that.subgraph)},10)}},Subgraph.prototype.onSubgraphNewGlobalInput=function(name,type){this.addInput(name,type)},Subgraph.prototype.onSubgraphRenamedGlobalInput=function(oldname,name){var slot=this.findInputSlot(oldname);-1!=slot&&(this.getInputInfo(slot).name=name)},Subgraph.prototype.onSubgraphTypeChangeGlobalInput=function(name,type){var slot=this.findInputSlot(name);-1!=slot&&(this.getInputInfo(slot).type=type)},Subgraph.prototype.onSubgraphNewGlobalOutput=function(name,type){this.addOutput(name,type)},Subgraph.prototype.onSubgraphRenamedGlobalOutput=function(oldname,name){var slot=this.findOutputSlot(oldname);-1!=slot&&(this.getOutputInfo(slot).name=name)},Subgraph.prototype.onSubgraphTypeChangeGlobalOutput=function(name,type){var slot=this.findOutputSlot(name);-1!=slot&&(this.getOutputInfo(slot).type=type)},Subgraph.prototype.getExtraMenuOptions=function(graphcanvas){var that=this;return[{content:"Open",callback:function(){graphcanvas.openSubgraph(that.subgraph)}}]},Subgraph.prototype.onResize=function(size){size[1]+=20},Subgraph.prototype.onExecute=function(){if(this.inputs)for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i],value=this.getInputData(i);this.subgraph.setGlobalInputData(input.name,value)}if(this.subgraph.runStep(),this.outputs)for(i=0;i<this.outputs.length;i++){var output=this.outputs[i];value=this.subgraph.getGlobalOutputData(output.name);this.setOutputData(i,value)}},Subgraph.prototype.configure=function(o){LGraphNode.prototype.configure.call(this,o)},Subgraph.prototype.serialize=function(){var data=LGraphNode.prototype.serialize.call(this);return data.subgraph=this.subgraph.serialize(),data},Subgraph.prototype.clone=function(){var node=LiteGraph.createNode(this.type),data=this.serialize();return delete data.id,delete data.inputs,delete data.outputs,node.configure(data),node},LiteGraph.registerNodeType("graph/subgraph",Subgraph),GlobalInput.title="Input",GlobalInput.desc="Input of the graph",GlobalInput.prototype.onAdded=function(){this.graph.addGlobalInput(this.properties.name,this.properties.type)},GlobalInput.prototype.onExecute=function(){var name=this.properties.name,data=this.graph.global_inputs[name];data&&this.setOutputData(0,data.value)},LiteGraph.registerNodeType("graph/input",GlobalInput),GlobalOutput.title="Output",GlobalOutput.desc="Output of the graph",GlobalOutput.prototype.onAdded=function(){this.graph.addGlobalOutput(this.properties.name,this.properties.type)},GlobalOutput.prototype.getValue=function(){return this._value},GlobalOutput.prototype.onExecute=function(){this._value=this.getInputData(0),this.graph.setGlobalOutputData(this.properties.name,this._value)},LiteGraph.registerNodeType("graph/output",GlobalOutput),Constant.title="Const",Constant.desc="Constant value",Constant.prototype.setValue=function(v){"string"==typeof v&&(v=parseFloat(v)),this.properties.value=v,this.setDirtyCanvas(!0)},Constant.prototype.onExecute=function(){this.setOutputData(0,parseFloat(this.properties.value))},Constant.prototype.onDrawBackground=function(ctx){this.outputs[0].label=this.properties.value.toFixed(3)},LiteGraph.registerNodeType("basic/const",Constant),Watch.title="Watch",Watch.desc="Show value of input",Watch.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},Watch.toString=function(o){if(null==o)return"null";if(o.constructor===Number)return o.toFixed(3);if(o.constructor===Array){for(var str="[",i=0;i<o.length;++i)str+=Watch.toString(o[i])+(i+1!=o.length?",":"");return str+="]"}return String(o)},Watch.prototype.onDrawBackground=function(ctx){this.inputs[0].label=Watch.toString(this.value)},LiteGraph.registerNodeType("basic/watch",Watch),Pass.title="Pass",Pass.desc="Allows to connect different types",Pass.prototype.onExecute=function(){this.setOutputData(0,this.getInputData(0))},LiteGraph.registerNodeType("basic/pass",Pass),Console.title="Console",Console.desc="Show value inside the console",Console.prototype.onAction=function(action,param){"log"==action?console.log(param):"warn"==action?console.warn(param):"error"==action&&console.error(param)},Console.prototype.onExecute=function(){var msg=this.getInputData(1);null!==msg&&(this.properties.msg=msg),console.log(msg)},Console.prototype.onGetInputs=function(){return[["log",LiteGraph.ACTION],["warn",LiteGraph.ACTION],["error",LiteGraph.ACTION]]},LiteGraph.registerNodeType("basic/console",Console),NodeScript.title="Script",NodeScript.desc="executes a code",NodeScript.widgets_info={onExecute:{type:"code"}},NodeScript.prototype.onPropertyChanged=function(name,value){if("onExecute"==name&&LiteGraph.allow_scripts){this._func=null;try{this._func=new Function(value)}catch(err){console.error("Error parsing script"),console.error(err)}}},NodeScript.prototype.onExecute=function(){if(this._func)try{this._func.call(this)}catch(err){console.error("Error in script"),console.error(err)}},LiteGraph.registerNodeType("basic/script",NodeScript)}(),function(global){var LiteGraph=exports.LiteGraph;function LogEvent(){this.size=[60,20],this.addInput("event",LiteGraph.ACTION)}function FilterEvent(){this.size=[60,20],this.addInput("event",LiteGraph.ACTION),this.addOutput("event",LiteGraph.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}function DelayEvent(){this.size=[60,20],this.addProperty("time",1e3),this.addInput("event",LiteGraph.ACTION),this.addOutput("on_time",LiteGraph.EVENT),this._pending=[]}function TimerEvent(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",LiteGraph.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}LogEvent.title="Log Event",LogEvent.desc="Log event in console",LogEvent.prototype.onAction=function(action,param){console.log(action,param)},LiteGraph.registerNodeType("events/log",LogEvent),FilterEvent.title="Filter Event",FilterEvent.desc="Blocks events that do not match the filter",FilterEvent.prototype.onAction=function(action,param){if(null!=param&&(!this.properties.equal_to||this.properties.equal_to==param)){if(this.properties.has_property){var prop=param[this.properties.has_property];if(null==prop)return;if(this.properties.property_equal_to&&this.properties.property_equal_to!=prop)return}this.triggerSlot(0,param)}},LiteGraph.registerNodeType("events/filter",FilterEvent),DelayEvent.title="Delay",DelayEvent.desc="Delays one event",DelayEvent.prototype.onAction=function(action,param){this._pending.push([this.properties.time,param])},DelayEvent.prototype.onExecute=function(){for(var dt=1e3*this.graph.elapsed_time,i=0;i<this._pending.length;++i){var action=this._pending[i];action[0]-=dt,action[0]>0||(this._pending.splice(i,1),--i,this.trigger(null,action[1]))}},DelayEvent.prototype.onGetInputs=function(){return[["event",LiteGraph.ACTION]]},LiteGraph.registerNodeType("events/delay",DelayEvent),TimerEvent.title="Timer",TimerEvent.desc="Sends an event every N milliseconds",TimerEvent.prototype.onStart=function(){this.time=0},TimerEvent.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"},TimerEvent.on_color="#AAA",TimerEvent.off_color="#222",TimerEvent.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?TimerEvent.on_color:TimerEvent.off_color,this.triggered=!1},TimerEvent.prototype.onExecute=function(){var dt=1e3*this.graph.elapsed_time;this.time+=dt,this.last_interval=Math.max(1,0|this.getInputOrProperty("interval")),this.time<this.last_interval||isNaN(this.last_interval)?this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!1):(this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!0))},TimerEvent.prototype.onGetInputs=function(){return[["interval","number"]]},TimerEvent.prototype.onGetOutputs=function(){return[["tick","boolean"]]},LiteGraph.registerNodeType("events/timer",TimerEvent)}(),function(global){var LiteGraph=exports.LiteGraph;function WidgetButton(){this.addOutput("clicked",LiteGraph.EVENT),this.addProperty("text",""),this.addProperty("font_size",40),this.addProperty("message",""),this.size=[64,84]}function WidgetToggle(){this.addInput("","boolean"),this.addInput("e",LiteGraph.ACTION),this.addOutput("v","boolean"),this.addOutput("e",LiteGraph.EVENT),this.properties={font:"",value:!1},this.size=[124,64]}function WidgetNumber(){this.addOutput("","number"),this.size=[74,54],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}function WidgetKnob(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,wcolor:"#7AF",size:50}}function WidgetSliderGUI(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var that=this;this.size=[80,60],this.slider=this.addWidget("slider","V",this.properties.value,function(v){that.properties.value=v},this.properties)}function WidgetHSlider(){this.size=[160,26],this.addOutput("","number"),this.properties={wcolor:"#7AF",min:0,max:1,value:.5}}function WidgetProgress(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,wcolor:"#AAF"}}function WidgetText(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}function WidgetPanel(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}WidgetButton.title="Button",WidgetButton.desc="Triggers an event",WidgetButton.font="Arial",WidgetButton.prototype.onDrawForeground=function(ctx){if(!this.flags.collapsed&&(ctx.fillStyle="black",ctx.fillRect(1,1,this.size[0]-3,this.size[1]-3),ctx.fillStyle="#AAF",ctx.fillRect(0,0,this.size[0]-3,this.size[1]-3),ctx.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",ctx.fillRect(1,1,this.size[0]-4,this.size[1]-4),this.properties.text||0===this.properties.text)){var font_size=this.properties.font_size||30;ctx.textAlign="center",ctx.fillStyle=this.clicked?"black":"white",ctx.font=font_size+"px "+WidgetButton.font,ctx.fillText(this.properties.text,.5*this.size[0],.5*this.size[1]+.3*font_size),ctx.textAlign="left"}},WidgetButton.prototype.onMouseDown=function(e,local_pos){if(local_pos[0]>1&&local_pos[1]>1&&local_pos[0]<this.size[0]-2&&local_pos[1]<this.size[1]-2)return this.clicked=!0,this.trigger("clicked",this.properties.message),!0},WidgetButton.prototype.onMouseUp=function(e){this.clicked=!1},LiteGraph.registerNodeType("widget/button",WidgetButton),WidgetToggle.title="Toggle",WidgetToggle.desc="Toggles between true or false",WidgetToggle.prototype.onDrawForeground=function(ctx){if(!this.flags.collapsed){var size=.5*this.size[1],h=.8*this.size[1];ctx.fillStyle="#AAA",ctx.fillRect(10,h-size,size,size),ctx.fillStyle=this.properties.value?"#AEF":"#000",ctx.fillRect(10+.25*size,h-size+.25*size,.5*size,.5*size),ctx.textAlign="left",ctx.font=this.properties.font||(.8*size).toFixed(0)+"px Arial",ctx.fillStyle="#AAA",ctx.fillText(this.title,size+20,.85*h),ctx.textAlign="left"}},WidgetToggle.prototype.onAction=function(action){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)},WidgetToggle.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&(this.properties.value=v),this.setOutputData(0,this.properties.value)},WidgetToggle.prototype.onMouseDown=function(e,local_pos){if(local_pos[0]>1&&local_pos[1]>1&&local_pos[0]<this.size[0]-2&&local_pos[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0},LiteGraph.registerNodeType("widget/toggle",WidgetToggle),WidgetNumber.title="Number",WidgetNumber.desc="Widget to select number value",WidgetNumber.pixels_threshold=10,WidgetNumber.markers_color="#666",WidgetNumber.prototype.onDrawForeground=function(ctx){var x=.5*this.size[0],h=this.size[1];h>30?(ctx.fillStyle=WidgetNumber.markers_color,ctx.beginPath(),ctx.moveTo(x,.1*h),ctx.lineTo(x+.1*h,.2*h),ctx.lineTo(x+-.1*h,.2*h),ctx.fill(),ctx.beginPath(),ctx.moveTo(x,.9*h),ctx.lineTo(x+.1*h,.8*h),ctx.lineTo(x+-.1*h,.8*h),ctx.fill(),ctx.font=(.7*h).toFixed(1)+"px Arial"):ctx.font=(.8*h).toFixed(1)+"px Arial",ctx.textAlign="center",ctx.font=(.7*h).toFixed(1)+"px Arial",ctx.fillStyle="#EEE",ctx.fillText(this.properties.value.toFixed(this._precision),x,.75*h)},WidgetNumber.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},WidgetNumber.prototype.onPropertyChanged=function(name,value){var t=(this.properties.step+"").split(".");this._precision=t.length>1?t[1].length:0},WidgetNumber.prototype.onMouseDown=function(e,pos){if(!(pos[1]<0))return this.old_y=e.canvasY,this.captureInput(!0),this.mouse_captured=!0,!0},WidgetNumber.prototype.onMouseMove=function(e){if(this.mouse_captured){var delta=this.old_y-e.canvasY;e.shiftKey&&(delta*=10),(e.metaKey||e.altKey)&&(delta*=.1),this.old_y=e.canvasY;var steps=this._remainder+delta/WidgetNumber.pixels_threshold;this._remainder=steps%1,steps|=0;var v=Math.clamp(this.properties.value+steps*this.properties.step,this.properties.min,this.properties.max);this.properties.value=v,this.graph._version++,this.setDirtyCanvas(!0)}},WidgetNumber.prototype.onMouseUp=function(e,pos){if(e.click_time<200){var steps=pos[1]>.5*this.size[1]?-1:1;this.properties.value=Math.clamp(this.properties.value+steps*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)}this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))},LiteGraph.registerNodeType("widget/number",WidgetNumber),WidgetKnob.title="Knob",WidgetKnob.desc="Circular controller",WidgetKnob.widgets=[{name:"increase",text:"+",type:"minibutton"},{name:"decrease",text:"-",type:"minibutton"}],WidgetKnob.prototype.onAdded=function(){this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min),this.imgbg=this.loadImage("imgs/knob_bg.png"),this.imgfg=this.loadImage("imgs/knob_fg.png")},WidgetKnob.prototype.onDrawImageKnob=function(ctx){if(this.imgfg&&this.imgfg.width){var d=.5*this.imgbg.width,scale=this.size[0]/this.imgfg.width;ctx.save(),ctx.translate(0,20),ctx.scale(scale,scale),ctx.drawImage(this.imgbg,0,0),ctx.translate(d,d),ctx.rotate(this.value*(2*Math.PI)*6/8+10*Math.PI/8),ctx.translate(-d,-d),ctx.drawImage(this.imgfg,0,0),ctx.restore(),this.title&&(ctx.font="bold 16px Criticized,Tahoma",ctx.fillStyle="rgba(100,100,100,0.8)",ctx.textAlign="center",ctx.fillText(this.title.toUpperCase(),.5*this.size[0],18),ctx.textAlign="left")}},WidgetKnob.prototype.onDrawVectorKnob=function(ctx){if(this.imgfg&&this.imgfg.width){ctx.lineWidth=1,ctx.strokeStyle=this.mouseOver?"#FFF":"#AAA",ctx.fillStyle="#000",ctx.beginPath(),ctx.arc(.5*this.size[0],.5*this.size[1]+10,.5*this.properties.size,0,2*Math.PI,!0),ctx.stroke(),this.value>0&&(ctx.strokeStyle=this.properties.wcolor,ctx.lineWidth=.2*this.properties.size,ctx.beginPath(),ctx.arc(.5*this.size[0],.5*this.size[1]+10,.35*this.properties.size,-.5*Math.PI+2*Math.PI*this.value,-.5*Math.PI,!0),ctx.stroke(),ctx.lineWidth=1),ctx.font=.2*this.properties.size+"px Arial",ctx.fillStyle="#AAA",ctx.textAlign="center";var str=this.properties.value;"number"==typeof str&&(str=str.toFixed(2)),ctx.fillText(str,.5*this.size[0],.65*this.size[1]),ctx.textAlign="left"}},WidgetKnob.prototype.onDrawForeground=function(ctx){this.onDrawImageKnob(ctx)},WidgetKnob.prototype.onExecute=function(){this.setOutputData(0,this.properties.value),this.boxcolor=LiteGraph.colorToString([this.value,this.value,this.value])},WidgetKnob.prototype.onMouseDown=function(e){if(this.imgfg&&this.imgfg.width)return this.center=[.5*this.size[0],.5*this.size[1]+20],this.radius=.5*this.size[0],!(e.canvasY-this.pos[1]<20||LiteGraph.distance([e.canvasX,e.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius)&&(this.oldmouse=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],this.captureInput(!0),!0)},WidgetKnob.prototype.onMouseMove=function(e){if(this.oldmouse){var m=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],v=this.value;(v-=.01*(m[1]-this.oldmouse[1]))>1?v=1:v<0&&(v=0),this.value=v,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=m,this.setDirtyCanvas(!0)}},WidgetKnob.prototype.onMouseUp=function(e){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))},WidgetKnob.prototype.onMouseLeave=function(e){},WidgetKnob.prototype.onPropertyChanged=function(name,value){if("wcolor"==name)this.properties[name]=value;else if("size"==name)value=parseInt(value),this.properties[name]=value,this.size=[value+4,value+24],this.setDirtyCanvas(!0,!0);else{if("min"!=name&&"max"!=name&&"value"!=name)return!1;this.properties[name]=parseFloat(value)}return!0},LiteGraph.registerNodeType("widget/knob",WidgetKnob),WidgetSliderGUI.title="Internal Slider",WidgetSliderGUI.prototype.onPropertyChanged=function(name,value){"value"==name&&(this.slider.value=value)},WidgetSliderGUI.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},LiteGraph.registerNodeType("widget/internal_slider",WidgetSliderGUI),WidgetHSlider.title="H.Slider",WidgetHSlider.desc="Linear slider controller",WidgetHSlider.prototype.onAdded=function(){this.value=.5,this.imgfg=this.loadImage("imgs/slider_fg.png")},WidgetHSlider.prototype.onDrawVectorial=function(ctx){this.imgfg&&this.imgfg.width&&(ctx.lineWidth=1,ctx.strokeStyle=this.mouseOver?"#FFF":"#AAA",ctx.fillStyle="#000",ctx.beginPath(),ctx.rect(2,0,this.size[0]-4,20),ctx.stroke(),ctx.fillStyle=this.properties.wcolor,ctx.beginPath(),ctx.rect(2+(this.size[0]-4-20)*this.value,0,20,20),ctx.fill())},WidgetHSlider.prototype.onDrawImage=function(ctx){this.imgfg&&this.imgfg.width&&(ctx.lineWidth=1,ctx.fillStyle="#000",ctx.fillRect(2,9,this.size[0]-4,2),ctx.strokeStyle="#333",ctx.beginPath(),ctx.moveTo(2,9),ctx.lineTo(this.size[0]-4,9),ctx.stroke(),ctx.strokeStyle="#AAA",ctx.beginPath(),ctx.moveTo(2,11),ctx.lineTo(this.size[0]-4,11),ctx.stroke(),ctx.drawImage(this.imgfg,2+(this.size[0]-4)*this.value-.5*this.imgfg.width,.5*-this.imgfg.height+10))},WidgetHSlider.prototype.onDrawForeground=function(ctx){this.onDrawImage(ctx)},WidgetHSlider.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=LiteGraph.colorToString([this.value,this.value,this.value])},WidgetHSlider.prototype.onMouseDown=function(e){return!(e.canvasY-this.pos[1]<0)&&(this.oldmouse=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],this.captureInput(!0),!0)},WidgetHSlider.prototype.onMouseMove=function(e){if(this.oldmouse){var m=[e.canvasX-this.pos[0],e.canvasY-this.pos[1]],v=this.value;(v+=(m[0]-this.oldmouse[0])/this.size[0])>1?v=1:v<0&&(v=0),this.value=v,this.oldmouse=m,this.setDirtyCanvas(!0)}},WidgetHSlider.prototype.onMouseUp=function(e){this.oldmouse=null,this.captureInput(!1)},WidgetHSlider.prototype.onMouseLeave=function(e){},WidgetHSlider.prototype.onPropertyChanged=function(name,value){return"wcolor"==name&&(this.properties[name]=value,!0)},LiteGraph.registerNodeType("widget/hslider",WidgetHSlider),WidgetProgress.title="Progress",WidgetProgress.desc="Shows data in linear progress",WidgetProgress.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&(this.properties.value=v)},WidgetProgress.prototype.onDrawForeground=function(ctx){ctx.lineWidth=1,ctx.fillStyle=this.properties.wcolor;var v=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);v=Math.min(1,v),v=Math.max(0,v),ctx.fillRect(2,2,(this.size[0]-4)*v,this.size[1]-4)},LiteGraph.registerNodeType("widget/progress",WidgetProgress),WidgetText.title="Text",WidgetText.desc="Shows the input value",WidgetText.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}],WidgetText.prototype.onDrawForeground=function(ctx){ctx.fillStyle=this.properties.color;var v=this.properties.value;this.properties.glowSize?(ctx.shadowColor=this.properties.color,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=this.properties.glowSize):ctx.shadowColor="transparent";var fontsize=this.properties.fontsize;if(ctx.textAlign=this.properties.align,ctx.font=fontsize.toString()+"px "+this.properties.font,this.str="number"==typeof v?v.toFixed(this.properties.decimals):v,"string"==typeof this.str){var lines=this.str.split("\\n");for(var i in lines)ctx.fillText(lines[i],"left"==this.properties.align?15:this.size[0]-15,-.15*fontsize+fontsize*(parseInt(i)+1))}ctx.shadowColor="transparent",this.last_ctx=ctx,ctx.textAlign="left"},WidgetText.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&(this.properties.value=v)},WidgetText.prototype.resize=function(){if(this.last_ctx){var lines=this.str.split("\\n");this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font;var max=0;for(var i in lines){var w=this.last_ctx.measureText(lines[i]).width;max<w&&(max=w)}this.size[0]=max+20,this.size[1]=4+lines.length*this.properties.fontsize,this.setDirtyCanvas(!0)}},WidgetText.prototype.onPropertyChanged=function(name,value){return this.properties[name]=value,this.str="number"==typeof value?value.toFixed(3):value,!0},LiteGraph.registerNodeType("widget/text",WidgetText),WidgetPanel.title="Panel",WidgetPanel.desc="Non interactive panel",WidgetPanel.widgets=[{name:"update",text:"Update",type:"button"}],WidgetPanel.prototype.createGradient=function(ctx){""!=this.properties.bgcolorTop&&""!=this.properties.bgcolorBottom?(this.lineargradient=ctx.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom)):this.lineargradient=0},WidgetPanel.prototype.onDrawForeground=function(ctx){null==this.lineargradient&&this.createGradient(ctx),this.lineargradient&&(ctx.lineWidth=1,ctx.strokeStyle=this.properties.borderColor,ctx.fillStyle=this.lineargradient,this.properties.shadowSize?(ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=this.properties.shadowSize):ctx.shadowColor="transparent",ctx.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),ctx.fill(),ctx.shadowColor="transparent",ctx.stroke())},LiteGraph.registerNodeType("widget/panel",WidgetPanel)}(),function(global){var LiteGraph=exports.LiteGraph;function GamepadInput(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",LiteGraph.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}GamepadInput.title="Gamepad",GamepadInput.desc="gets the input of the gamepad",GamepadInput.zero=new Float32Array(2),GamepadInput.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"],GamepadInput.prototype.onExecute=function(){var gamepad=this.getGamepad(),threshold=this.properties.threshold||0;if(gamepad&&(this._left_axis[0]=Math.abs(gamepad.xbox.axes.lx)>threshold?gamepad.xbox.axes.lx:0,this._left_axis[1]=Math.abs(gamepad.xbox.axes.ly)>threshold?gamepad.xbox.axes.ly:0,this._right_axis[0]=Math.abs(gamepad.xbox.axes.rx)>threshold?gamepad.xbox.axes.rx:0,this._right_axis[1]=Math.abs(gamepad.xbox.axes.ry)>threshold?gamepad.xbox.axes.ry:0,this._triggers[0]=Math.abs(gamepad.xbox.axes.ltrigger)>threshold?gamepad.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(gamepad.xbox.axes.rtrigger)>threshold?gamepad.xbox.axes.rtrigger:0),this.outputs)for(var i=0;i<this.outputs.length;i++){var output=this.outputs[i];if(output.links&&output.links.length){var v=null;if(gamepad)switch(output.name){case"left_axis":v=this._left_axis;break;case"right_axis":v=this._right_axis;break;case"left_x_axis":v=this._left_axis[0];break;case"left_y_axis":v=this._left_axis[1];break;case"right_x_axis":v=this._right_axis[0];break;case"right_y_axis":v=this._right_axis[1];break;case"trigger_left":v=this._triggers[0];break;case"trigger_right":v=this._triggers[1];break;case"a_button":v=gamepad.xbox.buttons.a?1:0;break;case"b_button":v=gamepad.xbox.buttons.b?1:0;break;case"x_button":v=gamepad.xbox.buttons.x?1:0;break;case"y_button":v=gamepad.xbox.buttons.y?1:0;break;case"lb_button":v=gamepad.xbox.buttons.lb?1:0;break;case"rb_button":v=gamepad.xbox.buttons.rb?1:0;break;case"ls_button":v=gamepad.xbox.buttons.ls?1:0;break;case"rs_button":v=gamepad.xbox.buttons.rs?1:0;break;case"start_button":v=gamepad.xbox.buttons.start?1:0;break;case"back_button":v=gamepad.xbox.buttons.back?1:0;break;case"button_pressed":for(var j=0;j<this._current_buttons.length;++j)this._current_buttons[j]&&!this._previous_buttons[j]&&this.triggerSlot(i,GamepadInput.buttons[j])}else switch(output.name){case"button_pressed":break;case"left_axis":case"right_axis":v=GamepadInput.zero;break;default:v=0}this.setOutputData(i,v)}}},GamepadInput.prototype.getGamepad=function(){var getGamepads=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!getGamepads)return null;var gamepads=getGamepads.call(navigator),gamepad=null;this._previous_buttons.set(this._current_buttons);for(var i=this.properties.gamepad_index;i<4;i++)if(gamepads[i]){gamepad=gamepads[i];var xbox=this.xbox_mapping;xbox||(xbox=this.xbox_mapping={axes:[],buttons:{},hat:""}),xbox.axes.lx=gamepad.axes[0],xbox.axes.ly=gamepad.axes[1],xbox.axes.rx=gamepad.axes[2],xbox.axes.ry=gamepad.axes[3],xbox.axes.ltrigger=gamepad.buttons[6].value,xbox.axes.rtrigger=gamepad.buttons[7].value;for(var j=0;j<gamepad.buttons.length;j++)switch(this._current_buttons[j]=gamepad.buttons[j].pressed,j){case 0:xbox.buttons.a=gamepad.buttons[j].pressed;break;case 1:xbox.buttons.b=gamepad.buttons[j].pressed;break;case 2:xbox.buttons.x=gamepad.buttons[j].pressed;break;case 3:xbox.buttons.y=gamepad.buttons[j].pressed;break;case 4:xbox.buttons.lb=gamepad.buttons[j].pressed;break;case 5:xbox.buttons.rb=gamepad.buttons[j].pressed;break;case 6:xbox.buttons.lt=gamepad.buttons[j].pressed;break;case 7:xbox.buttons.rt=gamepad.buttons[j].pressed;break;case 8:xbox.buttons.back=gamepad.buttons[j].pressed;break;case 9:xbox.buttons.start=gamepad.buttons[j].pressed;break;case 10:xbox.buttons.ls=gamepad.buttons[j].pressed;break;case 11:xbox.buttons.rs=gamepad.buttons[j].pressed;break;case 12:gamepad.buttons[j].pressed&&(xbox.hat+="up");break;case 13:gamepad.buttons[j].pressed&&(xbox.hat+="down");break;case 14:gamepad.buttons[j].pressed&&(xbox.hat+="left");break;case 15:gamepad.buttons[j].pressed&&(xbox.hat+="right");break;case 16:xbox.buttons.home=gamepad.buttons[j].pressed}return gamepad.xbox=xbox,gamepad}},GamepadInput.prototype.onDrawBackground=function(ctx){if(!this.flags.collapsed){var la=this._left_axis,ra=this._right_axis;ctx.strokeStyle="#88A",ctx.strokeRect(.5*(la[0]+1)*this.size[0]-4,.5*(la[1]+1)*this.size[1]-4,8,8),ctx.strokeStyle="#8A8",ctx.strokeRect(.5*(ra[0]+1)*this.size[0]-4,.5*(ra[1]+1)*this.size[1]-4,8,8);var h=this.size[1]/this._current_buttons.length;ctx.fillStyle="#AEB";for(var i=0;i<this._current_buttons.length;++i)this._current_buttons[i]&&ctx.fillRect(0,h*i,6,h)}},GamepadInput.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start","number"],["back","number"],["button_pressed",LiteGraph.EVENT]]},LiteGraph.registerNodeType("input/gamepad",GamepadInput)}(),function(global){var LiteGraph=global.LiteGraph;function Converter(){this.addInput("in","*"),this.size=[60,20]}function Bypass(){this.addInput("in"),this.addOutput("out"),this.size=[60,20]}function MathRange(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[80,20]}function MathRand(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[60,20]}function MathClamp(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[60,20],this.addProperty("min",0),this.addProperty("max",1)}function MathLerp(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}function MathAbs(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[60,20]}function MathFloor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[60,20]}function MathFrac(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[60,20]}function MathSmoothStep(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[60,20],this.properties={A:0,B:1}}function MathScale(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[60,20],this.addProperty("factor",1)}function MathAverageFilter(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[60,20],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}function MathTendTo(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[60,20],this._value=null}function MathOperation(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:MathOperation.values})}function MathCompare(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}function MathCondition(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","string",{values:MathCondition.values}),this.size=[60,40]}function MathAccumulate(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}function MathTrigonometry(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}function MathFormula(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.addWidget("toggle","allow",LiteGraph.allow_scripts,function(v){LiteGraph.allow_scripts=v}),this._func=null}function Math3DVec2ToXYZ(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}function Math3DXYToVec2(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}function Math3DVec3ToXYZ(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}function Math3DXYZToVec3(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}function Math3DVec4ToXYZW(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}function Math3DXYZWToVec4(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}if(Converter.title="Converter",Converter.desc="type A to type B",Converter.prototype.onExecute=function(){var v=this.getInputData(0);if(null!=v&&this.outputs)for(var i=0;i<this.outputs.length;i++){var output=this.outputs[i];if(output.links&&output.links.length){var result=null;switch(output.name){case"number":result=v.length?v[0]:parseFloat(v);break;case"vec2":case"vec3":case"vec4":result=null;var count=1;switch(output.name){case"vec2":count=2;break;case"vec3":count=3;break;case"vec4":count=4}result=new Float32Array(count);if(v.length)for(var j=0;j<v.length&&j<result.length;j++)result[j]=v[j];else result[0]=parseFloat(v)}this.setOutputData(i,result)}}},Converter.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]},LiteGraph.registerNodeType("math/converter",Converter),Bypass.title="Bypass",Bypass.desc="removes the type",Bypass.prototype.onExecute=function(){var v=this.getInputData(0);this.setOutputData(0,v)},LiteGraph.registerNodeType("math/bypass",Bypass),MathRange.title="Range",MathRange.desc="Convert a number from one range to another",MathRange.prototype.getTitle=function(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title},MathRange.prototype.onExecute=function(){if(this.inputs)for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i];void 0!==(v=this.getInputData(i))&&(this.properties[input.name]=v)}var v;null!=(v=this.properties.in)&&v.constructor===Number||(v=0);var in_min=this.properties.in_min,in_max=this.properties.in_max,out_min=this.properties.out_min,out_max=this.properties.out_max;this._last_v=(v-in_min)/(in_max-in_min)*(out_max-out_min)+out_min,this.setOutputData(0,this._last_v)},MathRange.prototype.onDrawBackground=function(ctx){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},MathRange.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]},LiteGraph.registerNodeType("math/range",MathRange),MathRand.title="Rand",MathRand.desc="Random number",MathRand.prototype.onExecute=function(){if(this.inputs)for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i],v=this.getInputData(i);void 0!==v&&(this.properties[input.name]=v)}var min=this.properties.min,max=this.properties.max;this._last_v=Math.random()*(max-min)+min,this.setOutputData(0,this._last_v)},MathRand.prototype.onDrawBackground=function(ctx){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},MathRand.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]},LiteGraph.registerNodeType("math/rand",MathRand),MathClamp.title="Clamp",MathClamp.desc="Clamp number between min and max",MathClamp.filter="shader",MathClamp.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&(v=Math.max(this.properties.min,v),v=Math.min(this.properties.max,v),this.setOutputData(0,v))},MathClamp.prototype.getCode=function(lang){var code="";return this.isInputConnected(0)&&(code+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),code},LiteGraph.registerNodeType("math/clamp",MathClamp),MathLerp.title="Lerp",MathLerp.desc="Linear Interpolation",MathLerp.prototype.onExecute=function(){var v1=this.getInputData(0);null==v1&&(v1=0);var v2=this.getInputData(1);null==v2&&(v2=0);var f=this.properties.f,_f=this.getInputData(2);void 0!==_f&&(f=_f),this.setOutputData(0,v1*(1-f)+v2*f)},MathLerp.prototype.onGetInputs=function(){return[["f","number"]]},LiteGraph.registerNodeType("math/lerp",MathLerp),MathAbs.title="Abs",MathAbs.desc="Absolute",MathAbs.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&this.setOutputData(0,Math.abs(v))},LiteGraph.registerNodeType("math/abs",MathAbs),MathFloor.title="Floor",MathFloor.desc="Floor number to remove fractional part",MathFloor.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&this.setOutputData(0,Math.floor(v))},LiteGraph.registerNodeType("math/floor",MathFloor),MathFrac.title="Frac",MathFrac.desc="Returns fractional part",MathFrac.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&this.setOutputData(0,v%1)},LiteGraph.registerNodeType("math/frac",MathFrac),MathSmoothStep.title="Smoothstep",MathSmoothStep.desc="Smoothstep",MathSmoothStep.prototype.onExecute=function(){var v=this.getInputData(0);if(void 0!==v){var edge0=this.properties.A,edge1=this.properties.B;v=(v=Math.clamp((v-edge0)/(edge1-edge0),0,1))*v*(3-2*v),this.setOutputData(0,v)}},LiteGraph.registerNodeType("math/smoothstep",MathSmoothStep),MathScale.title="Scale",MathScale.desc="v * factor",MathScale.prototype.onExecute=function(){var value=this.getInputData(0);null!=value&&this.setOutputData(0,value*this.properties.factor)},LiteGraph.registerNodeType("math/scale",MathScale),MathAverageFilter.title="Average",MathAverageFilter.desc="Average Filter",MathAverageFilter.prototype.onExecute=function(){var v=this.getInputData(0);null==v&&(v=0);var num_samples=this._values.length;this._values[this._current%num_samples]=v,this._current+=1,this._current>num_samples&&(this._current=0);for(var avr=0,i=0;i<num_samples;++i)avr+=this._values[i];this.setOutputData(0,avr/num_samples)},MathAverageFilter.prototype.onPropertyChanged=function(name,value){value<1&&(value=1),this.properties.samples=Math.round(value);var old=this._values;this._values=new Float32Array(this.properties.samples),old.length<=this._values.length?this._values.set(old):this._values.set(old.subarray(0,this._values.length))},LiteGraph.registerNodeType("math/average",MathAverageFilter),MathTendTo.title="TendTo",MathTendTo.desc="moves the output value always closer to the input",MathTendTo.prototype.onExecute=function(){var v=this.getInputData(0);null==v&&(v=0);var f=this.properties.factor;null==this._value?this._value=v:this._value=this._value*(1-f)+v*f,this.setOutputData(0,this._value)},LiteGraph.registerNodeType("math/tendTo",MathTendTo),MathOperation.values=["+","-","*","/","%","^"],MathOperation.title="Operation",MathOperation.desc="Easy math operators",MathOperation["@OP"]={type:"enum",title:"operation",values:MathOperation.values},MathOperation.prototype.getTitle=function(){return"A "+this.properties.OP+" B"},MathOperation.prototype.setValue=function(v){"string"==typeof v&&(v=parseFloat(v)),this.properties.value=v},MathOperation.prototype.onExecute=function(){var A=this.getInputData(0),B=this.getInputData(1);null!=A?this.properties.A=A:A=this.properties.A,null!=B?this.properties.B=B:B=this.properties.B;var result=0;switch(this.properties.OP){case"+":result=A+B;break;case"-":result=A-B;break;case"x":case"X":case"*":result=A*B;break;case"/":result=A/B;break;case"%":result=A%B;break;case"^":result=Math.pow(A,B);break;default:console.warn("Unknown operation: "+this.properties.OP)}this.setOutputData(0,result)},MathOperation.prototype.onDrawBackground=function(ctx){this.flags.collapsed||(ctx.font="40px Arial",ctx.fillStyle="#CCC",ctx.textAlign="center",ctx.fillText(this.properties.OP,.5*this.size[0],.35*this.size[1]+LiteGraph.NODE_TITLE_HEIGHT),ctx.textAlign="left")},LiteGraph.registerNodeType("math/operation",MathOperation),MathCompare.title="Compare",MathCompare.desc="compares between two values",MathCompare.prototype.onExecute=function(){var A=this.getInputData(0),B=this.getInputData(1);void 0!==A?this.properties.A=A:A=this.properties.A,void 0!==B?this.properties.B=B:B=this.properties.B;for(var i=0,l=this.outputs.length;i<l;++i){var output=this.outputs[i];if(output.links&&output.links.length){switch(output.name){case"A==B":value=A==B;break;case"A!=B":value=A!=B;break;case"A>B":value=A>B;break;case"A<B":value=A<B;break;case"A<=B":value=A<=B;break;case"A>=B":value=A>=B}this.setOutputData(i,value)}}},MathCompare.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]},LiteGraph.registerNodeType("math/compare",MathCompare),LiteGraph.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),LiteGraph.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),LiteGraph.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),LiteGraph.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),LiteGraph.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),LiteGraph.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"}),MathCondition.values=[">","<","==","!=","<=",">="],MathCondition["@OP"]={type:"enum",title:"operation",values:MathCondition.values},MathCondition.title="Condition",MathCondition.desc="evaluates condition between A and B",MathCondition.prototype.onExecute=function(){var A=this.getInputData(0);void 0===A?A=this.properties.A:this.properties.A=A;var B=this.getInputData(1);void 0===B?B=this.properties.B:this.properties.B=B;var result=!0;switch(this.properties.OP){case">":result=A>B;break;case"<":result=A<B;break;case"==":result=A==B;break;case"!=":result=A!=B;break;case"<=":result=A<=B;break;case">=":result=A>=B}this.setOutputData(0,result)},LiteGraph.registerNodeType("math/condition",MathCondition),MathAccumulate.title="Accumulate",MathAccumulate.desc="Increments a value every time",MathAccumulate.prototype.onExecute=function(){null===this.properties.value&&(this.properties.value=0);var inc=this.getInputData(0);this.properties.value+=null!==inc?inc:this.properties.increment,this.setOutputData(0,this.properties.value)},LiteGraph.registerNodeType("math/accumulate",MathAccumulate),MathTrigonometry.title="Trigonometry",MathTrigonometry.desc="Sin Cos Tan",MathTrigonometry.filter="shader",MathTrigonometry.prototype.onExecute=function(){var v=this.getInputData(0);null==v&&(v=0);var amplitude=this.properties.amplitude,slot=this.findInputSlot("amplitude");-1!=slot&&(amplitude=this.getInputData(slot));var offset=this.properties.offset;-1!=(slot=this.findInputSlot("offset"))&&(offset=this.getInputData(slot));for(var i=0,l=this.outputs.length;i<l;++i){switch(this.outputs[i].name){case"sin":value=Math.sin(v);break;case"cos":value=Math.cos(v);break;case"tan":value=Math.tan(v);break;case"asin":value=Math.asin(v);break;case"acos":value=Math.acos(v);break;case"atan":value=Math.atan(v)}this.setOutputData(i,amplitude*value+offset)}},MathTrigonometry.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]},MathTrigonometry.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]},LiteGraph.registerNodeType("math/trigonometry",MathTrigonometry),LiteGraph.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),LiteGraph.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),LiteGraph.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"}),MathFormula.title="Formula",MathFormula.desc="Compute formula",MathFormula.prototype.onExecute=function(){if(LiteGraph.allow_scripts){var x=this.getInputData(0),y=this.getInputData(1);null!=x?this.properties.x=x:x=this.properties.x,null!=y?this.properties.y=y:y=this.properties.y;this.properties.formula;this._func&&this._func_code==this.properties.formula||(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula);var value=this._func(x,y,this.graph.globaltime);this.setOutputData(0,value)}},MathFormula.prototype.getTitle=function(){return this._func_code||""},MathFormula.prototype.onDrawBackground=function(){var f=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=f)},LiteGraph.registerNodeType("math/formula",MathFormula),Math3DVec2ToXYZ.title="Vec2->XY",Math3DVec2ToXYZ.desc="vector 2 to components",Math3DVec2ToXYZ.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&(this.setOutputData(0,v[0]),this.setOutputData(1,v[1]))},LiteGraph.registerNodeType("math3d/vec2-to-xyz",Math3DVec2ToXYZ),Math3DXYToVec2.title="XY->Vec2",Math3DXYToVec2.desc="components to vector2",Math3DXYToVec2.prototype.onExecute=function(){var x=this.getInputData(0);null==x&&(x=this.properties.x);var y=this.getInputData(1);null==y&&(y=this.properties.y);var data=this._data;data[0]=x,data[1]=y,this.setOutputData(0,data)},LiteGraph.registerNodeType("math3d/xy-to-vec2",Math3DXYToVec2),Math3DVec3ToXYZ.title="Vec3->XYZ",Math3DVec3ToXYZ.desc="vector 3 to components",Math3DVec3ToXYZ.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&(this.setOutputData(0,v[0]),this.setOutputData(1,v[1]),this.setOutputData(2,v[2]))},LiteGraph.registerNodeType("math3d/vec3-to-xyz",Math3DVec3ToXYZ),Math3DXYZToVec3.title="XYZ->Vec3",Math3DXYZToVec3.desc="components to vector3",Math3DXYZToVec3.prototype.onExecute=function(){var x=this.getInputData(0);null==x&&(x=this.properties.x);var y=this.getInputData(1);null==y&&(y=this.properties.y);var z=this.getInputData(2);null==z&&(z=this.properties.z);var data=this._data;data[0]=x,data[1]=y,data[2]=z,this.setOutputData(0,data)},LiteGraph.registerNodeType("math3d/xyz-to-vec3",Math3DXYZToVec3),Math3DVec4ToXYZW.title="Vec4->XYZW",Math3DVec4ToXYZW.desc="vector 4 to components",Math3DVec4ToXYZW.prototype.onExecute=function(){var v=this.getInputData(0);null!=v&&(this.setOutputData(0,v[0]),this.setOutputData(1,v[1]),this.setOutputData(2,v[2]),this.setOutputData(3,v[3]))},LiteGraph.registerNodeType("math3d/vec4-to-xyzw",Math3DVec4ToXYZW),Math3DXYZWToVec4.title="XYZW->Vec4",Math3DXYZWToVec4.desc="components to vector4",Math3DXYZWToVec4.prototype.onExecute=function(){var x=this.getInputData(0);null==x&&(x=this.properties.x);var y=this.getInputData(1);null==y&&(y=this.properties.y);var z=this.getInputData(2);null==z&&(z=this.properties.z);var w=this.getInputData(3);null==w&&(w=this.properties.w);var data=this._data;data[0]=x,data[1]=y,data[2]=z,data[3]=w,this.setOutputData(0,data)},LiteGraph.registerNodeType("math3d/xyzw-to-vec4",Math3DXYZWToVec4),global.glMatrix){function Math3DQuaternion(){this.addOutput("quat","quat"),this.properties={x:0,y:0,z:0,w:1},this._value=quat.create()}function Math3DRotation(){this.addInputs([["degrees","number"],["axis","vec3"]]),this.addOutput("quat","quat"),this.properties={angle:90,axis:vec3.fromValues(0,1,0)},this._value=quat.create()}function Math3DRotateVec3(){this.addInputs([["vec3","vec3"],["quat","quat"]]),this.addOutput("result","vec3"),this.properties={vec:[0,0,1]}}function Math3DMultQuat(){this.addInputs([["A","quat"],["B","quat"]]),this.addOutput("A*B","quat"),this._value=quat.create()}function Math3DQuatSlerp(){this.addInputs([["A","quat"],["B","quat"],["factor","number"]]),this.addOutput("slerp","quat"),this.addProperty("factor",.5),this._value=quat.create()}Math3DQuaternion.title="Quaternion",Math3DQuaternion.desc="quaternion",Math3DQuaternion.prototype.onExecute=function(){this._value[0]=this.properties.x,this._value[1]=this.properties.y,this._value[2]=this.properties.z,this._value[3]=this.properties.w,this.setOutputData(0,this._value)},LiteGraph.registerNodeType("math3d/quaternion",Math3DQuaternion),Math3DRotation.title="Rotation",Math3DRotation.desc="quaternion rotation",Math3DRotation.prototype.onExecute=function(){var angle=this.getInputData(0);null==angle&&(angle=this.properties.angle);var axis=this.getInputData(1);null==axis&&(axis=this.properties.axis);var R=quat.setAxisAngle(this._value,axis,.0174532925*angle);this.setOutputData(0,R)},LiteGraph.registerNodeType("math3d/rotation",Math3DRotation),Math3DRotateVec3.title="Rot. Vec3",Math3DRotateVec3.desc="rotate a point",Math3DRotateVec3.prototype.onExecute=function(){var vec=this.getInputData(0);null==vec&&(vec=this.properties.vec);var quat=this.getInputData(1);null==quat?this.setOutputData(vec):this.setOutputData(0,vec3.transformQuat(vec3.create(),vec,quat))},LiteGraph.registerNodeType("math3d/rotate_vec3",Math3DRotateVec3),Math3DMultQuat.title="Mult. Quat",Math3DMultQuat.desc="rotate quaternion",Math3DMultQuat.prototype.onExecute=function(){var A=this.getInputData(0);if(null!=A){var B=this.getInputData(1);if(null!=B){var R=quat.multiply(this._value,A,B);this.setOutputData(0,R)}}},LiteGraph.registerNodeType("math3d/mult-quat",Math3DMultQuat),Math3DQuatSlerp.title="Quat Slerp",Math3DQuatSlerp.desc="quaternion spherical interpolation",Math3DQuatSlerp.prototype.onExecute=function(){var A=this.getInputData(0);if(null!=A){var B=this.getInputData(1);if(null!=B){var factor=this.properties.factor;null!=this.getInputData(2)&&(factor=this.getInputData(2));var R=quat.slerp(this._value,A,B,factor);this.setOutputData(0,R)}}},LiteGraph.registerNodeType("math3d/quat-slerp",Math3DQuatSlerp)}}(exports),function(global){var LiteGraph=exports.LiteGraph;function Selector(){this.addInput("sel","boolean"),this.addOutput("value","number"),this.properties={A:0,B:1},this.size=[60,20]}Selector.title="Selector",Selector.desc="outputs A if selector is true, B if selector is false",Selector.prototype.onExecute=function(){var cond=this.getInputData(0);if(void 0!==cond){for(var i=1;i<this.inputs.length;i++){var input=this.inputs[i],v=this.getInputData(i);void 0!==v&&(this.properties[input.name]=v)}var A=this.properties.A,B=this.properties.B;this.setOutputData(0,cond?A:B)}},Selector.prototype.onGetInputs=function(){return[["A",0],["B",0]]},LiteGraph.registerNodeType("logic/selector",Selector)}(),function(global){var LiteGraph=exports.LiteGraph;function GraphicsPlot(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}function GraphicsImage(){this.addOutput("frame","image"),this.properties={url:""}}function ColorPalette(){this.addInput("f","number"),this.addOutput("Color","color"),this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}function ImageFrame(){this.addInput("","image"),this.size=[200,200]}function ImageFade(){this.addInputs([["img1","image"],["img2","image"],["fade","number"]]),this.addOutput("","image"),this.properties={fade:.5,width:512,height:512}}function ImageCrop(){this.addInput("","image"),this.addOutput("","image"),this.properties={width:256,height:256,x:0,y:0,scale:1},this.size=[50,20]}function ImageVideo(){this.addInput("t","number"),this.addOutputs([["frame","image"],["t","number"],["d","number"]]),this.properties={url:"",use_proxy:!0}}function ImageWebcam(){this.addOutput("Webcam","image"),this.properties={facingMode:"user"},this.boxcolor="black",this.frame=0}GraphicsPlot.title="Plot",GraphicsPlot.desc="Plots data over time",GraphicsPlot.colors=["#FFF","#F99","#9F9","#99F"],GraphicsPlot.prototype.onExecute=function(ctx){if(!this.flags.collapsed)for(var size=this.size,i=0;i<4;++i){var v=this.getInputData(i);if(null!=v){var values=this.values[i];values.push(v),values.length>size[0]&&values.shift()}}},GraphicsPlot.prototype.onDrawBackground=function(ctx){if(!this.flags.collapsed){var size=this.size,scale=.5*size[1]/this.properties.scale,colors=GraphicsPlot.colors,offset=.5*size[1];if(ctx.fillStyle="#000",ctx.fillRect(0,0,size[0],size[1]),ctx.strokeStyle="#555",ctx.beginPath(),ctx.moveTo(0,offset),ctx.lineTo(size[0],offset),ctx.stroke(),this.inputs)for(var i=0;i<4;++i){var values=this.values[i];if(this.inputs[i]&&this.inputs[i].link){ctx.strokeStyle=colors[i],ctx.beginPath();var v=values[0]*scale*-1+offset;ctx.moveTo(0,Math.clamp(v,0,size[1]));for(var j=1;j<values.length&&j<size[0];++j){v=values[j]*scale*-1+offset;ctx.lineTo(j,Math.clamp(v,0,size[1]))}ctx.stroke()}}}},LiteGraph.registerNodeType("graphics/plot",GraphicsPlot),GraphicsImage.title="Image",GraphicsImage.desc="Image loader",GraphicsImage.widgets=[{name:"load",text:"Load",type:"button"}],GraphicsImage.supported_extensions=["jpg","jpeg","png","gif"],GraphicsImage.prototype.onAdded=function(){""!=this.properties.url&&null==this.img&&this.loadImage(this.properties.url)},GraphicsImage.prototype.onDrawBackground=function(ctx){this.img&&this.size[0]>5&&this.size[1]>5&&ctx.drawImage(this.img,0,0,this.size[0],this.size[1])},GraphicsImage.prototype.onExecute=function(){this.img||(this.boxcolor="#000"),this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null),this.img&&this.img.dirty&&(this.img.dirty=!1)},GraphicsImage.prototype.onPropertyChanged=function(name,value){return this.properties[name]=value,"url"==name&&""!=value&&this.loadImage(value),!0},GraphicsImage.prototype.loadImage=function(url,callback){if(""!=url){this.img=document.createElement("img"),"http"==url.substr(0,4)&&LiteGraph.proxy&&(url=LiteGraph.proxy+url.substr(url.indexOf(":")+3)),this.img.src=url,this.boxcolor="#F95";var that=this;this.img.onload=function(){callback&&callback(this),that.trace("Image loaded, size: "+that.img.width+"x"+that.img.height),this.dirty=!0,that.boxcolor="#9F9",that.setDirtyCanvas(!0)}}else this.img=null},GraphicsImage.prototype.onWidget=function(e,widget){"load"==widget.name&&this.loadImage(this.properties.url)},GraphicsImage.prototype.onDropFile=function(file){var that=this;this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(file),this.properties.url=this._url,this.loadImage(this._url,function(img){that.size[1]=img.height/img.width*that.size[0]})},LiteGraph.registerNodeType("graphics/image",GraphicsImage),ColorPalette.title="Palette",ColorPalette.desc="Generates a color",ColorPalette.prototype.onExecute=function(){var c=[];null!=this.properties.colorA&&c.push(hex2num(this.properties.colorA)),null!=this.properties.colorB&&c.push(hex2num(this.properties.colorB)),null!=this.properties.colorC&&c.push(hex2num(this.properties.colorC)),null!=this.properties.colorD&&c.push(hex2num(this.properties.colorD));var f=this.getInputData(0);if(null==f&&(f=.5),f>1?f=1:f<0&&(f=0),0!=c.length){var result=[0,0,0];if(0==f)result=c[0];else if(1==f)result=c[c.length-1];else{var pos=(c.length-1)*f,c1=c[Math.floor(pos)],c2=c[Math.floor(pos)+1],t=pos-Math.floor(pos);result[0]=c1[0]*(1-t)+c2[0]*t,result[1]=c1[1]*(1-t)+c2[1]*t,result[2]=c1[2]*(1-t)+c2[2]*t}for(var i in result)result[i]/=255;this.boxcolor=colorToString(result),this.setOutputData(0,result)}},LiteGraph.registerNodeType("color/palette",ColorPalette),ImageFrame.title="Frame",ImageFrame.desc="Frame viewerew",ImageFrame.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}],ImageFrame.prototype.onDrawBackground=function(ctx){this.frame&&ctx.drawImage(this.frame,0,0,this.size[0],this.size[1])},ImageFrame.prototype.onExecute=function(){this.frame=this.getInputData(0),this.setDirtyCanvas(!0)},ImageFrame.prototype.onWidget=function(e,widget){if("resize"==widget.name&&this.frame){var width=this.frame.width,height=this.frame.height;width||null==this.frame.videoWidth||(width=this.frame.videoWidth,height=this.frame.videoHeight),width&&height&&(this.size=[width,height]),this.setDirtyCanvas(!0,!0)}else"view"==widget.name&&this.show()},ImageFrame.prototype.show=function(){showElement&&this.frame&&showElement(this.frame)},LiteGraph.registerNodeType("graphics/frame",ImageFrame),ImageFade.title="Image fade",ImageFade.desc="Fades between images",ImageFade.widgets=[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}],ImageFade.prototype.onAdded=function(){this.createCanvas();var ctx=this.canvas.getContext("2d");ctx.fillStyle="#000",ctx.fillRect(0,0,this.properties.width,this.properties.height)},ImageFade.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},ImageFade.prototype.onExecute=function(){var ctx=this.canvas.getContext("2d");this.canvas.width=this.canvas.width;var A=this.getInputData(0);null!=A&&ctx.drawImage(A,0,0,this.canvas.width,this.canvas.height);var fade=this.getInputData(2);null==fade?fade=this.properties.fade:this.properties.fade=fade,ctx.globalAlpha=fade;var B=this.getInputData(1);null!=B&&ctx.drawImage(B,0,0,this.canvas.width,this.canvas.height),ctx.globalAlpha=1,this.setOutputData(0,this.canvas),this.setDirtyCanvas(!0)},LiteGraph.registerNodeType("graphics/imagefade",ImageFade),ImageCrop.title="Crop",ImageCrop.desc="Crop Image",ImageCrop.prototype.onAdded=function(){this.createCanvas()},ImageCrop.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},ImageCrop.prototype.onExecute=function(){var input=this.getInputData(0);input&&(input.width?(this.canvas.getContext("2d").drawImage(input,-this.properties.x,-this.properties.y,input.width*this.properties.scale,input.height*this.properties.scale),this.setOutputData(0,this.canvas)):this.setOutputData(0,null))},ImageCrop.prototype.onDrawBackground=function(ctx){this.flags.collapsed||this.canvas&&ctx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])},ImageCrop.prototype.onPropertyChanged=function(name,value){return this.properties[name]=value,"scale"==name?(this.properties[name]=parseFloat(value),0==this.properties[name]&&(this.trace("Error in scale"),this.properties[name]=1)):this.properties[name]=parseInt(value),this.createCanvas(),!0},LiteGraph.registerNodeType("graphics/cropImage",ImageCrop),ImageVideo.title="Video",ImageVideo.desc="Video playback",ImageVideo.widgets=[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}],ImageVideo.prototype.onExecute=function(){if(this.properties.url&&(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),this._video&&0!=this._video.width)){var t=this.getInputData(0);t&&t>=0&&t<=1&&(this._video.currentTime=t*this._video.duration,this._video.pause()),this._video.dirty=!0,this.setOutputData(0,this._video),this.setOutputData(1,this._video.currentTime),this.setOutputData(2,this._video.duration),this.setDirtyCanvas(!0)}},ImageVideo.prototype.onStart=function(){this.play()},ImageVideo.prototype.onStop=function(){this.stop()},ImageVideo.prototype.loadVideo=function(url){this._video_url=url,this.properties.use_proxy&&"http"==url.substr(0,4)&&LiteGraph.proxy&&(url=LiteGraph.proxy+url.substr(url.indexOf(":")+3)),this._video=document.createElement("video"),this._video.src=url,this._video.type="type=video/mp4",this._video.muted=!0,this._video.autoplay=!0;var that=this;this._video.addEventListener("loadedmetadata",function(e){that.trace("Duration: "+this.duration+" seconds"),that.trace("Size: "+this.videoWidth+","+this.videoHeight),that.setDirtyCanvas(!0),this.width=this.videoWidth,this.height=this.videoHeight}),this._video.addEventListener("progress",function(e){}),this._video.addEventListener("error",function(e){if(console.log("Error loading video: "+this.src),that.trace("Error loading video: "+this.src),this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:that.trace("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:that.trace("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:that.trace("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:that.trace("Sorry, your browser can't play this video.")}}),this._video.addEventListener("ended",function(e){that.trace("Ended."),this.play()})},ImageVideo.prototype.onPropertyChanged=function(name,value){return this.properties[name]=value,"url"==name&&""!=value&&this.loadVideo(value),!0},ImageVideo.prototype.play=function(){this._video&&this._video.play()},ImageVideo.prototype.playPause=function(){this._video&&(this._video.paused?this.play():this.pause())},ImageVideo.prototype.stop=function(){this._video&&(this._video.pause(),this._video.currentTime=0)},ImageVideo.prototype.pause=function(){this._video&&(this.trace("Video paused"),this._video.pause())},ImageVideo.prototype.onWidget=function(e,widget){},LiteGraph.registerNodeType("graphics/video",ImageVideo),ImageWebcam.title="Webcam",ImageWebcam.desc="Webcam image",ImageWebcam.prototype.openStream=function(){if(navigator.getUserMedia){this._waiting_confirmation=!0;var constraints={audio:!1,video:{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(constraints).then(this.streamReady.bind(this)).catch(function(e){console.log("Webcam rejected",e),that._webcam_stream=!1,that.boxcolor="red",that.trigger("stream_error")});var that=this}},ImageWebcam.prototype.closeStream=function(){if(this._webcam_stream){var tracks=this._webcam_stream.getTracks();if(tracks.length)for(var i=0;i<tracks.length;++i)tracks[i].stop();this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},ImageWebcam.prototype.onPropertyChanged=function(name,value){"facingMode"==name&&(this.properties.facingMode=value,this.closeStream(),this.openStream())},ImageWebcam.prototype.onRemoved=function(){this.closeStream()},ImageWebcam.prototype.streamReady=function(localMediaStream){this._webcam_stream=localMediaStream,this.boxcolor="green";var video=this._video;video||((video=document.createElement("video")).autoplay=!0,video.srcObject=localMediaStream,this._video=video,video.onloadedmetadata=function(e){console.log(e)}),this.trigger("stream_ready",video)},ImageWebcam.prototype.onExecute=function(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){this._video.frame=++this.frame,this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video);for(var i=1;i<this.outputs.length;++i)if(this.outputs[i])switch(this.outputs[i].name){case"width":this.setOutputData(i,this._video.videoWidth);break;case"height":this.setOutputData(i,this._video.videoHeight)}}},ImageWebcam.prototype.getExtraMenuOptions=function(graphcanvas){var that=this;return[{content:that.properties.show?"Hide Frame":"Show Frame",callback:function(){that.properties.show=!that.properties.show}}]},ImageWebcam.prototype.onDrawBackground=function(ctx){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._video&&(ctx.save(),ctx.drawImage(this._video,0,0,this.size[0],this.size[1]),ctx.restore())},ImageWebcam.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",LiteGraph.EVENT],["stream_closed",LiteGraph.EVENT],["stream_error",LiteGraph.EVENT]]},LiteGraph.registerNodeType("graphics/webcam",ImageWebcam)}(),function(global){var LiteGraph=global.LiteGraph;if(global.LGraphTexture=null,"undefined"!=typeof GL){function LGraphTexture(){this.addOutput("Texture","Texture"),this.properties={name:"",filter:!0},this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size]}function LGraphTexturePreview(){this.addInput("Texture","Texture"),this.properties={flipY:!1},this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size]}function LGraphTextureSave(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={name:""}}function LGraphTextureOperation(){this.addInput("Texture","Texture"),this.addInput("TextureB","Texture"),this.addInput("value","number"),this.addOutput("Texture","Texture"),this.help="<p>pixelcode must be vec3</p>\t\t\t<p>uvcode must be vec2, is optional</p>\t\t\t<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture</p><p><strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time</p><p><strong>value:</strong> input value</p>",this.properties={value:1,uvcode:"",pixelcode:"color + colorB * value",precision:LGraphTexture.DEFAULT}}function LGraphTextureShader(){this.addOutput("out","Texture"),this.properties={code:"",width:512,height:512,precision:LGraphTexture.DEFAULT},this.properties.code="\nvoid main() {\n  vec2 uv = v_coord;\n  vec3 color = vec3(0.0);\n//your code here\n\ngl_FragColor = vec4(color, 1.0);\n}\n",this._uniforms={in_texture:0,texSize:vec2.create(),time:0}}function LGraphTextureScaleOffset(){this.addInput("in","Texture"),this.addInput("scale","vec2"),this.addInput("offset","vec2"),this.addOutput("out","Texture"),this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:LGraphTexture.DEFAULT}}function LGraphTextureWarp(){this.addInput("in","Texture"),this.addInput("warp","Texture"),this.addInput("factor","number"),this.addOutput("out","Texture"),this.properties={factor:.01,precision:LGraphTexture.DEFAULT}}function LGraphTextureToViewport(){this.addInput("Texture","Texture"),this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1},this.size[0]=130}function LGraphTextureCopy(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:0,generate_mipmaps:!1,precision:LGraphTexture.DEFAULT}}function LGraphTextureDownsample(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={iterations:1,generate_mipmaps:!1,precision:LGraphTexture.DEFAULT}}function LGraphTextureAverage(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("avg","vec4"),this.addOutput("lum","number"),this.properties={mipmap_offset:0,low_precision:!1},this._uniforms={u_texture:0,u_mipmap_offset:this.properties.mipmap_offset},this._luminance=new Float32Array(4)}function LGraphImageToTexture(){this.addInput("Image","image"),this.addOutput("","Texture"),this.properties={}}function LGraphTextureLUT(){this.addInput("Texture","Texture"),this.addInput("LUT","Texture"),this.addInput("Intensity","number"),this.addOutput("","Texture"),this.properties={intensity:1,precision:LGraphTexture.DEFAULT,texture:null},LGraphTextureLUT._shader||(LGraphTextureLUT._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureLUT.pixel_shader))}function LGraphTextureChannels(){this.addInput("Texture","Texture"),this.addOutput("R","Texture"),this.addOutput("G","Texture"),this.addOutput("B","Texture"),this.addOutput("A","Texture"),this.properties={},LGraphTextureChannels._shader||(LGraphTextureChannels._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureChannels.pixel_shader))}function LGraphChannelsTexture(){this.addInput("R","Texture"),this.addInput("G","Texture"),this.addInput("B","Texture"),this.addInput("A","Texture"),this.addOutput("Texture","Texture"),this.properties={},LGraphChannelsTexture._shader||(LGraphChannelsTexture._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphChannelsTexture.pixel_shader))}function LGraphTextureColor(){this.addOutput("Texture","Texture"),this._tex_color=vec4.create(),this.properties={color:vec4.create(),precision:LGraphTexture.DEFAULT}}function LGraphTextureGradient(){this.addInput("A","color"),this.addInput("B","color"),this.addOutput("Texture","Texture"),this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32},LGraphTextureGradient._shader||(LGraphTextureGradient._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureGradient.pixel_shader)),this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}}function LGraphTextureMix(){this.addInput("A","Texture"),this.addInput("B","Texture"),this.addInput("Mixer","Texture"),this.addOutput("Texture","Texture"),this.properties={factor:.5,precision:LGraphTexture.DEFAULT},this._uniforms={u_textureA:0,u_textureB:1,u_textureMix:2,u_mix:vec4.create()}}function LGraphTextureEdges(){this.addInput("Tex.","Texture"),this.addOutput("Edges","Texture"),this.properties={invert:!0,threshold:!1,factor:1,precision:LGraphTexture.DEFAULT},LGraphTextureEdges._shader||(LGraphTextureEdges._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureEdges.pixel_shader))}function LGraphTextureDepthRange(){this.addInput("Texture","Texture"),this.addInput("Distance","number"),this.addInput("Range","number"),this.addOutput("Texture","Texture"),this.properties={distance:100,range:50,only_depth:!1,high_precision:!1},this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}}function LGraphTextureBlur(){this.addInput("Texture","Texture"),this.addInput("Iterations","number"),this.addInput("Intensity","number"),this.addOutput("Blurred","Texture"),this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:LGraphTexture.DEFAULT}}function LGraphTextureGlow(){this.addInput("in","Texture"),this.addInput("dirt","Texture"),this.addOutput("out","Texture"),this.addOutput("glow","Texture"),this.properties={enabled:!0,intensity:1,persistence:.99,iterations:16,threshold:0,scale:1,dirt_factor:.5,precision:LGraphTexture.DEFAULT},this._textures=[],this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}}function LGraphTextureKuwaharaFilter(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={intensity:1,radius:5}}function LGraphTextureWebcam(){this.addOutput("Webcam","Texture"),this.properties={texture_name:"",facingMode:"user"},this.boxcolor="black",this.version=0}function LGraphLensFX(){this.addInput("in","Texture"),this.addInput("f","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,factor:1,precision:LGraphTexture.LOW},this._uniforms={u_texture:0,u_factor:1}}function LGraphExposition(){this.addInput("in","Texture"),this.addInput("exp","number"),this.addOutput("out","Texture"),this.properties={exposition:1,precision:LGraphTexture.LOW},this._uniforms={u_texture:0,u_exposition:1}}function LGraphToneMapping(){this.addInput("in","Texture"),this.addInput("avg","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,scale:1,gamma:1,average_lum:1,lum_white:1,precision:LGraphTexture.LOW},this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}}function LGraphTexturePerlin(){this.addOutput("out","Texture"),this.properties={width:512,height:512,seed:0,persistence:.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:LGraphTexture.DEFAULT},this._key=0,this._uniforms={u_persistence:.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}}function LGraphTextureCanvas2D(){this.addOutput("out","Texture"),this.properties={code:"",width:512,height:512,precision:LGraphTexture.DEFAULT},this._func=null,this._temp_texture=null}function LGraphTextureMatte(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={key_color:vec3.fromValues(0,1,0),threshold:.8,slope:.2,precision:LGraphTexture.DEFAULT}}function LGraphCubemap(){this.addOutput("Cubemap","Cubemap"),this.properties={name:""},this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size]}LGraphCanvas.link_type_colors.Texture="#AEF",global.LGraphTexture=LGraphTexture,LGraphTexture.title="Texture",LGraphTexture.desc="Texture",LGraphTexture.widgets_info={name:{widget:"texture"},filter:{widget:"checkbox"}},LGraphTexture.loadTextureCallback=null,LGraphTexture.image_preview_size=256,LGraphTexture.PASS_THROUGH=1,LGraphTexture.COPY=2,LGraphTexture.LOW=3,LGraphTexture.HIGH=4,LGraphTexture.REUSE=5,LGraphTexture.DEFAULT=2,LGraphTexture.MODE_VALUES={"pass through":LGraphTexture.PASS_THROUGH,copy:LGraphTexture.COPY,low:LGraphTexture.LOW,high:LGraphTexture.HIGH,reuse:LGraphTexture.REUSE,default:LGraphTexture.DEFAULT},LGraphTexture.getTexturesContainer=function(){return gl.textures},LGraphTexture.loadTexture=function(name,options){options=options||{};var url=name;return"http://"==url.substr(0,7)&&LiteGraph.proxy&&(url=LiteGraph.proxy+url.substr(7)),LGraphTexture.getTexturesContainer()[name]=GL.Texture.fromURL(url,options)},LGraphTexture.getTexture=function(name){var container=this.getTexturesContainer();if(!container)throw"Cannot load texture, container of textures not found";var tex=container[name];return!tex&&name&&":"!=name[0]?this.loadTexture(name):tex},LGraphTexture.getTargetTexture=function(origin,target,mode){if(!origin)throw"LGraphTexture.getTargetTexture expects a reference texture";var tex_type=null;switch(mode){case LGraphTexture.LOW:tex_type=gl.UNSIGNED_BYTE;break;case LGraphTexture.HIGH:tex_type=gl.HIGH_PRECISION_FORMAT;break;case LGraphTexture.REUSE:return origin;case LGraphTexture.COPY:default:tex_type=origin?origin.type:gl.UNSIGNED_BYTE}return target&&target.width==origin.width&&target.height==origin.height&&target.type==tex_type||(target=new GL.Texture(origin.width,origin.height,{type:tex_type,format:gl.RGBA,filter:gl.LINEAR})),target},LGraphTexture.getTextureType=function(precision,ref_texture){var type=ref_texture?ref_texture.type:gl.UNSIGNED_BYTE;switch(precision){case LGraphTexture.HIGH:type=gl.HIGH_PRECISION_FORMAT;break;case LGraphTexture.LOW:type=gl.UNSIGNED_BYTE}return type},LGraphTexture.getNoiseTexture=function(){if(this._noise_texture)return this._noise_texture;for(var noise=new Uint8Array(1048576),i=0;i<1048576;++i)noise[i]=255*Math.random();var texture=GL.Texture.fromMemory(512,512,noise,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return this._noise_texture=texture,texture},LGraphTexture.prototype.onDropFile=function(data,filename,file){if(data){var texture=null;if("string"==typeof data)texture=GL.Texture.fromURL(data);else if(-1!=filename.toLowerCase().indexOf(".dds"))texture=GL.Texture.fromDDSInMemory(data);else{var blob=new Blob([file]),url=URL.createObjectURL(blob);texture=GL.Texture.fromURL(url)}this._drop_texture=texture,this.properties.name=filename}else this._drop_texture=null,this.properties.name=""},LGraphTexture.prototype.getExtraMenuOptions=function(graphcanvas){var that=this;if(this._drop_texture)return[{content:"Clear",callback:function(){that._drop_texture=null,that.properties.name=""}}]},LGraphTexture.prototype.onExecute=function(){var tex=null;if(this.isOutputConnected(1)&&(tex=this.getInputData(0)),!tex&&this._drop_texture&&(tex=this._drop_texture),!tex&&this.properties.name&&(tex=LGraphTexture.getTexture(this.properties.name)),tex){this._last_tex=tex,!1===this.properties.filter?tex.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST):tex.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),this.setOutputData(0,tex);for(var i=1;i<this.outputs.length;i++){var output=this.outputs[i];if(output){var v=null;"width"==output.name?v=tex.width:"height"==output.name?v=tex.height:"aspect"==output.name&&(v=tex.width/tex.height),this.setOutputData(i,v)}}}},LGraphTexture.prototype.onResourceRenamed=function(old_name,new_name){this.properties.name==old_name&&(this.properties.name=new_name)},LGraphTexture.prototype.onDrawBackground=function(ctx){if(!(this.flags.collapsed||this.size[1]<=20))if(this._drop_texture&&ctx.webgl)ctx.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);else{if(this._last_preview_tex!=this._last_tex)if(ctx.webgl)this._canvas=this._last_tex;else{var tex_canvas=LGraphTexture.generateLowResTexturePreview(this._last_tex);if(!tex_canvas)return;this._last_preview_tex=this._last_tex,this._canvas=cloneCanvas(tex_canvas)}this._canvas&&(ctx.save(),ctx.webgl||(ctx.translate(0,this.size[1]),ctx.scale(1,-1)),ctx.drawImage(this._canvas,0,0,this.size[0],this.size[1]),ctx.restore())}},LGraphTexture.generateLowResTexturePreview=function(tex){if(!tex)return null;var size=LGraphTexture.image_preview_size,temp_tex=tex;if(tex.format==gl.DEPTH_COMPONENT)return null;(tex.width>size||tex.height>size)&&(temp_tex=this._preview_temp_tex,this._preview_temp_tex||(temp_tex=new GL.Texture(size,size,{minFilter:gl.NEAREST}),this._preview_temp_tex=temp_tex),tex.copyTo(temp_tex),tex=temp_tex);var tex_canvas=this._preview_canvas;return tex_canvas||(tex_canvas=createCanvas(size,size),this._preview_canvas=tex_canvas),temp_tex&&temp_tex.toCanvas(tex_canvas),tex_canvas},LGraphTexture.prototype.getResources=function(res){return res[this.properties.name]=GL.Texture,res},LGraphTexture.prototype.onGetInputs=function(){return[["in","Texture"]]},LGraphTexture.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["aspect","number"]]},LiteGraph.registerNodeType("texture/texture",LGraphTexture),LGraphTexturePreview.title="Preview",LGraphTexturePreview.desc="Show a texture in the graph canvas",LGraphTexturePreview.allow_preview=!1,LGraphTexturePreview.prototype.onDrawBackground=function(ctx){if(!this.flags.collapsed&&(ctx.webgl||LGraphTexturePreview.allow_preview)){var tex=this.getInputData(0);if(tex){var tex_canvas=null;tex_canvas=!tex.handle&&ctx.webgl?tex:LGraphTexture.generateLowResTexturePreview(tex),ctx.save(),this.properties.flipY&&(ctx.translate(0,this.size[1]),ctx.scale(1,-1)),ctx.drawImage(tex_canvas,0,0,this.size[0],this.size[1]),ctx.restore()}}},LiteGraph.registerNodeType("texture/preview",LGraphTexturePreview),LGraphTextureSave.title="Save",LGraphTextureSave.desc="Save a texture in the repository",LGraphTextureSave.prototype.onExecute=function(){var tex=this.getInputData(0);if(tex){if(this.properties.name)if(LGraphTexture.storeTexture)LGraphTexture.storeTexture(this.properties.name,tex);else LGraphTexture.getTexturesContainer()[this.properties.name]=tex;this.setOutputData(0,tex)}},LiteGraph.registerNodeType("texture/save",LGraphTextureSave),LGraphTextureOperation.widgets_info={uvcode:{widget:"textarea",height:100},pixelcode:{widget:"textarea",height:100},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureOperation.title="Operation",LGraphTextureOperation.desc="Texture shader operation",LGraphTextureOperation.prototype.getExtraMenuOptions=function(graphcanvas){var that=this;return[{content:that.properties.show?"Hide Texture":"Show Texture",callback:function(){that.properties.show=!that.properties.show}}]},LGraphTextureOperation.prototype.onDrawBackground=function(ctx){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._tex&&this._tex.gl==ctx&&(ctx.save(),ctx.drawImage(this._tex,0,0,this.size[0],this.size[1]),ctx.restore())},LGraphTextureOperation.prototype.onExecute=function(){var tex=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision!==LGraphTexture.PASS_THROUGH){var texB=this.getInputData(1);if(this.properties.uvcode||this.properties.pixelcode){var width=512,height=512;tex?(width=tex.width,height=tex.height):texB&&(width=texB.width,height=texB.height);var type=LGraphTexture.getTextureType(this.properties.precision,tex);tex||this._tex?this._tex=LGraphTexture.getTargetTexture(tex||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(width,height,{type:type,format:gl.RGBA,filter:gl.LINEAR});var uvcode="";this.properties.uvcode&&(uvcode="uv = "+this.properties.uvcode,-1!=this.properties.uvcode.indexOf(";")&&(uvcode=this.properties.uvcode));var pixelcode="";this.properties.pixelcode&&(pixelcode="result = "+this.properties.pixelcode,-1!=this.properties.pixelcode.indexOf(";")&&(pixelcode=this.properties.pixelcode));var shader=this._shader;if(!shader||this._shader_code!=uvcode+"|"+pixelcode){try{this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureOperation.pixel_shader,{UV_CODE:uvcode,PIXEL_CODE:pixelcode}),this.boxcolor="#00FF00"}catch(err){return console.log("Error compiling shader: ",err),void(this.boxcolor="#FF0000")}this.boxcolor="#FF0000",this._shader_code=uvcode+"|"+pixelcode,shader=this._shader}if(shader){this.boxcolor="green";var value=this.getInputData(2);null!=value?this.properties.value=value:value=parseFloat(this.properties.value);var time=this.graph.getTime();this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),tex&&tex.bind(0),texB&&texB.bind(1);var mesh=Mesh.getScreenQuad();shader.uniforms({u_texture:0,u_textureB:1,value:value,texSize:[width,height],time:time}).draw(mesh)}),this.setOutputData(0,this._tex)}else this.boxcolor="red"}}else this.setOutputData(0,tex)},LGraphTextureOperation.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 texSize;\n\t\t\tuniform float time;\n\t\t\tuniform float value;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tUV_CODE;\n\t\t\t\tvec4 color4 = texture2D(u_texture, uv);\n\t\t\t\tvec3 color = color4.rgb;\n\t\t\t\tvec4 color4B = texture2D(u_textureB, uv);\n\t\t\t\tvec3 colorB = color4B.rgb;\n\t\t\t\tvec3 result = color;\n\t\t\t\tfloat alpha = 1.0;\n\t\t\t\tPIXEL_CODE;\n\t\t\t\tgl_FragColor = vec4(result, alpha);\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/operation",LGraphTextureOperation),LGraphTextureShader.title="Shader",LGraphTextureShader.desc="Texture shader",LGraphTextureShader.widgets_info={code:{type:"code"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureShader.prototype.onPropertyChanged=function(name,value){if("code"==name){var shader=this.getShader();if(shader){var uniforms=shader.uniformInfo;if(this.inputs)for(var already={},i=0;i<this.inputs.length;++i){(info=this.getInputInfo(i))&&(!uniforms[info.name]||already[info.name]?(this.removeInput(i),i--):already[info.name]=!0)}for(var i in uniforms){var info;if(null!==(info=shader.uniformInfo[i]).loc&&"time"!=i){var type="number";if(this._shader.samplers[i])type="texture";else switch(info.size){case 1:type="number";break;case 2:type="vec2";break;case 3:type="vec3";break;case 4:type="vec4";break;case 9:type="mat3";break;case 16:type="mat4";break;default:continue}var slot=this.findInputSlot(i);if(-1!=slot){var input_info=this.getInputInfo(slot);if(input_info){if(input_info.type==type)continue;this.removeInput(slot,type),this.addInput(i,type)}else this.addInput(i,type)}else this.addInput(i,type)}}}}},LGraphTextureShader.prototype.getShader=function(){return this._shader&&this._shader_code==this.properties.code?this._shader:(this._shader_code=this.properties.code,this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureShader.pixel_shader+this.properties.code),this._shader?(this.boxcolor="green",this._shader):(this.boxcolor="red",null))},LGraphTextureShader.prototype.onExecute=function(){if(this.isOutputConnected(0)){var shader=this.getShader();if(shader){for(var tex_slot=0,in_tex=null,i=0;i<this.inputs.length;++i){var info=this.getInputInfo(i),data=this.getInputData(i);null!=data&&(data.constructor===GL.Texture&&(data.bind(tex_slot),in_tex||(in_tex=data),data=tex_slot,tex_slot++),shader.setUniform(info.name,data))}var uniforms=this._uniforms,type=LGraphTexture.getTextureType(this.properties.precision,in_tex),w=0|this.properties.width,h=0|this.properties.height;0==w&&(w=in_tex?in_tex.width:gl.canvas.width),0==h&&(h=in_tex?in_tex.height:gl.canvas.height),uniforms.texSize[0]=w,uniforms.texSize[1]=h,uniforms.time=this.graph.getTime(),this._tex&&this._tex.type==type&&this._tex.width==w&&this._tex.height==h||(this._tex=new GL.Texture(w,h,{type:type,format:gl.RGBA,filter:gl.LINEAR})),this._tex.drawTo(function(){shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._tex)}}},LGraphTextureShader.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform float time;\n\t",LiteGraph.registerNodeType("texture/shader",LGraphTextureShader),LGraphTextureScaleOffset.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureScaleOffset.title="Scale/Offset",LGraphTextureScaleOffset.desc="Applies an scaling and offseting",LGraphTextureScaleOffset.prototype.onExecute=function(){var tex=this.getInputData(0);if(this.isOutputConnected(0)&&tex)if(this.properties.precision!==LGraphTexture.PASS_THROUGH){var width=tex.width,height=tex.height,type=this.precision===LGraphTexture.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===LGraphTexture.DEFAULT&&(type=tex.type),this._tex&&this._tex.width==width&&this._tex.height==height&&this._tex.type==type||(this._tex=new GL.Texture(width,height,{type:type,format:gl.RGBA,filter:gl.LINEAR}));var shader=this._shader;shader||(shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureScaleOffset.pixel_shader));var scale=this.getInputData(1);scale?(this.properties.scale[0]=scale[0],this.properties.scale[1]=scale[1]):scale=this.properties.scale;var offset=this.getInputData(2);offset?(this.properties.offset[0]=offset[0],this.properties.offset[1]=offset[1]):offset=this.properties.offset,this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),tex.bind(0);var mesh=Mesh.getScreenQuad();shader.uniforms({u_texture:0,u_scale:scale,u_offset:offset}).draw(mesh)}),this.setOutputData(0,this._tex)}else this.setOutputData(0,tex)},LGraphTextureScaleOffset.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_scale;\n\t\t\tuniform vec2 u_offset;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tuv = uv / u_scale - u_offset;\n\t\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/scaleOffset",LGraphTextureScaleOffset),LGraphTextureWarp.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureWarp.title="Warp",LGraphTextureWarp.desc="Texture warp operation",LGraphTextureWarp.prototype.onExecute=function(){var tex=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision!==LGraphTexture.PASS_THROUGH){var texB=this.getInputData(1),width=512,height=512;gl.UNSIGNED_BYTE;tex?(width=tex.width,height=tex.height,tex.type):texB&&(width=texB.width,height=texB.height,texB.type),tex||this._tex?this._tex=LGraphTexture.getTargetTexture(tex||this._tex,this._tex,this.properties.precision):this._tex=new GL.Texture(width,height,{type:this.precision===LGraphTexture.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,format:gl.RGBA,filter:gl.LINEAR});var shader=this._shader;shader||(shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureWarp.pixel_shader));var factor=this.getInputData(2);null!=factor?this.properties.factor=factor:factor=parseFloat(this.properties.factor),this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),tex&&tex.bind(0),texB&&texB.bind(1);var mesh=Mesh.getScreenQuad();shader.uniforms({u_texture:0,u_textureB:1,u_factor:factor}).draw(mesh)}),this.setOutputData(0,this._tex)}else this.setOutputData(0,tex)},LGraphTextureWarp.pixel_shader="precision highp float;\n\t\t\t\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform float u_factor;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tuv += ( texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor;\n\t\t\t\tgl_FragColor = texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/warp",LGraphTextureWarp),LGraphTextureToViewport.title="to Viewport",LGraphTextureToViewport.desc="Texture to viewport",LGraphTextureToViewport.prototype.onExecute=function(){var tex=this.getInputData(0);if(tex){this.properties.disable_alpha?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),this.properties.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),gl.disable(gl.DEPTH_TEST);var gamma=this.properties.gamma||1;if(this.isInputConnected(1)&&(gamma=this.getInputData(1)),tex.setParameter(gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),this.properties.antialiasing){LGraphTextureToViewport._shader||(LGraphTextureToViewport._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureToViewport.aa_pixel_shader));gl.getViewport();var mesh=Mesh.getScreenQuad();tex.bind(0),LGraphTextureToViewport._shader.uniforms({u_texture:0,uViewportSize:[tex.width,tex.height],u_igamma:1/gamma,inverseVP:[1/tex.width,1/tex.height]}).draw(mesh)}else 1!=gamma?(LGraphTextureToViewport._gamma_shader||(LGraphTextureToViewport._gamma_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureToViewport.gamma_pixel_shader)),tex.toViewport(LGraphTextureToViewport._gamma_shader,{u_texture:0,u_igamma:1/gamma})):tex.toViewport()}},LGraphTextureToViewport.prototype.onGetInputs=function(){return[["gamma","number"]]},LGraphTextureToViewport.aa_pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 uViewportSize;\n\t\t\tuniform vec2 inverseVP;\n\t\t\tuniform float u_igamma;\n\t\t\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t\t\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t\t\t#define FXAA_SPAN_MAX     8.0\n\t\t\t\n\t\t\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\t\t\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t\t\t{\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\t/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/\n\t\t\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;\n\t\t\t\tvec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;\n\t\t\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\t\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\t\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\t\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\t\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\t\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\t\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\t\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\t\t\n\t\t\t\tvec2 dir;\n\t\t\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\t\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\t\t\n\t\t\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\t\t\n\t\t\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\t\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;\n\t\t\t\t\n\t\t\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\t\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + \n\t\t\t\t\ttexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\t\t\t\t\n\t\t\t\t//return vec4(rgbA,1.0);\n\t\t\t\tfloat lumaB = dot(rgbB, luma);\n\t\t\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\t\t\tcolor = vec4(rgbA, 1.0);\n\t\t\t\telse\n\t\t\t\t\tcolor = vec4(rgbB, 1.0);\n\t\t\t\tif(u_igamma != 1.0)\n\t\t\t\t\tcolor.xyz = pow( color.xyz, vec3(u_igamma) );\n\t\t\t\treturn color;\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;\n\t\t\t}\n\t\t\t",LGraphTextureToViewport.gamma_pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_igamma;\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_texture, v_coord);\n\t\t\t\tcolor.xyz = pow(color.xyz, vec3(u_igamma) );\n\t\t\t   gl_FragColor = color;\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/toviewport",LGraphTextureToViewport),LGraphTextureCopy.title="Copy",LGraphTextureCopy.desc="Copy Texture",LGraphTextureCopy.widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureCopy.prototype.onExecute=function(){var tex=this.getInputData(0);if((tex||this._temp_texture)&&this.isOutputConnected(0)){if(tex){var width=tex.width,height=tex.height;0!=this.properties.size&&(width=this.properties.size,height=this.properties.size);var temp=this._temp_texture,type=tex.type;if(this.properties.precision===LGraphTexture.LOW?type=gl.UNSIGNED_BYTE:this.properties.precision===LGraphTexture.HIGH&&(type=gl.HIGH_PRECISION_FORMAT),!temp||temp.width!=width||temp.height!=height||temp.type!=type){var minFilter=gl.LINEAR;this.properties.generate_mipmaps&&isPowerOfTwo(width)&&isPowerOfTwo(height)&&(minFilter=gl.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL.Texture(width,height,{type:type,format:gl.RGBA,minFilter:minFilter,magFilter:gl.LINEAR})}tex.copyTo(this._temp_texture),this.properties.generate_mipmaps&&(this._temp_texture.bind(0),gl.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0))}this.setOutputData(0,this._temp_texture)}},LiteGraph.registerNodeType("texture/copy",LGraphTextureCopy),LGraphTextureDownsample.title="Downsample",LGraphTextureDownsample.desc="Downsample Texture",LGraphTextureDownsample.widgets_info={iterations:{type:"number",step:1,precision:0,min:1},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureDownsample.prototype.onExecute=function(){var tex=this.getInputData(0);if((tex||this._temp_texture)&&this.isOutputConnected(0)&&tex&&tex.texture_type===GL.TEXTURE_2D){var shader=LGraphTextureDownsample._shader;shader||(LGraphTextureDownsample._shader=shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureDownsample.pixel_shader));var width=0|tex.width,height=0|tex.height,type=tex.type;this.properties.precision===LGraphTexture.LOW?type=gl.UNSIGNED_BYTE:this.properties.precision===LGraphTexture.HIGH&&(type=gl.HIGH_PRECISION_FORMAT);var iterations=this.properties.iterations||1,origin=tex,target=null,temp=[],options={type:type,format:tex.format},offset=vec2.create(),uniforms={u_offset:offset};this._texture&&GL.Texture.releaseTemporary(this._texture);for(var i=0;i<iterations&&(offset[0]=1/width,offset[1]=1/height,width=width>>1||0,height=height>>1||0,target=GL.Texture.getTemporary(width,height,options),temp.push(target),origin.setParameter(GL.TEXTURE_MAG_FILTER,GL.NEAREST),origin.copyTo(target,shader,uniforms),1!=width||1!=height);++i)origin=target;this._texture=temp.pop();for(i=0;i<temp.length;++i)GL.Texture.releaseTemporary(temp[i]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},LGraphTextureDownsample.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tvarying vec2 v_coord;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord );\n\t\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, 0.0 ) );\n\t\t\t\tcolor += texture2D(u_texture, v_coord + vec2( 0.0, u_offset.y ) );\n\t\t\t\tcolor += texture2D(u_texture, v_coord + vec2( u_offset.x, u_offset.y ) );\n\t\t\t   gl_FragColor = color * 0.25;\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/downsample",LGraphTextureDownsample),LGraphTextureAverage.title="Average",LGraphTextureAverage.desc="Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture",LGraphTextureAverage.prototype.onExecute=function(){var tex=this.getInputData(0);if(tex&&(this.isOutputConnected(0)||this.isOutputConnected(1)||this.isOutputConnected(2))){if(!LGraphTextureAverage._shader){LGraphTextureAverage._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureAverage.pixel_shader);for(var samples=new Float32Array(32),i=0;i<32;++i)samples[i]=Math.random();LGraphTextureAverage._shader.uniforms({u_samples_a:samples.subarray(0,16),u_samples_b:samples.subarray(16,32)})}var temp=this._temp_texture,type=gl.UNSIGNED_BYTE;tex.type!=type&&(type=gl.FLOAT),temp&&temp.type==type||(this._temp_texture=new GL.Texture(1,1,{type:type,format:gl.RGBA,filter:gl.NEAREST}));var shader=LGraphTextureAverage._shader,uniforms=this._uniforms;if(uniforms.u_mipmap_offset=this.properties.mipmap_offset,this._temp_texture.drawTo(function(){tex.toViewport(shader,uniforms)}),this.setOutputData(0,this._temp_texture),this.isOutputConnected(1)||this.isOutputConnected(2)){var pixel=this._temp_texture.getPixels();if(pixel){var v=this._luminance;type=this._temp_texture.type;v.set(pixel),type==gl.UNSIGNED_BYTE?vec4.scale(v,v,1/255):type!=GL.HALF_FLOAT&&type!=GL.HALF_FLOAT_OES||vec4.scale(v,v,1/65025),this.setOutputData(1,v),this.setOutputData(2,(v[0]+v[1]+v[2])/3)}}}},LGraphTextureAverage.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tuniform mat4 u_samples_a;\n\t\t\tuniform mat4 u_samples_b;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_mipmap_offset;\n\t\t\tvarying vec2 v_coord;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor(int i = 0; i < 4; ++i)\n\t\t\t\t\tfor(int j = 0; j < 4; ++j)\n\t\t\t\t\t{\n\t\t\t\t\t\tcolor += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t\t\tcolor += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );\n\t\t\t\t\t}\n\t\t\t   gl_FragColor = color * 0.03125;\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/average",LGraphTextureAverage),LGraphImageToTexture.title="Image to Texture",LGraphImageToTexture.desc="Uploads an image to the GPU",LGraphImageToTexture.prototype.onExecute=function(){var img=this.getInputData(0);if(img){var width=img.videoWidth||img.width,height=img.videoHeight||img.height;if(img.gltexture)this.setOutputData(0,img.gltexture);else{var temp=this._temp_texture;temp&&temp.width==width&&temp.height==height||(this._temp_texture=new GL.Texture(width,height,{format:gl.RGBA,filter:gl.LINEAR}));try{this._temp_texture.uploadImage(img)}catch(err){return void console.error("image comes from an unsafe location, cannot be uploaded to webgl: "+err)}this.setOutputData(0,this._temp_texture)}}},LiteGraph.registerNodeType("texture/imageToTexture",LGraphImageToTexture),LGraphTextureLUT.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureLUT.title="LUT",LGraphTextureLUT.desc="Apply LUT to Texture",LGraphTextureLUT.prototype.onExecute=function(){if(this.isOutputConnected(0)){var tex=this.getInputData(0);if(this.properties.precision!==LGraphTexture.PASS_THROUGH){if(tex){var lut_tex=this.getInputData(1);if(lut_tex||(lut_tex=LGraphTexture.getTexture(this.properties.texture)),lut_tex){lut_tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var intensity=this.properties.intensity;this.isInputConnected(2)&&(this.properties.intensity=intensity=this.getInputData(2)),this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision),this._tex.drawTo(function(){lut_tex.bind(1),tex.toViewport(LGraphTextureLUT._shader,{u_texture:0,u_textureB:1,u_amount:intensity})}),this.setOutputData(0,this._tex)}else this.setOutputData(0,tex)}}else this.setOutputData(0,tex)}},LGraphTextureLUT.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tuniform float u_amount;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\t lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );\n\t\t\t\t mediump float blueColor = textureColor.b * 63.0;\n\t\t\t\t mediump vec2 quad1;\n\t\t\t\t quad1.y = floor(floor(blueColor) / 8.0);\n\t\t\t\t quad1.x = floor(blueColor) - (quad1.y * 8.0);\n\t\t\t\t mediump vec2 quad2;\n\t\t\t\t quad2.y = floor(ceil(blueColor) / 8.0);\n\t\t\t\t quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n\t\t\t\t highp vec2 texPos1;\n\t\t\t\t texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t\t texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t\t highp vec2 texPos2;\n\t\t\t\t texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t\t\t texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t\t\t lowp vec4 newColor1 = texture2D(u_textureB, texPos1);\n\t\t\t\t lowp vec4 newColor2 = texture2D(u_textureB, texPos2);\n\t\t\t\t lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n\t\t\t\t gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/LUT",LGraphTextureLUT),LGraphTextureChannels.title="Texture to Channels",LGraphTextureChannels.desc="Split texture channels",LGraphTextureChannels.prototype.onExecute=function(){var texA=this.getInputData(0);if(texA){this._channels||(this._channels=Array(4));for(var connections=0,i=0;i<4;i++)this.isOutputConnected(i)?(this._channels[i]&&this._channels[i].width==texA.width&&this._channels[i].height==texA.height&&this._channels[i].type==texA.type||(this._channels[i]=new GL.Texture(texA.width,texA.height,{type:texA.type,format:gl.RGBA,filter:gl.LINEAR})),connections++):this._channels[i]=null;if(connections){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad(),shader=LGraphTextureChannels._shader,masks=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]];for(i=0;i<4;i++)this._channels[i]&&(this._channels[i].drawTo(function(){texA.bind(0),shader.uniforms({u_texture:0,u_mask:masks[i]}).draw(mesh)}),this.setOutputData(i,this._channels[i]))}}},LGraphTextureChannels.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_mask;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/textureChannels",LGraphTextureChannels),LGraphChannelsTexture.title="Channels to Texture",LGraphChannelsTexture.desc="Split texture channels",LGraphChannelsTexture.prototype.onExecute=function(){var tex=[this.getInputData(0),this.getInputData(1),this.getInputData(2),this.getInputData(3)];if(tex[0]&&tex[1]&&tex[2]&&tex[3]){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad(),shader=LGraphChannelsTexture._shader;this._tex=LGraphTexture.getTargetTexture(tex[0],this._tex),this._tex.drawTo(function(){tex[0].bind(0),tex[1].bind(1),tex[2].bind(2),tex[3].bind(3),shader.uniforms({u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3}).draw(mesh)}),this.setOutputData(0,this._tex)}},LGraphChannelsTexture.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_textureR;\n\t\t\tuniform sampler2D u_textureG;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\tuniform sampler2D u_textureA;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = vec4( \t\t\t\t\t\ttexture2D(u_textureR, v_coord).r,\t\t\t\t\t\ttexture2D(u_textureG, v_coord).r,\t\t\t\t\t\ttexture2D(u_textureB, v_coord).r,\t\t\t\t\t\ttexture2D(u_textureA, v_coord).r);\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/channelsTexture",LGraphChannelsTexture),LGraphTextureColor.title="Color",LGraphTextureColor.desc="Generates a 1x1 texture with a constant color",LGraphTextureColor.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureColor.prototype.onDrawBackground=function(ctx){var c=this.properties.color;ctx.fillStyle="rgb("+Math.floor(255*Math.clamp(c[0],0,1))+","+Math.floor(255*Math.clamp(c[1],0,1))+","+Math.floor(255*Math.clamp(c[2],0,1))+")",this.flags.collapsed?this.boxcolor=ctx.fillStyle:ctx.fillRect(0,0,this.size[0],this.size[1])},LGraphTextureColor.prototype.onExecute=function(){var type=this.properties.precision==LGraphTexture.HIGH?LGraphTexture.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;this._tex&&this._tex.type==type||(this._tex=new GL.Texture(1,1,{format:gl.RGBA,type:type,minFilter:gl.NEAREST}));var color=this.properties.color;if(this.inputs)for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i],v=this.getInputData(i);if(void 0!==v)switch(input.name){case"RGB":case"RGBA":color.set(v);break;case"R":color[0]=v;break;case"G":color[1]=v;break;case"B":color[2]=v;break;case"A":color[3]=v}}vec4.sqrDist(this._tex_color,color)>.001&&(this._tex_color.set(color),this._tex.fill(color)),this.setOutputData(0,this._tex)},LGraphTextureColor.prototype.onGetInputs=function(){return[["RGB","vec3"],["RGBA","vec4"],["R","number"],["G","number"],["B","number"],["A","number"]]},LiteGraph.registerNodeType("texture/color",LGraphTextureColor),LGraphTextureGradient.title="Gradient",LGraphTextureGradient.desc="Generates a gradient",LGraphTextureGradient["@A"]={type:"color"},LGraphTextureGradient["@B"]={type:"color"},LGraphTextureGradient["@texture_size"]={type:"enum",values:[32,64,128,256,512]},LGraphTextureGradient.prototype.onExecute=function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=GL.Mesh.getScreenQuad(),shader=LGraphTextureGradient._shader,A=this.getInputData(0);A||(A=this.properties.A);var B=this.getInputData(1);B||(B=this.properties.B);for(var i=2;i<this.inputs.length;i++){var input=this.inputs[i],v=this.getInputData(i);void 0!==v&&(this.properties[input.name]=v)}var uniforms=this._uniforms;this._uniforms.u_angle=this.properties.angle*DEG2RAD,this._uniforms.u_scale=this.properties.scale,vec3.copy(uniforms.u_colorA,A),vec3.copy(uniforms.u_colorB,B);var size=parseInt(this.properties.texture_size);this._tex&&this._tex.width==size||(this._tex=new GL.Texture(size,size,{format:gl.RGB,filter:gl.LINEAR})),this._tex.drawTo(function(){shader.uniforms(uniforms).draw(mesh)}),this.setOutputData(0,this._tex)},LGraphTextureGradient.prototype.onGetInputs=function(){return[["angle","number"],["scale","number"]]},LGraphTextureGradient.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform float u_angle;\n\t\t\tuniform float u_scale;\n\t\t\tuniform vec3 u_colorA;\n\t\t\tuniform vec3 u_colorB;\n\t\t\t\n\t\t\tvec2 rotate(vec2 v, float angle)\n\t\t\t{\n\t\t\t\tvec2 result;\n\t\t\t\tfloat _cos = cos(angle);\n\t\t\t\tfloat _sin = sin(angle);\n\t\t\t\tresult.x = v.x * _cos - v.y * _sin;\n\t\t\t\tresult.y = v.x * _sin + v.y * _cos;\n\t\t\t\treturn result;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tfloat f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;\n\t\t\t\tvec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));\n\t\t\t   gl_FragColor = vec4(color,1.0);\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/gradient",LGraphTextureGradient),LGraphTextureMix.title="Mix",LGraphTextureMix.desc="Generates a texture mixing two textures",LGraphTextureMix.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureMix.prototype.onExecute=function(){var texA=this.getInputData(0);if(this.isOutputConnected(0))if(this.properties.precision!==LGraphTexture.PASS_THROUGH){var texB=this.getInputData(1);if(texA&&texB){var texMix=this.getInputData(2),factor=this.getInputData(3);this._tex=LGraphTexture.getTargetTexture(texA,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad(),shader=null,uniforms=this._uniforms;if(texMix)(shader=LGraphTextureMix._shader_tex)||(shader=LGraphTextureMix._shader_tex=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureMix.pixel_shader,{MIX_TEX:""}));else{(shader=LGraphTextureMix._shader_factor)||(shader=LGraphTextureMix._shader_factor=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureMix.pixel_shader));var f=null==factor?this.properties.factor:factor;uniforms.u_mix.set([f,f,f,f])}this._tex.drawTo(function(){texA.bind(0),texB.bind(1),texMix&&texMix.bind(2),shader.uniforms(uniforms).draw(mesh)}),this.setOutputData(0,this._tex)}}else this.setOutputData(0,texA)},LGraphTextureMix.prototype.onGetInputs=function(){return[["factor","number"]]},LGraphTextureMix.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_textureA;\n\t\t\tuniform sampler2D u_textureB;\n\t\t\t#ifdef MIX_TEX\n\t\t\t\tuniform sampler2D u_textureMix;\n\t\t\t#else\n\t\t\t\tuniform vec4 u_mix;\n\t\t\t#endif\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\t#ifdef MIX_TEX\n\t\t\t\t   vec4 f = texture2D(u_textureMix, v_coord);\n\t\t\t\t#else\n\t\t\t\t   vec4 f = u_mix;\n\t\t\t\t#endif\n\t\t\t   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), f );\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/mix",LGraphTextureMix),LGraphTextureEdges.title="Edges",LGraphTextureEdges.desc="Detects edges",LGraphTextureEdges.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureEdges.prototype.onExecute=function(){if(this.isOutputConnected(0)){var tex=this.getInputData(0);if(this.properties.precision!==LGraphTexture.PASS_THROUGH){if(tex){this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad(),shader=LGraphTextureEdges._shader,invert=this.properties.invert,factor=this.properties.factor,threshold=this.properties.threshold?1:0;this._tex.drawTo(function(){tex.bind(0),shader.uniforms({u_texture:0,u_isize:[1/tex.width,1/tex.height],u_factor:factor,u_threshold:threshold,u_invert:invert?1:0}).draw(mesh)}),this.setOutputData(0,this._tex)}}else this.setOutputData(0,tex)}},LGraphTextureEdges.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_isize;\n\t\t\tuniform int u_invert;\n\t\t\tuniform float u_factor;\n\t\t\tuniform float u_threshold;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 center = texture2D(u_texture, v_coord);\n\t\t\t\tvec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );\n\t\t\t\tvec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );\n\t\t\t\tvec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );\n\t\t\t\tvec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );\n\t\t\t\tvec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);\n\t\t\t\tdiff *= u_factor;\n\t\t\t\tif(u_invert == 1)\n\t\t\t\t\tdiff.xyz = vec3(1.0) - diff.xyz;\n\t\t\t\tif( u_threshold == 0.0 )\n\t\t\t\t\tgl_FragColor = vec4( diff.xyz, center.a );\n\t\t\t\telse\n\t\t\t\t\tgl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/edges",LGraphTextureEdges),LGraphTextureDepthRange.title="Depth Range",LGraphTextureDepthRange.desc="Generates a texture with a depth range",LGraphTextureDepthRange.prototype.onExecute=function(){if(this.isOutputConnected(0)){var tex=this.getInputData(0);if(tex){var precision=gl.UNSIGNED_BYTE;this.properties.high_precision&&(precision=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==precision&&this._temp_texture.width==tex.width&&this._temp_texture.height==tex.height||(this._temp_texture=new GL.Texture(tex.width,tex.height,{type:precision,format:gl.RGBA,filter:gl.LINEAR}));var uniforms=this._uniforms,distance=this.properties.distance;this.isInputConnected(1)&&(distance=this.getInputData(1),this.properties.distance=distance);var range=this.properties.range;this.isInputConnected(2)&&(range=this.getInputData(2),this.properties.range=range),uniforms.u_distance=distance,uniforms.u_range=range,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad();LGraphTextureDepthRange._shader||(LGraphTextureDepthRange._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureDepthRange.pixel_shader),LGraphTextureDepthRange._shader_onlydepth=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureDepthRange.pixel_shader,{ONLY_DEPTH:""}));var shader=this.properties.only_depth?LGraphTextureDepthRange._shader_onlydepth:LGraphTextureDepthRange._shader,planes=null;planes=tex.near_far_planes?tex.near_far_planes:window.LS&&LS.Renderer._main_camera?LS.Renderer._main_camera._uniforms.u_camera_planes:[.1,1e3],uniforms.u_camera_planes=planes,this._temp_texture.drawTo(function(){tex.bind(0),shader.uniforms(uniforms).draw(mesh)}),this._temp_texture.near_far_planes=planes,this.setOutputData(0,this._temp_texture)}}},LGraphTextureDepthRange.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform float u_distance;\n\t\t\tuniform float u_range;\n\t\t\t\n\t\t\tfloat LinearDepth()\n\t\t\t{\n\t\t\t\tfloat zNear = u_camera_planes.x;\n\t\t\t\tfloat zFar = u_camera_planes.y;\n\t\t\t\tfloat depth = texture2D(u_texture, v_coord).x;\n\t\t\t\tdepth = depth * 2.0 - 1.0;\n\t\t\t\treturn zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = LinearDepth();\n\t\t\t\t#ifdef ONLY_DEPTH\n\t\t\t\t   gl_FragColor = vec4(depth);\n\t\t\t\t#else\n\t\t\t\t\tfloat diff = abs(depth * u_camera_planes.y - u_distance);\n\t\t\t\t\tfloat dof = 1.0;\n\t\t\t\t\tif(diff <= u_range)\n\t\t\t\t\t\tdof = diff / u_range;\n\t\t\t\t   gl_FragColor = vec4(dof);\n\t\t\t\t#endif\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("texture/depth_range",LGraphTextureDepthRange),LGraphTextureBlur.title="Blur",LGraphTextureBlur.desc="Blur a texture",LGraphTextureBlur.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureBlur.max_iterations=20,LGraphTextureBlur.prototype.onExecute=function(){var tex=this.getInputData(0);if(tex&&this.isOutputConnected(0)){var temp=this._final_texture;temp&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(temp=this._final_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR}));var iterations=this.properties.iterations;if(this.isInputConnected(1)&&(iterations=this.getInputData(1),this.properties.iterations=iterations),0!=(iterations=Math.min(Math.floor(iterations),LGraphTextureBlur.max_iterations))){var intensity=this.properties.intensity;this.isInputConnected(2)&&(intensity=this.getInputData(2),this.properties.intensity=intensity);var aspect=LiteGraph.camera_aspect;aspect||void 0===window.gl||(aspect=gl.canvas.height/gl.canvas.width),aspect||(aspect=1),aspect=this.properties.preserve_aspect?aspect:1;var scale=this.properties.scale||[1,1];tex.applyBlur(aspect*scale[0],scale[1],intensity,temp);for(var i=1;i<iterations;++i)temp.applyBlur(aspect*scale[0]*(i+1),scale[1]*(i+1),intensity);this.setOutputData(0,temp)}else this.setOutputData(0,tex)}},LiteGraph.registerNodeType("texture/blur",LGraphTextureBlur),LGraphTextureGlow.title="Glow",LGraphTextureGlow.desc="Filters a texture giving it a glow effect",LGraphTextureGlow.weights=new Float32Array([.5,.4,.3,.2]),LGraphTextureGlow.widgets_info={iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:.01,precision:2},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureGlow.prototype.onGetInputs=function(){return[["enabled","boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]},LGraphTextureGlow.prototype.onGetOutputs=function(){return[["average","Texture"]]},LGraphTextureGlow.prototype.onExecute=function(){var tex=this.getInputData(0);if(tex&&this.isAnyOutputConnected())if(this.properties.precision!==LGraphTexture.PASS_THROUGH&&!1!==this.getInputOrProperty("enabled")){var width=tex.width,height=tex.height,texture_info={format:tex.format,type:tex.type,minFilter:GL.LINEAR,magFilter:GL.LINEAR,wrap:gl.CLAMP_TO_EDGE},type=LGraphTexture.getTextureType(this.properties.precision,tex),uniforms=this._uniforms,textures=this._textures;(shader=LGraphTextureGlow._cut_shader)||(shader=LGraphTextureGlow._cut_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureGlow.cut_pixel_shader)),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),uniforms.u_threshold=this.getInputOrProperty("threshold");var currentDestination=textures[0]=GL.Texture.getTemporary(width,height,texture_info);tex.blit(currentDestination,shader.uniforms(uniforms));var currentSource=currentDestination,iterations=this.getInputOrProperty("iterations");iterations=0|Math.clamp(iterations,1,16);var shader,texel_size=uniforms.u_texel_size,intensity=this.getInputOrProperty("intensity");uniforms.u_intensity=1,uniforms.u_delta=this.properties.scale,(shader=LGraphTextureGlow._shader)||(shader=LGraphTextureGlow._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureGlow.scale_pixel_shader));for(var i=1;i<iterations&&((0|height)>1&&(height>>=1),!((width>>=1)<2));i++)currentDestination=textures[i]=GL.Texture.getTemporary(width,height,texture_info),texel_size[0]=1/currentSource.width,texel_size[1]=1/currentSource.height,currentSource.blit(currentDestination,shader.uniforms(uniforms)),currentSource=currentDestination;if(this.isOutputConnected(2)){var average_texture=this._average_texture;average_texture&&average_texture.type==tex.type&&average_texture.format==tex.format||(average_texture=this._average_texture=new GL.Texture(1,1,{type:tex.type,format:tex.format,filter:gl.LINEAR})),texel_size[0]=1/currentSource.width,texel_size[1]=1/currentSource.height,uniforms.u_intensity=intensity,uniforms.u_delta=1,currentSource.blit(average_texture,shader.uniforms(uniforms)),this.setOutputData(2,average_texture)}for(gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),uniforms.u_intensity=this.getInputOrProperty("persistence"),uniforms.u_delta=.5,i-=2;i>=0;i--)currentDestination=textures[i],textures[i]=null,texel_size[0]=1/currentSource.width,texel_size[1]=1/currentSource.height,currentSource.blit(currentDestination,shader.uniforms(uniforms)),GL.Texture.releaseTemporary(currentSource),currentSource=currentDestination;if(gl.disable(gl.BLEND),this.isOutputConnected(1)){var glow_texture=this._glow_texture;glow_texture&&glow_texture.width==tex.width&&glow_texture.height==tex.height&&glow_texture.type==type&&glow_texture.format==tex.format||(glow_texture=this._glow_texture=new GL.Texture(tex.width,tex.height,{type:type,format:tex.format,filter:gl.LINEAR})),currentSource.blit(glow_texture),this.setOutputData(1,glow_texture)}if(this.isOutputConnected(0)){var final_texture=this._final_texture;final_texture&&final_texture.width==tex.width&&final_texture.height==tex.height&&final_texture.type==type&&final_texture.format==tex.format||(final_texture=this._final_texture=new GL.Texture(tex.width,tex.height,{type:type,format:tex.format,filter:gl.LINEAR}));var dirt_texture=this.getInputData(1),dirt_factor=this.getInputOrProperty("dirt_factor");uniforms.u_intensity=intensity,(shader=dirt_texture?LGraphTextureGlow._dirt_final_shader:LGraphTextureGlow._final_shader)||(shader=dirt_texture?LGraphTextureGlow._dirt_final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureGlow.final_pixel_shader,{USE_DIRT:""}):LGraphTextureGlow._final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureGlow.final_pixel_shader)),final_texture.drawTo(function(){tex.bind(0),currentSource.bind(1),dirt_texture&&(shader.setUniform("u_dirt_factor",dirt_factor),shader.setUniform("u_dirt_texture",dirt_texture.bind(2))),shader.toViewport(uniforms)}),this.setOutputData(0,final_texture)}GL.Texture.releaseTemporary(currentSource)}else this.setOutputData(0,tex)},LGraphTextureGlow.cut_pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform float u_threshold;\n\t\tvoid main() {\n\t\t\tgl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );\n\t\t}",LGraphTextureGlow.scale_pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform vec2 u_texel_size;\n\t\tuniform float u_delta;\n\t\tuniform float u_intensity;\n\t\t\n\t\tvec4 sampleBox(vec2 uv) {\n\t\t\tvec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n\t\t\tvec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);\n\t\t\treturn s * 0.25;\n\t\t}\n\t\tvoid main() {\n\t\t\tgl_FragColor = u_intensity * sampleBox( v_coord );\n\t\t}",LGraphTextureGlow.final_pixel_shader="precision highp float;\n\t\tvarying vec2 v_coord;\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_glow_texture;\n\t\t#ifdef USE_DIRT\n\t\t\tuniform sampler2D u_dirt_texture;\n\t\t#endif\n\t\tuniform vec2 u_texel_size;\n\t\tuniform float u_delta;\n\t\tuniform float u_intensity;\n\t\tuniform float u_dirt_factor;\n\t\t\n\t\tvec4 sampleBox(vec2 uv) {\n\t\t\tvec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;\n\t\t\tvec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);\n\t\t\treturn s * 0.25;\n\t\t}\n\t\tvoid main() {\n\t\t\tvec4 glow = sampleBox( v_coord );\n\t\t\t#ifdef USE_DIRT\n\t\t\t\tglow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );\n\t\t\t#endif\n\t\t\tgl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;\n\t\t}",LiteGraph.registerNodeType("texture/glow",LGraphTextureGlow),LGraphTextureKuwaharaFilter.title="Kuwahara Filter",LGraphTextureKuwaharaFilter.desc="Filters a texture giving an artistic oil canvas painting",LGraphTextureKuwaharaFilter.max_radius=10,LGraphTextureKuwaharaFilter._shaders=[],LGraphTextureKuwaharaFilter.prototype.onExecute=function(){var tex=this.getInputData(0);if(tex&&this.isOutputConnected(0)){var temp=this._temp_texture;temp&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(this._temp_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR}));var radius=this.properties.radius;if(0!=(radius=Math.min(Math.floor(radius),LGraphTextureKuwaharaFilter.max_radius))){var intensity=this.properties.intensity,aspect=LiteGraph.camera_aspect;aspect||void 0===window.gl||(aspect=gl.canvas.height/gl.canvas.width),aspect||(aspect=1),aspect=this.properties.preserve_aspect?aspect:1,LGraphTextureKuwaharaFilter._shaders[radius]||(LGraphTextureKuwaharaFilter._shaders[radius]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphTextureKuwaharaFilter.pixel_shader,{RADIUS:radius.toFixed(0)}));var shader=LGraphTextureKuwaharaFilter._shaders[radius],mesh=GL.Mesh.getScreenQuad();tex.bind(0),this._temp_texture.drawTo(function(){shader.uniforms({u_texture:0,u_intensity:intensity,u_resolution:[tex.width,tex.height],u_iResolution:[1/tex.width,1/tex.height]}).draw(mesh)}),this.setOutputData(0,this._temp_texture)}else this.setOutputData(0,tex)}},LGraphTextureKuwaharaFilter.pixel_shader="\n\tprecision highp float;\n\tvarying vec2 v_coord;\n\tuniform sampler2D u_texture;\n\tuniform float u_intensity;\n\tuniform vec2 u_resolution;\n\tuniform vec2 u_iResolution;\n\t#ifndef RADIUS\n\t\t#define RADIUS 7\n\t#endif\n\tvoid main() {\n\t\n\t\tconst int radius = RADIUS;\n\t\tvec2 fragCoord = v_coord;\n\t\tvec2 src_size = u_iResolution;\n\t\tvec2 uv = v_coord;\n\t\tfloat n = float((radius + 1) * (radius + 1));\n\t\tint i;\n\t\tint j;\n\t\tvec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);\n\t\tvec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);\n\t\tvec3 c;\n\t\t\n\t\tfor (int j = -radius; j <= 0; ++j)  {\n\t\t\tfor (int i = -radius; i <= 0; ++i)  {\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\t\tm0 += c;\n\t\t\t\ts0 += c * c;\n\t\t\t}\n\t\t}\n\t\t\n\t\tfor (int j = -radius; j <= 0; ++j)  {\n\t\t\tfor (int i = 0; i <= radius; ++i)  {\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\t\tm1 += c;\n\t\t\t\ts1 += c * c;\n\t\t\t}\n\t\t}\n\t\t\n\t\tfor (int j = 0; j <= radius; ++j)  {\n\t\t\tfor (int i = 0; i <= radius; ++i)  {\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\t\tm2 += c;\n\t\t\t\ts2 += c * c;\n\t\t\t}\n\t\t}\n\t\t\n\t\tfor (int j = 0; j <= radius; ++j)  {\n\t\t\tfor (int i = -radius; i <= 0; ++i)  {\n\t\t\t\tc = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;\n\t\t\t\tm3 += c;\n\t\t\t\ts3 += c * c;\n\t\t\t}\n\t\t}\n\t\t\n\t\tfloat min_sigma2 = 1e+2;\n\t\tm0 /= n;\n\t\ts0 = abs(s0 / n - m0 * m0);\n\t\t\n\t\tfloat sigma2 = s0.r + s0.g + s0.b;\n\t\tif (sigma2 < min_sigma2) {\n\t\t\tmin_sigma2 = sigma2;\n\t\t\tgl_FragColor = vec4(m0, 1.0);\n\t\t}\n\t\t\n\t\tm1 /= n;\n\t\ts1 = abs(s1 / n - m1 * m1);\n\t\t\n\t\tsigma2 = s1.r + s1.g + s1.b;\n\t\tif (sigma2 < min_sigma2) {\n\t\t\tmin_sigma2 = sigma2;\n\t\t\tgl_FragColor = vec4(m1, 1.0);\n\t\t}\n\t\t\n\t\tm2 /= n;\n\t\ts2 = abs(s2 / n - m2 * m2);\n\t\t\n\t\tsigma2 = s2.r + s2.g + s2.b;\n\t\tif (sigma2 < min_sigma2) {\n\t\t\tmin_sigma2 = sigma2;\n\t\t\tgl_FragColor = vec4(m2, 1.0);\n\t\t}\n\t\t\n\t\tm3 /= n;\n\t\ts3 = abs(s3 / n - m3 * m3);\n\t\t\n\t\tsigma2 = s3.r + s3.g + s3.b;\n\t\tif (sigma2 < min_sigma2) {\n\t\t\tmin_sigma2 = sigma2;\n\t\t\tgl_FragColor = vec4(m3, 1.0);\n\t\t}\n\t}\n\t",LiteGraph.registerNodeType("texture/kuwahara",LGraphTextureKuwaharaFilter),LGraphTextureWebcam.title="Webcam",LGraphTextureWebcam.desc="Webcam texture",LGraphTextureWebcam.prototype.openStream=function(){if(navigator.getUserMedia){this._waiting_confirmation=!0;var constraints={audio:!1,video:{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(constraints).then(this.streamReady.bind(this)).catch(function(e){console.log("Webcam rejected",e),that._webcam_stream=!1,that.boxcolor="red",that.trigger("stream_error")});var that=this}},LGraphTextureWebcam.prototype.closeStream=function(){if(this._webcam_stream){var tracks=this._webcam_stream.getTracks();if(tracks.length)for(var i=0;i<tracks.length;++i)tracks[i].stop();this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},LGraphTextureWebcam.prototype.streamReady=function(localMediaStream){this._webcam_stream=localMediaStream,this.boxcolor="green";var video=this._video;video||((video=document.createElement("video")).autoplay=!0,video.srcObject=localMediaStream,this._video=video,video.onloadedmetadata=function(e){console.log(e)}),this.trigger("stream_ready",video)},LGraphTextureWebcam.prototype.onPropertyChanged=function(name,value){"facingMode"==name&&(this.properties.facingMode=value,this.closeStream(),this.openStream())},LGraphTextureWebcam.prototype.onRemoved=function(){if(this._webcam_stream){var tracks=this._webcam_stream.getTracks();if(tracks.length)for(var i=0;i<tracks.length;++i)tracks[i].stop();this._webcam_stream=null,this._video=null}},LGraphTextureWebcam.prototype.onDrawBackground=function(ctx){this.flags.collapsed||this.size[1]<=20||this._video&&(ctx.save(),ctx.webgl?this._video_texture&&ctx.drawImage(this._video_texture,0,0,this.size[0],this.size[1]):ctx.drawImage(this._video,0,0,this.size[0],this.size[1]),ctx.restore())},LGraphTextureWebcam.prototype.onExecute=function(){if(null!=this._webcam_stream||this._waiting_confirmation||this.openStream(),this._video&&this._video.videoWidth){var width=this._video.videoWidth,height=this._video.videoHeight,temp=this._video_texture;if(temp&&temp.width==width&&temp.height==height||(this._video_texture=new GL.Texture(width,height,{format:gl.RGB,filter:gl.LINEAR})),this._video_texture.uploadImage(this._video),this._video_texture.version=++this.version,this.properties.texture_name)LGraphTexture.getTexturesContainer()[this.properties.texture_name]=this._video_texture;this.setOutputData(0,this._video_texture);for(var i=1;i<this.outputs.length;++i)if(this.outputs[i])switch(this.outputs[i].name){case"width":this.setOutputData(i,this._video.videoWidth);break;case"height":this.setOutputData(i,this._video.videoHeight)}}},LGraphTextureWebcam.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",LiteGraph.EVENT],["stream_closed",LiteGraph.EVENT],["stream_error",LiteGraph.EVENT]]},LiteGraph.registerNodeType("texture/webcam",LGraphTextureWebcam),LGraphLensFX.title="Lens FX",LGraphLensFX.desc="distortion and chromatic aberration",LGraphLensFX.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphLensFX.prototype.onGetInputs=function(){return[["enabled","boolean"]]},LGraphLensFX.prototype.onExecute=function(){var tex=this.getInputData(0);if(tex&&this.isOutputConnected(0))if(this.properties.precision!==LGraphTexture.PASS_THROUGH&&!1!==this.getInputOrProperty("enabled")){var temp=this._temp_texture;temp&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(temp=this._temp_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR}));var shader=LGraphLensFX._shader;shader||(shader=LGraphLensFX._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphLensFX.pixel_shader));var factor=this.getInputData(1);null==factor&&(factor=this.properties.factor);var uniforms=this._uniforms;uniforms.u_factor=factor,gl.disable(gl.DEPTH_TEST),temp.drawTo(function(){tex.bind(0),shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,temp)}else this.setOutputData(0,tex)},LGraphLensFX.pixel_shader="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_factor;\n\t\t\tvec2 barrelDistortion(vec2 coord, float amt) {\n\t\t\t\tvec2 cc = coord - 0.5;\n\t\t\t\tfloat dist = dot(cc, cc);\n\t\t\t\treturn coord + cc * dist * amt;\n\t\t\t}\n\t\t\t\n\t\t\tfloat sat( float t )\n\t\t\t{\n\t\t\t\treturn clamp( t, 0.0, 1.0 );\n\t\t\t}\n\t\t\t\n\t\t\tfloat linterp( float t ) {\n\t\t\t\treturn sat( 1.0 - abs( 2.0*t - 1.0 ) );\n\t\t\t}\n\t\t\t\n\t\t\tfloat remap( float t, float a, float b ) {\n\t\t\t\treturn sat( (t - a) / (b - a) );\n\t\t\t}\n\t\t\t\n\t\t\tvec4 spectrum_offset( float t ) {\n\t\t\t\tvec4 ret;\n\t\t\t\tfloat lo = step(t,0.5);\n\t\t\t\tfloat hi = 1.0-lo;\n\t\t\t\tfloat w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );\n\t\t\t\tret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);\n\t\t\t\n\t\t\t\treturn pow( ret, vec4(1.0/2.2) );\n\t\t\t}\n\t\t\t\n\t\t\tconst float max_distort = 2.2;\n\t\t\tconst int num_iter = 12;\n\t\t\tconst float reci_num_iter_f = 1.0 / float(num_iter);\n\t\t\t\n\t\t\tvoid main()\n\t\t\t{\t\n\t\t\t\tvec2 uv=v_coord;\n\t\t\t\tvec4 sumcol = vec4(0.0);\n\t\t\t\tvec4 sumw = vec4(0.0);\t\n\t\t\t\tfor ( int i=0; i<num_iter;++i )\n\t\t\t\t{\n\t\t\t\t\tfloat t = float(i) * reci_num_iter_f;\n\t\t\t\t\tvec4 w = spectrum_offset( t );\n\t\t\t\t\tsumw += w;\n\t\t\t\t\tsumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );\n\t\t\t\t}\n\t\t\t\tgl_FragColor = sumcol / sumw;\n\t\t\t}",LiteGraph.registerNodeType("texture/lensfx",LGraphLensFX),LGraphExposition.title="Exposition",LGraphExposition.desc="Controls texture exposition",LGraphExposition.widgets_info={exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphExposition.prototype.onExecute=function(){var tex=this.getInputData(0);if(tex&&this.isOutputConnected(0)){var temp=this._temp_texture;temp&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(temp=this._temp_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR}));var shader=LGraphExposition._shader;shader||(shader=LGraphExposition._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphExposition.pixel_shader));this.properties.exposition;var exp_input=this.getInputData(1);null!=exp_input&&(this.properties.exposition=exp_input);var uniforms=this._uniforms;temp.drawTo(function(){gl.disable(gl.DEPTH_TEST),tex.bind(0),shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,temp)}},LGraphExposition.pixel_shader="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_exposition;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_texture, v_coord );\n\t\t\t\tgl_FragColor = vec4( color.xyz * u_exposition, color.a );\n\t\t\t}",LiteGraph.registerNodeType("texture/exposition",LGraphExposition),LGraphToneMapping.title="Tone Mapping",LGraphToneMapping.desc="Applies Tone Mapping to convert from high to low",LGraphToneMapping.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphToneMapping.prototype.onGetInputs=function(){return[["enabled","boolean"]]},LGraphToneMapping.prototype.onExecute=function(){var tex=this.getInputData(0);if(tex&&this.isOutputConnected(0))if(this.properties.precision!==LGraphTexture.PASS_THROUGH&&!1!==this.getInputOrProperty("enabled")){var temp=this._temp_texture;temp&&temp.width==tex.width&&temp.height==tex.height&&temp.type==tex.type||(temp=this._temp_texture=new GL.Texture(tex.width,tex.height,{type:tex.type,format:gl.RGBA,filter:gl.LINEAR}));var shader=LGraphToneMapping._shader;shader||(shader=LGraphToneMapping._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphToneMapping.pixel_shader));var avg=this.getInputData(1);null!=avg&&(this.properties.average_lum=avg);var uniforms=this._uniforms;uniforms.u_lumwhite2=this.properties.lum_white*this.properties.lum_white,uniforms.u_scale=this.properties.scale,uniforms.u_average_lum=this.properties.average_lum,uniforms.u_igamma=1/this.properties.gamma,gl.disable(gl.DEPTH_TEST),temp.drawTo(function(){tex.bind(0),shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._temp_texture)}else this.setOutputData(0,tex)},LGraphToneMapping.pixel_shader="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_scale;\n\t\t\tuniform float u_average_lum;\n\t\t\tuniform float u_lumwhite2;\n\t\t\tuniform float u_igamma;\n\t\t\tvec3 RGB2xyY (vec3 rgb)\n\t\t\t{\n\t\t\t\t const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,\n\t\t\t\t\t\t\t\t\t\t   0.2126, 0.7152, 0.0722,\n\t\t\t\t\t\t\t\t\t\t   0.0193, 0.1192, 0.9505);\n\t\t\t\tvec3 XYZ = RGB2XYZ * rgb;\n\t\t\t\t\n\t\t\t\tfloat f = (XYZ.x + XYZ.y + XYZ.z);\n\t\t\t\treturn vec3(XYZ.x / f,\n\t\t\t\t\t\t\tXYZ.y / f,\n\t\t\t\t\t\t\tXYZ.y);\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_texture, v_coord );\n\t\t\t\tvec3 rgb = color.xyz;\n\t\t\t\t//Ld - this part of the code is the same for both versions\n\t\t\t\tfloat lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));\n\t\t\t\tfloat L = (u_scale / u_average_lum) * lum;\n\t\t\t\tfloat Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);\n\t\t\t\t//first\n\t\t\t\t//vec3 xyY = RGB2xyY(rgb);\n\t\t\t\t//xyY.z *= Ld;\n\t\t\t\t//rgb = xyYtoRGB(xyY);\n\t\t\t\t//second\n\t\t\t\trgb = (rgb / lum) * Ld;\n\t\t\t\trgb = pow( rgb, vec3( u_igamma ) );\n\t\t\t\tgl_FragColor = vec4( rgb, color.a );\n\t\t\t}",LiteGraph.registerNodeType("texture/tonemapping",LGraphToneMapping),LGraphTexturePerlin.title="Perlin",LGraphTexturePerlin.desc="Generates a perlin noise texture",LGraphTexturePerlin.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES},width:{type:"Number",precision:0,step:1},height:{type:"Number",precision:0,step:1},octaves:{type:"Number",precision:0,step:1,min:1,max:50}},LGraphTexturePerlin.prototype.onExecute=function(){if(this.isOutputConnected(0)){var w=0|this.properties.width,h=0|this.properties.height;0==w&&(w=gl.viewport_data[2]),0==h&&(h=gl.viewport_data[3]);var type=LGraphTexture.getTextureType(this.properties.precision),temp=this._temp_texture;temp&&temp.width==w&&temp.height==h&&temp.type==type||(temp=this._temp_texture=new GL.Texture(w,h,{type:type,format:gl.RGB,filter:gl.LINEAR}));var key=w+h+type+this.properties.persistence+this.properties.octaves+this.properties.scale+this.properties.seed+this.properties.offset[0]+this.properties.offset[1]+this.properties.amplitude;if(key!=this._key){this._key=key;var uniforms=this._uniforms;uniforms.u_persistence=this.properties.persistence,uniforms.u_octaves=this.properties.octaves,uniforms.u_offset[0]=this.properties.offset[0],uniforms.u_offset[1]=this.properties.offset[1],uniforms.u_scale=this.properties.scale,uniforms.u_amplitude=this.properties.amplitude,uniforms.u_viewport[0]=w,uniforms.u_viewport[1]=h,uniforms.u_seed=128*this.properties.seed;var shader=LGraphTexturePerlin._shader;shader||(shader=LGraphTexturePerlin._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTexturePerlin.pixel_shader)),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),temp.drawTo(function(){shader.uniforms(uniforms).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,temp)}else this.setOutputData(0,temp)}},LGraphTexturePerlin.pixel_shader="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_scale;\n\t\t\tuniform float u_persistence;\n\t\t\tuniform int u_octaves;\n\t\t\tuniform float u_amplitude;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform float u_seed;\n\t\t\t#define M_PI 3.14159265358979323846\n\t\t\t\n\t\t\tfloat rand(vec2 c){\treturn fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }\n\t\t\t\n\t\t\tfloat noise(vec2 p, float freq ){\n\t\t\t\tfloat unit = u_viewport.x/freq;\n\t\t\t\tvec2 ij = floor(p/unit);\n\t\t\t\tvec2 xy = mod(p,unit)/unit;\n\t\t\t\t//xy = 3.*xy*xy-2.*xy*xy*xy;\n\t\t\t\txy = .5*(1.-cos(M_PI*xy));\n\t\t\t\tfloat a = rand((ij+vec2(0.,0.)));\n\t\t\t\tfloat b = rand((ij+vec2(1.,0.)));\n\t\t\t\tfloat c = rand((ij+vec2(0.,1.)));\n\t\t\t\tfloat d = rand((ij+vec2(1.,1.)));\n\t\t\t\tfloat x1 = mix(a, b, xy.x);\n\t\t\t\tfloat x2 = mix(c, d, xy.x);\n\t\t\t\treturn mix(x1, x2, xy.y);\n\t\t\t}\n\t\t\t\n\t\t\tfloat pNoise(vec2 p, int res){\n\t\t\t\tfloat persistance = u_persistence;\n\t\t\t\tfloat n = 0.;\n\t\t\t\tfloat normK = 0.;\n\t\t\t\tfloat f = 4.;\n\t\t\t\tfloat amp = 1.0;\n\t\t\t\tint iCount = 0;\n\t\t\t\tfor (int i = 0; i<50; i++){\n\t\t\t\t\tn+=amp*noise(p, f);\n\t\t\t\t\tf*=2.;\n\t\t\t\t\tnormK+=amp;\n\t\t\t\t\tamp*=persistance;\n\t\t\t\t\tif (iCount >= res)\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tiCount++;\n\t\t\t\t}\n\t\t\t\tfloat nf = n/normK;\n\t\t\t\treturn nf*nf*nf*nf;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;\n\t\t\t\tvec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );\n\t\t\t\tgl_FragColor = color;\n\t\t\t}",LiteGraph.registerNodeType("texture/perlin",LGraphTexturePerlin),LGraphTextureCanvas2D.title="Canvas2D",LGraphTextureCanvas2D.desc="Executes Canvas2D code inside a texture or the viewport",LGraphTextureCanvas2D.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES},code:{type:"code"},width:{type:"Number",precision:0,step:1},height:{type:"Number",precision:0,step:1}},LGraphTextureCanvas2D.prototype.onPropertyChanged=function(name,value){if("code"==name&&LiteGraph.allow_scripts){this._func=null;try{this._func=new Function("canvas","ctx","time","script",value),this.boxcolor="#00FF00"}catch(err){this.boxcolor="#FF0000",console.error("Error parsing script"),console.error(err)}}},LGraphTextureCanvas2D.prototype.onExecute=function(){var func=this._func;if(func&&this.isOutputConnected(0))if(global.enableWebGLCanvas){var width=this.properties.width||gl.canvas.width,height=this.properties.height||gl.canvas.height,temp=this._temp_texture;temp&&temp.width==width&&temp.height==height||(temp=this._temp_texture=new GL.Texture(width,height,{format:gl.RGBA,filter:gl.LINEAR}));var that=this,time=this.graph.getTime();temp.drawTo(function(){gl.start2D();try{func.draw?func.draw.call(that,gl.canvas,gl,time,func):func.call(that,gl.canvas,gl,time,func),that.boxcolor="#00FF00"}catch(err){that.boxcolor="#FF0000",console.error("Error executing script"),console.error(err)}gl.finish2D()}),this.setOutputData(0,temp)}else console.warn("cannot use LGraphTextureCanvas2D if Canvas2DtoWebGL is not included")},LiteGraph.registerNodeType("texture/canvas2D",LGraphTextureCanvas2D),LGraphTextureMatte.title="Matte",LGraphTextureMatte.desc="Extracts background",LGraphTextureMatte.widgets_info={key_color:{widget:"color"},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphTextureMatte.prototype.onExecute=function(){if(this.isOutputConnected(0)){var tex=this.getInputData(0);if(this.properties.precision!==LGraphTexture.PASS_THROUGH){if(tex){this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1});var uniforms=this._uniforms,mesh=Mesh.getScreenQuad(),shader=LGraphTextureMatte._shader;shader||(shader=LGraphTextureMatte._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphTextureMatte.pixel_shader)),uniforms.u_key_color=this.properties.key_color,uniforms.u_threshold=this.properties.threshold,uniforms.u_slope=this.properties.slope,this._tex.drawTo(function(){tex.bind(0),shader.uniforms(uniforms).draw(mesh)}),this.setOutputData(0,this._tex)}}else this.setOutputData(0,tex)}},LGraphTextureMatte.pixel_shader="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec3 u_key_color;\n\t\t\tuniform float u_threshold;\n\t\t\tuniform float u_slope;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec3 color = texture2D( u_texture, v_coord ).xyz;\n\t\t\t\tfloat diff = length( normalize(color) - normalize(u_key_color) );\n\t\t\t\tfloat edge = u_threshold * (1.0 - u_slope);\n\t\t\t\tfloat alpha = smoothstep( edge, u_threshold, diff);\n\t\t\t\tgl_FragColor = vec4( color, alpha );\n\t\t\t}",LiteGraph.registerNodeType("texture/matte",LGraphTextureMatte),LGraphCubemap.title="Cubemap",LGraphCubemap.prototype.onDropFile=function(data,filename,file){data?(this._drop_texture="string"==typeof data?GL.Texture.fromURL(data):GL.Texture.fromDDSInMemory(data),this.properties.name=filename):(this._drop_texture=null,this.properties.name="")},LGraphCubemap.prototype.onExecute=function(){if(this._drop_texture)this.setOutputData(0,this._drop_texture);else if(this.properties.name){var tex=LGraphTexture.getTexture(this.properties.name);tex&&(this._last_tex=tex,this.setOutputData(0,tex))}},LGraphCubemap.prototype.onDrawBackground=function(ctx){if(!(this.flags.collapsed||this.size[1]<=20)&&ctx.webgl){var cube_mesh=gl.meshes.cube;cube_mesh||(cube_mesh=gl.meshes.cube=GL.Mesh.cube({size:1}))}},LiteGraph.registerNodeType("texture/cubemap",LGraphCubemap)}}(exports),function(global){var LiteGraph=global.LiteGraph;if("undefined"!=typeof GL){function LGraphFXLens(){this.addInput("Texture","Texture"),this.addInput("Aberration","number"),this.addInput("Distortion","number"),this.addInput("Blur","number"),this.addOutput("Texture","Texture"),this.properties={aberration:1,distortion:1,blur:1,precision:LGraphTexture.DEFAULT},LGraphFXLens._shader||(LGraphFXLens._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,LGraphFXLens.pixel_shader),LGraphFXLens._texture=new GL.Texture(3,1,{format:gl.RGB,wrap:gl.CLAMP_TO_EDGE,magFilter:gl.LINEAR,minFilter:gl.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))}function LGraphFXBokeh(){this.addInput("Texture","Texture"),this.addInput("Blurred","Texture"),this.addInput("Mask","Texture"),this.addInput("Threshold","number"),this.addOutput("Texture","Texture"),this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}}function LGraphFXGeneric(){this.addInput("Texture","Texture"),this.addInput("value1","number"),this.addInput("value2","number"),this.addOutput("Texture","Texture"),this.properties={fx:"halftone",value1:1,value2:1,precision:LGraphTexture.DEFAULT}}function LGraphFXVigneting(){this.addInput("Tex.","Texture"),this.addInput("intensity","number"),this.addOutput("Texture","Texture"),this.properties={intensity:1,invert:!1,precision:LGraphTexture.DEFAULT},LGraphFXVigneting._shader||(LGraphFXVigneting._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphFXVigneting.pixel_shader))}LGraphFXLens.title="Lens",LGraphFXLens.desc="Camera Lens distortion",LGraphFXLens.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphFXLens.prototype.onExecute=function(){var tex=this.getInputData(0);if(this.properties.precision!==LGraphTexture.PASS_THROUGH){if(tex){this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision);var aberration=this.properties.aberration;this.isInputConnected(1)&&(aberration=this.getInputData(1),this.properties.aberration=aberration);var distortion=this.properties.distortion;this.isInputConnected(2)&&(distortion=this.getInputData(2),this.properties.distortion=distortion);var blur=this.properties.blur;this.isInputConnected(3)&&(blur=this.getInputData(3),this.properties.blur=blur),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad(),shader=LGraphFXLens._shader;this._tex.drawTo(function(){tex.bind(0),shader.uniforms({u_texture:0,u_aberration:aberration,u_distortion:distortion,u_blur:blur}).draw(mesh)}),this.setOutputData(0,this._tex)}}else this.setOutputData(0,tex)},LGraphFXLens.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform float u_aberration;\n\t\t\tuniform float u_distortion;\n\t\t\tuniform float u_blur;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = v_coord;\n\t\t\t\tfloat dist = distance(vec2(0.5), coord);\n\t\t\t\tvec2 dist_coord = coord - vec2(0.5);\n\t\t\t\tfloat percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;\n\t\t\t\tdist_coord *= percent;\n\t\t\t\tcoord = dist_coord + vec2(0.5);\n\t\t\t\tvec4 color = texture2D(u_texture,coord, u_blur * dist);\n\t\t\t\tcolor.r = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0+0.01*u_aberration), u_blur * dist ).r;\n\t\t\t\tcolor.b = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0-0.01*u_aberration), u_blur * dist ).b;\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("fx/lens",LGraphFXLens),global.LGraphFXLens=LGraphFXLens,LGraphFXBokeh.title="Bokeh",LGraphFXBokeh.desc="applies an Bokeh effect",LGraphFXBokeh.widgets_info={shape:{widget:"texture"}},LGraphFXBokeh.prototype.onExecute=function(){var tex=this.getInputData(0),blurred_tex=this.getInputData(1),mask_tex=this.getInputData(2);if(tex&&mask_tex&&this.properties.shape){blurred_tex||(blurred_tex=tex);var shape_tex=LGraphTexture.getTexture(this.properties.shape);if(shape_tex){var threshold=this.properties.threshold;this.isInputConnected(3)&&(threshold=this.getInputData(3),this.properties.threshold=threshold);var precision=gl.UNSIGNED_BYTE;this.properties.high_precision&&(precision=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),this._temp_texture&&this._temp_texture.type==precision&&this._temp_texture.width==tex.width&&this._temp_texture.height==tex.height||(this._temp_texture=new GL.Texture(tex.width,tex.height,{type:precision,format:gl.RGBA,filter:gl.LINEAR}));this.properties.size;var first_shader=LGraphFXBokeh._first_shader;first_shader||(first_shader=LGraphFXBokeh._first_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,LGraphFXBokeh._first_pixel_shader));var second_shader=LGraphFXBokeh._second_shader;second_shader||(second_shader=LGraphFXBokeh._second_shader=new GL.Shader(LGraphFXBokeh._second_vertex_shader,LGraphFXBokeh._second_pixel_shader));var points_mesh=this._points_mesh;points_mesh&&points_mesh._width==tex.width&&points_mesh._height==tex.height&&2==points_mesh._spacing||(points_mesh=this.createPointsMesh(tex.width,tex.height,2));var screen_mesh=Mesh.getScreenQuad(),point_size=this.properties.size,alpha=(this.properties.min_light,this.properties.alpha);gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){tex.bind(0),blurred_tex.bind(1),mask_tex.bind(2),first_shader.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[tex.width,tex.height]}).draw(screen_mesh)}),this._temp_texture.drawTo(function(){gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),tex.bind(0),shape_tex.bind(3),second_shader.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:alpha,u_threshold:threshold,u_pointSize:point_size,u_itexsize:[1/tex.width,1/tex.height]}).draw(points_mesh,gl.POINTS)}),this.setOutputData(0,this._temp_texture)}}else this.setOutputData(0,tex)},LGraphFXBokeh.prototype.createPointsMesh=function(width,height,spacing){for(var nwidth=Math.round(width/spacing),nheight=Math.round(height/spacing),vertices=new Float32Array(nwidth*nheight*2),ny=-1,dx=2/width*spacing,dy=2/height*spacing,y=0;y<nheight;++y){for(var nx=-1,x=0;x<nwidth;++x){var pos=y*nwidth*2+2*x;vertices[pos]=nx,vertices[pos+1]=ny,nx+=dx}ny+=dy}return this._points_mesh=GL.Mesh.load({vertices2D:vertices}),this._points_mesh._width=width,this._points_mesh._height=height,this._points_mesh._spacing=spacing,this._points_mesh},LGraphFXBokeh._first_pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture_blur;\n\t\t\tuniform sampler2D u_mask;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tvec4 blurred_color = texture2D(u_texture_blur, v_coord);\n\t\t\t\tfloat mask = texture2D(u_mask, v_coord).x;\n\t\t\t   gl_FragColor = mix(color, blurred_color, mask);\n\t\t\t}\n\t\t\t",LGraphFXBokeh._second_vertex_shader="precision highp float;\n\t\t\tattribute vec2 a_vertex2D;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_mask;\n\t\t\tuniform vec2 u_itexsize;\n\t\t\tuniform float u_pointSize;\n\t\t\tuniform float u_threshold;\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = a_vertex2D * 0.5 + 0.5;\n\t\t\t\tv_color = texture2D( u_texture, coord );\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(u_itexsize.x, 0.0) );\n\t\t\t\tv_color += texture2D( u_texture, coord + vec2(0.0, u_itexsize.y));\n\t\t\t\tv_color += texture2D( u_texture, coord + u_itexsize);\n\t\t\t\tv_color *= 0.25;\n\t\t\t\tfloat mask = texture2D(u_mask, coord).x;\n\t\t\t\tfloat luminance = length(v_color) * mask;\n\t\t\t\t/*luminance /= (u_pointSize*u_pointSize)*0.01 */;\n\t\t\t\tluminance -= u_threshold;\n\t\t\t\tif(luminance < 0.0)\n\t\t\t\t{\n\t\t\t\t\tgl_Position.x = -100.0;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tgl_PointSize = u_pointSize;\n\t\t\t\tgl_Position = vec4(a_vertex2D,0.0,1.0);\n\t\t\t}\n\t\t\t",LGraphFXBokeh._second_pixel_shader="precision highp float;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_shape;\n\t\t\tuniform float u_alpha;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D( u_shape, gl_PointCoord );\n\t\t\t\tcolor *= v_color * u_alpha;\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n",LiteGraph.registerNodeType("fx/bokeh",LGraphFXBokeh),global.LGraphFXBokeh=LGraphFXBokeh,LGraphFXGeneric.title="FX",LGraphFXGeneric.desc="applies an FX from a list",LGraphFXGeneric.widgets_info={fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphFXGeneric.shaders={},LGraphFXGeneric.prototype.onExecute=function(){if(this.isOutputConnected(0)){var tex=this.getInputData(0);if(this.properties.precision!==LGraphTexture.PASS_THROUGH){if(tex){this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision);var value1=this.properties.value1;this.isInputConnected(1)&&(value1=this.getInputData(1),this.properties.value1=value1);var value2=this.properties.value2;this.isInputConnected(2)&&(value2=this.getInputData(2),this.properties.value2=value2);var fx=this.properties.fx,shader=LGraphFXGeneric.shaders[fx];if(!shader){var pixel_shader_code=LGraphFXGeneric["pixel_shader_"+fx];if(!pixel_shader_code)return;shader=LGraphFXGeneric.shaders[fx]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,pixel_shader_code)}gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad(),camera=global.LS?LS.Renderer._current_camera:null;camera_planes=camera?[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:[1,100];var noise=null;"noise"==fx&&(noise=LGraphTexture.getNoiseTexture()),this._tex.drawTo(function(){tex.bind(0),"noise"==fx&&noise.bind(1),shader.uniforms({u_texture:0,u_noise:1,u_size:[tex.width,tex.height],u_rand:[Math.random(),Math.random()],u_value1:value1,u_value2:value2,u_camera_planes:camera_planes}).draw(mesh)}),this.setOutputData(0,this._tex)}}else this.setOutputData(0,tex)}},LGraphFXGeneric.pixel_shader_halftone="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tfloat pattern() {\n\t\t\t\tfloat s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);\n\t\t\t\tvec2 tex = v_coord * u_size.xy;\n\t\t\t\tvec2 point = vec2(\n\t\t\t\t   c * tex.x - s * tex.y ,\n\t\t\t\t   s * tex.x + c * tex.y \n\t\t\t\t) * u_value2;\n\t\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tfloat average = (color.r + color.g + color.b) / 3.0;\n\t\t\t\tgl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);\n\t\t\t}\n",LGraphFXGeneric.pixel_shader_pixelate="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec2 coord = vec2( floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2 );\n\t\t\t\tvec4 color = texture2D(u_texture, coord);\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n",LGraphFXGeneric.pixel_shader_lowpalette="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_camera_planes;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tgl_FragColor = floor(color * u_value1) / u_value1;\n\t\t\t}\n",LGraphFXGeneric.pixel_shader_noise="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_noise;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform float u_value1;\n\t\t\tuniform float u_value2;\n\t\t\tuniform vec2 u_rand;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tvec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);\n\t\t\t\tgl_FragColor = vec4( color.xyz + noise * u_value1, color.a );\n\t\t\t}\n",LGraphFXGeneric.pixel_shader_gamma="precision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_value1;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tfloat gamma = 1.0 / u_value1;\n\t\t\t\tgl_FragColor = vec4( pow( color.xyz, vec3(gamma) ), color.a );\n\t\t\t}\n",LiteGraph.registerNodeType("fx/generic",LGraphFXGeneric),global.LGraphFXGeneric=LGraphFXGeneric,LGraphFXVigneting.title="Vigneting",LGraphFXVigneting.desc="Vigneting",LGraphFXVigneting.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},LGraphFXVigneting.prototype.onExecute=function(){var tex=this.getInputData(0);if(this.properties.precision!==LGraphTexture.PASS_THROUGH){if(tex){this._tex=LGraphTexture.getTargetTexture(tex,this._tex,this.properties.precision);var intensity=this.properties.intensity;this.isInputConnected(1)&&(intensity=this.getInputData(1),this.properties.intensity=intensity),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var mesh=Mesh.getScreenQuad(),shader=LGraphFXVigneting._shader,invert=this.properties.invert;this._tex.drawTo(function(){tex.bind(0),shader.uniforms({u_texture:0,u_intensity:intensity,u_isize:[1/tex.width,1/tex.height],u_invert:invert?1:0}).draw(mesh)}),this.setOutputData(0,this._tex)}}else this.setOutputData(0,tex)},LGraphFXVigneting.pixel_shader="precision highp float;\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_intensity;\n\t\t\tuniform int u_invert;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tfloat luminance = 1.0 - length( v_coord - vec2(0.5) ) * 1.414;\n\t\t\t\tvec4 color = texture2D(u_texture, v_coord);\n\t\t\t\tif(u_invert == 1)\n\t\t\t\t\tluminance = 1.0 - luminance;\n\t\t\t\tluminance = mix(1.0, luminance, u_intensity);\n\t\t\t   gl_FragColor = vec4( luminance * color.xyz, color.a);\n\t\t\t}\n\t\t\t",LiteGraph.registerNodeType("fx/vigneting",LGraphFXVigneting),global.LGraphFXVigneting=LGraphFXVigneting}}(exports),function(global){var LiteGraph=exports.LiteGraph;function MIDIEvent(data){this.channel=0,this.cmd=0,data?this.setup(data):this.data=[0,0,0]}function MIDIInterface(on_ready,on_error){if(!navigator.requestMIDIAccess)return this.error="not suppoorted",void(on_error?on_error("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags"));this.on_ready=on_ready,this.state={note:[],cc:[]},navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))}function LGMIDIIn(){this.addOutput("on_midi",LiteGraph.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null;var that=this;new MIDIInterface(function(midi){that._midi=midi,that._waiting&&that.onStart(),that._waiting=!1})}function LGMIDIOut(){this.addInput("send",LiteGraph.EVENT),this.properties={port:0};var that=this;new MIDIInterface(function(midi){that._midi=midi})}function LGMIDIShow(){this.addInput("on_midi",LiteGraph.EVENT),this._str="",this.size=[200,40]}function LGMIDIFilter(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1},this.addInput("in",LiteGraph.EVENT),this.addOutput("on_midi",LiteGraph.EVENT)}function LGMIDIEvent(){this.properties={channel:0,cmd:"CC",value1:1,value2:1},this.addInput("send",LiteGraph.EVENT),this.addInput("assign",LiteGraph.EVENT),this.addOutput("on_midi",LiteGraph.EVENT)}function LGMIDICC(){this.properties={cc:1,value:0},this.addOutput("value","number")}MIDIEvent.prototype.setup=function(raw_data){this.data=raw_data;var midiStatus=raw_data[0];this.status=midiStatus;var midiCommand=240&midiStatus;this.cmd=midiStatus>=240?midiStatus:midiCommand,this.cmd==MIDIEvent.NOTEON&&0==this.velocity&&(this.cmd=MIDIEvent.NOTEOFF),this.cmd_str=MIDIEvent.commands[this.cmd]||"",(midiCommand>=MIDIEvent.NOTEON||midiCommand<=MIDIEvent.NOTEOFF)&&(this.channel=15&midiStatus)},Object.defineProperty(MIDIEvent.prototype,"velocity",{get:function(){return this.cmd==MIDIEvent.NOTEON?this.data[2]:-1},set:function(v){this.data[2]=v},enumerable:!0}),MIDIEvent.notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],MIDIEvent.prototype.getPitch=function(){return 440*Math.pow(2,(this.data[1]-69)/12)},MIDIEvent.computePitch=function(note){return 440*Math.pow(2,(note-69)/12)},MIDIEvent.prototype.getCC=function(){return this.data[1]},MIDIEvent.prototype.getCCValue=function(){return this.data[2]},MIDIEvent.prototype.getPitchBend=function(){return this.data[1]+(this.data[2]<<7)-8192},MIDIEvent.computePitchBend=function(v1,v2){return v1+(v2<<7)-8192},MIDIEvent.prototype.setCommandFromString=function(str){this.cmd=MIDIEvent.computeCommandFromString(str)},MIDIEvent.computeCommandFromString=function(str){if(!str)return 0;if(str&&str.constructor===Number)return str;switch(str=str.toUpperCase()){case"NOTE ON":case"NOTEON":return MIDIEvent.NOTEON;case"NOTE OFF":case"NOTEOFF":return MIDIEvent.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return MIDIEvent.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return MIDIEvent.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return MIDIEvent.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return MIDIEvent.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return MIDIEvent.PITCHBEND;case"TIME TICK":case"TIMETICK":return MIDIEvent.TIMETICK;default:return Number(str)}},MIDIEvent.toNoteString=function(d){var note=d-21,octave=d-24;return(note%=12)<0&&(note=12+note),MIDIEvent.notes[note]+Math.floor(octave/12+1)},MIDIEvent.prototype.toString=function(){var str=this.channel+". ";switch(this.cmd){case MIDIEvent.NOTEON:str+="NOTEON "+MIDIEvent.toNoteString(this.data[1]);break;case MIDIEvent.NOTEOFF:str+="NOTEOFF "+MIDIEvent.toNoteString(this.data[1]);break;case MIDIEvent.CONTROLLERCHANGE:str+="CC "+this.data[1]+" "+this.data[2];break;case MIDIEvent.PROGRAMCHANGE:str+="PC "+this.data[1];break;case MIDIEvent.PITCHBEND:str+="PITCHBEND "+this.getPitchBend();break;case MIDIEvent.KEYPRESSURE:str+="KEYPRESS "+this.data[1]}return str},MIDIEvent.prototype.toHexString=function(){for(var i=0;i<this.data.length;i++)this.data[i].toString(16)+" "},MIDIEvent.NOTEOFF=128,MIDIEvent.NOTEON=144,MIDIEvent.KEYPRESSURE=160,MIDIEvent.CONTROLLERCHANGE=176,MIDIEvent.PROGRAMCHANGE=192,MIDIEvent.CHANNELPRESSURE=208,MIDIEvent.PITCHBEND=224,MIDIEvent.TIMETICK=248,MIDIEvent.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"},MIDIInterface.input=null,MIDIInterface.MIDIEvent=MIDIEvent,MIDIInterface.prototype.onMIDISuccess=function(midiAccess){console.log("MIDI ready!"),console.log(midiAccess),this.midi=midiAccess,this.updatePorts(),this.on_ready&&this.on_ready(this)},MIDIInterface.prototype.updatePorts=function(){var midi=this.midi;this.input_ports=midi.inputs;for(var num=0,it_value=(it=this.input_ports.values()).next();it_value&&!1===it_value.done;){var port_info=it_value.value;console.log("Input port [type:'"+port_info.type+"'] id:'"+port_info.id+"' manufacturer:'"+port_info.manufacturer+"' name:'"+port_info.name+"' version:'"+port_info.version+"'"),num++,it_value=it.next()}this.num_input_ports=num,num=0,this.output_ports=midi.outputs;var it;for(it_value=(it=this.output_ports.values()).next();it_value&&!1===it_value.done;){port_info=it_value.value;console.log("Output port [type:'"+port_info.type+"'] id:'"+port_info.id+"' manufacturer:'"+port_info.manufacturer+"' name:'"+port_info.name+"' version:'"+port_info.version+"'"),num++,it_value=it.next()}this.num_output_ports=num},MIDIInterface.prototype.onMIDIFailure=function(msg){console.error("Failed to get MIDI access - "+msg)},MIDIInterface.prototype.openInputPort=function(port,callback){var input_port=this.input_ports.get("input-"+port);if(!input_port)return!1;MIDIInterface.input=this;var that=this;return input_port.onmidimessage=function(a){var midi_event=new MIDIEvent(a.data);that.updateState(midi_event),callback&&callback(a.data,midi_event),MIDIInterface.on_message&&MIDIInterface.on_message(a.data,midi_event)},console.log("port open: ",input_port),!0},MIDIInterface.parseMsg=function(data){},MIDIInterface.prototype.updateState=function(midi_event){switch(midi_event.cmd){case MIDIEvent.NOTEON:this.state.note[0|midi_event.value1]=midi_event.value2;break;case MIDIEvent.NOTEOFF:this.state.note[0|midi_event.value1]=0;break;case MIDIEvent.CONTROLLERCHANGE:this.state.cc[midi_event.getCC()]=midi_event.getCCValue()}},MIDIInterface.prototype.sendMIDI=function(port,midi_data){if(midi_data){var output_port=this.output_ports.get("output-"+port);output_port&&(MIDIInterface.output=this,midi_data.constructor===MIDIEvent?output_port.send(midi_data.data):output_port.send(midi_data))}},LGMIDIIn.MIDIInterface=MIDIInterface,LGMIDIIn.title="MIDI Input",LGMIDIIn.desc="Reads MIDI from a input port",LGMIDIIn.prototype.getPropertyInfo=function(name){if(this._midi&&"port"==name){for(var values={},i=0;i<this._midi.input_ports.size;++i){var input=this._midi.input_ports.get("input-"+i);values[i]=i+".- "+input.name+" version:"+input.version}return{type:"enum",values:values}}},LGMIDIIn.prototype.onStart=function(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0},LGMIDIIn.prototype.onMIDIEvent=function(data,midi_event){this._last_midi_event=midi_event,this.trigger("on_midi",midi_event),midi_event.cmd==MIDIEvent.NOTEON?this.trigger("on_noteon",midi_event):midi_event.cmd==MIDIEvent.NOTEOFF?this.trigger("on_noteoff",midi_event):midi_event.cmd==MIDIEvent.CONTROLLERCHANGE?this.trigger("on_cc",midi_event):midi_event.cmd==MIDIEvent.PROGRAMCHANGE?this.trigger("on_pc",midi_event):midi_event.cmd==MIDIEvent.PITCHBEND&&this.trigger("on_pitchbend",midi_event)},LGMIDIIn.prototype.onExecute=function(){if(this.outputs)for(var last=this._last_midi_event,i=0;i<this.outputs.length;++i){var v=null;switch(this.outputs[i].name){case"midi":v=this._midi;break;case"last_midi":v=last;break;default:continue}this.setOutputData(i,v)}},LGMIDIIn.prototype.onGetOutputs=function(){return[["last_midi","midi"],["on_midi",LiteGraph.EVENT],["on_noteon",LiteGraph.EVENT],["on_noteoff",LiteGraph.EVENT],["on_cc",LiteGraph.EVENT],["on_pc",LiteGraph.EVENT],["on_pitchbend",LiteGraph.EVENT]]},LiteGraph.registerNodeType("midi/input",LGMIDIIn),LGMIDIOut.MIDIInterface=MIDIInterface,LGMIDIOut.title="MIDI Output",LGMIDIOut.desc="Sends MIDI to output channel",LGMIDIOut.prototype.getPropertyInfo=function(name){if(this._midi&&"port"==name){for(var values={},i=0;i<this._midi.output_ports.size;++i){var output=this._midi.output_ports.get(i);values[i]=i+".- "+output.name+" version:"+output.version}return{type:"enum",values:values}}},LGMIDIOut.prototype.onAction=function(event,midi_event){console.log(midi_event),this._midi&&("send"==event&&this._midi.sendMIDI(this.port,midi_event),this.trigger("midi",midi_event))},LGMIDIOut.prototype.onGetInputs=function(){return[["send",LiteGraph.ACTION]]},LGMIDIOut.prototype.onGetOutputs=function(){return[["on_midi",LiteGraph.EVENT]]},LiteGraph.registerNodeType("midi/output",LGMIDIOut),LGMIDIShow.title="MIDI Show",LGMIDIShow.desc="Shows MIDI in the graph",LGMIDIShow.prototype.onAction=function(event,midi_event){midi_event&&(midi_event.constructor===MIDIEvent?this._str=midi_event.toString():this._str="???")},LGMIDIShow.prototype.onDrawForeground=function(ctx){this._str&&(ctx.font="30px Arial",ctx.fillText(this._str,10,.8*this.size[1]))},LGMIDIShow.prototype.onGetInputs=function(){return[["in",LiteGraph.ACTION]]},LGMIDIShow.prototype.onGetOutputs=function(){return[["on_midi",LiteGraph.EVENT]]},LiteGraph.registerNodeType("midi/show",LGMIDIShow),LGMIDIFilter.title="MIDI Filter",LGMIDIFilter.desc="Filters MIDI messages",LGMIDIFilter.prototype.onAction=function(event,midi_event){midi_event&&midi_event.constructor===MIDIEvent&&(-1!=this.properties.channel&&midi_event.channel!=this.properties.channel||-1!=this.properties.cmd&&midi_event.cmd!=this.properties.cmd||-1!=this.properties.min_value&&midi_event.data[1]<this.properties.min_value||-1!=this.properties.max_value&&midi_event.data[1]>this.properties.max_value||this.trigger("on_midi",midi_event))},LiteGraph.registerNodeType("midi/filter",LGMIDIFilter),LGMIDIEvent.title="MIDIEvent",LGMIDIEvent.desc="Create a MIDI Event",LGMIDIEvent.prototype.onAction=function(event,midi_event){if("assign"==event)return this.properties.channel=midi_event.channel,this.properties.cmd=midi_event.cmd,this.properties.value1=midi_event.data[1],void(this.properties.value2=midi_event.data[2]);(midi_event=new MIDIEvent).channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?midi_event.setCommandFromString(this.properties.cmd):midi_event.cmd=this.properties.cmd,midi_event.data[0]=midi_event.cmd|midi_event.channel,midi_event.data[1]=Number(this.properties.value1),midi_event.data[2]=Number(this.properties.value2),this.trigger("on_midi",midi_event)},LGMIDIEvent.prototype.onExecute=function(){var props=this.properties;if(this.outputs)for(var i=0;i<this.outputs.length;++i){var v=null;switch(this.outputs[i].name){case"midi":(v=new MIDIEvent).setup([props.cmd,props.value1,props.value2]),v.channel=props.channel;break;case"command":v=props.cmd;break;case"cc":v=props.value1;break;case"cc_value":v=props.value2;break;case"note":v=props.cmd==MIDIEvent.NOTEON||props.cmd==MIDIEvent.NOTEOFF?props.value1:null;break;case"velocity":v=props.cmd==MIDIEvent.NOTEON?props.value2:null;break;case"pitch":v=props.cmd==MIDIEvent.NOTEON?MIDIEvent.computePitch(props.value1):null;break;case"pitchbend":v=props.cmd==MIDIEvent.PITCHBEND?MIDIEvent.computePitchBend(props.value1,props.value2):null;break;default:continue}null!==v&&this.setOutputData(i,v)}},LGMIDIEvent.prototype.onPropertyChanged=function(name,value){"cmd"==name&&(this.properties.cmd=MIDIEvent.computeCommandFromString(value))},LGMIDIEvent.prototype.onGetOutputs=function(){return[["midi","midi"],["on_midi",LiteGraph.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["pitchbend","number"]]},LiteGraph.registerNodeType("midi/event",LGMIDIEvent),LGMIDICC.title="MIDICC",LGMIDICC.desc="gets a Controller Change",LGMIDICC.prototype.onExecute=function(){this.properties;MIDIInterface.input&&(this.properties.value=MIDIInterface.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)},LiteGraph.registerNodeType("midi/cc",LGMIDICC)}(),function(global){var LiteGraph=global.LiteGraph,LGAudio={};function LGAudioSource(){this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var context=LGAudio.getAudioContext();this.audionode=context.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}function LGAudioMediaSource(){this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var context=LGAudio.getAudioContext();this.audionode=context.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain}function LGAudioAnalyser(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var context=LGAudio.getAudioContext();this.audionode=context.createAnalyser(),this.audionode.graphnode=this,this.audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}function LGAudioGain(){this.properties={gain:1},this.audionode=LGAudio.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}function LGAudioConvolver(){this.properties={impulse_src:"",normalize:!0},this.audionode=LGAudio.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}function LGAudioDynamicsCompressor(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=LGAudio.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}function LGAudioWaveShaper(){this.properties={},this.audionode=LGAudio.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}function LGAudioMixer(){this.properties={gain1:.5,gain2:.5},this.audionode=LGAudio.getAudioContext().createGain(),this.audionode1=LGAudio.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=LGAudio.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}function LGAudioDelay(){this.properties={delayTime:.5},this.audionode=LGAudio.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}function LGAudioBiquadFilter(){this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=LGAudio.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}function LGAudioOscillatorNode(){this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=LGAudio.getAudioContext().createOscillator(),this.addOutput("out","audio")}function LGAudioVisualization(){this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}function LGAudioBandSignal(){this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}function LGAudioScript(){if(!LGAudioScript.default_code){var code=LGAudioScript.default_function.toString(),index=code.indexOf("{")+1,index2=code.lastIndexOf("}");LGAudioScript.default_code=code.substr(index,index2-index)}this.properties={code:LGAudioScript.default_code};var ctx=LGAudio.getAudioContext();ctx.createScriptProcessor?this.audionode=ctx.createScriptProcessor(4096,1,1):(console.warn("ScriptProcessorNode deprecated"),this.audionode=ctx.createGain()),this.processCode(),LGAudioScript._bypass_function||(LGAudioScript._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}function LGAudioDestination(){this.audionode=LGAudio.getAudioContext().destination,this.addInput("in","audio")}global.LGAudio=LGAudio,LGAudio.getAudioContext=function(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return console.error("AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(msg){console.log("msg",msg)},this._audio_context.onended=function(msg){console.log("ended",msg)},this._audio_context.oncomplete=function(msg){console.log("complete",msg)}}return this._audio_context},LGAudio.connect=function(audionodeA,audionodeB){try{audionodeA.connect(audionodeB)}catch(err){console.warn("LGraphAudio:",err)}},LGAudio.disconnect=function(audionodeA,audionodeB){try{audionodeA.disconnect(audionodeB)}catch(err){console.warn("LGraphAudio:",err)}},LGAudio.changeAllAudiosConnections=function(node,connect){if(node.inputs)for(var i=0;i<node.inputs.length;++i){var input=node.inputs[i];if(link_info=node.graph.links[input.link]){var origin_node=node.graph.getNodeById(link_info.origin_id),origin_audionode=null;origin_audionode=origin_node.getAudioNodeInOutputSlot?origin_node.getAudioNodeInOutputSlot(link_info.origin_slot):origin_node.audionode;var target_audionode=null;target_audionode=node.getAudioNodeInInputSlot?node.getAudioNodeInInputSlot(i):node.audionode,connect?LGAudio.connect(origin_audionode,target_audionode):LGAudio.disconnect(origin_audionode,target_audionode)}}if(node.outputs)for(i=0;i<node.outputs.length;++i)for(var output=node.outputs[i],j=0;j<output.links.length;++j){var link_info;if(link_info=node.graph.links[output.links[j]]){origin_audionode=null;origin_audionode=node.getAudioNodeInOutputSlot?node.getAudioNodeInOutputSlot(i):node.audionode;var target_node=node.graph.getNodeById(link_info.target_id);target_audionode=null;target_audionode=target_node.getAudioNodeInInputSlot?target_node.getAudioNodeInInputSlot(link_info.target_slot):target_node.audionode,connect?LGAudio.connect(origin_audionode,target_audionode):LGAudio.disconnect(origin_audionode,target_audionode)}}},LGAudio.onConnectionsChange=function(connection,slot,connected,link_info){if(connection==LiteGraph.OUTPUT){var target_node=null;if(link_info&&(target_node=this.graph.getNodeById(link_info.target_id)),target_node){var local_audionode=null;local_audionode=this.getAudioNodeInOutputSlot?this.getAudioNodeInOutputSlot(slot):this.audionode;var target_audionode=null;target_audionode=target_node.getAudioNodeInInputSlot?target_node.getAudioNodeInInputSlot(link_info.target_slot):target_node.audionode,connected?LGAudio.connect(local_audionode,target_audionode):LGAudio.disconnect(local_audionode,target_audionode)}}},LGAudio.createAudioNodeWrapper=function(class_object){var old_func=class_object.prototype.onPropertyChanged;class_object.prototype.onPropertyChanged=function(name,value){old_func&&old_func.call(this,name,value),this.audionode&&void 0!==this.audionode[name]&&(void 0!==this.audionode[name].value?this.audionode[name].value=value:this.audionode[name]=value)},class_object.prototype.onConnectionsChange=LGAudio.onConnectionsChange},LGAudio.cached_audios={},LGAudio.loadSound=function(url,on_complete,on_error){if(!LGAudio.cached_audios[url]||-1!=url.indexOf("blob:")){LGAudio.onProcessAudioURL&&(url=LGAudio.onProcessAudioURL(url));var request=new XMLHttpRequest;request.open("GET",url,!0),request.responseType="arraybuffer";var context=LGAudio.getAudioContext();return request.onload=function(){console.log("AudioSource loaded"),context.decodeAudioData(request.response,function(buffer){console.log("AudioSource decoded"),LGAudio.cached_audios[url]=buffer,on_complete&&on_complete(buffer)},onError)},request.send(),request}function onError(err){console.log("Audio loading sample error:",err),on_error&&on_error(err)}on_complete&&on_complete(LGAudio.cached_audios[url])},LGAudioSource["@src"]={widget:"resource"},LGAudioSource.supported_extensions=["wav","ogg","mp3"],LGAudioSource.prototype.onAdded=function(graph){graph.status===LGraph.STATUS_RUNNING&&this.onStart()},LGAudioSource.prototype.onStart=function(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)},LGAudioSource.prototype.onStop=function(){this.stopAllSounds()},LGAudioSource.prototype.onPause=function(){this.pauseAllSounds()},LGAudioSource.prototype.onUnpause=function(){this.unpauseAllSounds()},LGAudioSource.prototype.onRemoved=function(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)},LGAudioSource.prototype.stopAllSounds=function(){for(var i=0;i<this._audionodes.length;++i)this._audionodes[i].started&&(this._audionodes[i].started=!1,this._audionodes[i].stop());this._audionodes.length=0},LGAudioSource.prototype.pauseAllSounds=function(){LGAudio.getAudioContext().suspend()},LGAudioSource.prototype.unpauseAllSounds=function(){LGAudio.getAudioContext().resume()},LGAudioSource.prototype.onExecute=function(){if(this.inputs)for(var i=0;i<this.inputs.length;++i){var input=this.inputs[i];if(null!=input.link){var v=this.getInputData(i);if(void 0!==v)if("gain"==input.name)this.audionode.gain.value=v;else if("playbackRate"==input.name){this.properties.playbackRate=v;for(var j=0;j<this._audionodes.length;++j)this._audionodes[j].playbackRate.value=v}}}if(this.outputs)for(i=0;i<this.outputs.length;++i){"buffer"==this.outputs[i].name&&this._audiobuffer&&this.setOutputData(i,this._audiobuffer)}},LGAudioSource.prototype.onAction=function(event){this._audiobuffer&&("Play"==event?this.playBuffer(this._audiobuffer):"Stop"==event&&this.stopAllSounds())},LGAudioSource.prototype.onPropertyChanged=function(name,value){if("src"==name)this.loadSound(value);else if("gain"==name)this.audionode.gain.value=value;else if("playbackRate"==name)for(var j=0;j<this._audionodes.length;++j)this._audionodes[j].playbackRate.value=value},LGAudioSource.prototype.playBuffer=function(buffer){var that=this,audionode=LGAudio.getAudioContext().createBufferSource();return this._last_sourcenode=audionode,audionode.graphnode=this,audionode.buffer=buffer,audionode.loop=this.properties.loop,audionode.playbackRate.value=this.properties.playbackRate,this._audionodes.push(audionode),audionode.connect(this.audionode),this._audionodes.push(audionode),audionode.onended=function(){that.trigger("ended");var index=that._audionodes.indexOf(audionode);-1!=index&&that._audionodes.splice(index,1)},audionode.started||(audionode.started=!0,audionode.start()),audionode},LGAudioSource.prototype.loadSound=function(url){var that=this;this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,url&&(this._request=LGAudio.loadSound(url,function(buffer){this.boxcolor=LiteGraph.NODE_DEFAULT_BOXCOLOR,that._audiobuffer=buffer,that._loading_audio=!1,that.graph&&that.graph.status===LGraph.STATUS_RUNNING&&that.onStart()}),this._loading_audio=!0,this.boxcolor="#AA4")},LGAudioSource.prototype.onConnectionsChange=LGAudio.onConnectionsChange,LGAudioSource.prototype.onGetInputs=function(){return[["playbackRate","number"],["Play",LiteGraph.ACTION],["Stop",LiteGraph.ACTION]]},LGAudioSource.prototype.onGetOutputs=function(){return[["buffer","audiobuffer"],["ended",LiteGraph.EVENT]]},LGAudioSource.prototype.onDropFile=function(file){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);var url=URL.createObjectURL(file);this.properties.src=url,this.loadSound(url),this._dropped_url=url},LGAudioSource.title="Source",LGAudioSource.desc="Plays audio",LiteGraph.registerNodeType("audio/source",LGAudioSource),LGAudioMediaSource.prototype.onAdded=function(graph){graph.status===LGraph.STATUS_RUNNING&&this.onStart()},LGAudioMediaSource.prototype.onStart=function(){null!=this._media_stream||this._waiting_confirmation||this.openStream()},LGAudioMediaSource.prototype.onStop=function(){this.audionode.gain.value=0},LGAudioMediaSource.prototype.onPause=function(){this.audionode.gain.value=0},LGAudioMediaSource.prototype.onUnpause=function(){this.audionode.gain.value=this.properties.gain},LGAudioMediaSource.prototype.onRemoved=function(){if(this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream){var tracks=this._media_stream.getTracks();tracks.length&&tracks[0].stop()}},LGAudioMediaSource.prototype.openStream=function(){if(navigator.mediaDevices){this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(function(err){console.log("Media rejected",err),that._media_stream=!1,that.boxcolor="red"});var that=this}else console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags")},LGAudioMediaSource.prototype.streamReady=function(localMediaStream){this._media_stream=localMediaStream,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var context=LGAudio.getAudioContext();this.audiosource_node=context.createMediaStreamSource(localMediaStream),this.audiosource_node.graphnode=this,this.audiosource_node.connect(this.audionode),this.boxcolor="white"},LGAudioMediaSource.prototype.onExecute=function(){if(null!=this._media_stream||this._waiting_confirmation||this.openStream(),this.inputs)for(var i=0;i<this.inputs.length;++i){var input=this.inputs[i];if(null!=input.link){var v=this.getInputData(i);void 0!==v&&"gain"==input.name&&(this.audionode.gain.value=this.properties.gain=v)}}},LGAudioMediaSource.prototype.onAction=function(event){"Play"==event?this.audionode.gain.value=this.properties.gain:"Stop"==event&&(this.audionode.gain.value=0)},LGAudioMediaSource.prototype.onPropertyChanged=function(name,value){"gain"==name&&(this.audionode.gain.value=value)},LGAudioMediaSource.prototype.onConnectionsChange=LGAudio.onConnectionsChange,LGAudioMediaSource.prototype.onGetInputs=function(){return[["playbackRate","number"],["Play",LiteGraph.ACTION],["Stop",LiteGraph.ACTION]]},LGAudioMediaSource.title="MediaSource",LGAudioMediaSource.desc="Plays microphone",LiteGraph.registerNodeType("audio/media_source",LGAudioMediaSource),LGAudioAnalyser.prototype.onPropertyChanged=function(name,value){this.audionode[name]=value},LGAudioAnalyser.prototype.onExecute=function(){if(this.isOutputConnected(0)){var bufferLength=this.audionode.frequencyBinCount;this._freq_bin&&this._freq_bin.length==bufferLength||(this._freq_bin=new Uint8Array(bufferLength)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)}if(this.isOutputConnected(1)){bufferLength=this.audionode.frequencyBinCount;this._time_bin&&this._time_bin.length==bufferLength||(this._time_bin=new Uint8Array(bufferLength)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin)}for(var i=1;i<this.inputs.length;++i){var input=this.inputs[i];if(null!=input.link){var v=this.getInputData(i);void 0!==v&&(this.audionode[input.name].value=v)}}},LGAudioAnalyser.prototype.onGetInputs=function(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]},LGAudioAnalyser.prototype.onGetOutputs=function(){return[["freqs","array"],["samples","array"]]},LGAudioAnalyser.title="Analyser",LGAudioAnalyser.desc="Audio Analyser",LiteGraph.registerNodeType("audio/analyser",LGAudioAnalyser),LGAudioGain.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var i=1;i<this.inputs.length;++i){var input=this.inputs[i],v=this.getInputData(i);void 0!==v&&(this.audionode[input.name].value=v)}},LGAudio.createAudioNodeWrapper(LGAudioGain),LGAudioGain.title="Gain",LGAudioGain.desc="Audio gain",LiteGraph.registerNodeType("audio/gain",LGAudioGain),LGAudio.createAudioNodeWrapper(LGAudioConvolver),LGAudioConvolver.prototype.onRemove=function(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)},LGAudioConvolver.prototype.onPropertyChanged=function(name,value){"impulse_src"==name?this.loadImpulse(value):"normalize"==name&&(this.audionode.normalize=value)},LGAudioConvolver.prototype.onDropFile=function(file){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(file),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)},LGAudioConvolver.prototype.loadImpulse=function(url){var that=this;this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,url&&(this._request=LGAudio.loadSound(url,function(buffer){that._impulse_buffer=buffer,that.audionode.buffer=buffer,console.log("Impulse signal set"),that._loading_impulse=!1}),this._loading_impulse=!0)},LGAudioConvolver.title="Convolver",LGAudioConvolver.desc="Convolves the signal (used for reverb)",LiteGraph.registerNodeType("audio/convolver",LGAudioConvolver),LGAudio.createAudioNodeWrapper(LGAudioDynamicsCompressor),LGAudioDynamicsCompressor.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var i=1;i<this.inputs.length;++i){var input=this.inputs[i];if(null!=input.link){var v=this.getInputData(i);void 0!==v&&(this.audionode[input.name].value=v)}}},LGAudioDynamicsCompressor.prototype.onGetInputs=function(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]},LGAudioDynamicsCompressor.title="DynamicsCompressor",LGAudioDynamicsCompressor.desc="Dynamics Compressor",LiteGraph.registerNodeType("audio/dynamicsCompressor",LGAudioDynamicsCompressor),LGAudioWaveShaper.prototype.onExecute=function(){if(this.inputs&&this.inputs.length){var v=this.getInputData(1);void 0!==v&&(this.audionode.curve=v)}},LGAudioWaveShaper.prototype.setWaveShape=function(shape){this.audionode.curve=shape},LGAudio.createAudioNodeWrapper(LGAudioWaveShaper),LGAudioMixer.prototype.getAudioNodeInInputSlot=function(slot){return 0==slot?this.audionode1:2==slot?this.audionode2:void 0},LGAudioMixer.prototype.onPropertyChanged=function(name,value){"gain1"==name?this.audionode1.gain.value=value:"gain2"==name&&(this.audionode2.gain.value=value)},LGAudioMixer.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var i=1;i<this.inputs.length;++i){var input=this.inputs[i];if(null!=input.link&&"audio"!=input.type){var v=this.getInputData(i);void 0!==v&&(1==i?this.audionode1.gain.value=v:3==i&&(this.audionode2.gain.value=v))}}},LGAudio.createAudioNodeWrapper(LGAudioMixer),LGAudioMixer.title="Mixer",LGAudioMixer.desc="Audio mixer",LiteGraph.registerNodeType("audio/mixer",LGAudioMixer),LGAudio.createAudioNodeWrapper(LGAudioDelay),LGAudioDelay.prototype.onExecute=function(){var v=this.getInputData(1);void 0!==v&&(this.audionode.delayTime.value=v)},LGAudioDelay.title="Delay",LGAudioDelay.desc="Audio delay",LiteGraph.registerNodeType("audio/delay",LGAudioDelay),LGAudioBiquadFilter.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var i=1;i<this.inputs.length;++i){var input=this.inputs[i];if(null!=input.link){var v=this.getInputData(i);void 0!==v&&(this.audionode[input.name].value=v)}}},LGAudioBiquadFilter.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["Q","number"]]},LGAudio.createAudioNodeWrapper(LGAudioBiquadFilter),LGAudioBiquadFilter.title="BiquadFilter",LGAudioBiquadFilter.desc="Audio filter",LiteGraph.registerNodeType("audio/biquadfilter",LGAudioBiquadFilter),LGAudioOscillatorNode.prototype.onStart=function(){this.audionode.started||(this.audionode.started=!0,this.audionode.start())},LGAudioOscillatorNode.prototype.onStop=function(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())},LGAudioOscillatorNode.prototype.onPause=function(){this.onStop()},LGAudioOscillatorNode.prototype.onUnpause=function(){this.onStart()},LGAudioOscillatorNode.prototype.onExecute=function(){if(this.inputs&&this.inputs.length)for(var i=0;i<this.inputs.length;++i){var input=this.inputs[i];if(null!=input.link){var v=this.getInputData(i);void 0!==v&&(this.audionode[input.name].value=v)}}},LGAudioOscillatorNode.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["type","string"]]},LGAudio.createAudioNodeWrapper(LGAudioOscillatorNode),LGAudioOscillatorNode.title="Oscillator",LGAudioOscillatorNode.desc="Oscillator",LiteGraph.registerNodeType("audio/oscillator",LGAudioOscillatorNode),LGAudioVisualization.prototype.onExecute=function(){this._last_buffer=this.getInputData(0);var v=this.getInputData(1);void 0!==v&&(this.properties.mark=v),this.setDirtyCanvas(!0,!1)},LGAudioVisualization.prototype.onDrawForeground=function(ctx){if(this._last_buffer){var buffer=this._last_buffer,delta=buffer.length/this.size[0],h=this.size[1];ctx.fillStyle="black",ctx.fillRect(0,0,this.size[0],this.size[1]),ctx.strokeStyle="white",ctx.beginPath();var x=0;if(this.properties.continuous){ctx.moveTo(x,h);for(var i=0;i<buffer.length;i+=delta)ctx.lineTo(x,h-buffer[0|i]/255*h),x++}else for(i=0;i<buffer.length;i+=delta)ctx.moveTo(x+.5,h),ctx.lineTo(x+.5,h-buffer[0|i]/255*h),x++;if(ctx.stroke(),this.properties.mark>=0){var binfreq=LGAudio.getAudioContext().sampleRate/buffer.length;(x=this.properties.mark/binfreq*2/delta)>=this.size[0]&&(x=this.size[0]-1),ctx.strokeStyle="red",ctx.beginPath(),ctx.moveTo(x,h),ctx.lineTo(x,0),ctx.stroke()}}},LGAudioVisualization.title="Visualization",LGAudioVisualization.desc="Audio Visualization",LiteGraph.registerNodeType("audio/visualization",LGAudioVisualization),LGAudioBandSignal.prototype.onExecute=function(){if(this._freqs=this.getInputData(0),this._freqs){var band=this.properties.band;void 0!==(v=this.getInputData(1))&&(band=v);var index=band/(LGAudio.getAudioContext().sampleRate/this._freqs.length)*2,v=0;if(index<0&&(v=this._freqs[0]),index>=this._freqs.length)v=this._freqs[this._freqs.length-1];else{var pos=0|index,f=index-pos;v=this._freqs[pos]*(1-f)+this._freqs[pos+1]*f}this.setOutputData(0,v/255*this.properties.amplitude)}},LGAudioBandSignal.prototype.onGetInputs=function(){return[["band","number"]]},LGAudioBandSignal.title="Signal",LGAudioBandSignal.desc="extract the signal of some frequency",LiteGraph.registerNodeType("audio/signal",LGAudioBandSignal),LGAudioScript.prototype.onAdded=function(graph){graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)},LGAudioScript["@code"]={widget:"code"},LGAudioScript.prototype.onStart=function(){this.audionode.onaudioprocess=this._callback},LGAudioScript.prototype.onStop=function(){this.audionode.onaudioprocess=LGAudioScript._bypass_function},LGAudioScript.prototype.onPause=function(){this.audionode.onaudioprocess=LGAudioScript._bypass_function},LGAudioScript.prototype.onUnpause=function(){this.audionode.onaudioprocess=this._callback},LGAudioScript.prototype.onExecute=function(){},LGAudioScript.prototype.onRemoved=function(){this.audionode.onaudioprocess=LGAudioScript._bypass_function},LGAudioScript.prototype.processCode=function(){try{var func=new Function("properties",this.properties.code);this._script=new func(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(err){console.error("Error in onaudioprocess code",err),this._callback=LGAudioScript._bypass_function,this.audionode.onaudioprocess=this._callback}},LGAudioScript.prototype.onPropertyChanged=function(name,value){"code"==name&&(this.properties.code=value,this.processCode(),this.graph&&this.graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))},LGAudioScript.default_function=function(){this.onaudioprocess=function(audioProcessingEvent){for(var inputBuffer=audioProcessingEvent.inputBuffer,outputBuffer=audioProcessingEvent.outputBuffer,channel=0;channel<outputBuffer.numberOfChannels;channel++)for(var inputData=inputBuffer.getChannelData(channel),outputData=outputBuffer.getChannelData(channel),sample=0;sample<inputBuffer.length;sample++)outputData[sample]=inputData[sample]}},LGAudio.createAudioNodeWrapper(LGAudioScript),LGAudioScript.title="Script",LGAudioScript.desc="apply script to signal",LiteGraph.registerNodeType("audio/script",LGAudioScript),LGAudioDestination.title="Destination",LGAudioDestination.desc="Audio output",LiteGraph.registerNodeType("audio/destination",LGAudioDestination)}(exports),function(global){var LiteGraph=exports.LiteGraph;function LGWebSocket(){this.size=[60,20],this.addInput("send",LiteGraph.ACTION),this.addOutput("received",LiteGraph.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph"},this._ws=null,this._last_data=[]}function LGSillyClient(){this.size=[60,20],this.addInput("send",LiteGraph.ACTION),this.addOutput("received",LiteGraph.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"tamats.com:55000",room:"lgraph",save_bandwidth:!0},this._server=null,this.createSocket(),this._last_input_data=[],this._last_output_data=[]}LGWebSocket.title="WebSocket",LGWebSocket.desc="Send data through a websocket",LGWebSocket.prototype.onPropertyChanged=function(name,value){"url"==name&&this.createSocket()},LGWebSocket.prototype.onExecute=function(){if(!this._ws&&this.properties.url&&this.createSocket(),this._ws&&this._ws.readyState==WebSocket.OPEN){for(var room=this.properties.room,i=1;i<this.inputs.length;++i){var data=this.getInputData(i);if(null!=data){var json;try{json=JSON.stringify({type:0,room:room,channel:i,data:data})}catch(err){continue}this._ws.send(json)}}for(i=1;i<this.outputs.length;++i)this.setOutputData(i,this._last_data[i])}},LGWebSocket.prototype.createSocket=function(){var that=this,url=this.properties.url;"ws"!=url.substr(0,2)&&(url="ws://"+url),this._ws=new WebSocket(url),this._ws.onopen=function(){console.log("ready"),that.boxcolor="#8E8"},this._ws.onmessage=function(e){var data=JSON.parse(e.data);data.room&&data.room!=this.properties.room||(1==e.data.type?that.triggerSlot(0,data):that._last_data[e.data.channel||0]=data.data)},this._ws.onerror=function(e){console.log("couldnt connect to websocket"),that.boxcolor="#E88"},this._ws.onclose=function(e){console.log("connection closed"),that.boxcolor="#000"}},LGWebSocket.prototype.send=function(data){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send(JSON.stringify({type:1,msg:data}))},LGWebSocket.prototype.onAction=function(action,param){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send({type:1,room:this.properties.room,action:action,data:param})},LGWebSocket.prototype.onGetInputs=function(){return[["in",0]]},LGWebSocket.prototype.onGetOutputs=function(){return[["out",0]]},LiteGraph.registerNodeType("network/websocket",LGWebSocket),LGSillyClient.title="SillyClient",LGSillyClient.desc="Connects to SillyServer to broadcast messages",LGSillyClient.prototype.onPropertyChanged=function(name,value){var final_url=this.properties.url+"/"+this.properties.room;this._server&&this._final_url!=final_url&&(this._server.connect(this.properties.url,this.properties.room),this._final_url=final_url)},LGSillyClient.prototype.onExecute=function(){if(this._server&&this._server.is_connected){for(var save_bandwidth=this.properties.save_bandwidth,i=1;i<this.inputs.length;++i){var data=this.getInputData(i);if(null!=data){if(save_bandwidth&&this._last_input_data[i]==data)continue;this._server.sendMessage({type:0,channel:i,data:data}),this._last_input_data[i]=data}}for(i=1;i<this.outputs.length;++i)this.setOutputData(i,this._last_output_data[i])}},LGSillyClient.prototype.createSocket=function(){var that=this;if("undefined"==typeof SillyClient)return this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),void(this._error=!0);this._server=new SillyClient,this._server.on_ready=function(){console.log("ready"),that.boxcolor="#8E8"},this._server.on_message=function(id,msg){var data=null;try{data=JSON.parse(msg)}catch(err){return}1==data.type?that.triggerSlot(0,data):that._last_output_data[data.channel||0]=data.data},this._server.on_error=function(e){console.log("couldnt connect to websocket"),that.boxcolor="#E88"},this._server.on_close=function(e){console.log("connection closed"),that.boxcolor="#000"},this.properties.url&&this.properties.room&&(this._server.connect(this.properties.url,this.properties.room),this._final_url=this.properties.url+"/"+this.properties.room)},LGSillyClient.prototype.send=function(data){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,data:data})},LGSillyClient.prototype.onAction=function(action,param){this._server&&this._server.is_connected&&this._server.sendMessage({type:1,action:action,data:param})},LGSillyClient.prototype.onGetInputs=function(){return[["in",0]]},LGSillyClient.prototype.onGetOutputs=function(){return[["out",0]]},LiteGraph.registerNodeType("network/sillyclient",LGSillyClient)}()}),$__System.registerDynamic("11",["14"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var litegraph_js_1=$__require("14"),IGraphNode=function(){function IGraphNode(){this.shape="round",this.pos=[60,20],this.size=[60,20],this.store={}}return IGraphNode.prototype.onConnectionsChange=function(type,slot,added,link,input){IGraphNode.Loaded&&this.mode!==litegraph_js_1.LiteGraph.NEVER&&(type===litegraph_js_1.LiteGraph.INPUT&&0===slot&&(added&&input.type===litegraph_js_1.LiteGraph.EVENT?this.mode=litegraph_js_1.LiteGraph.ON_TRIGGER:this.mode=litegraph_js_1.LiteGraph.ALWAYS),IGraphNode.SetColor(this))},IGraphNode.SetColor=function(node){switch(node.mode){case litegraph_js_1.LiteGraph.ALWAYS:node.color="#555",node.bgColor="#AAA";break;case litegraph_js_1.LiteGraph.ON_EVENT:node.color="#55A",node.bgColor="#44A";break;case litegraph_js_1.LiteGraph.ON_TRIGGER:node.color="#151",node.bgColor="#4A4";break;case litegraph_js_1.LiteGraph.NEVER:node.color="#A55",node.bgColor="#A44"}},IGraphNode.prototype.onDrawBackground=function(ctx,graph,canvas,text){if(!this.flags.collapsed&&text){ctx.font="14px Arial",ctx.fillStyle="grey",ctx.textAlign="center",ctx.shadowColor="#000000",ctx.shadowBlur=2;var measure=ctx.measureText(text);this.size[0]<=measure.width&&(this.size[0]=measure.width+100),ctx.fillText(text,.5*this.size[0],this.size[1]+15)}},IGraphNode.prototype.setNodeState=function(warning){warning?this.boxcolor="#ffff00":delete this.boxcolor},IGraphNode.RegisterNode=function(path,ctor){litegraph_js_1.LiteGraph.registered_node_types[path]||litegraph_js_1.LiteGraph.registerNodeType(path,ctor)},IGraphNode}();exports.IGraphNode=IGraphNode}),$__System.registerDynamic("10",["c","11"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__values=exports&&exports.__values||function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")},__read=exports&&exports.__read||function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar};Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),types_1=$__require("11");exports.registerNode=function(description,object){var _a;(!object||object instanceof description.ctor)&&GraphNode.RegisterNode(description.path,((_a=function(_super){function class_1(){var _this=_super.call(this,description)||this;return _this.title=description.name,_this.desc=description.description,_this}return __extends(class_1,_super),class_1}(GraphNode)).Title=description.name,_a.Desc=description.description,_a))};var GraphNode=function(_super){function GraphNode(description){var _this=_super.call(this)||this;return _this.description=description,_this._propertiesOrder=[],_this._inputsOrder=[],_this._parametersOrder=[],_this._outputsOrder=[],description.properties&&description.properties.forEach(function(i){switch(i.type){case"number":case"string":case"boolean":_this._propertiesOrder.push(GraphNode.commonToCommon),_this.addProperty(i.name,i.defaultValue);break;case"vec2":_this._propertiesOrder.push(GraphNode.vec2ToVector2),_this.addProperty(i.name,[0,0]);break;case"vec3":_this._propertiesOrder.push(GraphNode.vec3ToVector3),_this.addProperty(i.name,[0,0,0]);break;case"vec4":_this._propertiesOrder.push(GraphNode.vec4ToVector4),_this.addProperty(i.name,[0,0,0,0])}}),description.inputs&&description.inputs.forEach(function(i){switch(i.type){case"number":case"string":_this._inputsOrder.push(GraphNode.commonToCommon);break;case"vec2":_this._inputsOrder.push(GraphNode.vec2ToVector2);break;case"vec3":_this._inputsOrder.push(GraphNode.vec3ToVector3);break;case"vec4":_this._inputsOrder.push(GraphNode.vec4ToVector4);break;case"col3":_this._inputsOrder.push(GraphNode.col3ToColor3);break;case"col4":_this._inputsOrder.push(GraphNode.col4ToColor4);break;default:_this._inputsOrder.push(GraphNode.inputToNode)}_this.addInput(i.name,i.type)}),description.parameters&&description.parameters.forEach(function(p){switch(p.type){case"number":case"string":_this._parametersOrder.push(GraphNode.commonToCommon);break;case"vec2":_this._parametersOrder.push(GraphNode.vec2ToVector2);break;case"vec3":_this._parametersOrder.push(GraphNode.vec3ToVector3);break;case"vec4":_this._parametersOrder.push(GraphNode.vec4ToVector4);break;case"col3":_this._parametersOrder.push(GraphNode.col3ToColor3);break;case"col4":_this._parametersOrder.push(GraphNode.col4ToColor4)}}),description.outputs&&description.outputs.forEach(function(o){switch(o.type){case"number":case"string":_this._outputsOrder.push(GraphNode.commonToCommon);break;case"vec2":_this._outputsOrder.push(GraphNode.vector2ToVec2);break;case"vec3":_this._outputsOrder.push(GraphNode.vector3ToVec3);break;case"vec4":_this._outputsOrder.push(GraphNode.vector4ToVec4);break;case"col3":_this._outputsOrder.push(GraphNode.color3ToCol3);break;case"col4":_this._outputsOrder.push(GraphNode.color4ToCol4);break;default:_this._outputsOrder.push(GraphNode.inputToNode)}_this.addOutput(o.name,o.type)}),description.widgets&&description.widgets.forEach(function(w){var widget=_this.addWidget(w.type,w.name,w.value,w.callback,w.options);"combo"===w.type&&(widget._value=w.value,Object.defineProperty(widget,"value",{get:function(){return widget._value},set:function(v){widget._value=v,w.callback&&w.callback(v,_this.graph,_this)}}))}),_this}return __extends(GraphNode,_super),GraphNode.prototype.onGetInputs=function(){return this.description&&this.description.onGetInputs().length>0?this.description.onGetInputs():[]},GraphNode.prototype.onGetOutputs=function(){return this.description&&this.description.onGetOutputs().length>0?this.description.onGetOutputs():[]},GraphNode.prototype.onExecute=function(){var e_1,_a,e_2,_b,e_3,_c,targetPath=this.properties["Target Path"],target=targetPath?GraphNode.GetTargetPath(targetPath,this.graph.scriptObject,this.graph.scriptScene):this.graph.scriptObject,functionRef=this.description.functionRef?"string"==typeof this.description.functionRef?GraphNode.GetProperty(target,this.description.functionRef):this.description.functionRef:null,inputs=[],parameters=[];if(this.description.inputs)try{for(var _d=__values(this.description.inputs.entries()),_e=_d.next();!_e.done;_e=_d.next()){var _f=__read(_e.value,2),index=_f[0],input=_f[1],data=this.getInputData(index);if(inputs.push({name:input.name,data:data}),data&&input.propertyPath){var split=input.propertyPath.split(".");GraphNode.GetEffectiveProperty(target,input.propertyPath)[split[split.length-1]]=GraphNode.nodeToOutput(data,"col3"===input.type||"col4"===input.type)}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_e&&!_e.done&&(_a=_d.return)&&_a.call(_d)}finally{if(e_1)throw e_1.error}}if(this.description.parameters){var _loop_1=function(index,parameter){if(parameter.inputName){var input=inputs.find(function(i){return i.name===parameter.inputName});if(!input&&!parameter.optional)return{value:console.warn('Warning: calling "'+this_1.description.functionRef+'", input "'+input.name+'" is mandatory')};parameters.push(this_1._parametersOrder[index](input.data))}},this_1=this;try{for(var _g=__values(this.description.parameters.entries()),_h=_g.next();!_h.done;_h=_g.next()){var _j=__read(_h.value,2),state_1=_loop_1(index=_j[0],_j[1]);if("object"==typeof state_1)return state_1.value}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_h&&!_h.done&&(_b=_g.return)&&_b.call(_g)}finally{if(e_2)throw e_2.error}}}var result=functionRef?"string"==typeof this.description.functionRef?functionRef.apply(target,parameters):functionRef(this,target,this.graph.scriptScene):null;if(this.description.outputs){var _loop_2=function(index,output){if(this_2.description.functionRef&&0===index)return this_2.setOutputData(index,this_2._outputsOrder[index](result)),"continue";if(output.propertyPath){if(output.propertyName){var property=GraphNode.GetProperty(target,this_2.properties[output.propertyName]);this_2.setOutputData(index,this_2._outputsOrder[index](property))}else{property=GraphNode.GetProperty(target,output.propertyPath);this_2.setOutputData(index,this_2._outputsOrder[index](property))}return"continue"}if(output.propertyName)return this_2.setOutputData(index,this_2.properties[output.propertyName]),"continue";if(output.inputName){var input=inputs.find(function(i){return i.name===output.inputName});return this_2.setOutputData(index,input.data),"continue"}},this_2=this;try{for(var _k=__values(this.description.outputs.entries()),_l=_k.next();!_l.done;_l=_k.next()){var _m=__read(_l.value,2);_loop_2(index=_m[0],_m[1])}}catch(e_3_1){e_3={error:e_3_1}}finally{try{_l&&!_l.done&&(_c=_k.return)&&_c.call(_k)}finally{if(e_3)throw e_3.error}}}},GraphNode.prototype.onDrawBackground=function(ctx,graph,canvas,text){this.description.drawBackground&&_super.prototype.onDrawBackground.call(this,ctx,graph,canvas,this.description.drawBackground(this,this.properties["Target Path"]))},GraphNode.prototype.onKeyUp=function(ev){46===ev.keyCode&&this.graph.remove(this)},GraphNode.prototype.isInputValid=function(value){return null!=value},GraphNode.GetProperty=function(object,path){for(var split=path.split("."),i=0;i<split.length;i++)object=object[split[i]];return object},GraphNode.GetEffectiveProperty=function(object,path){for(var split=path.split("."),i=0;i<split.length-1;i++)object=object[split[i]];return object},GraphNode.GetConstructorName=function(obj){var ctrName=null!=obj&&obj.constructor?obj.constructor.name:"";return""===ctrName&&(ctrName=typeof obj),ctrName},GraphNode.GetTargetPath=function(path,target,scene){return"Self"===path?target:"Scene"===path?scene:scene.getNodeByName(path)},GraphNode.inputToNode=function(value){switch(GraphNode.GetConstructorName(value).toLowerCase()){case"number":case"string":return value;case"vector2":case"vector3":case"vector4":return value.asArray();case"color3":case"color4":return value.asArray();default:return value}},GraphNode.nodeToOutput=function(value,asColor){switch(GraphNode.GetConstructorName(value).toLowerCase()){case"number":case"string":return value;case"array":switch(value.length){case 2:return babylonjs_1.Vector2.FromArray(value);case 3:return asColor?babylonjs_1.Color3.FromArray(value):babylonjs_1.Vector3.FromArray(value);case 4:return asColor?babylonjs_1.Color4.FromArray(value):babylonjs_1.Vector4.FromArray(value)}default:return value}},GraphNode.commonToCommon=function(value){return value},GraphNode.vec2ToVector2=function(vec2){return babylonjs_1.Vector2.FromArray(vec2)},GraphNode.vector2ToVec2=function(vector2){return vector2.asArray()},GraphNode.vec3ToVector3=function(vec3){return babylonjs_1.Vector3.FromArray(vec3)},GraphNode.vector3ToVec3=function(vector3){return vector3.asArray()},GraphNode.vec4ToVector4=function(vec4){return babylonjs_1.Vector4.FromArray(vec4)},GraphNode.vector4ToVec4=function(vector4){return vector4.asArray()},GraphNode.col3ToColor3=function(col3){return babylonjs_1.Color3.FromArray(col3)},GraphNode.color3ToCol3=function(color3){return color3.asArray()},GraphNode.col4ToColor4=function(col4){return babylonjs_1.Color4.FromArray(col4)},GraphNode.color4ToCol4=function(color4){return color4.asArray()},GraphNode}(types_1.IGraphNode);exports.GraphNode=GraphNode}),$__System.registerDynamic("20",["10"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var graph_node_1=$__require("10");exports.registerAllSceneNodes=function(object){graph_node_1.registerNode({name:"Get Node By Name",description:"Returns the given node by name",path:"scene/getnodebyname",ctor:Object,functionRef:function(node,target,scene){return node.store.node=node.store.node||scene.getNodeByName(node.getInputData(0)||node.properties["Target Path"]),node.store.node},inputs:[{name:"Name",type:"string"}],properties:[{name:"Target Path",type:"string",defaultValue:"Self"}],outputs:[{name:"Mesh",type:"node"}],drawBackground:function(node,target){return target}},object),graph_node_1.registerNode({name:"Get Mesh By Name",description:"Returns the given mesh by name",path:"scene/getmeshbyname",ctor:Object,functionRef:function(node,target,scene){return node.store.mesh=node.store.mesh||scene.getMeshByName(node.getInputData(0)||node.properties["Target Path"]),node.store.mesh},inputs:[{name:"Name",type:"string"}],properties:[{name:"Target Path",type:"string",defaultValue:"Self"}],outputs:[{name:"Mesh",type:"node,mesh"}],drawBackground:function(node,target){return target}},object)}}),$__System.registerDynamic("21",["12","16","17","18","19","1a","1b","1c","1d","1e","1f","20"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var types_1=$__require("12"),functions_1=$__require("16"),utils_1=$__require("17"),math_1=$__require("18"),properties_1=$__require("19"),transforms_1=$__require("1a"),pointer_1=$__require("1b"),keyboard_1=$__require("1c"),abstract_mesh_1=$__require("1d"),animation_1=$__require("1e"),sound_1=$__require("1f"),scene_1=$__require("20");exports.registerAllNodes=function(object){types_1.registerAllTypeNodes(object),functions_1.registerAllFunctionNodes(object),utils_1.registerAllUtilsNodes(object),math_1.registerAllMathNodes(object),properties_1.registerAllPropertiesNodes(object),transforms_1.registerAllTransformsNodes(object),pointer_1.registerAllPointerNodes(object),keyboard_1.registerAllKeyboardNodes(object),abstract_mesh_1.registerAllAbstractMeshNodes(object),animation_1.registerAllAnimationNodes(object),sound_1.registerAllSoundNodes(object),scene_1.registerAllSceneNodes(object)}}),$__System.registerDynamic("15",["c","14","d","e","10","21"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),litegraph_js_1=$__require("14");exports.LGraph=litegraph_js_1.LGraph,exports.LGraphCanvas=litegraph_js_1.LGraphCanvas,exports.LiteGraph=litegraph_js_1.LiteGraph,exports.LGraphGroup=litegraph_js_1.LGraphGroup;var extensions_1=$__require("d"),extension_1=$__require("e"),graph_node_1=$__require("10");exports.GraphNode=graph_node_1.GraphNode;var nodes_list_1=$__require("21"),GraphExtension=function(_super){function GraphExtension(scene){var _this=_super.call(this,scene)||this;return _this.id="graph-editor",_this.assetsCaption="Graphs",_this.datas=null,_this}return __extends(GraphExtension,_super),GraphExtension.prototype.onGetAssets=function(){var data=this.onSerialize(),attached=[],unAttached=[];return data.graphs.forEach(function(s){if(data.nodes.find(function(n){return void 0!==n.metadatas.find(function(m){return m.graphId===s.id})}))return attached.push({name:s.name,data:s});unAttached.push({name:s.name,data:s})}),[{separator:"Attached"}].concat(attached).concat([{separator:"Unattached"}]).concat(unAttached)},GraphExtension.prototype.onRemoveAsset=function(asset){var data=asset.data,remove=function(objects){objects.forEach(function(o){if(o.metadata&&o.metadata.behaviorGraph)for(var links=o.metadata.behaviorGraph.metadatas,i=0;i<links.length;i++)links[i].graphId===data.id&&(links.splice(i,1),i--)})};remove([this.scene]),remove(this.scene.meshes),remove(this.scene.lights),remove(this.scene.cameras);var index=this.scene.metadata.behaviorGraphs.indexOf(data);-1!==index&&this.scene.metadata.behaviorGraphs.splice(index,1)},GraphExtension.prototype.onAddAsset=function(asset){this.scene.metadata.behaviorGraphs.push(asset.data)},GraphExtension.prototype.onDragAndDropAsset=function(targetMesh,asset){targetMesh.metadata=targetMesh.metadata||{},targetMesh.metadata.behaviorGraph||(targetMesh.metadata.behaviorGraph={node:targetMesh.name,metadatas:[]}),targetMesh.metadata.behaviorGraph.metadatas.push({graphId:asset.data.id,active:!0})},GraphExtension.prototype.onApply=function(data){var _this=this;this.datas=data,GraphExtension.RegisterNodes(),this.datas.nodes.forEach(function(d){var node="Scene"===d.node?_this.scene:_this.scene.getNodeByID(d.nodeId)||_this.scene.getNodeByName(d.node);node&&d.metadatas.forEach(function(m){if(m.active){var graph=new litegraph_js_1.LGraph;graph.scriptObject=node,graph.scriptScene=_this.scene,graph_node_1.GraphNode.Loaded=!1;var effectiveData=_this.datas.graphs.find(function(s){return s.id===m.graphId});graph.configure(JSON.parse(JSON.stringify(effectiveData.graph))),graph.variables=effectiveData.variables,graph_node_1.GraphNode.Loaded=!0,_this.scene.onReadyObservable.addOnce(function(){_this.scene.onBeforeRenderObservable.add(function(){graph.runStep(1,!0)})})}})})},GraphExtension.prototype.onSerialize=function(){var result={graphs:this.scene.metadata&&this.scene.metadata.behaviorGraphs||[],nodes:[]},add=function(objects){objects.forEach(function(o){if(o.metadata&&o.metadata.behaviorGraph){var behavior=o.metadata.behaviorGraph;behavior.node=o instanceof babylonjs_1.Scene?"Scene":o instanceof Node?o.name:o.id,behavior.nodeId=o instanceof babylonjs_1.Scene?"Scene":o.id,result.nodes.push(behavior)}})};return add([this.scene]),add(this.scene.meshes),add(this.scene.lights),add(this.scene.cameras),result},GraphExtension.prototype.onLoad=function(data){var _this=this;if(!data.graphs){var oldData=data;data={graphs:[],nodes:[]},oldData.forEach(function(od){var node={node:od.node,nodeId:od.node,metadatas:[]};od.metadatas.forEach(function(m){var id=babylonjs_1.Tools.RandomId();data.graphs.push({name:m.name,id:id,graph:m.graph,variables:m.variables||[]}),node.metadatas.push({graphId:id,active:m.active})}),data.nodes.push(node)})}this.datas=data,this.scene.metadata=this.scene.metadata||{},this.scene.metadata.behaviorGraphs=this.datas.graphs,this.datas.nodes.forEach(function(d){var node="Scene"===d.node?_this.scene:_this.scene.getNodeByID(d.nodeId)||_this.scene.getNodeByName(d.node);node&&(node.metadata=node.metadata||{},node.metadata.behaviorGraph=d)})},GraphExtension.ClearNodes=function(){litegraph_js_1.LiteGraph.registered_node_types={}},GraphExtension.RegisterNodes=function(object){litegraph_js_1.LiteGraph.registered_node_types={},nodes_list_1.registerAllNodes(object)},GraphExtension}(extension_1.default);exports.default=GraphExtension,extensions_1.default.Register("BehaviorGraphExtension",GraphExtension)}),definition=function(){function pathTo(node){for(var curr=node,path=[];curr.parent;)path.unshift(curr),curr=curr.parent;return path}var astar={search:function(graph,start,end,options){graph.cleanDirty();var heuristic=(options=options||{}).heuristic||astar.heuristics.manhattan,closest=options.closest||!1,openHeap=new BinaryHeap(function(node){return node.f}),closestNode=start;for(start.h=heuristic(start,end),openHeap.push(start);openHeap.size()>0;){var currentNode=openHeap.pop();if(currentNode===end)return pathTo(currentNode);currentNode.closed=!0;for(var neighbors=graph.neighbors(currentNode),i=0,il=neighbors.length;i<il;++i){var neighbor=neighbors[i];if(!neighbor.closed&&!neighbor.isWall()){var gScore=currentNode.g+neighbor.getCost(currentNode),beenVisited=neighbor.visited;(!beenVisited||gScore<neighbor.g)&&(neighbor.visited=!0,neighbor.parent=currentNode,neighbor.h=neighbor.h||heuristic(neighbor,end),neighbor.g=gScore,neighbor.f=neighbor.g+neighbor.h,graph.markDirty(neighbor),closest&&(neighbor.h<closestNode.h||neighbor.h===closestNode.h&&neighbor.g<closestNode.g)&&(closestNode=neighbor),beenVisited?openHeap.rescoreElement(neighbor):openHeap.push(neighbor))}}}return closest?pathTo(closestNode):[]},heuristics:{manhattan:function(pos0,pos1){return Math.abs(pos1.x-pos0.x)+Math.abs(pos1.y-pos0.y)},diagonal:function(pos0,pos1){var D2=Math.sqrt(2),d1=Math.abs(pos1.x-pos0.x),d2=Math.abs(pos1.y-pos0.y);return 1*(d1+d2)+(D2-2)*Math.min(d1,d2)}},cleanNode:function(node){node.f=0,node.g=0,node.h=0,node.visited=!1,node.closed=!1,node.parent=null}};function Graph(gridIn,options){options=options||{},this.nodes=[],this.diagonal=!!options.diagonal,this.grid=[];for(var x=0;x<gridIn.length;x++){this.grid[x]=[];for(var y=0,row=gridIn[x];y<row.length;y++){var node=new GridNode(x,y,row[y]);this.grid[x][y]=node,this.nodes.push(node)}}this.init()}function GridNode(x,y,weight){this.x=x,this.y=y,this.weight=weight}function BinaryHeap(scoreFunction){this.content=[],this.scoreFunction=scoreFunction}return Graph.prototype.init=function(){this.dirtyNodes=[];for(var i=0;i<this.nodes.length;i++)astar.cleanNode(this.nodes[i])},Graph.prototype.cleanDirty=function(){for(var i=0;i<this.dirtyNodes.length;i++)astar.cleanNode(this.dirtyNodes[i]);this.dirtyNodes=[]},Graph.prototype.markDirty=function(node){this.dirtyNodes.push(node)},Graph.prototype.neighbors=function(node){var ret=[],x=node.x,y=node.y,grid=this.grid;return grid[x-1]&&grid[x-1][y]&&ret.push(grid[x-1][y]),grid[x+1]&&grid[x+1][y]&&ret.push(grid[x+1][y]),grid[x]&&grid[x][y-1]&&ret.push(grid[x][y-1]),grid[x]&&grid[x][y+1]&&ret.push(grid[x][y+1]),this.diagonal&&(grid[x-1]&&grid[x-1][y-1]&&ret.push(grid[x-1][y-1]),grid[x+1]&&grid[x+1][y-1]&&ret.push(grid[x+1][y-1]),grid[x-1]&&grid[x-1][y+1]&&ret.push(grid[x-1][y+1]),grid[x+1]&&grid[x+1][y+1]&&ret.push(grid[x+1][y+1])),ret},Graph.prototype.toString=function(){for(var rowDebug,row,y,l,graphString=[],nodes=this.grid,x=0,len=nodes.length;x<len;x++){for(rowDebug=[],y=0,l=(row=nodes[x]).length;y<l;y++)rowDebug.push(row[y].weight);graphString.push(rowDebug.join(" "))}return graphString.join("\n")},GridNode.prototype.toString=function(){return"["+this.x+" "+this.y+"]"},GridNode.prototype.getCost=function(fromNeighbor){return fromNeighbor&&fromNeighbor.x!=this.x&&fromNeighbor.y!=this.y?1.41421*this.weight:this.weight},GridNode.prototype.isWall=function(){return 0===this.weight},BinaryHeap.prototype={push:function(element){this.content.push(element),this.sinkDown(this.content.length-1)},pop:function(){var result=this.content[0],end=this.content.pop();return this.content.length>0&&(this.content[0]=end,this.bubbleUp(0)),result},remove:function(node){var i=this.content.indexOf(node),end=this.content.pop();i!==this.content.length-1&&(this.content[i]=end,this.scoreFunction(end)<this.scoreFunction(node)?this.sinkDown(i):this.bubbleUp(i))},size:function(){return this.content.length},rescoreElement:function(node){this.sinkDown(this.content.indexOf(node))},sinkDown:function(n){for(var element=this.content[n];n>0;){var parentN=(n+1>>1)-1,parent=this.content[parentN];if(!(this.scoreFunction(element)<this.scoreFunction(parent)))break;this.content[parentN]=element,this.content[n]=parent,n=parentN}},bubbleUp:function(n){for(var length=this.content.length,element=this.content[n],elemScore=this.scoreFunction(element);;){var child1Score,child2N=n+1<<1,child1N=child2N-1,swap=null;if(child1N<length){var child1=this.content[child1N];(child1Score=this.scoreFunction(child1))<elemScore&&(swap=child1N)}if(child2N<length){var child2=this.content[child2N];this.scoreFunction(child2)<(null===swap?elemScore:child1Score)&&(swap=child2N)}if(null===swap)break;this.content[n]=this.content[swap],this.content[swap]=element,n=swap}}},{astar:astar,Graph:Graph}},"object"==typeof module&&"object"==typeof module.exports?module.exports=definition():$__System.registerDynamic("22",[],!1,function($__require,$__exports,$__module){return definition.call(this)}),$__System.registerDynamic("23",["c","22"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),Astar=$__require("22"),PathFinder=function(){function PathFinder(size){this.graph=null,this.points=[],this.availablePoints=[],this._removeAnimationKey=function(path,i){var first=path[i].point,middle=path[i+1].point,last=path[i+2].point;return first.equals(last)&&first.equals(middle)?(path.splice(i+1,1),!0):!!new babylonjs_1.Vector3(.5*first.x+.5*last.x,.5*first.y+.5*last.y,.5*first.z+.5*last.z).equals(middle)&&(path.splice(i+1,1),!0)},this.rebuildBuffers(size)}return PathFinder.prototype.rebuildBuffers=function(size){this.width=this.height=size>>0,this.buffer=new Array(this.width);for(var i=0;i<this.height;i++)this.buffer[i]=new Array(this.height);this.points=[]},PathFinder.prototype.fromTo=function(from,to,optimize){void 0===optimize&&(optimize=!1);for(var fromIndex=-1,toIndex=-1,i=0;i<this.points.length;i++){if((p=this.points[i])&&(p.x===from.x&&p.z===from.z&&(fromIndex=i),p.x===to.x&&p.z===to.z&&(toIndex=i),-1!==fromIndex&&-1!==toIndex))break}var sx=fromIndex/this.width>>0,sy=fromIndex%this.height>>0,ex=toIndex/this.width>>0,ey=toIndex%this.width>>0,path=Astar.astar.search(this.graph,this.graph.grid[ex][ey],this.graph.grid[sx][sy],{heuristic:Astar.astar.heuristics.diagonal,closest:!0});if(optimize)for(i=path.length-3;i>=0;--i)for(;path.length-i>=3&&this._removeAnimationKey(path,i););var result=[];for(i=0;i<path.length;i++){var p;if(!(p=path[i]).point)return;result.push(new babylonjs_1.Vector3(p.point.x,babylonjs_1.Scalar.Lerp(from.y,to.y,i/path.length),p.point.z))}return result.reverse()},PathFinder.prototype.createAnimation=function(name,path,framesPerSecond){void 0===framesPerSecond&&(framesPerSecond=60);for(var a=new babylonjs_1.Animation(name,"position",framesPerSecond,babylonjs_1.Animation.ANIMATIONTYPE_VECTOR3,babylonjs_1.Animation.ANIMATIONLOOPMODE_RELATIVE,!1),keys=new Array(path.length),i=0;i<path.length;i++)keys[i]={frame:i,value:path[i]};return a.setKeys(keys),a},PathFinder.prototype.findNearestPoint=function(point){for(var lastDistance=Number.MAX_VALUE,nearest=point,i=0;i<this.points.length;i++){var p=this.points[i];if(p){var d=babylonjs_1.Vector3.Distance(p,point);d<lastDistance&&(lastDistance=d,nearest=p)}}return new babylonjs_1.Vector3(nearest.x,point.y,nearest.z)},PathFinder.prototype.fill=function(castMeshes,rayHeight,rayLength){this.rebuildBuffers(this.width);var b=new babylonjs_1.BoundingInfo(babylonjs_1.Vector3.Zero(),babylonjs_1.Vector3.Zero()),average=babylonjs_1.Vector3.Zero();castMeshes.forEach(function(cm){cm.computeWorldMatrix(!0);var cb=cm._boundingInfo;cb.update(cm.getWorldMatrix()),b.minimum.x=Math.min(b.minimum.x,cb.minimum.x),b.minimum.y=Math.min(b.minimum.y,cb.minimum.y),b.minimum.z=Math.min(b.minimum.z,cb.minimum.z),b.maximum.x=Math.max(b.maximum.x,cb.maximum.x),b.maximum.y=Math.max(b.maximum.y,cb.maximum.y),b.maximum.z=Math.max(b.maximum.z,cb.maximum.z),average.x+=cb.boundingBox.centerWorld.x,average.y+=cb.boundingBox.centerWorld.y,average.z+=cb.boundingBox.centerWorld.z}),average.x/=castMeshes.length,average.y/=castMeshes.length,average.z/=castMeshes.length,this.boundingInfo=b;for(var xd=Math.abs(b.maximum.x)+Math.abs(b.minimum.x),yd=Math.abs(b.maximum.z)+Math.abs(b.minimum.z),s=average.subtract(new babylonjs_1.Vector3(xd/2,0,yd/2)),x=0;x<this.width;x++)for(var rx=x*xd/this.width,y=0;y<this.height;y++){var ry=y*yd/this.height,hit=new babylonjs_1.Ray(s.add(new babylonjs_1.Vector3(rx,rayHeight||b.maximum.y+10,ry)),new babylonjs_1.Vector3(0,-1,0),rayLength||100).intersectsMeshes(castMeshes,!1).find(function(p){return p.hit});hit?(this.points.push(hit.pickedPoint),this.buffer[x][y]=1):(this.points.push(null),this.buffer[x][y]=0)}this.graph=new Astar.Graph(this.buffer,{diagonal:!0});for(x=0;x<this.width;x++)for(y=0;y<this.height;y++){var coord=y*this.width+x;this.graph.grid[y][x].point=this.points[coord]}this.availablePoints=this.points.filter(function(p){return null!==p})},PathFinder}();exports.default=PathFinder}),$__System.registerDynamic("24",["d","e","23"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var extensions_1=$__require("d"),extension_1=$__require("e"),path_finder_1=$__require("23"),PathFinderExtension=function(_super){function PathFinderExtension(scene){var _this=_super.call(this,scene)||this;return _this.instances={},_this.datas=[],_this}return __extends(PathFinderExtension,_super),PathFinderExtension.prototype.onApply=function(data){var _this=this;this.datas=data,data.forEach(function(d){return _this._buildPathFinder(d)})},PathFinderExtension.prototype.onSerialize=function(){return this.scene.metadata&&this.scene.metadata.PathFinderExtension?this.scene.metadata.PathFinderExtension:null},PathFinderExtension.prototype.onLoad=function(data){var _this=this;this.datas=data,this.scene.metadata=this.scene.metadata||{},this.scene.metadata.PathFinderExtension=[],this.datas.forEach(function(d){return _this.scene.metadata.PathFinderExtension.push(d)})},PathFinderExtension.prototype._buildPathFinder=function(data){var _this=this,p=new path_finder_1.default(data.size),meshes=[];data.castMeshes.forEach(function(cm){var m=_this.scene.getMeshByName(cm);m&&meshes.push(m)}),p.fill(meshes,data.rayHeight,data.rayLength),this.instances[data.name]=p},PathFinderExtension}(extension_1.default);exports.default=PathFinderExtension,extensions_1.default.Register("PathFinderExtension",PathFinderExtension)}),$__System.registerDynamic("25",["c"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),AbstractPostProcessEditor=function(_super){function AbstractPostProcessEditor(name,fragmentUrl,camera,engine,config,customCode){var _this=_super.call(this,name,fragmentUrl,[],["textureSampler"],config.ratio,camera,babylonjs_1.Texture.BILINEAR_SAMPLINGMODE,engine)||this;return _this.userConfig={},_this.additionalUniforms=[],_this.additionalSamplers=[],_this.scene=camera?camera.getScene():engine.scenes[0],_this.customCode=customCode,_this.config=config,customCode&&customCode.init(),_this.setConfig(config),_this.setOnApply(),_this}return __extends(AbstractPostProcessEditor,_super),AbstractPostProcessEditor.prototype.setOnApply=function(){var _this=this;this.onApply=function(effect){_this.customCode&&_this.customCode.onApply(effect),_this.config.textures.forEach(function(t){return void 0!==_this.userConfig[t]&&effect.setTexture(t,_this.userConfig[t])}),_this.config.floats.forEach(function(f){return void 0!==_this.userConfig[f]&&effect.setFloat(f,_this.userConfig[f]||0)}),_this.config.vectors2.forEach(function(v){return void 0!==_this.userConfig[v]&&effect.setVector2(v,_this.userConfig[v])}),_this.config.vectors3.forEach(function(v){return void 0!==_this.userConfig[v]&&effect.setVector3(v,_this.userConfig[v])})}},AbstractPostProcessEditor.prototype.setConfig=function(config){var uniforms=["scale"].concat(config.floats).concat(config.vectors2).concat(config.vectors3),samplers=["textureSampler"].concat(config.textures);this.customCode&&this.customCode.setUniforms(uniforms,samplers);try{this.updateEffect("#define UPDATED"+babylonjs_1.Tools.RandomId()+"\n",uniforms,samplers),this.config=config,this.setOnApply()}catch(e){}},AbstractPostProcessEditor.prototype.dispose=function(){this.customCode&&this.customCode.dispose(),_super.prototype.dispose.call(this)},AbstractPostProcessEditor.prototype.getClassName=function(){return"PostProcessEditor"},AbstractPostProcessEditor}(babylonjs_1.PostProcess);exports.default=AbstractPostProcessEditor}),$__System.registerDynamic("26",["c","d","e","27","25"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var EDITOR,babylonjs_1=$__require("c"),extensions_1=$__require("d"),extension_1=$__require("e"),tools_1=$__require("27"),post_process_1=$__require("25"),template="\nEDITOR.PostProcessCreator.Constructors['{{name}}'] = function (camera, tools, mobile) {\nvar returnValue = null;\nvar exports = { };\n\n{{code}}\n"+tools_1.exportScriptString+"\n}\n";!function(EDITOR){var PostProcessCreator=function(){function PostProcessCreator(){}return PostProcessCreator.Constructors={},PostProcessCreator}();EDITOR.PostProcessCreator=PostProcessCreator}(EDITOR=exports.EDITOR||(exports.EDITOR={})),window.EDITOR=window.EDITOR||{},window.EDITOR.PostProcessCreator=EDITOR.PostProcessCreator;var PostProcessEditorExtension=function(_super){function PostProcessEditorExtension(scene){var _this=_super.call(this,scene)||this;return _this.instances={},_this.datas=[],PostProcessEditorExtension.Instance=_this,_this}return __extends(PostProcessEditorExtension,_super),PostProcessEditorExtension.prototype.createPostProcess=function(data,rootUrl){var _this=this,id=data.name+babylonjs_1.Tools.RandomId();babylonjs_1.Effect.ShadersStore[id+"PixelShader"]=data.pixel;var url=window.location.href;url=url.replace(babylonjs_1.Tools.GetFilename(url),"")+"post-processes/"+data.name.replace(/ /g,"")+".js",extension_1.default.AddScript(template.replace("{{name}}",id).replace("{{code}}",data.compiledCode||data.code),url);var camera=this.scene.getCameraByName(data.cameraName)||this.scene.activeCamera,code=new new EDITOR.PostProcessCreator.Constructors[id](camera,extensions_1.default.Tools,extensions_1.default.Mobile)(camera,this.scene),config=null;try{config=JSON.parse(data.config)}catch(e){}var postprocess=new post_process_1.default(data.name,id,data.preview?camera:null,this.scene.getEngine(),config,code);return data.userConfig.textures.forEach(function(t){return postprocess.userConfig[t.name]=babylonjs_1.Texture.Parse(t.value,_this.scene,rootUrl||"file:")}),data.userConfig.floats.forEach(function(f){return postprocess.userConfig[f.name]=f.value}),data.userConfig.vectors2.forEach(function(v){return postprocess.userConfig[v.name]=babylonjs_1.Vector2.FromArray(v.value)}),data.userConfig.vectors3.forEach(function(v){return postprocess.userConfig[v.name]=babylonjs_1.Vector3.FromArray(v.value)}),this.instances[data.name]={code:code,postprocess:postprocess},postprocess},PostProcessEditorExtension.prototype.onApply=function(data,rootUrl){var _this=this;this.datas=data,this.datas.forEach(function(d){return _this.createPostProcess(d,rootUrl)})},PostProcessEditorExtension.prototype.onSerialize=function(){var _this=this;if(!this.scene.metadata||!this.scene.metadata.PostProcessCreator)return null;var data=this.scene.metadata.PostProcessCreator;return data.forEach(function(d){_this.scene.postProcesses.forEach(function(p){p instanceof post_process_1.default&&p.config&&p.name===d.name&&(d.userConfig.textures=[],p.config.textures.forEach(function(t){return p.userConfig[t]&&d.userConfig.textures.push({value:p.userConfig[t].serialize(),name:t})}),d.userConfig.floats=[],p.config.floats.forEach(function(f){return d.userConfig.floats.push({value:p.userConfig[f],name:f})}),d.userConfig.vectors2=[],p.config.vectors2.forEach(function(v){return d.userConfig.vectors2.push({value:p.userConfig[v].asArray(),name:v})}),d.userConfig.vectors3=[],p.config.vectors3.forEach(function(v){return d.userConfig.vectors3.push({value:p.userConfig[v].asArray(),name:v})}))})}),data},PostProcessEditorExtension.prototype.onLoad=function(data){var _this=this;this.datas=data,this.scene.metadata=this.scene.metadata||{},this.scene.metadata.PostProcessCreator=[],this.datas.forEach(function(d){d.id=d.id||babylonjs_1.Tools.RandomId(),_this.scene.metadata.PostProcessCreator.push(d)})},PostProcessEditorExtension.Instance=null,PostProcessEditorExtension}(extension_1.default);exports.default=PostProcessEditorExtension,extensions_1.default.Register("PostProcessCreatorExtension",PostProcessEditorExtension)}),$__System.registerDynamic("28",["c"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__decorate=exports&&exports.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__values=exports&&exports.__values||function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),CustomMaterialDefines=function(_super){function CustomMaterialDefines(){var _this=_super.call(this)||this;return _this.TEXTURE=!1,_this.CLIPPLANE=!1,_this.ALPHATEST=!1,_this.DEPTHPREPASS=!1,_this.POINTSIZE=!1,_this.FOG=!1,_this.NORMAL=!1,_this.UV1=!1,_this.UV2=!1,_this.VERTEXCOLOR=!1,_this.VERTEXALPHA=!1,_this.NUM_BONE_INFLUENCERS=0,_this.BonesPerMesh=0,_this.INSTANCES=!1,_this.rebuild(),_this}return __extends(CustomMaterialDefines,_super),CustomMaterialDefines}(babylonjs_1.MaterialDefines);exports.CustomMaterialDefines=CustomMaterialDefines;var CustomEditorMaterial=function(_super){function CustomEditorMaterial(name,scene,shaderName,customCode,config){var _this=_super.call(this,name,scene)||this;return _this.baseColor=new babylonjs_1.Color3(1,1,1),_this._disableLighting=!1,_this._maxSimultaneousLights=4,_this.userConfig={},_this._buildId=0,_this._lastBuildId=0,_this._shaderName=shaderName,_this.customCode=customCode,_this.customCode&&_this.customCode.init(),_this.config=config,_this}return __extends(CustomEditorMaterial,_super),CustomEditorMaterial.prototype.setCustomCode=function(customCode){this.customCode=customCode,this.customCode&&this.customCode.init()},CustomEditorMaterial.prototype.needAlphaBlending=function(){return this.alpha<1},CustomEditorMaterial.prototype.needAlphaTesting=function(){return!1},CustomEditorMaterial.prototype.getAlphaTestTexture=function(){return null},CustomEditorMaterial.prototype.isReadyForSubMesh=function(mesh,subMesh,useInstances){var e_1,_a;if(void 0===this.customCode)return!1;if(this.isFrozen&&this._wasPreviouslyReady&&subMesh.effect)return!0;subMesh._materialDefines||(subMesh._materialDefines=new CustomMaterialDefines);var defines=subMesh._materialDefines,scene=this.getScene();if(!this.checkReadyOnEveryCall&&subMesh.effect&&this._renderId===scene.getRenderId())return!0;var engine=scene.getEngine();if(defines._areTexturesDirty&&(defines._needUVs=!1,scene.texturesEnabled&&this.config)){var atLeastOneTexture=!1;try{for(var _b=__values(this.config.textures),_c=_b.next();!_c.done;_c=_b.next()){var t=_c.value;if(this.userConfig[t.name]){if(!this.userConfig[t.name].isReady())return!1;atLeastOneTexture=!0}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}atLeastOneTexture&&(defines._needUVs=!0,defines.TEXTURE=!0)}if(babylonjs_1.MaterialHelper.PrepareDefinesForMisc(mesh,scene,!1,this.pointsCloud,this.fogEnabled,!1,defines),defines._needNormals=babylonjs_1.MaterialHelper.PrepareDefinesForLights(scene,mesh,defines,!1,this._maxSimultaneousLights,this._disableLighting),babylonjs_1.MaterialHelper.PrepareDefinesForFrameBoundValues(scene,engine,defines,!!useInstances),babylonjs_1.MaterialHelper.PrepareDefinesForAttributes(mesh,defines,!0,!0),!this.customCode){for(var i=0;i<this._buildId;i++)delete defines["BUILD_"+i];defines["BUILD_"+this._buildId]=!0,defines.rebuild(),this._lastBuildId!==this._buildId&&subMesh.effect&&(this._lastBuildId=this._buildId,scene.getEngine()._releaseEffect(subMesh.effect))}if(defines.isDirty){defines.markAsProcessed(),scene.resetCachedMaterial();var fallbacks=new babylonjs_1.EffectFallbacks;defines.FOG&&fallbacks.addFallback(1,"FOG"),babylonjs_1.MaterialHelper.HandleFallbacksForShadows(defines,fallbacks,this.maxSimultaneousLights),defines.NUM_BONE_INFLUENCERS>0&&fallbacks.addCPUSkinningFallback(0,mesh);var attribs=[babylonjs_1.VertexBuffer.PositionKind];defines.NORMAL&&attribs.push(babylonjs_1.VertexBuffer.NormalKind),defines.UV1&&attribs.push(babylonjs_1.VertexBuffer.UVKind),defines.UV2&&attribs.push(babylonjs_1.VertexBuffer.UV2Kind),defines.VERTEXCOLOR&&attribs.push(babylonjs_1.VertexBuffer.ColorKind),babylonjs_1.MaterialHelper.PrepareAttributesForBones(attribs,mesh,defines,fallbacks),babylonjs_1.MaterialHelper.PrepareAttributesForInstances(attribs,defines);var shaderName=this._shaderName,join=defines.toString(),uniformBuffers=new Array,samplers=this.config?this.config.textures.map(function(t){return t.name}):[],uniforms_1=["world","view","viewProjection","vEyePosition","vLightsType","vBaseColor","vFogInfos","vFogColor","pointSize","mBones","vClipPlane"];if(this.config&&(uniforms_1=uniforms_1.concat(this.config.floats).concat(this.config.vectors2).concat(this.config.vectors3),this.config.textures.forEach(function(t){uniforms_1.push(t.name+"Infos"),uniforms_1.push(t.name+"Matrix")})),this.customCode&&this.customCode.setUniforms(uniforms_1,samplers),this.customCode&&!this.customCode.isReadyForSubMesh(mesh,subMesh,defines))return!1;babylonjs_1.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:uniforms_1,uniformBuffersNames:uniformBuffers,samplers:samplers,defines:defines,maxSimultaneousLights:this.maxSimultaneousLights}),subMesh.setEffect(scene.getEngine().createEffect(shaderName,{attributes:attribs,uniformsNames:uniforms_1,uniformBuffersNames:uniformBuffers,samplers:samplers,defines:join,fallbacks:fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights-1}},engine),defines)}return!(!subMesh.effect||!subMesh.effect.isReady())&&(this._renderId=scene.getRenderId(),this._wasPreviouslyReady=!0,!0)},CustomEditorMaterial.prototype.bindForSubMesh=function(world,mesh,subMesh){var _this=this,scene=this.getScene(),defines=subMesh._materialDefines;if(defines){var effect=subMesh.effect;effect&&(this._activeEffect=effect,this.bindOnlyWorldMatrix(world),this._activeEffect.setMatrix("viewProjection",scene.getTransformMatrix()),babylonjs_1.MaterialHelper.BindBonesParameters(mesh,this._activeEffect),this._mustRebind(scene,effect)&&(this.config&&this.config.textures.forEach(function(t){var texture=_this.userConfig[t.name];texture&&(_this._activeEffect.setTexture(t.name,texture),_this._activeEffect.setFloat2(t.name+"Infos",texture.coordinatesIndex,texture.level),_this._activeEffect.setMatrix(t.name+"Matrix",texture.getTextureMatrix()))}),babylonjs_1.MaterialHelper.BindClipPlane(this._activeEffect,scene),this.pointsCloud&&this._activeEffect.setFloat("pointSize",this.pointSize),babylonjs_1.MaterialHelper.BindEyePosition(effect,scene)),this._activeEffect.setColor4("vBaseColor",this.baseColor,this.alpha*mesh.visibility),scene.lightsEnabled&&!this.disableLighting&&babylonjs_1.MaterialHelper.BindLights(scene,mesh,this._activeEffect,defines,this.maxSimultaneousLights),scene.fogEnabled&&mesh.applyFog&&scene.fogMode!==babylonjs_1.Scene.FOGMODE_NONE&&this._activeEffect.setMatrix("view",scene.getViewMatrix()),babylonjs_1.MaterialHelper.BindFogParameters(scene,mesh,this._activeEffect),this.customCode&&this.customCode.bindForSubMesh(world,mesh,subMesh,this._activeEffect),this.config&&(this.config.floats.forEach(function(f){return void 0!==_this.userConfig[f]&&_this._activeEffect.setFloat(f,_this.userConfig[f]||0)}),this.config.vectors2.forEach(function(v){return void 0!==_this.userConfig[v]&&_this._activeEffect.setVector2(v,_this.userConfig[v])}),this.config.vectors3.forEach(function(v){return void 0!==_this.userConfig[v]&&_this._activeEffect.setVector3(v,_this.userConfig[v])})),this._afterBind(mesh,this._activeEffect))}},CustomEditorMaterial.prototype.getAnimatables=function(){var _this=this,results=[];return this.config.textures.forEach(function(t){var texture=_this.userConfig[t.name];texture&&texture.animations&&texture.animations.length>0&&results.push(texture)}),results},CustomEditorMaterial.prototype.getActiveTextures=function(){var _this=this,activeTextures=_super.prototype.getActiveTextures.call(this);return this.config.textures.forEach(function(t){var texture=_this.userConfig[t.name];texture&&activeTextures.push(texture)}),activeTextures},CustomEditorMaterial.prototype.hasTexture=function(texture){var e_2,_a;if(_super.prototype.hasTexture.call(this,texture))return!0;if(this.config)try{for(var _b=__values(this.config.textures),_c=_b.next();!_c.done;_c=_b.next()){var t=_c.value;if(this.userConfig[t.name]===texture)return!0}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_2)throw e_2.error}}return!1},CustomEditorMaterial.prototype.dispose=function(forceDisposeEffect){this.customCode&&this.customCode.dispose(),_super.prototype.dispose.call(this,forceDisposeEffect)},CustomEditorMaterial.prototype.clone=function(name){var _this=this;return babylonjs_1.SerializationHelper.Clone(function(){return new CustomEditorMaterial(name,_this.getScene(),_this._shaderName,_this.customCode,_this.config)},this)},CustomEditorMaterial.prototype.serialize=function(){var _this=this,serializationObject=babylonjs_1.SerializationHelper.Serialize(this);return serializationObject.customType="BABYLON.CustomEditorMaterial",serializationObject.textures={},serializationObject.floats={},serializationObject.vectors2={},serializationObject.vectors3={},this.config&&(this.config.textures.forEach(function(t){return void 0!==_this.userConfig[t.name]&&(serializationObject.textures[t.name]=_this.userConfig[t.name].serialize())}),this.config.floats.forEach(function(f){return void 0!==_this.userConfig[f]&&(serializationObject.floats[f]=_this.userConfig[f])}),this.config.vectors2.forEach(function(v){return void 0!==_this.userConfig[v]&&(serializationObject.vectors2[v]=_this.userConfig[v].asArray())}),this.config.vectors3.forEach(function(v){return void 0!==_this.userConfig[v]&&(serializationObject.vectors3[v]=_this.userConfig[v].asArray())})),serializationObject},CustomEditorMaterial.prototype.getClassName=function(){return"CustomMaterial"},CustomEditorMaterial.Parse=function(source,scene,rootUrl){var material=babylonjs_1.SerializationHelper.Parse(function(){return new CustomEditorMaterial(source.name,scene,source._shaderName,source._customCode,source.config)},source,scene,rootUrl);for(var thing in source.textures)material.userConfig[thing]=babylonjs_1.Texture.Parse(source.textures[thing],scene,rootUrl);for(var thing in source.floats)material.userConfig[thing]=source.floats[thing];for(var thing in source.vectors2)material.userConfig[thing]=babylonjs_1.Vector2.FromArray(source.vectors2[thing]);for(var thing in source.vectors3)material.userConfig[thing]=babylonjs_1.Vector3.FromArray(source.vectors3[thing]);return material},__decorate([babylonjs_1.serializeAsColor3("baseColor")],CustomEditorMaterial.prototype,"baseColor",void 0),__decorate([babylonjs_1.serialize("disableLighting")],CustomEditorMaterial.prototype,"_disableLighting",void 0),__decorate([babylonjs_1.expandToProperty("_markAllSubMeshesAsLightsDirty")],CustomEditorMaterial.prototype,"disableLighting",void 0),__decorate([babylonjs_1.serialize("maxSimultaneousLights")],CustomEditorMaterial.prototype,"_maxSimultaneousLights",void 0),__decorate([babylonjs_1.expandToProperty("_markAllSubMeshesAsLightsDirty")],CustomEditorMaterial.prototype,"maxSimultaneousLights",void 0),__decorate([babylonjs_1.serialize()],CustomEditorMaterial.prototype,"_shaderName",void 0),CustomEditorMaterial}(babylonjs_1.PushMaterial);exports.default=CustomEditorMaterial}),$__System.registerDynamic("29",["c","d","e","27","28"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var EDITOR,babylonjs_1=$__require("c"),extensions_1=$__require("d"),extension_1=$__require("e"),tools_1=$__require("27"),material_1=$__require("28"),template="\nEDITOR.MaterialCreator.Constructors['{{name}}'] = function () {\nvar returnValue = null;\nvar exports = { };\n\n{{code}}\n"+tools_1.exportScriptString+"\n}\n";!function(EDITOR){var MaterialCreator=function(){function MaterialCreator(){}return MaterialCreator.Constructors={},MaterialCreator}();EDITOR.MaterialCreator=MaterialCreator}(EDITOR=exports.EDITOR||(exports.EDITOR={})),window.EDITOR=window.EDITOR||{},window.EDITOR.MaterialCreator=EDITOR.MaterialCreator;var MaterialEditorExtension=function(_super){function MaterialEditorExtension(scene){var _this=_super.call(this,scene)||this;return _this.instances={},_this.datas=[],MaterialEditorExtension.Instance=_this,_this}return __extends(MaterialEditorExtension,_super),MaterialEditorExtension.prototype.createMaterial=function(data,rootUrl){var _this=this,id=data.name+babylonjs_1.Tools.RandomId();babylonjs_1.Effect.ShadersStore[id+"VertexShader"]=data.vertex,babylonjs_1.Effect.ShadersStore[id+"PixelShader"]=data.pixel;var code=null;if(data.code){var url=window.location.href;url=url.replace(babylonjs_1.Tools.GetFilename(url),"")+"materials/"+data.name.replace(/ /g,"")+".js",extension_1.default.AddScript(template.replace("{{name}}",id).replace("{{code}}",data.compiledCode||data.code),url),code=new(EDITOR.MaterialCreator.Constructors[id]())}var config=null;try{config=JSON.parse(data.config)}catch(e){}var material=this.scene.getMaterialByName(data.name);return material?(material.config=config,material._shaderName=id,material.setCustomCode(code)):material=new material_1.default(data.name,this.scene,id,code,config),data.code&&(data.userConfig.textures.forEach(function(t){return material.userConfig[t.name]=babylonjs_1.Texture.Parse(t.value,_this.scene,rootUrl||"file:")}),data.userConfig.floats.forEach(function(f){return material.userConfig[f.name]=f.value}),data.userConfig.vectors2.forEach(function(v){return material.userConfig[v.name]=babylonjs_1.Vector2.FromArray(v.value)}),data.userConfig.vectors3.forEach(function(v){return material.userConfig[v.name]=babylonjs_1.Vector3.FromArray(v.value)})),this.instances[data.name]={code:code,material:material},material},MaterialEditorExtension.prototype.onApply=function(data,rootUrl){var _this=this;this.datas=data,this.datas.forEach(function(d){return _this.createMaterial(d,rootUrl)})},MaterialEditorExtension.prototype.onSerialize=function(){var _this=this;if(!this.scene.metadata||!this.scene.metadata.MaterialCreator)return null;var data=this.scene.metadata.MaterialCreator;return data.forEach(function(d){_this.scene.materials.forEach(function(m){m instanceof material_1.default&&m.config&&m.name===d.name&&(d.userConfig.textures=[],m.config.textures.forEach(function(t){return m.userConfig[t.name]&&d.userConfig.textures.push({value:m.userConfig[t.name].serialize(),name:t.name})}),d.userConfig.floats=[],m.config.floats.forEach(function(f){return d.userConfig.floats.push({value:m.userConfig[f],name:f})}),d.userConfig.vectors2=[],m.config.vectors2.forEach(function(v){return d.userConfig.vectors2.push({value:m.userConfig[v].asArray(),name:v})}),d.userConfig.vectors3=[],m.config.vectors3.forEach(function(v){return d.userConfig.vectors3.push({value:m.userConfig[v].asArray(),name:v})}))})}),data},MaterialEditorExtension.prototype.onLoad=function(data){var _this=this;this.datas=data,this.scene.metadata=this.scene.metadata||{},this.scene.metadata.MaterialCreator=[],this.datas.forEach(function(d){d.id=d.id||babylonjs_1.Tools.RandomId(),_this.scene.metadata.MaterialCreator.push(d)})},MaterialEditorExtension.Instance=null,MaterialEditorExtension}(extension_1.default);exports.default=MaterialEditorExtension,extensions_1.default.Register("MaterialCreatorExtension",MaterialEditorExtension)}),$__System.registerDynamic("2a",["c","e","d"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),extension_1=$__require("e"),extensions_1=$__require("d"),PostProcessesExtension=function(_super){function PostProcessesExtension(scene){var _this=_super.call(this,scene)||this;return _this.standard=null,_this.default=null,_this.ssao2=null,_this.datas={},_this}return __extends(PostProcessesExtension,_super),PostProcessesExtension.prototype.onApply=function(data,rootUrl){this._applyPostProcesses(data,rootUrl)},PostProcessesExtension.prototype.onSerialize=function(){var pipelines=this.scene.postProcessRenderPipelineManager._renderPipelines,data={};return pipelines.Standard&&(data.standard=pipelines.Standard.serialize()),pipelines.SSAO2&&(data.ssao2=pipelines.SSAO2.serialize()),pipelines.Default&&(data.default=pipelines.Default.serialize()),data},PostProcessesExtension.prototype.onLoad=function(data){this._applyPostProcesses(data,"file:")},PostProcessesExtension.prototype._applyPostProcesses=function(data,rootUrl){data.ssao2&&(this.ssao2=babylonjs_1.SSAO2RenderingPipeline.Parse(data.ssao2,this.scene,rootUrl),this.ssao2._attachCameras(this.scene.cameras,!0)),data.standard&&(this.standard=babylonjs_1.StandardRenderingPipeline.Parse(data.standard,this.scene,rootUrl)),data.default&&(this.default=babylonjs_1.DefaultRenderingPipeline.Parse(data.default,this.scene,rootUrl))},PostProcessesExtension}(extension_1.default);exports.default=PostProcessesExtension,extensions_1.default.Register("PostProcess",PostProcessesExtension)}),$__System.registerDynamic("2b",["d","e"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var extensions_1=$__require("d"),CustomMetadatasExtension=function(_super){function CustomMetadatasExtension(scene){var _this=_super.call(this,scene)||this;return _this.datas=[],_this}return __extends(CustomMetadatasExtension,_super),CustomMetadatasExtension.prototype.onApply=function(data){var _this=this;this.datas=data,data.forEach(function(d){var node=_this.scene.getNodeByID(d.nodeId)||_this.scene.getNodeByName(d.node)||_this.scene.getParticleSystemByID(d.nodeId);node&&(node.metadata=d.metadatas)})},CustomMetadatasExtension.prototype.onSerialize=function(){var result=[],add=function(nodes){nodes.forEach(function(n){n.metadata&&n.metadata.customMetadatas&&result.push({nodeId:n.id,node:n.name,metadatas:n.metadata.customMetadatas})})};return add(this.scene.meshes),add(this.scene.lights),add(this.scene.cameras),add(this.scene.particleSystems),result},CustomMetadatasExtension.prototype.onLoad=function(data){var _this=this;this.datas=data,data.forEach(function(d){var node=_this.scene.getNodeByID(d.nodeId)||_this.scene.getNodeByName(d.node)||_this.scene.getParticleSystemByID(d.nodeId);node&&(node.metadata=node.metadata||{},node.metadata.customMetadatas=d.metadatas)})},CustomMetadatasExtension}($__require("e").default);exports.default=CustomMetadatasExtension,extensions_1.default.Register("CustomMetadatasExtension",CustomMetadatasExtension)}),$__System.registerDynamic("2c",[],!0,function($__require,exports,module){"use strict";var TokenType;this||self;Object.defineProperty(exports,"__esModule",{value:!0}),function(TokenType){TokenType[TokenType.IDENTIFIER=0]="IDENTIFIER",TokenType[TokenType.PARENTHESIS=1]="PARENTHESIS",TokenType[TokenType.COMMA=2]="COMMA",TokenType[TokenType.UNKNOWN=3]="UNKNOWN",TokenType[TokenType.END_OF_INPUT=4]="END_OF_INPUT"}(TokenType=exports.TokenType||(exports.TokenType={}));var Tokenizer=function(){function Tokenizer(toParse){this.identifier="",this.token=TokenType.UNKNOWN,this._pos=0,this._isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this.toParse=toParse,this._maxPos=toParse.length,this.getNextToken()}return Tokenizer.prototype.read=function(){return this.toParse[this._pos++]},Tokenizer.prototype.peek=function(){return this.toParse[this._pos]},Tokenizer.prototype.forward=function(){this._pos++},Tokenizer.prototype.isEnd=function(){return this._pos>=this._maxPos},Tokenizer.prototype.match=function(token){return this.token===token&&(this.getNextToken(),!0)},Tokenizer.prototype.matchIdentifier=function(expected){return this.identifier===expected&&(this.getNextToken(),!0)},Tokenizer.prototype.getNextToken=function(){if(this.isEnd())return this.token=TokenType.END_OF_INPUT;for(var c=" ";" "===(c=this.read())||"\t"===c;)if(this.isEnd())return this.token=TokenType.END_OF_INPUT;switch(c){case"(":case")":return this.token=TokenType.PARENTHESIS;case",":return this.token=TokenType.COMMA;default:if("_"===c||this._isLetterOrDigitPattern.test(c)){for(this.token=TokenType.IDENTIFIER,this.identifier=c;!this.isEnd()&&(this._isLetterOrDigitPattern.test(c=this.peek())||"_"===c||"."===c);)this.identifier+=c,this.forward();return this.token=TokenType.IDENTIFIER}}return this.token=TokenType.UNKNOWN},Tokenizer}();exports.default=Tokenizer}),$__System.registerDynamic("27",["c","d"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var babylonjs_1=$__require("c"),extensions_1=$__require("d"),Tools=function(){function Tools(){}return Tools.prototype.getCustomMaterial=function(name){var ext=extensions_1.default.Instances.MaterialCreatorExtension;return ext?ext.instances[name]:null},Tools.prototype.getCustomScript=function(object,name){var ext=extensions_1.default.Instances.BehaviorExtension;return ext?"string"===(typeof object).toLowerCase()?ext.instances[object+name]:object instanceof babylonjs_1.Scene?ext.instances["scene"+name]:object instanceof babylonjs_1.ParticleSystem?ext.instances[object.id+name]:ext.instances[object.name+name]:null},Tools.prototype.getConstructor=function(name){var ext=extensions_1.default.Instances.BehaviorExtension;return ext?ext.scriptsConstructors[name]:null},Tools.prototype.getCustomPostProcess=function(name){var ext=extensions_1.default.Instances.PostProcessCreatorExtension;return ext?ext.instances[name]:null},Tools.prototype.getFileByName=function(name){return babylonjs_1.FilesInputStore.FilesToLoad[name]},Tools.prototype.getFileUrl=function(filename,oneTimeOnly){return void 0===oneTimeOnly&&(oneTimeOnly=!0),extensions_1.default.RoolUrl&&"file:"!==extensions_1.default.RoolUrl?extensions_1.default.RoolUrl+filename:URL.createObjectURL(this.getFileByName(filename))},Tools.prototype.getPathFinder=function(name){var ext=extensions_1.default.Instances.PathFinderExtension;return ext?ext.instances[name]:null},Tools.prototype.instantiatePrefab=function(name){return extensions_1.default.Instances.AssetsExtension.instantiatePrefab(name)},Tools.prototype.instantiateParticleSystemSet=function(name,position){return extensions_1.default.Instances.AssetsExtension.instantiateParticleSystemsSet(name,position)},Tools.prototype.sendMessage=function(object,methodName){for(var params=[],_i=2;_i<arguments.length;_i++)params[_i-2]=arguments[_i];var ext=extensions_1.default.Instances.BehaviorExtension;if(!ext)return null;var scripts=ext.objectsInstances[object instanceof babylonjs_1.Scene?"Scene":object.id];scripts&&scripts.forEach(function(s){return s[methodName]&&s[methodName].apply(s,params)})},Tools}();exports.default=Tools;var exportScriptBodyString="\n    if (!params) {\n        returnValue = value;\n    } else {\n        returnValue = {\n            ctor: value\n        };\n\n        var keys = Object.keys(params);\n        for (var i = 0; i < keys.length; i++) {\n            returnValue[keys[i]] = params[keys[i]];\n        }\n    }\n".replace(/\n/g,"").replace(/\t/g,"").replace(/  /g,""),exportScriptReturnString="\nif (returnValue) {return returnValue;}\nif (exports) {return exports;}\n".replace(/\n/g,"").replace(/\t/g,"").replace(/  /g,"");exports.exportScriptString="\nfunction exportScript (value, params) {"+exportScriptBodyString+"};\n"+exportScriptReturnString+"\n"}),$__System.registerDynamic("2d",[],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var Mobile=function(){function Mobile(){}return Mobile.prototype.vibrate=function(pattern){return navigator.vibrate&&navigator.vibrate(pattern)},Mobile}();exports.default=Mobile}),$__System.registerDynamic("d",["27","2d"],!0,function($__require,exports,module){"use strict";this||self;var __values=exports&&exports.__values||function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(exports,"__esModule",{value:!0});var tools_1=$__require("27"),mobile_1=$__require("2d"),Extensions=function(){function Extensions(){}return Object.defineProperty(Extensions,"RoolUrl",{get:function(){return this.RootUrl},set:function(url){this.RootUrl=url},enumerable:!0,configurable:!0}),Extensions.Register=function(name,extension){return!this.Extensions[name]&&(this.Extensions[name]=extension,this.OrderedExtensions.push(name),!0)},Extensions.RequestExtension=function(scene,name){if(this.Instances[name])return this.Instances[name];if(!this.Extensions[name])return null;var instance=new this.Extensions[name](scene);return this.Instances[name]=instance,instance},Extensions.ApplyExtensions=function(scene,metadatas){var e_1,_a;try{for(var _b=__values(this.OrderedExtensions),_c=_b.next();!_c.done;_c=_b.next()){var name_1=_c.value,extension=new this.Extensions[name_1](scene);this.Instances[name_1]=extension,(extension.alwaysApply||metadatas[name_1])&&extension.onApply(metadatas[name_1],this.RoolUrl)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}},Extensions.ClearExtensions=function(){this.Instances={}},Extensions.Extensions={},Extensions.Instances={},Extensions.OrderedExtensions=[],Extensions.Tools=new tools_1.default,Extensions.Mobile=new mobile_1.default,Extensions.RootUrl=null,Extensions}();exports.default=Extensions}),$__System.registerDynamic("e",[],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var Extension=function(){function Extension(scene){this.alwaysApply=!1,this.scene=scene}return Extension.AddScript=function(code,url){var script=document.createElement("script");return script.type="text/javascript",script.text=code+"\n//# sourceURL="+url+"\n",document.head.appendChild(script),script},Extension}();exports.default=Extension}),$__System.registerDynamic("2e",["c","2c","27","2f","d","e"],!0,function($__require,exports,module){"use strict";this||self;var extendStatics,__extends=exports&&exports.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__awaiter=exports&&exports.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P(function(resolve){resolve(value)})).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=exports&&exports.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var EDITOR,babylonjs_1=$__require("c"),tokenizer_1=$__require("2c"),tools_1=$__require("27"),require_1=$__require("2f"),extensions_1=$__require("d"),extension_1=$__require("e"),template="\nEDITOR.BehaviorCode.Constructors['{{name}}'] = function (scene, {{node}}, tools, mobile, require) {\nvar returnValue = null;\nvar exports = { };\n\n{{code}}\n"+tools_1.exportScriptString+"\n}\n";!function(EDITOR){var BehaviorCode=function(){function BehaviorCode(){}return BehaviorCode.Constructors={},BehaviorCode}();EDITOR.BehaviorCode=BehaviorCode}(EDITOR=exports.EDITOR||(exports.EDITOR={})),window.EDITOR=window.EDITOR||{},window.EDITOR.BehaviorCode=EDITOR.BehaviorCode;var CodeExtension=function(_super){function CodeExtension(scene){var _this=_super.call(this,scene)||this;return _this.id="behavior-editor",_this.assetsCaption="Scripts",_this.instances={},_this.scriptsConstructors={},_this.objectsInstances={},_this.datas=null,CodeExtension.Instance=_this,_this}return __extends(CodeExtension,_super),CodeExtension.prototype.onCreateAsset=function(name){return __awaiter(this,void 0,void 0,function(){var code,asset;return __generator(this,function(_a){switch(_a.label){case 0:return[4,new Promise(function(resolve){babylonjs_1.Tools.LoadFile("assets/templates/code/custom-code-typescript.ts",function(data){return resolve(data)})})];case 1:return code=_a.sent(),asset={name:name,data:{code:code.replace(/{{name}}/g,(name[0].toUpperCase()+name.substr(1,name.length)).replace(/ /g,"")),id:babylonjs_1.Tools.RandomId(),name:name}},this.scene.metadata=this.scene.metadata||{},this.scene.metadata.behaviorScripts=this.scene.metadata.behaviorScripts||[],this.scene.metadata.behaviorScripts.push(asset.data),[2,asset]}})})},CodeExtension.prototype.onRenameAsset=function(asset,name){asset.data.name=name},CodeExtension.prototype.onGetAssets=function(){var data=this.onSerialize(),attached=[],unAttached=[];return data.scripts.forEach(function(s){if(data.nodes.find(function(n){return void 0!==n.metadatas.find(function(m){return m.codeId===s.id})}))return attached.push({name:s.name,data:s});unAttached.push({name:s.name,data:s})}),[{separator:"Attached"}].concat(attached).concat([{separator:"Unattached"}]).concat(unAttached)},CodeExtension.prototype.onDragAndDropAsset=function(targetMesh,asset){targetMesh.metadata=targetMesh.metadata||{},targetMesh.metadata.behavior||(targetMesh.metadata.behavior={node:targetMesh.name,metadatas:[]}),targetMesh.metadata.behavior.metadatas.push({codeId:asset.data.id,active:!0})},CodeExtension.prototype.onRemoveAsset=function(asset){var data=asset.data,remove=function(objects){objects.forEach(function(o){if(o.metadata&&o.metadata.behavior)for(var links=o.metadata.behavior.metadatas,i=0;i<links.length;i++)links[i].codeId===data.id&&(links.splice(i,1),i--)})};remove(this.scene.meshes),remove(this.scene.lights),remove(this.scene.cameras),remove([this.scene]),remove(this.scene.particleSystems);var index=this.scene.metadata.behaviorScripts.indexOf(data);-1!==index&&this.scene.metadata.behaviorScripts.splice(index,1)},CodeExtension.prototype.onAddAsset=function(asset){this.scene.metadata.behaviorScripts.push(asset.data)},CodeExtension.prototype.onApply=function(data){var _this=this;this.datas=data,this.datas.scripts.forEach(function(s){if(!EDITOR.BehaviorCode.Constructors[s.name.replace(/ /g,"")]&&!_this.datas.nodes.find(function(n){return void 0!==n.metadatas.find(function(m){return m.codeId===s.id})})){var ctor=_this.getConstructor(s,null);_this.scriptsConstructors[s.name]=ctor}}),this.datas.nodes.forEach(function(d){var node="Scene"===d.node?_this.scene:_this.scene.getNodeByID(d.nodeId)||_this.scene.getNodeByName(d.node);node||_this.scene.particleSystems.forEach(function(ps){return ps.name===d.node&&(node=ps)}),node||(node=_this.scene.getParticleSystemByID(d.nodeId)),node&&d.metadatas.forEach(function(m){if(m.active){var code=_this.datas.scripts.find(function(s){return s.id===m.codeId}),ctor=_this.getConstructor(code,node);if(!ctor.ctor&&"function"!=typeof ctor){var nodeName=node instanceof babylonjs_1.Scene?"Scene":node.name;return babylonjs_1.Tools.Warn('Script named "'+code.name+'" has been ignored on object "'+nodeName+'" as there is no exported script. Please use "exportScript(ctor);"')}var instance=new(ctor.ctor||ctor)(node,_this.scene);m.params&&_this.setCustomParams(m,instance),_this.instances[(node instanceof babylonjs_1.Scene?"scene":node.name)+code.name]=instance;var id=node instanceof babylonjs_1.Scene?"Scene":node.id;_this.objectsInstances[id]||(_this.objectsInstances[id]=[]),_this.objectsInstances[id].push(instance);var scope=_this;instance.start&&_this.scene.registerBeforeRender(function(){instance.start(),scope.scene.unregisterBeforeRender(this.callback)}),instance.update&&_this.scene.registerBeforeRender(function(){instance.update(_this.scene.getEngine().getDeltaTime())}),instance.dispose&&node.onDisposeObservable&&node.onDisposeObservable.add(function(){instance.dispose()})}})})},CodeExtension.prototype.onSerialize=function(){var result={scripts:this.scene.metadata&&this.scene.metadata.behaviorScripts||[],nodes:[]},add=function(objects){objects.forEach(function(o){if(o.metadata&&o.metadata.behavior){var behavior=o.metadata.behavior;behavior.node=o instanceof babylonjs_1.Scene?"Scene":o instanceof babylonjs_1.Node?o.name:o.id,behavior.nodeId=o instanceof babylonjs_1.Scene?"Scene":o.id,result.nodes.push(behavior)}})};return add(this.scene.meshes),add(this.scene.lights),add(this.scene.cameras),add([this.scene]),add(this.scene.particleSystems),result},CodeExtension.prototype.onLoad=function(data){var _this=this;if(!data.scripts){var oldData=data;data={scripts:[],nodes:[]},oldData.forEach(function(od){var node={node:od.node,nodeId:od.node,metadatas:[]};od.metadatas.forEach(function(m){var id=babylonjs_1.Tools.RandomId();m.link||(data.scripts.push({name:m.name,id:id,code:m.code,compiledCode:m.compiledCode}),node.metadatas.push({codeId:id,active:m.active,params:m.params}))}),data.nodes.push(node)})}this.datas=data,this.scene.metadata=this.scene.metadata||{},this.scene.metadata.behaviorScripts=this.datas.scripts,this.datas.nodes.forEach(function(d){var node="Scene"===d.node?_this.scene:_this.scene.getNodeByID(d.nodeId)||_this.scene.getNodeByName(d.node);node||(node=_this.scene.getParticleSystemByID(d.node)),node&&(d.metadatas.forEach(function(m){}),node.metadata=node.metadata||{},node.metadata.behavior=d)})},CodeExtension.prototype.setCustomParams=function(m,instance){for(var p in m.params){var param=m.params[p];void 0!==param.w?instance[p]=new babylonjs_1.Vector4(param.x,param.y,param.z,param.w):void 0!==param.z?instance[p]=new babylonjs_1.Vector3(param.x,param.y,param.z):void 0!==param.y?instance[p]=new babylonjs_1.Vector2(param.x,param.y):void 0!==param.a?instance[p]=new babylonjs_1.Color4(param.r,param.g,param.b,param.a):void 0!==param.b?instance[p]=new babylonjs_1.Color3(param.r,param.g,param.b):instance[p]=m.params[p]}},CodeExtension.prototype.getConstructor=function(code,node,evaluate){var url=window.location.href;url=url.replace(babylonjs_1.Tools.GetFilename(url),"")+"behaviors/",url+=node?(node instanceof babylonjs_1.Scene?"scene/":node.name.replace(/ /g,"")+"/")+code.name.replace(/ /g,"")+".js":code.name+".js";var fnName=node?(node instanceof babylonjs_1.Scene?"scene":node.name.replace(/ /g,""))+code.name.replace(/ /g,""):code.name.replace(/ /g,""),effectiveCode=template.replace(/{{name}}/g,fnName).replace(/{{class}}/g,node?node.constructor.name:"").replace(/{{node}}/g,this._getEffectiveConstructorName(node)).replace(/{{code}}/g,code.compiledCode||code.code);return evaluate?new Function(effectiveCode)():extension_1.default.AddScript(effectiveCode,url),EDITOR.BehaviorCode.Constructors[fnName](this.scene,node,extensions_1.default.Tools,extensions_1.default.Mobile,require_1.editorRequire)},CodeExtension.prototype.getConstructorName=function(obj){var tokenizer=new tokenizer_1.default(obj.toString());return tokenizer.matchIdentifier("function")||tokenizer.token===tokenizer_1.TokenType.IDENTIFIER?tokenizer.identifier:"Unknown Constructor Name"},CodeExtension.prototype.getFinalTypeScriptCode=function(code,node){var fnName=(node instanceof babylonjs_1.Scene?"scene":node.name.replace(/ /g,""))+code.name.replace(/ /g,"");return template.replace("{{name}}",fnName).replace("{{node}}",this._getEffectiveConstructorName(node)).replace("{{code}}",code.code)},CodeExtension.prototype._getEffectiveConstructorName=function(obj){if(obj instanceof babylonjs_1.DirectionalLight)return"dirlight";if(obj instanceof babylonjs_1.HemisphericLight)return"hemlight";if(obj instanceof babylonjs_1.GroundMesh||obj instanceof babylonjs_1.InstancedMesh)return"mesh";var ctrName=obj&&obj.constructor?obj.constructor.name:"";return""===ctrName&&(ctrName=typeof obj),ctrName.toLowerCase()},CodeExtension.prototype._getFunctionParameters=function(fn){var tokenizer=new tokenizer_1.default(fn.toString()),result=[];if(!tokenizer.matchIdentifier("function")||!tokenizer.match(tokenizer_1.TokenType.IDENTIFIER)||!tokenizer.match(tokenizer_1.TokenType.PARENTHESIS))return[];for(;!tokenizer.match(tokenizer_1.TokenType.PARENTHESIS)&&(result.push(tokenizer.identifier),tokenizer.getNextToken(),tokenizer.match(tokenizer_1.TokenType.COMMA)););return result},CodeExtension.Instance=null,CodeExtension.CurrentDatas=null,CodeExtension}(extension_1.default);exports.default=CodeExtension,extensions_1.default.Register("BehaviorExtension",CodeExtension)}),$__System.registerDynamic("2f",["c","30","31","32","33","34","35","36","2e"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var BABYLON=$__require("c"),POSTPROCESS=$__require("30"),MATERIALS=$__require("31"),LOADERS=$__require("32"),PROCEDURALTEXTURES=$__require("33"),GUI=$__require("34"),CANNON=$__require("35"),EARCUT=$__require("36"),code_1=$__require("2e");exports.defineRequire=function(){window.require||(window.require=function(name){return exports.editorRequire(name)})},exports.editorRequire=function(moduleName){switch(moduleName){case"babylonjs":return BABYLON;case"babylonjs-procedural-textures":return PROCEDURALTEXTURES;case"babylonjs-loaders":return LOADERS;case"babylonjs-materials":return MATERIALS;case"babylonjs-post-process":return POSTPROCESS;case"babylonjs-gui":return GUI;case"cannon":return CANNON;case"earcut":return EARCUT;default:var ctor=EDITOR.BehaviorCode.Constructors[moduleName];if(ctor){for(var args=new Array(ctor.length),i=0;i<args.length;i++)args[i]=exports.editorRequire;return ctor.apply(ctor,args)}if(ctor=EDITOR.BehaviorCode.Constructors[moduleName.replace(/ /g,"")])return ctor.apply(new Array(ctor.length).map(function(_){return exports.editorRequire}));var code=code_1.default.Instance.datas.scripts.find(function(s){return s.name===moduleName});if(!code)throw new Error('Cannot find custom module named "'+moduleName+'"');return(ctor=code_1.default.Instance.getConstructor(code,null)).default=ctor,ctor}}}),$__System.registerDynamic("a",["d","e","b","2e","15","24","26","29","2a","2b","2f"],!0,function($__require,exports,module){"use strict";this||self;Object.defineProperty(exports,"__esModule",{value:!0});var extensions_1=$__require("d");exports.Extensions=extensions_1.default;var extension_1=$__require("e");exports.Extension=extension_1.default;var assets_1=$__require("b");exports.AssetsExtension=assets_1.default;var code_1=$__require("2e");exports.CodeExtension=code_1.default;var graph_1=$__require("15");exports.GraphExtension=graph_1.default,exports.LGraph=graph_1.LGraph,exports.LGraphCanvas=graph_1.LGraphCanvas,exports.LiteGraph=graph_1.LiteGraph,exports.GraphNode=graph_1.GraphNode,exports.LGraphGroup=graph_1.LGraphGroup;var index_1=$__require("24");exports.PathFinderExtension=index_1.default;var post_process_editor_1=$__require("26");exports.PostProcessEditorExtension=post_process_editor_1.default;var material_editor_1=$__require("29");exports.MaterialEditorExtension=material_editor_1.default;var post_processes_1=$__require("2a");exports.PostProcessExtension=post_processes_1.default;var metadatas_1=$__require("2b");exports.CustomMetadatasExtension=metadatas_1.default,$__require("2f").defineRequire()})})(function(factory){module.exports=factory(require("babylonjs"),require("babylonjs-gui"),require("babylonjs-loaders"),require("babylonjs-materials"),require("babylonjs-post-process"),require("babylonjs-procedural-textures"),require("cannon"),require("earcut"))});